#line 12 "c:\sci\include\rddName.ch"
    EXTERNAL leto
    EXTERNAL DBFNTX
   EXTERNAL DBFCDX


    EXTERNAL DBFFPT
    EXTERNAL SIXCDX
    EXTERNAL DBFNSX
    EXTERNAL HB_MEMIO
#line 20 "apoio.prg"
Proc InclusaoProdutos( lAlteracao )

LOCAL cScreen      := SaveScreen()
LOCAL GetList      := {}
LOCAL lModificar := .F.
LOCAL Arq_Ant      := Alias()
LOCAL Ind_Ant      := IndexOrd()
LOCAL cCodi       := Space(04)
LOCAL cCodi1      := Space(04)
LOCAL cCodi2      := Space(04)
LOCAL cCodi3      := Space(04)
LOCAL cCodi4      := Space(04)
LOCAL cRepres      := Space(04)
LOCAL cCodigo      := "000000"
LOCAL cGrupo      := "000"
LOCAL cSub          := "000.00"
LOCAL cDesc       := Space( 40 )
LOCAL cFab          := Space(15)
LOCAL cCodeBar   := Space(13)
LOCAL cLocal      := Space(10)
LOCAL cUn          := "PC"
LOCAL nOpcao      := 0
LOCAL nEmb          := 0
LOCAL nQmin       := 0
LOCAL nQmax       := 0
LOCAL nPorc       := 0
LOCAL nTx_Icms   := 0
LOCAL nReducao   := 0
LOCAL nAtacado   := 0
LOCAL nVarejo      := 0
LOCAL nPCompra   := 0
LOCAL nMarVar      := 0
LOCAL nMarCus      := 0
LOCAL nMarAta      := 0
LOCAL nPcusto      := 0
LOCAL nAm          := 0
LOCAL nAc          := 0
LOCAL nRo          := 0
LOCAL nRr          := 0
LOCAL nMt          := 0
LOCAL cSituacao  := Space(01)
LOCAL cClasse      := Space(02)
LOCAL cTam          := Space(06)
LOCAL cSigla      := Space(10)
LOCAL nDescMax   := 0
LOCAL cServico   := "N"
LOCAL cSwap
LOCAL cSwapBar
LOCAL cString

if lAlteracao <> NIL .AND. lAlteracao
    lModificar := .T.
    if !PodeAlterar()
        ResTela( cScreen )
        Return
    endif
endif
if !lModificar
    if !PodeIncluir()
         Restela( cScreen )
        Return
    endif
endif
oMenu:Limpa()
dbSelectArea( "Lista" )
Lista->(Order( 2 ))










WHILE .T.
    oMenu:Limpa()
    cClasse     := IF( lModificar, Lista->Classe,            Lista->( Space( Len( Classe      ))))
    cGrupo     := IF( lModificar, Lista->CodGrupo,        Lista->( Space( Len( CodGrupo   ))))
    cSub         := IF( lModificar, Lista->CodSGrupo,        Lista->( Space( Len( CodsGrupo  ))))
    cDesc      := IF( lModificar, Lista->Descricao,        Lista->( Space( Len( Descricao  ))))
    cFab         := IF( lModificar, Lista->N_Original,     Lista->( Space( Len( N_Original ))))
    cLocal     := IF( lModificar, Lista->Local,            Lista->( Space( Len( Local       ))))
    cUn         := IF( lModificar, Lista->Un,                Lista->( Space( Len( Un           ))))
    cUn         := IF( lModificar, Lista->Un,                Lista->( Space( Len( Un           ))))
    cTam         := IF( lModificar, Lista->Tam,                Lista->( Space( Len( Tam          ))))
    cSituacao := IF( lModificar, Lista->Situacao,        Lista->( Space( Len( Situacao   ))))
    cCodi      := IF( lModificar, Lista->Codi,             Lista->( Space( Len( Codi          ))))
    cCodi1     := IF( lModificar, Lista->Codi1,            Lista->( Space( Len( Codi1       ))))
    cCodi2     := IF( lModificar, Lista->Codi2,            Lista->( Space( Len( Codi2       ))))
    cCodi3     := IF( lModificar, Lista->Codi3,            Lista->( Space( Len( Codi3       ))))
    cRepres     := IF( lModificar, Lista->Repres,            Lista->( Space( Len( Repres      ))))
    cCodeBar  := IF( lModificar, Lista->CodeBar,         Lista->( Space( Len( Codebar      ))))
    nAm         := IF( lModificar, Lista->Am,                0 )
    nAc         := IF( lModificar, Lista->Ac,                0 )
    nMt         := IF( lModificar, Lista->Mt,                0 )
    nRo         := IF( lModificar, Lista->Ro,                0 )
    nRr         := IF( lModificar, Lista->Rr,                0 )
    nEmb         := IF( lModificar, Lista->Emb,                0 )
    nQmin      := IF( lModificar, Lista->Qmin,             0 )
    nQmax      := IF( lModificar, Lista->Qmax,             0 )
    nPorc      := IF( lModificar, Lista->Porc,             0 )
    nDescMax  := IF( lModificar, Lista->Desconto,        0 )
    nMarVar     := IF( lModificar, Lista->MarVar,            0 )
    nMarCus     := IF( lModificar, Lista->MarCus,            0 )
    nMarAta     := IF( lModificar, Lista->Marata,            0 )
    nPcusto     := IF( lModificar, Lista->Pcusto,            0 )
    nVarejo     := IF( lModificar, Lista->Varejo,            0 )
    nPCompra  := IF( lModificar, Lista->PCompra,         0 )
    nAtacado  := IF( lModificar, Lista->Atacado,         0 )
    nTx_Icms  := IF( lModificar, Lista->Tx_Icms,         0 )
    nReducao  := IF( lModificar, Lista->Reducao,         0 )
    cServico  := IF( lModificar, IF( Lista->Servico, "S", "N"), "N")

    IF( !lModificar, Lista->(DbGoBottom()),)
    lSair     := .F.
    cCodigo    := IF( lModificar, Lista->Codigo, ProxCodigo( Lista->Codigo ))
    cString    := IF( lModificar, "ALTERACAO DE PRODUTOS", "INCLUSAO DE NOVOS PRODUTOS")
    cSwap     := cCodigo
    cSwapBar := ltrim(rtrim(cCodeBar))

    WHILE .T.
        MaBox( 01, 01, 23, 77, cString )
        SetCursor(1) ; DevPos( 02, 02 ) ; DevOut( "Codigo..............:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cCodigo, "cCodigo", "999999", {|| CodiCerto( @cCodigo, lModificar, cSwap )},))
      SetCursor(1) ; DevPos( Row()+1, 02 ) ; DevOut( "Grupo...............:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cGrupo, "cGrupo", "999", {|| GrupoCerto( @cGrupo, Row(), Col()+1 )},))
      SetCursor(1) ; DevPos( Row()+1, 02 ) ; DevOut( "SubGrupo............:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cSub, "cSub", "999.99", {|| SubCerto( @cSub, Row(), Col()+1, cGrupo )},))
        SetCursor(1) ; DevPos( Row()+1, 02 ) ; DevOut( "Descricao...........:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cDesc, "cDesc", "@!",,))
        SetCursor(1) ; DevPos( Row()+1, 02 ) ; DevOut( "Codigo Fabricante...:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cFab, "cFab", "@!",,))
        SetCursor(1) ; DevPos( Row(), 40 ) ; DevOut( "Localizacao.........:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cLocal, "cLocal", "@!",,))
        SetCursor(1) ; DevPos( Row()+1, 02 ) ; DevOut( "Unidade.............:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cUn, "cUn", "@!",,))
        SetCursor(1) ; DevPos( Row(), 40 ) ; DevOut( "Embalagem...........:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( nEmb, "nEmb", "999",,))
        SetCursor(1) ; DevPos( Row()+1, 02 ) ; DevOut( "Estoque Minimo......:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( nQmin, "nQmin", "999999.99",,))
        SetCursor(1) ; DevPos( Row(), 40 ) ; DevOut( "Estoque Maximo......:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( nQmax, "nQmax", "999999.99",,))
        SetCursor(1) ; DevPos( Row()+1, 02 ) ; DevOut( "Porc.Vendedor.......:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( nPorc, "nPorc", "99.99",,))
        SetCursor(1) ; DevPos( Row(), 40 ) ; DevOut( "Tamanho.............:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cTam, "cTam", "@!",,))
        SetCursor(1) ; DevPos( Row()+1, 02 ) ; DevOut( "Produto ‚ servi‡o...:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cServico, "cServico", "!", {|| PickSimNao( @cServico )},))
        SetCursor(1) ; DevPos( Row(), 40 ) ; DevOut( "Desconto Maximo.....:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( nDescMax, "nDescMax", "99.99",,))
        SetCursor(1) ; DevPos( Row()+1, 02 ) ; DevOut( "Pre‡o de Compra.....:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( nPCompra, "nPCompra", "99999999.99",,))

        SetCursor(1) ; DevPos( Row()+1, 02 ) ; DevOut( "Margem Custo........:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( nMarCus, "nMarCus", "999.99", {|| CalculaVenda( nPCompra, nMarCus, @nPcusto )},))
        SetCursor(1) ; DevPos( Row(), 40 ) ; DevOut( "Pre‡o de Custo......:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( nPcusto, "nPcusto", "99999999.99",,))
        SetCursor(1) ; DevPos( Row()+1, 02 ) ; DevOut( "Margem Varejo.......:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( nMarVar, "nMarVar", "999.99", {|| CalculaVenda( nPcusto, nMarVar, @nVarejo )},))
        SetCursor(1) ; DevPos( Row(), 40 ) ; DevOut( "Pre‡o Varejo........:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( nVarejo, "nVarejo", "99999999.99",,))
        SetCursor(1) ; DevPos( Row()+1, 02 ) ; DevOut( "Margem Atacado......:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( nMarAta, "nMarAta", "999.99", {|| CalculaVenda( nPcusto, nMarAta, @nAtacado )},))
        SetCursor(1) ; DevPos( Row(), 40 ) ; DevOut( "Pre‡o Atacado.......:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( nAtacado, "nAtacado", "99999999.99",,))
      SetCursor(1) ; DevPos( Row()+1, 02 ) ; DevOut( "Situa‡ao Tributaria.:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cSituacao, "cSituacao", "9", {|| PickSituacao( @cSituacao )},))
        SetCursor(1) ; DevPos( Row(), 40 ) ; DevOut( "Classificao Fiscal..:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cClasse, "cClasse", "99", {|| PickClasse( @cClasse ) .AND. CadReducao( cClasse, @nAm, @nRo, @nMt, @nAc, @nRr, cDesc)},))
        SetCursor(1) ; DevPos( Row()+1, 02 ) ; DevOut( "Icms Substituicao...:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( nTx_Icms, "nTx_Icms", "999",,))
        SetCursor(1) ; DevPos( Row(), 40 ) ; DevOut( "Reducao Base Calculo:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( nReducao, "nReducao", "999",,))
        SetCursor(1) ; DevPos( Row()+1, 02 ) ; DevOut( "Fabricante..........:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cCodi, "cCodi", "9999", {|| Pagarrado( @cCodi,  Row(), Col()+5, @cSigla ) .AND. BarNewCode( @cCodebar, cCodi, cCodigo )},))
        SetCursor(1) ; DevPos( Row()+1, 02 ) ; DevOut( "Fornecedor 1........:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cCodi1, "cCodi1", "9999", {|| Pagarrado( @cCodi1, Row(), Col()+5 )},))
        SetCursor(1) ; DevPos( Row()+1, 02 ) ; DevOut( "Fornecedor 2........:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cCodi2, "cCodi2", "9999", {|| Pagarrado( @cCodi2, Row(), Col()+5 )},))
        SetCursor(1) ; DevPos( Row()+1, 02 ) ; DevOut( "Fornecedor 3........:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cCodi3, "cCodi3", "9999", {|| Pagarrado( @cCodi3, Row(), Col()+5 )},))
        SetCursor(1) ; DevPos( Row()+1, 02 ) ; DevOut( "Representante.......:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cRepres, "cRepres", "9999", {|| Represrrado( @cRepres, Row(), Col()+5 )},))
        SetCursor(1) ; DevPos( Row()+1, 02 ) ; DevOut( "Codigo de Barra.....:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cCodeBar, "cCodeBar", "9999999999999", {|| BarErrado( @cCodeBar, lModificar, cSwapBar )},))
        ReadModal( GetList, NIL,,,,, ) ; GetList := {} ; ( GetList )
        if LastKey() = 27
            SetKey( -4, {| p, l, v | TabPreco( p, l, v ) } )
            SetKey( -8, NIL )
            SetKey( -1, NIL )
            SetKey( -2, NIL )
            AreaAnt( Arq_Ant, Ind_Ant )
            lSair := .T.
            Exit
        endif
        ErrorBeep()
        if lModificar
            nOpcao := Alerta(" Pergunta: Voce Deseja ? ", {" Alterar", " Cancelar ", "Sair "})
        Else
            nOpcao := Alerta(" Pergunta: Voce Deseja ? ", {" Incluir", " Alterar ", "Sair "})
        endif
        if nOpcao = 1
            if lModificar
              if !Lista->(TravaReg()) ; Loop ; endif
            Else
              if !CodiCerto( @cCodigo, lModificar ) ; Loop ; endif
              if !Lista->(Incluiu())                     ; Loop ; endif
            endif
            Lista->Codigo        := cCodigo
            Lista->CodGrupo    := cGrupo
            Lista->CodsGrupo    := cSub
            Lista->Descricao    := cDesc
            Lista->N_Original := cFab
            Lista->Un            := cUn
            Lista->Emb            := nEmb
            Lista->Qmin         := nQmin
            Lista->Qmax         := nQmax
            Lista->Porc         := nPorc
            Lista->Sigla        := cSigla
            Lista->Data         := Date()
            Lista->Pcusto        := nPcusto
            Lista->PCompra     := nPCompra
            Lista->Varejo        := nVarejo
            Lista->Atacado     := nAtacado
            Lista->MarVar        := CalcMargem( nPcusto,  nVarejo,  nMarVar )
            Lista->MarAta        := CalcMargem( nPcusto,  nAtacado, nMarAta )
            Lista->MarCus        := CalcMargem( nPCompra, nPcusto,  nMarCus )
            Lista->Classe        := cClasse
            Lista->Situacao    := cSituacao
            Lista->Tx_Icms     := nTx_Icms
            Lista->Reducao     := nReducao
            Lista->Local        := cLocal
            Lista->Repres        := cRepres
            Lista->Tam            := cTam
            Lista->CodeBar     := cCodeBar
            Lista->Desconto    := nDescMax
            Lista->Servico     := IF( cServico = "S", .T., .F. )
            Lista->Atualizado := Date()
            Lista->Am            := nAm
            Lista->Ac            := nAc
            Lista->Mt            := nMt
            Lista->Ro            := nRo
            Lista->Rr            := nRr
            Lista->Codi         := cCodi
            Lista->Codi1        := cCodi1
            Lista->Codi2        := cCodi2
            Lista->Codi3        := cCodi3
            Lista->(Libera())
            if lModificar
                lSair := .T.
                Exit
            endif
            cCodigo := ProxCodigo( cCodigo)
        Elseif nOpcao = 2
            Loop
        Elseif nOpcao = 3
            SetKey( -4, {| p, l, v | TabPreco( p, l, v ) } )
            SetKey( -8, NIL )
            SetKey( -1, NIL )
            SetKey( -2, NIL )
            AreaAnt( Arq_Ant, Ind_Ant )
            lSair := .T.
            Exit
        endif
    EndDo
    if lSair
        if !lModificar
            ResTela( cScreen )
        endif
        Exit
    endif
EndDo
ResTela( cScreen )
SetKey( -4, {| p, l, v | TabPreco( p, l, v ) } )
SetKey( -8, {| p, l, v | InclusaoProdutos( p, l, v ) } )
Return

Function CalcMargem( nCusto, nVenda, nMargem )

LOCAL nPorc := nMargem
if nVenda <> 0
    nPorc := (( nVenda / nCusto ) * 100 ) - 100
    if nPorc > 999.99
        nPorc := 999.99
    Elseif nMargem < 0
        nPorc := 0
    endif
endif
if nPorc > 999.99
    nPorc := 999.99
endif
if nPorc < -99.99
    nPorc := -99.99
endif
Return( nPorc )

Function CadReducao( cClasse, nAm, nRo, nMt, nAc, nRr, cDescricao)

LOCAL GetList := {}
LOCAL cScreen := SaveScreen()

if cClasse <> "20" .OR. LastKey() = 5
    Return( .T. )
endif

oMenu:Limpa()
MaBox( 10, 10, 17, 70, "INCLUSAO DE REDUCAO BASE CALCULO")
DevPos( 11, 11 ) ; DevOut( "Produto.....: " + cDescricao )
SetCursor(1) ; DevPos( 12, 11 ) ; DevOut( "Acre........:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( nAc, "nAc", "999.99",,))
SetCursor(1) ; DevPos( 13, 11 ) ; DevOut( "Amazonas....:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( nAm, "nAm", "999.99",,))
SetCursor(1) ; DevPos( 14, 11 ) ; DevOut( "Mato Grosso.:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( nMt, "nMt", "999.99",,))
SetCursor(1) ; DevPos( 15, 11 ) ; DevOut( "Rondonia....:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( nRo, "nRo", "999.99",,))
SetCursor(1) ; DevPos( 16, 11 ) ; DevOut( "Roraima.....:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( nRr, "nRr", "999.99",,))
ReadModal( GetList, NIL,,,,, ) ; GetList := {} ; ( GetList )
if LastKey() = 27
    ResTela( cScreen )
    Return( .F. )
endif
ErrorBeep()
if Conf("Pergunta: Confirma Inclusao ?")
    ResTela( cScreen )
    Return( .T. )
endif
ResTela( cScreen )
Return( .F. )

Function NovoArquivo()

LOCAL cTela
LOCAL xAlias := "T" + StrTran( Time(),":") + ".TMP"

Mensagem("Aguarde... Criando Arquivo de Trabalho.")
WHILE File((xAlias))
    xAlias := "T" + StrTran( Time(),":") + ".TMP"
EndDo
return( (xAlias) )

Function RecErrado( Var, cCodi, nRow, nCol, cNome )

LOCAL aRotina              := {{||CliInclusao()}}
LOCAL aRotinaAlteracao := {{||CliInclusao( .T. )}}
LOCAL Arq_Ant              := Alias()
LOCAL Ind_Ant              := IndexOrd()
LOCAL nMaxCol          := MaxCol()

dbSelectArea( "Receber" )
Receber->(Order( IF( Len( Var ) < 40, 2, 1 )))
if Receber->(!DbSeek( Var ))
    Receber->(Order( 1 ))
    Receber->(DbGoTop())
    if nMaxCol > 80
        Receber->(Escolhe( 03, 00, MaxRow()-2,"Codi + 'Ý' + Nome + 'Ý' + Fone + 'Ý' + Fax + 'Ý' + Left( Fanta, 15 ) + 'Ý' + Ende", "CODI NOME DO CLIENTE                           TELEFONE #1    TELEFONE #2    POP             ENDERECO", aRotina, nil, aRotinaAlteracao ))
    else
        Receber->(Escolhe( 03, 00, MaxRow()-2,"Codi + 'Ý' + Nome + 'Ý' + Fone + 'Ý' + Left( Fanta, 15 )", "CODI NOME DO CLIENTE                          TELEFONE       POP     ", aRotina, nil, aRotinaAlteracao ))
    endif
endif
if nRow <> Nil
    Write( nRow, nCol, Receber->Nome )
endif
Var   := IF( Len(Var) > 5, Receber->Nome, Receber->Codi )
cNome := Receber->Nome
cCodi := Receber->Codi
AreaAnt( Arq_Ant, Ind_Ant )
Return( .T. )

Function FuncInclusao(lAlteracao)

LOCAL GetList    := {}
LOCAL cScreen    := SaveScreen()
LOCAL lModificar := .F.
LOCAL cCida
LOCAL cEnde
LOCAL cNome
LOCAL cBair
LOCAL cCon
LOCAL dData
LOCAL cCpf
LOCAL cRg1
LOCAL cEsta
LOCAL cCep
LOCAL cFone
LOCAL cObs
LOCAL cCt
LOCAL nPorc
LOCAL cString

if lAlteracao <> NIL .AND. lAlteracao
    lModificar := .T.
    if !PodeAlterar()
       ResTela( cScreen )
        Return
    endif
endif

if !lModificar
    if !PodeIncluir()
        Restela( cScreen )
        Return
    endif
endif

dbSelectArea( "Vendedor" )
Vendedor->(Order( 1 ))
WHILE .T.
   oMenu:Limpa()
    cNome       := IF( lModificar, Vendedor->Nome,          Vendedor->( Space( Len( Nome     ))))
    cCida       := IF( lModificar, Vendedor->Cida,          Vendedor->( Space( Len( Cida     ))))
    cEnde       := IF( lModificar, Vendedor->Ende,          Vendedor->( Space( Len( Ende     ))))
    cBair       := IF( lModificar, Vendedor->Bair,          Vendedor->( Space( Len( Bair     ))))
   cCon         := IF( lModificar, Vendedor->Con,             Vendedor->( Space( Len( Con     ))))
   dData         := IF( lModificar, Vendedor->Data,         Date())
   cCpf         := IF( lModificar, Vendedor->Cpf,             Vendedor->( Space( Len( Cpf     ))))
   cRg         := IF( lModificar, Vendedor->Rg,             Vendedor->( Space( Len( Rg      ))))
   cEsta        := IF( lModificar, Vendedor->Esta,         Vendedor->( Space( Len( Esta     ))))
   cCep         := IF( lModificar, Vendedor->Cep,             Vendedor->( Space( Len( Cep     ))))
    cFone         := IF( lModificar, Vendedor->Fone,         Vendedor->( Space( Len( Fone     ))))
   cObs         := IF( lModificar, Vendedor->Obs,             Vendedor->( Space( Len( Obs     ))))
   cCt         := IF( lModificar, Vendedor->Ct,             Vendedor->( Space( Len( Ct      ))))
    nPorc         := IF( lModificar, Vendedor->PorcCob,        0 )

    IF( !lModificar, Vendedor->(DbGoBottom()),)
    lSair     := .F.

    IF( lModificar )
       cCodi := Vendedor->CodiVen
    Else
        Vendedor->(Order(0))
        Vendedor->(DbGobottom())
        cCodi := StrZero(Val( Vendedor->Codiven ) + 1, 4 )
    endif
    cString    := IF( lModificar, "ALTERACAO DE FUNCIONARIO", "INCLUSAO DE FUNCIONARIO")
    WHILE .T.
        MaBox( 06, 02, 22, 78, cString )
        DevPos( 07, 24 ) ; DevOut( Vendedor->CodiVen + " " + Vendedor->Nome )
        SetCursor(1) ; DevPos( 07, 03 ) ; DevOut( "Codigo........:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cCodi, "cCodi", "9999", {|| FunCerto( @cCodi, lModificar )},))
        SetCursor(1) ; DevPos( 08, 03 ) ; DevOut( "Data Cadastro.:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( dData, "dData", "##/##/##",,))
        SetCursor(1) ; DevPos( 09, 03 ) ; DevOut( "Nome..........:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cNome, "cNome", "@!",,))
        SetCursor(1) ; DevPos( 10, 03 ) ; DevOut( "CPF...........:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cCpf, "cCpf", "999.999.999-99", {|| TestaCpf( cCpf )},))
        SetCursor(1) ; DevPos( 11, 03 ) ; DevOut( "Rg............:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cRg, "cRg", "@!",,))
        SetCursor(1) ; DevPos( 12, 03 ) ; DevOut( "Cart.Trabalho.:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cCt, "cCt", "@!",,))
        SetCursor(1) ; DevPos( 13, 03 ) ; DevOut( "Cep...........:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cCep, "cCep", "99999-999", {|| CepErrado( @cCep, @cCida, @cEsta, @cBair )},))
        SetCursor(1) ; DevPos( 14, 03 ) ; DevOut( "Endereco......:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cEnde, "cEnde", "@!",,))
        SetCursor(1) ; DevPos( 15, 03 ) ; DevOut( "Bairro........:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cBair, "cBair", "@!",,))
        SetCursor(1) ; DevPos( 16, 03 ) ; DevOut( "Cidade........:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cCida, "cCida", "@!",,))
        SetCursor(1) ; DevPos( 17, 03 ) ; DevOut( "Estado........:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cEsta, "cEsta", "@!",,))
        SetCursor(1) ; DevPos( 18, 03 ) ; DevOut( "Telefone......:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cFone, "cFone", "(##)#####-####",,))
        SetCursor(1) ; DevPos( 19, 03 ) ; DevOut( "Contato.......:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cCon, "cCon", "@!",,))
        SetCursor(1) ; DevPos( 20, 03 ) ; DevOut( "Observacoes...:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cObs, "cObs", "@!",,))
        SetCursor(1) ; DevPos( 21, 03 ) ; DevOut( "Porc Cobranca.:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( nPorc, "nPorc", "99.99",,))
        ReadModal( GetList, NIL,,,,, ) ; GetList := {} ; ( GetList )

        if LastKey() = 27
            lSair := .T.
            Exit
        endif
        ErrorBeep()
        if lModificar
            nOpcao := Alerta(" Pergunta: Voce Deseja ? ", {" Alterar", " Cancelar ", "Sair "})
        Else
            nOpcao := Alerta(" Pergunta: Voce Deseja ? ", {" Incluir", " Alterar ", "Sair "})
        endif

        if nOpcao = 1
            if lModificar
                if !Vendedor->(TravaReg()) ; Loop ; endif
            Else
                if !FunCerto( @cCodi, lModificar ) ; Loop ; endif
                if !Vendedor->(Incluiu())              ; Loop ; endif
            endif

            Vendedor->CodiVen := cCodi
            Vendedor->Data     := dData
            Vendedor->Nome     := cNome
            Vendedor->Rg        := cRg
            Vendedor->Ende     := cEnde
            Vendedor->Bair     := cBair
            Vendedor->Cida     := cCida
            Vendedor->Con        := cCon
            Vendedor->Obs        := cObs
            Vendedor->Cpf        := cCpf
            Vendedor->Esta     := cEsta
            Vendedor->Cep        := cCep
            Vendedor->Fone     := cFone
            Vendedor->Ct        := cCt
            Vendedor->PorcCob := nPorc
            Vendedor->(Libera())

            if lModificar
               if !Empty(vendedor->senha)
                    cStr := "Deseja TROCAR a SENHA deste vendedor/cobrador ?"
                else
                    cStr := "Deseja ALTERAR a SENHA deste vendedor/cobrador ?"
                endif
            else
                cStr := "Deseja CADASTRAR a SENHA deste vendedor/cobrador ?"
            endif

            if Conf( cStr )
                CadastraSenha( cCodi )
            endif

            if lModificar
                lSair := .T.
            endif
            Exit

        Elseif nOpcao = 2
            Loop
        Elseif nOpcao = 3
            lSair := .T.
            Exit
        endif
    EndDO
    if lSair
        ResTela( cScreen )
        Exit
    endif
EndDo

Function FunCerto( cCodi, lModificar)

LOCAL Arq_Ant      := Alias()
LOCAL Ind_Ant      := IndexOrd()

if Empty( cCodi )
    ErrorBeep()
   Alerta( "ERRO: Codigo de vendedor invalido.")
    Return( .F. )
endif

if lModificar <> nil
   if lModificar
       return( .T. )
   endif
endif
Vendedor->(Order( 1 ))
if Vendedor->(!DbSeek(cCodi))
    AreaAnt( Arq_Ant, Ind_Ant )
    Return(.T.)
endif
ErrorBeep()
Alerta( "ERRO: Codigo de vendedor ja registrado.")
cCodi := StrZero( Val( cCodi ) + 1,4)
AreaAnt( Arq_Ant, Ind_Ant )
Return( .F. )

Function CadastraSenha( cCodi )

LOCAL GetList      := {}
LOCAL cScreen      := SaveScreen()
LOCAL Arq_Ant      := Alias()
LOCAL Ind_Ant      := IndexOrd()
LOCAL lParametro := .F.
LOCAL cPasse     := Space(10)

oMenu:Limpa()
WHILE .T.
    dbSelectArea( "Vendedor" )
    Vendedor->(Order( 1 ))
    MaBox( 15, 11, 18, 67 )
    if cCodi = NIL
        cCodi := Space(04)
    endif
    SetCursor(1) ; DevPos( 16, 12 ) ; DevOut( "Codigo..:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cCodi, "cCodi", "9999", {|| FunErrado( @cCodi,, Row(), Col()+1 )},))
    SetCursor(1) ; DevPos( 17, 12 ) ; DevOut( "Senha...:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cPasse, "cPasse", "@S", {|| FunSenha( cCodi, cPasse )},))
    ReadModal( GetList, NIL,,,,, ) ; GetList := {} ; ( GetList )

    if LastKey() = 27
        AreaAnt( Arq_Ant, Ind_Ant )
        ResTela( cScreen )
        return .F.
    endif
    ResTela( cScreen )
    AreaAnt( Arq_Ant, Ind_Ant )
    return .T.
EndDo

Function FunSenha( cCodi, cPasse)

LOCAL Arq_Ant    := Alias()
LOCAL Ind_Ant    := IndexOrd()
LOCAL cPassOld   := space(10)
LOCAL cScreen      := SaveScreen()

if !Empty( Vendedor->Senha )
    ErrorBeep()
    if !Conf("Pergunta: Senha do Vendedor Ja Registrada, Trocar ?")
        return .F.
    endif
    cPasse := Space(10)
    MaBox( 19, 11, 22, 40 )
    SetCursor(1) ; DevPos( 20, 12 ) ; DevOut( "Anterior...:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cPassOld, "cPassOld", "@S", {|| SenhaCerta( cCodi, cPassOld )},))
    SetCursor(1) ; DevPos( 21, 12 ) ; DevOut( "Nova Senha.:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cPasse, "cPasse", "@S",,))
    ReadModal( GetList, NIL,,,,, ) ; GetList := {} ; ( GetList )
    if LastKey() = 27
       ResTela( cScreen )
        return .F.
    endif
endif
if Conf( "Pergunta: Confirma Registro da Senha ?")
   if Vendedor->(TravaReg())
         Vendedor->Senha := MsEncrypt(Upper(cPasse))
       Vendedor->(Libera())
   endif
endif
AreaAnt( Arq_Ant, Ind_Ant )
ResTela( cScreen )
return .T.


Function FunErrado( Var, cCodi, nCol, nRow, cNome )

LOCAL aRotinaInc := {{||FuncInclusao()}}
LOCAL aRotinaAlt := {{||FuncInclusao(.T.)}}
LOCAL Arq_Ant    := Alias()
LOCAL Ind_Ant    := IndexOrd()

dbSelectArea( "VendeDor" )
Vendedor->(Order( IF( Len( Var ) < 40, 1, 2 )))
if Vendedor->(!DbSeek( Var ))
    Vendedor->(Order( 2 ))
    Vendedor->(Escolhe( 03, 01, MaxRow()-2, "CodiVen + 'Ý' + Nome + 'Ý' + Fone", "CODI NOME DO VENDEDOR" + Space(25)+ "TELEFONE", aRotinaInc, NIL, aRotinaAlt ))
    Var := IF( Len( Var ) > 4, Vendedor->Nome, Vendedor->CodiVen )
endif
cCodi := Vendedor->CodiVen
if cNome <> NIL
    cNome := Vendedor->Nome
endif
if nCol <> NIL
    Write( nCol, nRow, Vendedor->Nome )
endif
AreaAnt( Arq_Ant, Ind_Ant )
return( .T. )

Function FunAcha( cCpf )

LOCAL aRotinaInc := {{||FuncInclusao()}}
LOCAL aRotinaAlt := {{||FuncInclusao(.T.)}}

if Vendedor->(!DbSeek( cCpf ))
   Vendedor->(Escolhe( 03, 01, MaxRow()-2, "CodiVen + 'Ý' + Nome + 'Ý' + Fone", "CODI NOME DO VENDEDOR" + Space(25)+ "TELEFONE", aRotinaInc, NIL, aRotinaAlt ))
    IF( Len( cCpf ) > 14, cCpf := Vendedor->Nome, cCpf := Vendedor->Cpf )
endif
Return( .T. )

Function FazBrowse( nLinT, nColT, nLinB, nColb, cCabecalho )

LOCAL oBrowse        := TBrowseDb( nLint, nColt, nLinb, nColb )
LOCAL cFrame2        := SubStr( oAmbiente:Frame, 2, 1 )
LOCAL cFrame3        := SubStr( oAmbiente:Frame, 3, 1 )
LOCAL cFrame4        := SubStr( oAmbiente:Frame, 4, 1 )
LOCAL cFrame6        := SubStr( oAmbiente:Frame, 6, 1 )
LOCAL oColuna1
LOCAL oColuna2
LOCAL oColuna3
LOCAL oColuna4
LOCAL oColuna5
LOCAL oColuna6
LOCAL oColuna7
LOCAL oColuna8
LOCAL oColuna9
LOCAL oColuna10

FIELD Quant
FIELD Codigo
FIELD Descricao
FIELD Unitario
FIELD Local

oBrowse:HeadSep    := cFrame2 + cFrame3 + cFrame2
oBrowse:ColSep     := Chr(032) + cFrame4 + Chr(032)
oBrowse:FootSep    := cFrame2    + cFrame2 + cFrame2
oBrowse:colorSpec := "N/W, W+/G, B/W, B/BG, B/W, B/BG, R/W, W+/R"
oColuna1             := TBColumnNew( "QUANT"             ,  {|| Quant } )
oColuna2             := TBColumnNew( "CODI",                {|| Codigo } )
oColuna3             := TBColumnNew( "DESCRICAO DO PRODUTO",{|| Descricao } )
oColuna4             := TBColumnNew( "UNITARIO",            {|| Tran(Unitario,"@E 99,999,999.99")})
oColuna5             := TBColumnNew( "TOTAL ITEM",          {|| Tran(Unitario * Quant ,"@E 9,999,999,999.99")})
oColuna6             := TBColumnNew( "CUSTO",               {|| Tran(Pcusto, "@E 999,999.99")})
oColuna7             := TBColumnNew( "TOTAL CUSTO",         {|| Tran(Pcusto * Quant, "@E 999,999.99")})
oColuna8             := TBColumnNew( "MARGEM",              {|| Tran(((Unitario/Pcusto)*100)-100, "@E 999.99%")})
oColuna9             := TBColumnNew( "CMV",                 {|| Tran(((Pcusto/Unitario)*100), "@E 999.99%")})
oColuna10            := TBColumnNew( "LOCAL",               {|| Local })
oBrowse:AddColumn( oColuna1 )
oBrowse:AddColumn( oColuna2 )
oBrowse:AddColumn( oColuna3 )
oBrowse:AddColumn( oColuna4 )
oBrowse:AddColumn( oColuna5 )
oBrowse:AddColumn( oColuna6 )
oBrowse:AddColumn( oColuna7 )
oBrowse:AddColumn( oColuna8 )
oBrowse:AddColumn( oColuna9 )
oBrowse:AddColumn( oColuna10)
oColuna1:DefColor := {7,8 }
oColuna4:DefColor := {7,8 }
oColuna5:DefColor := {7,8 }
oColuna6:DefColor := {7,8 }
oColuna7:DefColor := {7,8 }
oColuna8:DefColor := {7,8 }
oColuna9:DefColor := {7,8 }
oColuna2:Width     := 6
oColuna3:Width     := 20
Return( oBrowse )

Function BrowseEntradas( nLinT, nColT, nLinB, nColb, cCabecalho )

LOCAL oBrowse        := TBrowseDb( nLint, nColt, nLinb, nColb )
LOCAL cFrame2        := SubStr( oAmbiente:Frame, 2, 1 )
LOCAL cFrame3        := SubStr( oAmbiente:Frame, 3, 1 )
LOCAL cFrame4        := SubStr( oAmbiente:Frame, 4, 1 )
LOCAL cFrame6        := SubStr( oAmbiente:Frame, 6, 1 )
LOCAL oColuna1
LOCAL oColuna2
LOCAL oColuna3
LOCAL oColuna4
LOCAL oColuna5
FIELD Quant
FIELD Codigo
FIELD Descricao
FIELD Unitario

oBrowse:HeadSep    := cFrame2 + cFrame3 + cFrame2
oBrowse:ColSep     := Chr(032) + cFrame4 + Chr(032)
oBrowse:FootSep    := cFrame2    + cFrame2 + cFrame2
oBrowse:colorSpec := "N/W, W+/G, B/W, B/BG, B/W, B/BG, R/W, W+/R"
oColuna1             := TBColumnNew( "QUANT"             ,  {|| Quant } )
oColuna2             := TBColumnNew( "CODI",                {|| Codigo } )
oColuna3             := TBColumnNew( "DESCRICAO DO PRODUTO",{|| Descricao } )
oColuna4             := TBColumnNew( "CUSTO NFF",           {|| Tran(Unitario,"@E 99,999,999.99")})
oColuna5             := TBColumnNew( "TOTAL ITEM",          {|| Tran(Unitario * Quant ,"@E 9,999,999,999.99")})
oColuna6             := TBColumnNew( "FRETE",               {|| Tran(Frete,    "999.99")})
oColuna7             := TBColumnNew( "IMPOSTO",             {|| Tran(Imposto,  "999.99")})
oColuna8             := TBColumnNew( "CUSTO FINAL",         {|| Tran(CustoFinal, "@E 999,999.99")})
oBrowse:AddColumn( oColuna1 )
oBrowse:AddColumn( oColuna2 )
oBrowse:AddColumn( oColuna3 )
oBrowse:AddColumn( oColuna4 )
oBrowse:AddColumn( oColuna5 )
oBrowse:AddColumn( oColuna6 )
oBrowse:AddColumn( oColuna7 )
oBrowse:AddColumn( oColuna8 )
oColuna1:DefColor := {7,8 }
oColuna4:DefColor := {7,8 }
oColuna5:DefColor := {7,8 }
oColuna6:DefColor := {7,8 }
oColuna7:DefColor := {7,8 }
oColuna2:Width     := 6
oColuna3:Width     := 20
Return( oBrowse )

Function BaixaDocnr( cDocnr, nRegistro )

LOCAL cScreen     := SaveScreen()
LOCAL GetList     := {}
LOCAL Arq_Ant     := Alias()
LOCAL Ind_Ant     := IndexOrd()
LOCAL nTam         := 0
LOCAL aDocnr     := {}
LOCAL aRegistro := {}
LOCAL aTodos     := {}
LOCAL xTodos     := {}
LOCAL cCodi      := Space(05)
LOCAL nChoice     := 0
LOCAL xLen         := 0
LOCAL nT          := 0

oMenu:Limpa()
MaBox( 15, 01, 17, 78 )
SetCursor(1) ; DevPos( 16, 02 ) ; DevOut( "Codigo Cliente..: " ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cCodi, "cCodi", "99999", {|| RecErrado( @cCodi,, 16, 35 )},))
ReadModal( GetList, NIL,,,,, ) ; GetList := {} ; ( GetList )
if LastKey() = 27
    AreaAnt( Arq_Ant, Ind_Ant )
    ResTela( cScreen )
    Return( .F. )
endif
dbSelectArea( "Recemov" )
Recemov->(Order( 2 ))
if Recemov->(!DbSeek( cCodi ))
    ErrorBeep()
    Alerta( "Erro: Nenhum Debito em Aberto Deste Cliente." )
    AreaAnt( Arq_Ant, Ind_Ant )
    ResTela( cScreen )
    Return( .F. )
endif
WHILE Recemov->Codi = cCodi
    Recemov->(Aadd( xTodos, {Docnr, Emis, Vcto, Vlr, Recno(), Obs}))
    Recemov->(DbSkip(1))
EndDo
if (nTam := Len( xTodos )) = 0
    ErrorBeep()
    Alerta( "Erro: Nenhum Debito em Aberto Cliente." )
    AreaAnt( Arq_Ant, Ind_Ant )
    ResTela( cScreen )
    Return( .F. )
endif
Asort( xTodos,,, {|x,y|y[3]>x[3]})
xLen := Len(xTodos)
For nT := 1 To xLen
    Aadd( aDocnr,      xTodos[nT,1])
    Aadd( aRegistro, xTodos[nT,5])
    Aadd( aTodos,      xTodos[nT,1] + " " + Dtoc(xTodos[nT,2]) + " " + Dtoc(xTodos[nT,3]) + " " + Tran(xTodos[nT,4],"@E 999,999,999.99") + " " + xTodos[nT,6])
Next
MaBox( 01, 01, 14, 78, "DOCTO  N§  EMISSAO   VENCTO          VALOR OBSERVACAO" + Space(23))
nChoice := aChoice( 02, 02, 13, 77, aTodos )
ResTela( cScreen )
if nChoice = 0
    AreaAnt( Arq_Ant, Ind_Ant )
    Alerta( "Erro: Procura Cancelada..." )
    ResTela( cScreen )
    Return( .F. )
endif
cDocnr     := aDocnr[ nChoice ]
nRegistro := aRegistro[ nChoice ]
AreaAnt( Arq_Ant, Ind_Ant )
ResTela( cScreen )
Return( .T. )

Proc Autenticar( nRecno, nSobra )

LOCAL cScreen := SaveScreen()
LOCAL cValor  := Space(0)
LOCAL nValor  := Space(0)
LOCAL cHist   := Space(60)
LOCAL nVlr      := 0
LOCAL Larg      := 76
LOCAL nOpcao  := 1
LOCAL cDocnr

Receber->(Order( 2 ))
dbSelectArea( "Recebido" )
if ( ! .F. ) ; dbClearRelation() ; end ; dbSetRelation( "Receber", {|| Codi}, "Codi", .F. )
Recebido->(Order( 1 ))
Recebido->(DbGoTo( nRecno ))
cDocnr := Recebido->Docnr
nVlr     := Recebido->VlrPag
cValor := ltrim(rtrim(Tran( nVlr,"@E 999,999.99")))
ErrorBeep()
For i := 1 To 3
    if !Instru80()
        Recebido->(DbClearRel())
        Restela( cScreen )
        Return
    endif
    Mensagem("Aguarde, Autenticando.")
    PrintOn()
    FPrInt( PQ )
    SetPrc(0,0)
    Qout("*MP*" + cDocnr + "*" + Dtoc( Date()) + "*" + cValor + "*" + Left( Receber->Nome,4 ) + "*")
    Qout("*MP*" + cDocnr + "*" + Dtoc( Date()) + "*" + cValor + "*" + Left( Receber->Nome,4 ) + "*")
    PrintOff()
Next
ResTela( cScreen )
Return

Function DocErrado( Var, nValor, nVlrTotal, dVcto, cHist, nRow, nCol, lLancarJurosNaoPago )

LOCAL Arq_Ant         := Alias()
LOCAL Ind_Ant         := IndexOrd()
LOCAL nRegistro     := 0
LOCAL cComplemento := Space(0)
LOCAL cString         := Space(0)
LOCAL nTam
IF lLancarJurosNaoPago == NIL ; lLancarJurosNaoPago := .F. ; END


    cComplemento := "PAG PARCIAL "
    cString         := "PARCELA CONTRATO SERVICOS DE INTERNET."
    cHist          := cString + Space(60-Len(cString))


Receber->(Order( 2 ))
dbSelectArea( "Recemov" )
if ( Recemov->(DbGoTop()), Recemov->(Eof()))
    AreaAnt( Arq_Ant, Ind_Ant )
    Nada()
    Return( .F. )
endif
if( nVlrTotal = NIL, nVlrTotal := 0, nVlrTotal )
if ( Recemov->(Order( 1 )), Recemov->(!DbSeek( Var )))
   if !lLancarJurosNaoPago
       ErrorBeep()
        if Conf("Erro: Documento nao Encontrado. Localizar por Nome?")
            if BaixaDocnr( @Var, @nRegistro )
                Recemov->( DbGoTo( nRegistro ))
                nValor    := Round(IF( nVlrTotal <= 0, Recemov->Vlr, nVlrTotal),2)
                nVlrTotal := Round(IF( nVlrTotal <= 0, CalcJuros(), nVlrTotal),2)
                dVcto      := Recemov->Vcto
                nTam         := Len(ltrim(rtrim(Recemov->Obs)))
                cHist      := IF( Empty(Recemov->Obs), cComplemento + cHist, cComplemento + Left(Recemov->Obs,nTam) + Space((60-12-nTam)))
                if nRow <> NIL
                    Write( nRow, nCol, Receber->Nome )
                endif
                AreaAnt( Arq_Ant, Ind_Ant )
                Return( .T. )
            endif
        endif
        Receber->(Order( 2 ))
        dbSelectArea( "Recemov" )
        Recemov->(Order( 1 ))
        if ( ! .F. ) ; dbClearRelation() ; end ; dbSetRelation( "Receber", {|| Recemov->Codi}, "Recemov->Codi", .F. )
        Recemov->(DbGoTop())
        Recemov->(Escolhe( 03, 01, MaxRow()-2, "Docnr + 'Ý' + Receber->Nome", "DOCTO N§  NOME DO CLIENTE" ))
    else
        AreaAnt( Arq_Ant, Ind_Ant )
        Return( .F. )
    endif
endif
Var         := Recemov->Docnr
nValor    := Round(IF( nVlrTotal <= 0, Recemov->Vlr, nVlrTotal),2)
nVlrTotal := Round(IF( nVlrTotal <= 0, CalcJuros(), nVlrTotal),2)
dVcto      := Recemov->Vcto
nTam         := Len(ltrim(rtrim(Recemov->Obs)))
cHist      := IF( Empty(Recemov->Obs), cComplemento + cHist, cComplemento + Left(Recemov->Obs,nTam) + Space((60-12-nTam)))
if nRow <> NIL
    Write( nRow, nCol, Receber->Nome )
endif
AreaAnt( Arq_Ant, Ind_Ant )
Return(.T.)

Function CheErrado( cCodi, cCodi1, nLinha, nCol, lOpcional )

LOCAL aRotina := {{|| Cheq11() }}
LOCAL cScreen := SaveScreen()
LOCAL Arq_Ant := Alias()
LOCAL Ind_Ant := IndexOrd()
FIELD Codi
FIELD Titular



if LastKey() = 5
    Return( .T. )
endif
if lOpcional <> Nil
    if Empty( cCodi )
        if nLinha <> Nil
            Write( nLinha, nCol, "MOVIMENTO CONTRA PARTIDA NAO LANCADO")
        endif
        __Keyboard( Chr( 13 ) )
        AreaAnt( Arq_Ant, Ind_Ant )
        Return( .T. )
    endif
endif
dbSelectArea( "Cheque" )
DbSetOrder( IF( Len( cCodi ) < 40, 1, 2 ) )
if !( DbSeek( cCodi ) )
    DbSetOrder( 2 )
    DbGoTop()
    Escolhe( 03, 01, MaxRow()-2, "Codi + 'Ý' + Titular","CODI TITULAR DA CONTA", aRotina  )
    cCodi  := IF( Len( cCodi ) = 4, Codi,      Titular )
    if cCodi1 <> Nil
        cCodi1 := IF( Len( cCodi1 ) = 4, Codi,     Titular )
    endif
endif
if nLinha <> Nil
    Write( nLinha, nCol, Titular )
endif
AreaAnt( Arq_Ant, Ind_Ant )
Return(.T.)

Proc Paga22( cCaixa )

LOCAL cScreen := SaveScreen( )
LOCAL Arq_Ant := Alias()
LOCAL Ind_Ant := IndexOrd()
LOCAL GetList := {}
LOCAL nLancar := 0
LOCAL cDocnr
LOCAL dData
LOCAL nVlr
LOCAL cFone
LOCAL cPort
LOCAL nDebito
LOCAL nJuro
LOCAL cCida
LOCAL cEsta
LOCAL cCep
LOCAL cEnde
LOCAL nRecno
LOCAL cCodi
LOCAL cNome
LOCAL dEmis
LOCAL dVcto
LOCAL ctipo
LOCAL cDc
LOCAL nAtraso
LOCAL nTotJuros
LOCAL nVlrTotal
LOCAL nVlrPago
LOCAL cCodiCx
LOCAL lOk_Baixo
LOCAL nRecno1
LOCAL cFatura
LOCAL cCodiCx1
LOCAL cCodiCx2
LOCAL cCodiCx3
LOCAL cDc1
LOCAL cDc2
LOCAL cDc3
LOCAL cObs1
LOCAL cObs2
LOCAL cHist
LOCAL nCol
LOCAL nRow
LOCAL nJuroDia
LOCAL lEmitir
LOCAL nChSaldo
LOCAL cHist2
LOCAL nDiferenca

FIELD Nome
FIELD CodiVen
FIELD Vlr
FIELD Fone
FIELD Port
FIELD Tipo
FIELD Cida
FIELD Ende
FIELD Codi
FIELD Emis
FIELD Vcto
FIELD Esta
FIELD Cep
FIELD Juro
FIELD Docnr

if !PodePagar()
    ResTela( cScreen )
    Return
endif

WHILE .T.
    oMenu:Limpa()
    MaBox( 15, 10, 17, 31 )
    cDocnr := Space( 09 )
    SetCursor(1) ; DevPos( 16, 11 ) ; DevOut( "Doc.No.." ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cDocnr, "cDocnr", "@!", {|| PgDocErrad( @cDocnr )},))
    ReadModal( GetList, NIL,,,,, ) ; GetList := {} ; ( GetList )
    if LastKey() = 27
        ResTela( cScreen )
        Exit
    endif
    if Pagamov->(!TravaReg())
        Loop
    endif
    Pagar->(Order( 2 ))
    dbSelectArea( "PagaMov" )
    if ( ! .F. ) ; dbClearRelation() ; end ; dbSetRelation( "Pagar", {|| Codi}, "Codi", .F. )
    dData      := Date()
    nVlr         := Pagamov->Vlr
    cPort      := Pagamov->Port
    cTipo      := Pagamov->Tipo
    nJuro      := Pagamov->Juro
    cDocnr     := Pagamov->Docnr
    cFatura     := Pagamov->Fatura
    cCodiCx     := "0000"
    cCodiCx1  := Space(04)
    cCodiCx2  := Space(04)
    cCodiCx3  := Space(04)
    cDc         := "D"
    cDc1         := "D"
    cDc2         := "C"
    cDc3         := "C"
    cCodi      := Pagamov->Codi
    dEmis      := Pagamov->Emis
    dVcto      := Pagamov->Vcto
    nVlr         := Pagamov->Vlr
    cObs1      := Pagamov->Obs1
    cObs2      := Pagamov->Obs2
    cNome      := Pagar->Nome
    cHist      := "PAG " + cNome
    WHILE .T.
        nCol := 06
        nRow := 02
        MaBox( 02, 05 , nRow+18 , 79, "PAGAMENTOS" )
        DevPos( nRow+01, nCol ) ; DevOut( "Fornecedor..: " + Pagar->Codi + " " + Pagar->Nome )
        DevPos( nRow+02, nCol ) ; DevOut( "Tipo........: " + cTipo )
        DevPos( nRow+02, nCol+35 ) ; DevOut( "Docto N§....: " + cDocnr )
        DevPos( nRow+03, nCol ) ; DevOut( "Emissao.....: " + Dtoc( Emis ) )
        DevPos( nRow+03, nCol+35 ) ; DevOut( "Vencto......: " + Dtoc( Vcto ) )
        DevPos( nRow+04, nCol ) ; DevOut( "Juros Mes...: " + Tran( nJuro , "@E 9,999,999,999.99" ) )
        DevPos( nRow+04, nCol+35 ) ; DevOut( "Dias Atraso.: " )
        DevPos( nRow+05, nCol ) ; DevOut( "Valor.......: " + Tran( Vlr ,      "@E 9,999,999,999.99" ) )
        DevPos( nRow+05, nCol+35 ) ; DevOut( "Desconto....: " + Tran( Desconto , "@E 999.99" ) )
        DevPos( nRow+06, nCol ) ; DevOut( "Jrs Devidos.: " )
        DevPos( nRow+07, nCol ) ; DevOut( "Vlr c/Juros.: " )
        DevPos( nRow+07, nCol+35 ) ; DevOut( "Vlr c/ Desc.: " )
        SetCursor(1) ; DevPos( nRow+08, nCol ) ; DevOut( "Data Pgto...: " ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( dData, "dData", "##/##/##",,))
        ReadModal( GetList, NIL,,,,, ) ; GetList := {} ; ( GetList )
        if LastKey() = 27
            Exit
        endif
        nAtraso    := Atraso( dData, Vcto )
        nJuroDia := JuroDia( Vlr, nJuro )
        if nAtraso <= 0
            nTotJuros := 0
            nVlrTotal := Vlr
            nVlrTotal -= Desconto
        Else
            nTotJuros := ( nAtraso * nJuroDia )
            nVlrTotal := ( nTotJuros + Vlr )
        endif
        nVlrPago := nVlrTotal

        Write( nRow+04, nCol+35, "Dias Atraso.: " + Tran( nAtraso,   "99999") + " Dias" )
        Write( nRow+06, nCol,     "Jrs Devidos.: " + Tran( nTotJuros, "@E 9,999,999,999.99"))
        Write( nRow+07, nCol,     "Vlr c/juros.: " + Tran( nVlrTotal, "@E 9,999,999,999.99"))
        Write( nRow+07, nCol+35, "Vlr c/ Desc.: " + Tran( nVlrPago,  "@E 9,999,999,999.99"))

        SetCursor(1) ; DevPos( nRow+09, nCol ) ; DevOut( "Valor Pago..: " ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( nVlrPago, "nVlrPago", "@E 9,999,999,999.99",,))
        SetCursor(1) ; DevPos( nRow+10, nCol ) ; DevOut( "Portador....: " ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cPort, "cPort", "@!",,))
        SetCursor(1) ; DevPos( nRow+11, nCol ) ; DevOut( "Conta Caixa.: " ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cCodiCx, "cCodiCx", "9999", {|| LastKey() = 5 .OR. CheErrado( @cCodiCx,,  Row(), 35 )},))
        SetCursor(1) ; DevPos( nRow+11, nCol+20 ) ; DevOut( "D/C.:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cDc, "cDc", "!", {|| PickTam({"Credito em conta","Debito em conta"}, {"C","D"}, @cDc )},))
        SetCursor(1) ; DevPos( nRow+12, nCol ) ; DevOut( "C. Partida..: " ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cCodiCx1, "cCodiCx1", "9999", {|| LastKey() = 5 .OR. CheErrado( @cCodiCx1,, Row(), 35, .T. )},))
        SetCursor(1) ; DevPos( nRow+12, nCol+20 ) ; DevOut( "D/C.:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cDc1, "cDc1", "!", {|| PickTam({"Credito em conta","Debito em conta"}, {"C","D"}, @cDc1 )},))
        SetCursor(1) ; DevPos( nRow+13, nCol ) ; DevOut( "C. Partida..: " ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cCodiCx2, "cCodiCx2", "9999", {|| LastKey() = 5 .OR. CheErrado( @cCodiCx2,, Row(), 35, .T. )},))
        SetCursor(1) ; DevPos( nRow+13, nCol+20 ) ; DevOut( "D/C.:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cDc2, "cDc2", "!", {|| PickTam({"Credito em conta","Debito em conta"}, {"C","D"}, @cDc2 )},))
        SetCursor(1) ; DevPos( nRow+14, nCol ) ; DevOut( "C. Partida..: " ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cCodiCx3, "cCodiCx3", "9999", {|| LastKey() = 5 .OR. CheErrado( @cCodiCx3,, Row(), 35, .T. )},))
        SetCursor(1) ; DevPos( nRow+14, nCol+20 ) ; DevOut( "D/C.:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cDc3, "cDc3", "!", {|| PickTam({"Credito em conta","Debito em conta"}, {"C","D"}, @cDc3 )},))
        SetCursor(1) ; DevPos( nRow+15, nCol ) ; DevOut( "Historico...: " ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cHist, "cHist", "@!", {|| LastKey() = 5 .OR. !Empty( cHist )},))
        SetCursor(1) ; DevPos( nRow+16, nCol ) ; DevOut( "Observacoes.: " ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cObs1, "cObs1", "@!",,))
        SetCursor(1) ; DevPos( nRow+17, nCol ) ; DevOut( "Observacoes.: " ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cObs2, "cObs2", "@!",,))
        ReadModal( GetList, NIL,,,,, ) ; GetList := {} ; ( GetList )
        if LastKey() = 27
            Exit
        endif
        lOk_Baixo := Conf(" Pergunta: Baixar Registro ? ", {" Sim ", " Alterar ", " Sair " })
        if      lOk_Baixo = 2
            Loop
        Elseif lOk_Baixo = 1
            lEmitir := 1
            if nVlrPago <> nVlrTotal
                ErrorBeep()

                lEmitir := Conf("Valor pago diferente que o devido.;;Pergunta: Fazer Baixa como:", {"Quitar", "Parcial", "Diferenca C/C", "Cancelar"})
                if lEmitir = 4
                    Loop
                endif
                if lEmitir = 3
                    cCodiCx2 := Space(04)
                    cDc2        := " "
                    cHist2    := cHist
                    MaBox( nRow+15, 05 , nRow+18 , 74, "LANCAMENTOS DIFERENCA C/C")
                    SetCursor(1) ; DevPos( nRow+16, nCol ) ; DevOut( "Conta Caixa.: " ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cCodiCx2, "cCodiCx2", "9999", {|| CheErrado( @cCodiCx2,, Row(), nCol+28 )},))
                    SetCursor(1) ; DevPos( nRow+16, nCol+20 ) ; DevOut( "D/C.:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cDc2, "cDc2", "!", {|| cDc2 $ "DC"},))
                    SetCursor(1) ; DevPos( nRow+17, nCol ) ; DevOut( "Historico...: " ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cHist2, "cHist2", "@!", {|| !Empty( cHist2 )},))
                    ReadModal( GetList, NIL,,,,, ) ; GetList := {} ; ( GetList )
                    if LastKey() = 27
                        Loop
                    endif
                    ErrorBeep()
                    if !Conf("Pergunta: Confirma Lancamento ?")
                        Loop
                    endif
                endif
            endif

            if Pago->(!Incluiu())      ; DbUnLockAll() ; Loop ; endif
            if Chemov->(!Incluiu())   ; DbUnLockAll() ; Loop ; endif
            Cheque->(Order( 1 ))
            if Cheque->(!DbSeek( cCodiCx )) ; DbUnLockAll() ; Loop ; endif
            if Cheque->(!TravaReg())          ; DbUnLockAll() ; Loop ; endif

            if lEmitir = 2
                if nVlrPago < nVlrTotal
                    if lEmitir = 2
                        Pagamov->Emis := dData
                        Pagamov->Vcto := dData
                        Pagamov->Vlr  := ( nVlrTotal - nVlrPago )
                    endif
                endif
            Else
                Pagamov->(DbDelete())
            endif
            Pagamov->(Libera())

            Pago->Codi      := cCodi
            Pago->Docnr   := cDocnr
            Pago->Fatura  := cFatura
            Pago->Emis      := dEmis
            Pago->Vcto      := dVcto
            Pago->Vlr      := nVlr
            Pago->DataPag := dData
            Pago->VlrPag  := nVlrPago
            Pago->Port      := cPort
            Pago->Tipo      := cTipo
            Pago->Juro      := nJuro
            Pago->nDeb      := "NAO"
            Pago->Obs1      := cObs1
            Pago->Obs2      := cObs2
            Pago->(Libera())


            nChSaldo := Cheque->Saldo
            if cDc = "C"
                nChSaldo     += nVlrPago
                Chemov->Cre := nVlrPago
            Else
                nChSaldo      -= nVlrPago
                Chemov->Deb  := nVlrPago
            endif
            Chemov->Codi      := cCodiCx
            Chemov->Docnr      := cDocnr
            Chemov->Fatura   := cFatura
            Chemov->Emis      := dData
            Chemov->Data      := dData
            Chemov->Baixa      := Date()
            Chemov->Hist      := cHist
            Chemov->Saldo      := nChSaldo
            Chemov->Tipo      := "PG"
            Chemov->Caixa      := IF( cCaixa = Nil, Space(4), cCaixa )
            Chemov->CPartida := .F.
            Chemov->(Libera())
            Cheque->Saldo    := nChSaldo

            if Cheque->(DbSeek( cCodiCx1 ))
                if Cheque->(TravaReg())
                    nChSaldo   := Cheque->Saldo
                    if Chemov->(Incluiu())
                        if cDc1 = "C"
                            nChSaldo     += nVlrPago
                            Chemov->Cre := nVlrPago
                        Else
                            nChSaldo      -= nVlrPago
                            Chemov->Deb  := nVlrPago
                        endif
                        Chemov->Codi    := cCodiCx1
                        Chemov->Docnr    := cDocnr
                        Chemov->Fatura := cFatura
                        Chemov->Emis    := dData
                        Chemov->Data    := dData
                        Chemov->Baixa    := Date()
                        Chemov->Hist    := cHist
                        Chemov->Saldo    := nChSaldo
                        Chemov->Tipo    := "PG"
                        Chemov->Caixa    := IF( cCaixa = Nil, Space(4), cCaixa )
                        Chemov->CPartida := .T.
                        Chemov->(Libera())
                        Cheque->Saldo := nChSaldo
                    endif
                endif
            endif

            if Cheque->(DbSeek( cCodiCx2 ))
                if Cheque->(TravaReg())
                    nChSaldo   := Cheque->Saldo
                    if Chemov->(Incluiu())
                        if cDc2 = "C"
                            nChSaldo     += nVlrPago
                            Chemov->Cre := nVlrPago
                        Else
                            nChSaldo      -= nVlrPago
                            Chemov->Deb  := nVlrPago
                        endif
                        Chemov->Codi    := cCodiCx2
                        Chemov->Docnr    := cDocnr
                        Chemov->Fatura := cFatura
                        Chemov->Emis    := dData
                        Chemov->Data    := dData
                        Chemov->Baixa    := Date()
                        Chemov->Hist    := cHist
                        Chemov->Saldo    := nChSaldo
                        Chemov->Tipo    := "PG"
                        Chemov->(Libera())
                        Cheque->Saldo := nChSaldo
                    endif
                endif
            endif

            if Cheque->(DbSeek( cCodiCx3 ))
                if Cheque->(TravaReg())
                    nChSaldo   := Cheque->Saldo
                    if Chemov->(Incluiu())
                        if cDc3 = "C"
                            nChSaldo     += nVlrPago
                            Chemov->Cre := nVlrPago
                        Else
                            nChSaldo      -= nVlrPago
                            Chemov->Deb  := nVlrPago
                        endif
                        Chemov->Codi    := cCodiCx3
                        Chemov->Docnr    := cDocnr
                        Chemov->Fatura := cFatura
                        Chemov->Emis    := dData
                        Chemov->Data    := dData
                        Chemov->Baixa    := Date()
                        Chemov->Hist    := cHist
                        Chemov->Saldo    := nChSaldo
                        Chemov->Tipo    := "PG"
                        Chemov->(Libera())
                        Cheque->Saldo := nChSaldo
                    endif
                endif
            endif

            if lEmitir = 3
                if Cheque->(DbSeek( cCodiCx2 ))
                    if Cheque->(TravaReg())
                        nChSaldo := Cheque->Saldo
                        if nVlrTotal < nVlrpago
                            nDiferenca := nVlrPago - nVlrTotal
                        Else
                            nDiferenca := nVlrTotal - nVlrPago
                        endif
                        if Chemov->(Incluiu())
                            if cDc2 = "C"
                                nChSaldo     += nDiferenca
                                Chemov->Cre := nDiferenca
                            Else
                                nChSaldo      -= nDiferenca
                                Chemov->Deb  := nDiferenca
                            endif
                            Chemov->Codi    := cCodiCx2
                            Chemov->Docnr    := cDocnr
                            Chemov->Fatura := cFatura
                            Chemov->Emis    := dData
                            Chemov->Data    := dData
                            Chemov->Baixa    := Date()
                            Chemov->Hist    := cHist2
                            Chemov->Saldo    := nChSaldo
                            Chemov->Tipo    := "DF"

                            Chemov->(Libera())
                            Cheque->Saldo    := nChSaldo
                        endif
                    endif
                endif
            endif
            Cheque->(Libera())
        endif
        Exit
    EndDo
    DbUnLockAll()
    Pagamov->(DbClearRel())
    AreaAnt( Arq_Ant, Ind_Ant )
    ResTela( cScreen )
EndDo

Function PgDocErrad( cDocnr )

LOCAL cScreen     := SaveScreen()
LOCAL Ind_Ant     := IndexOrd()
LOCAL Arq_Ant     := Alias()
LOCAL nRegistro := 0
FIELD Docnr
FIELD Emis
FIELD Vcto
FIELD Vlr

Pagar->(Order( 2 ))
dbSelectArea( "Pagamov" )
if ( Pagamov->(DbGoTop()), Pagamov->(Eof()))
    AreaAnt( Arq_Ant, Ind_Ant )
    Nada()
    Return( .F. )
endif
if ( Pagamov->(Order( 1 )), Pagamov->(!DbSeek( cDocnr )))
    ErrorBeep()
    if Conf("Erro: Documento nao Encontrado. Localizar por Nome ?.")
        if BaixaPag( @cDocnr, @nRegistro )
            Pagamov->( DbGoTo( nRegistro ))
            AreaAnt( Arq_Ant, Ind_Ant )
            Return( .T. )
        endif
        Pagar->(Order( 2 ))
        dbSelectArea( "Pagamov" )
        Pagamov->(Order( 1 ))
        if ( ! .F. ) ; dbClearRelation() ; end ; dbSetRelation( "Pagar", {|| Pagamov->Codi}, "Pagamov->Codi", .F. )
    endif
    Pagamov->(DbGoTop())
    Pagamov->(Escolhe( 03, 00, 22, "Docnr + 'Ý' + Dtoc( Emis ) + 'Ý' + Dtoc( Vcto ) + 'Ý' + Tran( Vlr, '@E 999,999.99') + 'Ý' + Left( Pagar->Nome, 37 )", "DOCTO N§  EMISSAO  VCTO         VALOR  NOME DO FORNECEDOR"))
    cDocnr := Pagamov->Docnr
endif
AreaAnt( Arq_Ant, Ind_Ant )
Return( .T. )

Function BaixaPag( cDocnr, nRegistro )

LOCAL cScreen     := SaveScreen()
LOCAL GetList     := {}
LOCAL Arq_Ant     := Alias()
LOCAL Ind_Ant     := IndexOrd()
LOCAL nTam         := 0
LOCAL aDocnr     := {}
LOCAL aRegistro := {}
LOCAL aTodos     := {}
LOCAL cCodi      := Space(04)
LOCAL nChoice     := 0

oMenu:Limpa()
MaBox( 15, 10, 17, 78 )
SetCursor(1) ; DevPos( 16, 11 ) ; DevOut( "Fornecedor......: " ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cCodi, "cCodi", "9999", {|| Pagarrado( @cCodi,, Row(), Col()+1 )},))
ReadModal( GetList, NIL,,,,, ) ; GetList := {} ; ( GetList )
if LastKey() = 27
    AreaAnt( Arq_Ant, Ind_Ant )
    ResTela( cScreen )
    Return( .F. )
endif
dbSelectArea( "Pagamov" )
Pagamov->(Order( 3 ))
if Pagamov->(!DbSeek( cCodi ))
    ErrorBeep()
    Alerta( "Erro: Nenhum Debito em Aberto Deste fornecedor." )
    AreaAnt( Arq_Ant, Ind_Ant )
    ResTela( cScreen )
    Return( .F. )
endif
WHILE Pagamov->Codi = cCodi
    Aadd( aDocnr,      Pagamov->Docnr )
    Aadd( aRegistro, Pagamov->(Recno()))
    Aadd( aTodos,      Pagamov->Docnr + " " + Dtoc( Pagamov->Emis ) + " " + Dtoc( Pagamov->Vcto ) + " " + Tran( Pagamov->Vlr, "@E 999,999,999.99"))
    Pagamov->(DbSkip(1))
EndDo
nTam := Len( aTodos )
if nTam = 0
    ErrorBeep()
    Alerta( "Erro: Nenhum Debito em Aberto deste Fornecedor." )
    AreaAnt( Arq_Ant, Ind_Ant )
    ResTela( cScreen )
    Return( .F. )
endif
MaBox( 00, 10, 14, 53, "DOCTO  N§  EMISSAO   VENCTO          VALOR")
nChoice := aChoice( 01, 11, 13, 52, aTodos )
ResTela( cScreen )
if nChoice = 0
    AreaAnt( Arq_Ant, Ind_Ant )
    Alerta( "Erro: Procura Cancelada..." )
    ResTela( cScreen )
    Return( .F. )
endif
cDocnr     := aDocnr[ nChoice ]
nRegistro := aRegistro[ nChoice ]
AreaAnt( Arq_Ant, Ind_Ant )
ResTela( cScreen )
Return( .T. )

Function TestaTecla( nKey, oBrowse )

if      nKey == 5
    oBrowse:up()
Elseif nKey == 24
    oBrowse:down()
Elseif nKey == 19
    oBrowse:Left()
Elseif nKey == 4
    oBrowse:Right()
Elseif nKey == 1
    oBrowse:home()
Elseif nKey == 6
    oBrowse:end()
Elseif nKey == 18
    oBrowse:pageUp()
Elseif nKey == 3
    oBrowse:pageDown()
Elseif nKey == 31
    oBrowse:gotop()
Elseif nKey == 30
    oBrowse:goBottom()
Elseif nKey == 29
    oBrowse:panHome()
Elseif nKey == 23
    oBrowse:panEnd()
Elseif nKey == 26
    oBrowse:panLeft()
Elseif nKey == 2
    oBrowse:panRight()
endif
Return Nil

Function Vlr_Icms( porc_icms, vlr_compra, vlr_icms )

Vlr_Icms := ( Vlr_Compra * Porc_Icms ) / 100
Write( 07, 48, Str( Vlr_Icms, 13, 2 ) )
Return( .T. )

Function Desconto( nDesc, nTotal, nTot )

if LastKey() = 5
    nTot := nTotal
Else
    nTot := ( nTotal - nDesc )
endif
Return(.T.)

Function Mostra_Vlr( vlr_titu, vlr_mer )

if Vlr_titu < vlr_mer
    ErrorBeep()
    Alerta( "Erro: Valor da Fatura Menor que a Soma das Mercadorias " )
    Return( .F. )

endif
Return( .T. )

Function SomaData( d_Vcto, d_Emis, n_Conta)

d_Vcto := ( d_Emis + n_Conta )
Return( .T. )

Function DocFucer( cDocnr, lManutencao )

if Empty( cDocnr )
     ErrorBeep()
     Alerta( "Erro: Codigo Documento Invalido...")
     Return( .F. )
endif
if lManutencao = NIL
    if DbSeek( cDocnr )
        ErrorBeep()
        Alerta( "Erro: Documento Ja Registrado ..." )
        Return( .F. )
    endif
endif
Return( .T. )

Function CheqDoc( var )

LOCAL Arq_Ant := Alias()
LOCAL Ind_Ant := IndexOrd()
if ( Empty( Var ) )
    ErrorBeep()
    Nada("Erro: Numero Documento Invalido ...")
    Return( .F. )
endif
dbSelectArea( "CheMov" )
DbSetOrder( 1 )
if ( DbSeek( Var ) )
    ErrorBeep()
    Nada("Erro: Numero Documento Ja Registrado...")
    AreaAnt( Arq_Ant, Ind_Ant )
    Return( .F. )
endif
AreaAnt( Arq_Ant, Ind_Ant )
Return( .T. )


Function VisualEntraFatura( cDocnr, nVlrFatura, cCodi )

LOCAL cScreen     := SaveScreen()
LOCAL Arq_Ant     := Alias()
LOCAL Ind_Ant     := IndexOrd()
LOCAL nRegistro := 0

if LastKey() = 5
    Return( .T. )
endif

if ( Entradas->(DbGoTop()), Entradas->(Eof()))
    Nada()
    AreaAnt( Arq_Ant, Ind_Ant )
    ResTela( cScreen )
    Return(.F.)
endif
Pagar->(Order( 2))
dbSelectArea( "Entradas" )
Entradas->(Order( 2 ))
if ( Entradas->(Order( 2 )), Entradas->(!DbSeek( cDocnr )))
    ErrorBeep()
    if Conf("Erro: Documento nao Encontrado. Localizar por Fornecedor ?")
        if LocalizaEntrada( @cDocnr, @nRegistro )
            EntNota->( DbGoTo( nRegistro ))
            cDocnr := EntNota->Numero
        endif
    Else
        Pagar->(Order( 2))
        dbSelectArea( "EntNota" )
        if ( ! .F. ) ; dbClearRelation() ; end ; dbSetRelation( "Pagar", {|| EntNota->Codi}, "EntNota->Codi", .F. )
        EntNota->(Order( 3 ))
        Escolhe( 03, 01, 22, "Numero + 'Ý' + Pagar->Nome", "FATURA  NOME DO FORNECEDOR")
        EntNota->(DbClearRel())
        cDocnr := EntNota->Numero
    endif
    dbSelectArea( "Entradas" )
    Entradas->(Order( 2 ))
    if Entradas->(!( DbSeek( cDocnr ) ))
        ErrorBeep()
        Alerta( "Erro: Nenhum Produto Relacionado a este Documento.")
        AreaAnt( Arq_Ant, Ind_Ant )
        Return( .F. )
    endif
endif
if cCodi <> Nil
    if Entradas->Codi <> cCodi
        ErrorBeep()
        Alerta( "Erro: Fatura nao e deste Fornecedor.")
        AreaAnt( Arq_Ant, Ind_Ant )
        Return( .F. )
    endif
endif
if nVlrFatura <> Nil
    nVlrFatura := Entradas->VlrFatura
endif
AreaAnt( Arq_Ant, Ind_Ant )
Return( .T. )

Function VisualAchaFatura( cDocnr, nVlrFatura, cCodi )

LOCAL cScreen     := SaveScreen()
LOCAL Arq_Ant     := Alias()
LOCAL Ind_Ant     := IndexOrd()
LOCAL nRegistro := 0

if LastKey() = 5
    Return( .T. )
endif

if ( Saidas->(DbGoTop()), Saidas->(Eof()))
    Nada()
    AreaAnt( Arq_Ant, Ind_Ant )
    ResTela( cScreen )
    Return(.F.)
endif
Receber->(Order( 2))
dbSelectArea( "Saidas" )
Saidas->(Order( 3 ))
if ( Saidas->(Order( 3 )), Saidas->(!DbSeek( cDocnr )))
    ErrorBeep()
    if Conf("Erro: Documento nao Encontrado. Localizar por Nome ?.")
        if LocalizaFatura( @cDocnr, @nRegistro )
            Nota->( DbGoTo( nRegistro ))
            cDocnr := Nota->Numero
        endif
    Else
        Receber->(Order( 2))
        dbSelectArea( "Nota" )
        if ( ! .F. ) ; dbClearRelation() ; end ; dbSetRelation( "Receber", {|| Nota->Codi}, "Nota->Codi", .F. )
        Nota->(Order( 1 ))
        Escolhe( 03, 01, 22, "Numero + 'Ý' + Receber->Nome+ 'Ý' + Situacao + 'Ý' + Caixa", "FATURA  NOME DO CLIENTE                         SITUACAO USER")
        Nota->(DbClearRel())
        cDocnr := Nota->Numero
    endif
    dbSelectArea( "Saidas" )
    Saidas->(Order( 3 ))
    if Saidas->(!( DbSeek( cDocnr ) ))
        ErrorBeep()
        Alerta( "Erro: Nenhum Produto Relacionado a este Documento.")
        AreaAnt( Arq_Ant, Ind_Ant )
        Return( .F. )
    endif
endif
if cCodi <> Nil
    if Saidas->Codi <> cCodi
        ErrorBeep()
        Alerta( "Erro: Fatura nao e deste cliente...")
        AreaAnt( Arq_Ant, Ind_Ant )
        Return( .F. )
    endif
endif
if nVlrFatura <> Nil
    nVlrFatura := Saidas->VlrFatura
endif
AreaAnt( Arq_Ant, Ind_Ant )
Return( .T. )

Function LocalizaFatura( cDocnr, nRegistro )

LOCAL cScreen     := SaveScreen()
LOCAL GetList     := {}
LOCAL Arq_Ant     := Alias()
LOCAL Ind_Ant     := IndexOrd()
LOCAL nTam         := 0
LOCAL aDocnr     := {}
LOCAL aRegistro := {}
LOCAL aTodos     := {}
LOCAL cCodi      := Space(05)
LOCAL cNumero     := ""
LOCAL cEmissao  := ""
LOCAL cDevol     := ""
LOCAL cUser      := ""
LOCAL cVlr         := ""
LOCAL cSituacao := Space(08)
LOCAL nChoice     := 0
LOCAL nConta     := 0
LOCAL cTela

oMenu:Limpa()
MaBox( 15, 10, 18, 78 )
Write( 17, 28, ltrim(rtrim(ValToStr(nConta))))
SetCursor(1) ; DevPos( 16, 11 ) ; DevOut( "Codigo Cliente: " ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cCodi, "cCodi", "99999", {|| RecErrado( @cCodi,, Row(), Col()+1 )},))
DevPos( 17, 11 ) ; DevOut( "Registro Add #: " )
ReadModal( GetList, NIL,,,,, ) ; GetList := {} ; ( GetList )
if LastKey() = 27
    AreaAnt( Arq_Ant, Ind_Ant )
    ResTela( cScreen )
    Return( .F. )
endif
Nota->(Order( 2 ))
if Nota->(!DbSeek( cCodi ))
    ErrorBeep()
    Alerta( "Erro: Nenhuma Fatura Deste Cliente." )
    AreaAnt( Arq_Ant, Ind_Ant )
    ResTela( cScreen )
    Return( .F. )
endif
Saidas->(Order( 3 ))
Nota->(Order( 2 ))
WHILE Nota->Codi = cCodi .OR. LastKey() = 27
    cNumero     := Nota->Numero
    cDevol     := Space(12)
    cUser      := Space(04)
    cSituacao := Space(08)
    cEmissao  := ""
    cVlr         := ""
    nConta++
    Write( 17, 28, ltrim(rtrim(ValToStr(nConta))))
    if Saidas->(DbSeek( cNumero ))
        cEmissao  := Dtoc( Saidas->Data )
        cDevol     := "em " + Dtoc( Saidas->Atualizado )
        cVlr         := Tran( Saidas->VlrFatura, "@E 999,999,999.99")
        cSituacao := Saidas->Situacao
        cUser      := Saidas->Caixa
    endif
    Aadd( aDocnr, cNumero )
    Aadd( aRegistro, Nota->(Recno()))
    Aadd( aTodos, cNumero + "   " + cEmissao + " " + cVlr + " " + cSituacao + " " + cDevol + " " + cUser)
    Nota->(DbSkip(1))
    if nConta >= 65535
        ErrorBeep()
        Alerta("Erro: M ximo 65535 registros por cliente. Use individual.")
        Exit
    endif
EndDo
nTam := Len( aTodos )
if nTam = 0
    ErrorBeep()
    Alerta( "Erro: Nenhuma Fatura Deste Cliente." )
    AreaAnt( Arq_Ant, Ind_Ant )
    ResTela( cScreen )
    Return( .F. )
endif
MaBox( 00, 10, 14, 70,"FATURA N§  EMISSAO          VALOR SITUACAO ALTER/EXCLU USER")
nChoice := aChoice( 01, 11, 13, 69, aTodos )
ResTela( cScreen )
if nChoice = 0
    AreaAnt( Arq_Ant, Ind_Ant )
    ResTela( cScreen )
    Return( .F. )
endif
cDocnr     := aDocnr[ nChoice ]
nRegistro := aRegistro[ nChoice ]
AreaAnt( Arq_Ant, Ind_Ant )
ResTela( cScreen )
Return( .T. )

Function LocalizaEntrada( cDocnr, nRegistro )

LOCAL cScreen     := SaveScreen()
LOCAL GetList     := {}
LOCAL Arq_Ant     := Alias()
LOCAL Ind_Ant     := IndexOrd()
LOCAL nTam         := 0
LOCAL aDocnr     := {}
LOCAL aRegistro := {}
LOCAL aTodos     := {}
LOCAL cCodi      := Space(04)
LOCAL cNumero     := ""
LOCAL cEmissao  := ""
LOCAL cVlr         := ""
LOCAL nChoice     := 0

oMenu:Limpa()
MaBox( 15, 10, 17, 78 )
SetCursor(1) ; DevPos( 16, 11 ) ; DevOut( "Id Fornecedor...: " ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cCodi, "cCodi", "9999", {|| Pagarrado( @cCodi, Row(), Col()+1 )},))
ReadModal( GetList, NIL,,,,, ) ; GetList := {} ; ( GetList )
if LastKey() = 27
    AreaAnt( Arq_Ant, Ind_Ant )
    ResTela( cScreen )
    Return( .F. )
endif
dbSelectArea( "EntNota" )
EntNota->(Order( 2 ))
if EntNota->(!DbSeek( cCodi ))
    ErrorBeep()
    Alerta( "Erro: Nenhuma Fatura Deste Fornecedor." )
    AreaAnt( Arq_Ant, Ind_Ant )
    ResTela( cScreen )
    Return( .F. )
endif
Entradas->(Order( 2 ))
WHILE EntNota->Codi = cCodi
    cNumero        := EntNota->Numero
    if Entradas->(DbSeek( cNumero ))
        cEmissao := Dtoc( Entradas->Data )
        cVlr        := Tran( Entradas->VlrFatura, "@E 999,999,999.99")
    Else
        cEmissao := ""
        cVlr        := ""
    endif
    Aadd( aDocnr, cNumero )
    Aadd( aRegistro, EntNota->(Recno()))
    Aadd( aTodos, cNumero + "   " + cEmissao + " " + cVlr )
    EntNota->(DbSkip(1))
EndDo
nTam := Len( aTodos )
if nTam = 0
    ErrorBeep()
    Alerta( "Erro: Nenhuma Fatura Deste Fornecedor." )
    AreaAnt( Arq_Ant, Ind_Ant )
    ResTela( cScreen )
    Return( .F. )
endif
MaBox( 00, 10, 14, 44,"FATURA N§  EMISSAO          VALOR")
nChoice := aChoice( 01, 11, 13, 43, aTodos )
ResTela( cScreen )
if nChoice = 0
    AreaAnt( Arq_Ant, Ind_Ant )
    ResTela( cScreen )
    Return( .F. )
endif
cDocnr     := aDocnr[ nChoice ]
nRegistro := aRegistro[ nChoice ]
AreaAnt( Arq_Ant, Ind_Ant )
ResTela( cScreen )
Return( .T. )

Function RecCerto( cCodi, lAlteracao, cSwap )

LOCAL Arq_Ant      := Alias()
LOCAL Ind_Ant      := IndexOrd()
LOCAL lModificar := IF( lAlteracao <> NIL .AND. lAlteracao, .T., .F. )
LOCAL nFieldLen  := Len( Receber->Codi )
LOCAL cFilial

if lModificar
    if cCodi == cSwap
        Return( .T. )
    endif
endif

if LastKey() = 5
    Return( .T. )
endif
if Empty( cCodi ) .OR. Len(ltrim(rtrim(cCodi))) < 5
    ErrorBeep()
    Alerta("Erro: Codigo Cliente Invalido.")
    Return( .F. )
endif
dbSelectArea( "Receber" )
Receber->(Order( 2 ))
if Receber->( DbSeek( cCodi ))
    ErrorBeep()
    Alerta("Erro: Codigo de Cliente Ja Registrado.")
    cCodi := ProxCli( @cCodi )
    AreaAnt( Arq_Ant, Ind_Ant )
    Return( .F. )
endif
AreaAnt( Arq_Ant, Ind_Ant )
Return( .T. )

Function ProxCli( cCodi )

LOCAL Arq_Ant      := Alias()
LOCAL Ind_Ant      := IndexOrd()
LOCAL nFieldLen  := Len( Receber->Codi )

Receber->(Order( 2 ))
While Receber->(DbSeek( cCodi ))
    cCodi := StrZero( Val( Right( cCodi, nFieldLen )) + 1, nFieldLen )
    Receber->(DbSkip(1))
EndDO
AreaAnt( Arq_Ant, Ind_Ant )
Return( cCodi )

Function Complet2( Mcep, Mcida, Mesta )

if LastKey() = 5
    Return(.T.)
endif
if Mcep    = "76970-000"
    Mcida = "PIMENTA BUENO"
    Mesta = "RO"
    __Keyboard( Chr( 13 ) + Chr( 13 ) )
endif
Return( .T. )


Function RegiaoErrada( cRegiao, nRow, nCol )

LOCAL aRotina := {{|| RegiaoInclusao() }}
LOCAL Ind_Ant := IndexOrd()
LOCAL Arq_Ant := Alias()

dbSelectArea( "Regiao" )
Regiao->(Order( 1 ))
if (Lastrec() = 0 )
    ErrorBeep()
    if Conf(" Pergunta: Nenhuma Regiao Disponivel... Registrar ?")
        RegiaoInclusao()
    endif
    AreaAnt( Arq_Ant, Ind_Ant )
    Return( .F. )
endif
if !DbSeek( cRegiao)
    Regiao->(Order( 2 ))
    Escolhe( 03, 01, 22,"Regiao + 'Ý' + Nome", "COD NOME DA REGIAO", aRotina )
    cRegiao := Regiao->Regiao
endif
if nRow <> NIL
    Write( nRow, nCol, Regiao->Nome )
endif
AreaAnt( Arq_Ant, Ind_Ant )
Return( .T. )

Proc RegiaoInclusao()

LOCAL GetList := {}
LOCAL cScreen := SaveScreen()
LOCAL cRegiao
LOCAL cNome
LOCAL lSair
LOCAL nOpcao
FIELD Regiao
FIELD Nome

dbSelectArea( "Regiao" )
WHILE .T.
    oMenu:Limpa()
    cRegiao := Space(02)
    cNome   := Space(40)
    Regiao->(Order( 1 ))
    Regiao->(DbGoBottom())
    cRegiao := Regiao->(StrZero( Val( Regiao)+1, 2))
    lSair   := .F.
    WHILE .T.
        MaBox( 06, 02 , 09 , 78, "INCLUSAO DE REGIOES" )
        SetCursor(1) ; DevPos( 07, 03 ) ; DevOut( "Codigo..:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cRegiao, "cRegiao", "99", {|| RegiaoCerta( @cRegiao )},))
        SetCursor(1) ; DevPos( Row()+1, 03 ) ; DevOut( "Nome....:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cNome, "cNome", "@!",,))
        ReadModal( GetList, NIL,,,,, ) ; GetList := {} ; ( GetList )
        if LastKey() = 27
            lSair := .T.
            Exit

        endif
        nOpcao := Alerta("Pergunta: Voce Deseja ? ", {" Incluir", " Alterar ", "Sair "})
        if nOpcao = 1
            if Regiao->(Incluiu())
                Regiao->Regiao := cRegiao
                Regiao->Nome    := cNome
                Regiao->(Libera())
                Exit
            endif

        Elseif nOpcao = 2
            Loop

        Elseif nOpcao = 3
            lSair := .T.
            Exit

        endif

    EndDo
    if lSair
        ResTela( cScreen )
        Exit

    endif
EndDo

Proc CmInclusao( lAlteracao )

LOCAL GetList        := {}
LOCAL cScreen        := SaveScreen()
LOCAL lModificar    := .F.
LOCAL nOpcao        := 0
LOCAL dInicio
LOCAL dFim
LOCAL nIndice
LOCAL cString
LOCAL cObs
LOCAL cSwap
LOCAL lSair

if lAlteracao <> NIL .AND. lAlteracao
    lModificar := .T.
endif

if !lModificar
    if !PodeIncluir()
        ResTela( cSCreen )
        Return
    endif
endif

dbSelectArea( "CM" )
Cm->(Order( 1 ))
WHILE .T.
    oMenu:Limpa()
    if lModificar
        dInicio     := Cm->Inicio
        dFim         := Cm->Fim
        nIndice     := Cm->Indice
        cObs         := Cm->Obs
        cString     := "ALTERACAO DE CORRECAO MONETARIA"
    Else
        Cm->(Order( 0 ))
        Cm->(DbGoBottom())
        dInicio     := Cm->Fim + 1
        dFim         := dInicio + 29
        nIndice     := 0
        cObs         := Space(40)
        cString     := "INCLUSAO DE CORRECAO MONETARIA"
    endif
    cSwap := dInicio
    lSair := .F.
    WHILE .T.
        MaBox( 06, 02, 11, 78, cString )
        SetCursor(1) ; DevPos( 07, 03 ) ; DevOut( "Data Inicial.:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( dInicio, "dInicio", "##/##/##", {|| CmCerto( @dInicio, lModificar, cSwap )},))
        SetCursor(1) ; DevPos( Row()+1, 03 ) ; DevOut( "Data Final...:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( dFim, "dFim", "##/##/##",,))
        SetCursor(1) ; DevPos( Row()+1, 03 ) ; DevOut( "Indice.......:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( nIndice, "nIndice", "9999.9999",,))
        SetCursor(1) ; DevPos( Row()+1, 03 ) ; DevOut( "Observacao...:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cObs, "cObs", "@!",,))
        ReadModal( GetList, NIL,,,,, ) ; GetList := {} ; ( GetList )
        if LastKey() = 27
            lSair := .T.
            Exit
        endif
        if lModificar
            nOpcao := Alerta("Pergunta: Voce Deseja ? ", {" Alterar", " Cancelar ", "Sair "})
        Else
            nOpcao := Alerta("Pergunta: Voce Deseja ? ", {" Incluir", " Alterar ", "Sair "})
        endif
        if nOpcao = 1
            if lModificar
                if Cm->(TravaReg())
                    Cm->Inicio     := dInicio
                    Cm->Fim         := dFim
                    Cm->Indice     := nIndice
                    Cm->Obs         := cObs
                    Cm->(Libera())
                    lSair := .T.
                    Exit
                endif
            Else
                if Cm->(Incluiu())
                    Cm->Inicio     := dInicio
                    Cm->Fim         := dFim
                    Cm->Indice     := nIndice
                    Cm->Obs         := cObs
                    Cm->(Libera())
                    Exit
                endif
            endif

        Elseif nOpcao = 2
            Loop

        Elseif nOpcao = 3
            lSair := .T.
            Exit

        endif
    EndDo
    if lSair
        ResTela( cScreen )
        Exit

    endif
EndDo

Function CmCerto( dInicio, lModificar, cSwap )

FIELD Inicio, Fim

if LastKey() = 5
    Return( .T. )
endif

if lModificar <> NIL .AND. lModificar
    if dInicio == cSwap
        Return( .T. )
    endif
endif

if Empty( dInicio )
    ErrorBeep()
    Alerta("Erro: Entrada de Data Invalida.")
    Return( .F. )
endif
Cm->(Order( 1 ))
if Cm->(DbSeek( dInicio ))
    ErrorBeep()
    Alerta("Erro: Indice de CM Ja Registrado. ")
    Return( .F. )
endif
Return( .T. )

Proc CepInclusao( lAlteracao )

LOCAL GetList        := {}
LOCAL cScreen        := SaveScreen()
LOCAL lModificar    := .F.
LOCAL nOpcao        := 0
LOCAL cCep
LOCAL cCida
LOCAL cBair
LOCAL cEsta
LOCAL cString
LOCAL cSwap
LOCAL lSair

if lAlteracao <> NIL .AND. lAlteracao
    lModificar := .T.
endif

if !lModificar
    if !PodeIncluir()
        ResTela( cSCreen )
        Return
    endif
endif

dbSelectArea( "Cep" )
Cep->(Order( 1 ))
WHILE .T.
    oMenu:Limpa()
    if lModificar
        cCep         := Cep->Cep
        cCida      := Cep->Cida
        cBair      := Cep->Bair
        cEsta      := Cep->Esta
        cString     := "ALTERACAO DE CEP"
    Else
        cCep         := Space(09)
        cCida      := Space(25)
        cBair      := Space(25 )
        cEsta      := Space(02)
        cString := "INCLUSAO DE NOVO CEP"
    endif
    cSwap := cCep
    lSair := .F.
    WHILE .T.
        MaBox( 06, 02, 11, 78, cString )
        SetCursor(1) ; DevPos( 07, 03 ) ; DevOut( "Novo Cep....:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cCep, "cCep", "99999-999", {|| CepCerto( @cCep, lModificar, cSwap )},))
        SetCursor(1) ; DevPos( Row()+1, 03 ) ; DevOut( "Cidade......:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cCida, "cCida", "@!",,))
        SetCursor(1) ; DevPos( Row()+1, 03 ) ; DevOut( "Bairro......:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cBair, "cBair", "@!",,))
        SetCursor(1) ; DevPos( Row()+1, 03 ) ; DevOut( "Estado......:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cEsta, "cEsta", "@!",,))
        ReadModal( GetList, NIL,,,,, ) ; GetList := {} ; ( GetList )
        if LastKey() = 27
            lSair := .T.
            Exit
        endif
        if lModificar
            nOpcao := Alerta("Pergunta: Voce Deseja ? ", {" Alterar", " Cancelar ", "Sair "})
        Else
            nOpcao := Alerta("Pergunta: Voce Deseja ? ", {" Incluir", " Alterar ", "Sair "})
        endif
        if nOpcao = 1
            if lModificar
                if Cep->(TravaReg())
                    Cep->Cep       := cCep
                    Cep->Cida      := cCida
                    Cep->Bair      := cBair
                    Cep->Esta      := cEsta
                    Cep->(Libera())
                    lSair := .T.
                    Exit
                endif
            Else
                if Cep->(Incluiu())
                    Cep->Cep       := cCep
                    Cep->Cida      := cCida
                    Cep->Bair      := cBair
                    Cep->Esta      := cEsta
                    Cep->(Libera())
                    Exit
                endif
            endif

        Elseif nOpcao = 2
            Loop

        Elseif nOpcao = 3
            lSair := .T.
            Exit

        endif
    EndDo
    if lSair
        ResTela( cScreen )
        Exit

    endif
EndDo

Function RegiaoCerta( cRegiao )

FIELD Nome

if LastKey() = 5
    Return( .T. )
endif
if Empty( cRegiao )
    ErrorBeep()
    Alerta("Erro: Codigo Regiao Invalida ....")
    Return( .F. )

endif
Regiao->(Order( 1 ))
if Regiao->(DbSeek( cRegiao))
    ErrorBeep()
    Alerta("Erro: Regiao Ja Registrada... ;" + Regiao->(ltrim(rtrim(Nome))))
    cRegiao := StrZero( Val( cRegiao ) + 1, 2 )
    Return( .F. )

endif
Return( .T. )

Function SubErrado( cSubGrupo, nRow, nCol )

LOCAL aRotina := {{||Lista1_2() }}
LOCAL Arq_Ant := Alias()
LOCAL Ind_Ant := IndexOrd()

dbSelectArea( "SubGrupo" )
SubGrupo->(Order( 1 ))
if SubGrupo->(!DbSeek( cSubGrupo ))
    SubGrupo->(Escolhe( 03, 01, 22, "CodsGrupo + 'Ý' + DessGrupo", "COD DESCRICAO DO SUBGRUPO", aRotina ))
    cSubGrupo := SubGrupo->CodsGrupo
endif
if nRow <> NIL
    Write( nRow, nCol, SubGrupo->DesSGrupo )
endif
AreaAnt( Arq_Ant, Ind_Ant )
Return( .T. )

Function GrupoErrado( cGrupo, nRow, nCol )

LOCAL aRotina := {{||Lista1_1() }}
LOCAL Arq_Ant := Alias()
LOCAL Ind_Ant := IndexOrd()

dbSelectArea( "Grupo" )
Grupo->(Order( 1 ))
if Grupo->( !DbSeek( cGrupo ))
    Grupo->(Order( 2 ))
    Grupo->(Escolhe( 03, 01, 22, "CodGrupo + 'Ý' + DesGrupo", "COD DESCRICAO DO GRUPO", aRotina ))
    cGrupo := Grupo->CodGrupo
endif
if nRow <> NIL
    Write( nRow, nCol, Grupo->DesGrupo )
endif
AreaAnt( Arq_Ant, Ind_Ant )
Return( .T. )

Proc Lista1_1()

LOCAL cScreen    := SaveScreen()
LOCAL GetList    := {}
LOCAL Arq_Ant    := Alias()
LOCAL Ind_Ant    := IndexOrd()
LOCAL bSetKey    := SetKey( -1 )
LOCAL cServico := Space(01)
LOCAL cDescricao
LOCAL cCodigo

SetKey(-1, NIL )
WHILE .T.
    dbSelectArea( "Grupo" )
    Grupo->(Order( 1 ))
    oMenu:Limpa()
    cDescricao := Space( Len( Grupo->Desgrupo ))
    cServico   := Space(01)
    Grupo->(DbGoBoTTom())
    cCodigo      := StrZero( Val( Grupo->Codgrupo )+1,3)
    MaBox( 05, 01, 09, 55, "INCLUSAO DE GRUPOS")
    SetCursor(1) ; DevPos( 06, 02 ) ; DevOut( "Grupo.....: " ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cCodigo, "cCodigo", "999", {|| Grupo( @cCodigo )},))
    SetCursor(1) ; DevPos( 07, 02 ) ; DevOut( "Descricao.: " ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cDescricao, "cDescricao", "@!",,))
    SetCursor(1) ; DevPos( 08, 02 ) ; DevOut( "Servicos..: " ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cServico, "cServico", "!", {|| PickServico( @cServico )},))
    ReadModal( GetList, NIL,,,,, ) ; GetList := {} ; ( GetList )
    if LastKey() = 27
        Exit
    endif
    ErrorBeep()
    if Conf("Pergunta: Confirma Inclusao do Grupo ?")
        if Grupo( cCodigo )
            if Grupo->(Incluiu())
                Grupo->Codgrupo    := cCodigo
                Grupo->Desgrupo    := cDescricao
                Grupo->Atualizado := Date()
                Grupo->Servico     := IF( cServico = "S", .T., .F. )
                Grupo->(Libera())
            endif
        endif
    endif
EndDo
SetKey( -1, bSetKey )
AreaAnt( Arq_Ant, Ind_Ant )
ResTela( cScreen )

Function PickServico( cServico )

LOCAL aList      := { "Grupo de Produtos", "Grupo de Servicos"}
LOCAL aSituacao := { "P", "S" }
LOCAL cScreen := SaveScreen()
LOCAL nChoice
if cServico $ aSituacao[1] .OR. cServico $ aSituacao[2]
    Return( .T. )
Else
    MaBox( 11, 01, 14, 44, NIL, NIL, Roloc( Cor()) )
    if (nChoice := AChoice( 12, 02, 13, 43, aList )) <> 0
        cServico := aSituacao[ nChoice ]
    endif
endif
ResTela( cScreen )
Return( .T. )

Proc Lista1_2()

LOCAL cScreen := SaveScreen()
LOCAL GetList := {}
LOCAL Arq_Ant := Alias()
LOCAL Ind_Ant := IndexOrd()
LOCAL bSetKey := SetKey( -2 )
LOCAL cGrupo  := Space(03)
LOCAL cCodigo
LOCAL cDescricao

SetKey( -2, NIL )
WHILE .T.
    dbSelectArea( "SubGrupo" )
    SubGrupo->(Order( 1 ))
    oMenu:Limpa()
    MaBox( 05, 01, 08, 55, "INCLUSAO DE SUB-GRUPOS")
    SubGrupo->(DbGoBoTTom())
    cDescricao := Space( Len( SubGrupo->DessGrupo ) )
    cGrupo      := Left( SubGrupo->CodsGrupo, 3 )
    cGrupo      := IF( Empty( cGrupo ), "001", cGrupo )
    cCodigo      := cGrupo + "." + StrZero( Val( Right( SubGrupo->CodSgrupo,2))+1, 2)
    SetCursor(1) ; DevPos( 06, 02 ) ; DevOut( "SubGrupo..¯ " ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cCodigo, "cCodigo", "999.99", {|| Sgrupo( cCodigo )},))
    SetCursor(1) ; DevPos( 07, 02 ) ; DevOut( "Descricao.¯ " ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cDescricao, "cDescricao", "@!",,))
    ReadModal( GetList, NIL,,,,, ) ; GetList := {} ; ( GetList )
    if LastKey() = 27
        Exit
    endif
    ErrorBeep()
    if Conf("Pergunta: Confirma Inclusao do SubGrupo ?")
        if Sgrupo( cCodigo )
            if SubGrupo->(Incluiu())
                SubGrupo->CodSgrupo    := cCodigo
                SubGrupo->DesSgrupo    := cDescricao
                SubGrupo->Atualizado := Date()
                SubGrupo->(Libera())
            endif
        endif
    endif
EndDo
SetKey( -2, bSetKey )
AreaAnt( Arq_Ant, Ind_Ant )
ResTela( cScreen )

Function Grupo( Var )

if Empty( Var ) .OR. Len(ltrim(rtrim(Var))) < 3
    ErrorBeep()
    Alerta("Erro: Codigo Grupo Invalido... ")
    Return(.F.)
endif
Grupo->( Order( 1 ))
Grupo->( DbGoTop() )
if Grupo->( DbSeek( var ) )
    ErrorBeep()
    Alerta("Erro: Grupo Ja Registrado... ;" + ltrim(rtrim(Grupo->DesGrupo)))
    Var := StrZero( Val( Var ) +1, 3 )
    Return( .F. )
endif
Return( .T. )

Function SGrupo( cGrupo )

LOCAL cScreen := SaveScreen()

if Empty( cGrupo )
    ErrorBeep()
    Alerta( "Erro: Codigo SubGrupo Invalido... ")
    Return( .F. )
endif
Grupo->( Order( 1 ))
if !Grupo->( DbSeek( Left( cGrupo, 3 )))
    ErrorBeep()
    if Conf( "Pergunta: Grupo Nao Registrado... Registrar ? ")
        Lista1_1()
    endif
    ResTela( cScreen )
    SubGrupo->( DbGoTop() )
    Return( .F. )
endif
if SubGrupo->(DbSeek( cGrupo ) )
    ErrorBeep()
    Alerta( "Erro: SubGrupo Ja Registrado...;" + ltrim(rtrim(SubGrupo->DesSgrupo)))
    Return( .F. )
endif
Return( .T. )

Proc ForInclusao( lAlteracao )

LOCAL GetList     := {}
LOCAL cScreen     := SaveScreen( )
LOCAL nRegistro := 0
LOCAL cCodi
LOCAL cNome
LOCAL cFanta
LOCAL dData
LOCAL cCpf
LOCAL cFone
LOCAL cFax
LOCAL cRg1
LOCAL cEnde
LOCAL cBair
LOCAL cCgc
LOCAL cCon
LOCAL cCida
LOCAL cEsta
LOCAL cCep
LOCAL cIns
LOCAL cCaixa
LOCAL cObs
LOCAL cSigla
LOCAL lModificar := .F.
LOCAL cString
LOCAL cSwap
LOCAL cRg
LOCAL cInsc
LOCAL lSair
LOCAL nOpcao

FIELD Codi
FIELD Nome
FIELD Fanta
FIELD Data
FIELD Cpf
FIELD Fone
FIELD Fax
FIELD Rg1
FIELD Ende
FIELD Bair
FIELD Cgc
FIELD Con
FIELD Cida
FIELD Esta
FIELD Cep
FIELD Ins
FIELD Caixa
FIELD Obs
FIELD Sigla

if lAlteracao <> NIL
    if lAlteracao = .T.
        lModificar := .T.
    endif
endif

dbSelectArea( "Pagar" )
Pagar->(Order( 2 ))
WHILE .T.
    oMenu:Limpa()
    cNome  := IF( lModificar, Pagar->Nome,       Space(40))
    cFanta := IF( lModificar, Pagar->Fanta,      Space(40))
    cSigla := IF( lModificar, Pagar->Sigla,      Space(10))
    cCpf     := IF( lModificar, Pagar->Cpf,          Space(14))
    cFone  := IF( lModificar, Pagar->Fone,       Space(14))
    cFax     := IF( lModificar, Pagar->Fax,          Space(14))
    cRg     := IF( lModificar, Pagar->Rg,          Space(18))
    cCgc     := IF( lModificar, Pagar->Cgc,          Space(18))
    cEnde  := IF( lModificar, Pagar->Ende,       Space(30))
    cObs     := IF( lModificar, Pagar->Obs,          Space(30))
    cBair  := IF( lModificar, Pagar->Bair,       Space(20))
    cCon     := IF( lModificar, Pagar->Con,          Space(20))
    cCida  := IF( lModificar, Pagar->Cida,       Space(25))
    cEsta  := IF( lModificar, Pagar->Esta,       Space(02))
    cCep     := IF( lModificar, Pagar->Cep,          Space(09))
    cInsc  := IF( lModificar, Pagar->Insc,       Space(15))
    cCaixa := IF( lModificar, Pagar->Caixa,      Space(03))
    dData  := IF( lModificar, Pagar->Data,       Date())
                 IF( lModificar,, Pagar->(DbGoBottom()))
    cCodi   := IF( lModificar, Pagar->Codi, Pagar->(StrZero(Val( Codi )+1, 4)))
    cString := IF( lModificar, "ALTERACAO DE FORNECEDORES", "INCLUSAO DE NOVOS FORNECEDORES")
    cSwap      := cCodi
    lSair      := .F.
    nRegistro := Pagar->(Recno())
    WHILE .T.
        MaBox( 06 , 02 , 21 , 78, cString )
        SetCursor(1) ; DevPos( 07, 03 ) ; DevOut( "Codigo......:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cCodi, "cCodi", "9999", {|| PagCerto( @cCodi, lModificar, cSwap )},))
        SetCursor(1) ; DevPos( Row()+1, 03 ) ; DevOut( "Data........:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( dData, "dData", "##/##/##",,))
        SetCursor(1) ; DevPos( Row()+1, 03 ) ; DevOut( "R. Social...:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cNome, "cNome", "@!", {|| !Empty(cNome) .OR. LastKey() = 5},))
        SetCursor(1) ; DevPos( Row()+1, 03 ) ; DevOut( "Sigla.......:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cSigla, "cSigla", "@!", {|| !Empty(cSigla) .OR. LastKey() = 5},))
        SetCursor(1) ; DevPos( Row()+1, 03 ) ; DevOut( "Fantasia....:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cFanta, "cFanta", "@!",,))
        SetCursor(1) ; DevPos( Row()+1, 03 ) ; DevOut( "CGC/MF......:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cCgc, "cCgc", "99.999.999/9999-99",,))
        SetCursor(1) ; DevPos( Row()+1, 03 ) ; DevOut( "Inscri‡ao...:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cInsc, "cInsc", "@!",,))
        SetCursor(1) ; DevPos( Row()+1, 03 ) ; DevOut( "CPF.........:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cCpf, "cCpf", "999.999.999-99", {|| TestaCpf( cCpf )},))
        SetCursor(1) ; DevPos( Row()+1, 03 ) ; DevOut( "Rg..........:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cRg, "cRg", "@!",,))
        SetCursor(1) ; DevPos( Row()+1, 03 ) ; DevOut( "Endere‡o....:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cEnde, "cEnde", "@!",,))
        SetCursor(1) ; DevPos( Row()+1, 03 ) ; DevOut( "CEP.........:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cCep, "cCep", "99999-999", {|| CepErrado( @cCep, @cCida, @cEsta, @cBair )},))
        SetCursor(1) ; DevPos( Row()+1, 03 ) ; DevOut( "Cidade......:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cCida, "cCida", "@!",,))
        SetCursor(1) ; DevPos( Row()+1, 03 ) ; DevOut( "Bairro......:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cBair, "cBair", "@!",,))
        SetCursor(1) ; DevPos( Row()+1, 03 ) ; DevOut( "Estado......:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cEsta, "cEsta", "@!",,))
        ReadModal( GetList, NIL,,,,, ) ; GetList := {} ; ( GetList )
        if LastKey() = 27
            lSair := .T.
            Exit
        endif
        Scroll( 07, 03, 20, 77, 14 )
        SetCursor(1) ; DevPos( 07, 03 ) ; DevOut( "Telefone....:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cFone, "cFone", "(##)#####-####",,))
        SetCursor(1) ; DevPos( Row()+1, 03 ) ; DevOut( "Fax.........:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cFax, "cFax", "(##)#####-####",,))
        SetCursor(1) ; DevPos( Row()+1, 03 ) ; DevOut( "Cx Postal...:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cCaixa, "cCaixa", "999",,))
        SetCursor(1) ; DevPos( Row()+1, 03 ) ; DevOut( "Contato.... :" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cCon, "cCon", "@!",,))
        SetCursor(1) ; DevPos( Row()+1, 03 ) ; DevOut( "Obs.........:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cObs, "cObs", "@!",,))
        ReadModal( GetList, NIL,,,,, ) ; GetList := {} ; ( GetList )
        if LastKey() = 27
            lSair := .T.
            Exit
        endif
        ErrorBeep()
        if lModificar
            nOpcao := Alerta(" Pergunta: Voce Deseja ? ", {" Alterar", " Cancelar ", "Sair "})
        Else
            nOpcao := Alerta(" Pergunta: Voce Deseja ? ", {" Incluir", " Alterar ", "Sair "})
        endif
        if nOpcao = 1
            if lModificar
                Pagar->(DbGoTo( nRegistro ))
                if !Pagar->(TravaReg())               ; Loop ; endif
            Else
                if !PagCerto( @cCodi, lModificar ) ; Loop ; endif
                if !Pagar->(Incluiu())                  ; Loop ; endif
            endif
            Pagar->Codi  := cCodi
            Pagar->Data  := dData
            Pagar->Nome  := cNome
            Pagar->Rg     := cRg
            Pagar->Ende  := cEnde
            Pagar->Bair  := cBair
            Pagar->Cida  := cCida
            Pagar->Con     := cCon
            Pagar->Obs     := cObs
            Pagar->Cpf     := cCpf
            Pagar->Esta  := cEsta
            Pagar->Cep     := cCep
            Pagar->Fone  := cFone
            Pagar->Cgc     := cCgc
            Pagar->Insc  := cInsc
            Pagar->Fanta := cFanta
            Pagar->Fax     := cFax
            Pagar->Caixa := cCaixa
            Pagar->Sigla := cSigla
            Pagar->(Libera())
            if lModificar
                lSair := .T.
            endif
            Exit

        Elseif nOpcao = 2
            Loop
        Elseif nOpcao = 3
            lSair := .T.
            Exit
        endif
    EndDo
    if lSair
        ResTela( cScreen )
        Exit
    endif
EndDo

Function CodiCerto( cCodigo, lAlteracao, cSwap )

LOCAL cScreen      := SaveScreen()
LOCAL Arq_Ant      := Alias()
LOCAL Ind_Ant      := IndexOrd()
LOCAL lModificar := IF( lAlteracao <> NIL .AND. lAlteracao, .T., .F. )

if lModificar
    if cCodigo == cSwap
        Return( .T. )
    endif
endif
if LastKey() = 5
    Return( .T. )
endif
if Len(ltrim(rtrim(cCodigo))) < 6 .OR. Empty( cCodigo )
    ErrorBeep()
    Alerta("Erro: Codigo Produto Invalido.")
    Return( .F. )
endif
Lista->(Order( 2 ))
if Lista->(DbSeek( cCodigo ))
    ErrorBeep()
    Alerta("Erro: Codigo de Produto Existente.")
    Lista->(DbGoBottom())
    cCodigo := ProxCodigo( Lista->Codigo )
    AreaAnt( Arq_Ant, Ind_Ant )
    Return( .F. )
endif
AreaAnt( Arq_Ant, Ind_Ant )
Return( .T. )

Function GrupoCerto( cGrupo, nCol, nLinha )

LOCAL oInclusao  := {{|| Lista1_1() }}
LOCAL oAlteracao := {{|| GrupoDbEdit() }}
LOCAL cScreen      := SaveScreen()
LOCAL Arq_Ant      := Alias()
LOCAL Ind_Ant      := IndexOrd()

if LastKey() = 5
    Return( .T. )
endif

dbSelectArea( "Grupo" )
Grupo->(Order( 1 ))
if Grupo->(!DbSeek( cGrupo ))
    Grupo->(Order( 2 ))
    Grupo->(Escolhe( 03, 01, 22, "CodGrupo + 'Ý' + DesGrupo", "GRUPO DESCRICAO DO GRUPO", oInclusao, NIL, oAlteracao, NIL, NIL, NIL ))
    cGrupo := Grupo->CodGrupo
endif
Write( nCol, nLinha, Grupo->DesGrupo )
AreaAnt( Arq_Ant, Ind_Ant )
return( .T. )

Function SubCerto( cSub, nCol, nLinha, cGrupo )

LOCAL oInclusao  := {{|| Lista1_2()         }}
LOCAL oAlteracao := {{|| SubGrupoDbEdit() }}
LOCAL cScreen      := SaveScreen()
LOCAL Arq_Ant      := Alias()
LOCAL Ind_Ant      := IndexOrd()

if LastKey() = 5
    Return( .T. )
endif
dbSelectArea( "SubGrupo" )
SubGrupo->(Order( 1 ))
if SubGrupo->(!DbSeek( cSub ))
    SubGrupo->(DbSeek( cGrupo ))
    SubGrupo->(Escolhe( 03, 01, 22, "CodsGrupo + 'Ý' + DessGrupo", "SUBGRUPO   DESCRICAO DO SUBGRUPO", oInclusao, NIL, oAlteracao, NIL, NIL, .T. ))
    cSub := SubGrupo->CodsGrupo
endif
if Left( cSub, 3 ) <> cGrupo
    ErrorBeep()
    Alerta("Erro: Subgrupo incompativel com o grupo.")
    AreaAnt( Arq_Ant, Ind_Ant )
    Return( .F. )
endif
Write( nCol, nLinha, SubGrupo->DessGrupo )
AreaAnt( Arq_Ant, Ind_Ant )
Return( .T. )

Proc RepresInclusao()

LOCAL GetList := {}
LOCAL cScreen := SaveScreen( )
LOCAL Mcodi
LOCAL Nom
LOCAL Mfanta
LOCAL Dat
LOCAL Mcpf
LOCAL Fon
LOCAL Mfax
LOCAL Rg1
LOCAL End
LOCAL Bai
LOCAL Mcgc
LOCAL Mcon
LOCAL Mcida
LOCAL Mesta
LOCAL Mcep
LOCAL Mins
LOCAL Mcaixa
LOCAL Mobs
LOCAL cNome
LOCAL cFanta
LOCAL cSigla
LOCAL cCpf
LOCAL cFone
LOCAL cFax
LOCAL cRg
LOCAL cCgc
LOCAL cEnde
LOCAL cObs
LOCAL cBair
LOCAL cCon
LOCAL cCida
LOCAL cEsta
LOCAL cCep
LOCAL cCodi
LOCAL cInsc
LOCAL cCaixa
LOCAL dData
FIELD Codi
FIELD Nome
FIELD Repres

oMenu:Limpa()
dbSelectArea( "Repres" )
Repres->(Order( 2 ))
WHILE .T.
    MaBox( 05, 02, 20, 78, "INCLUSAO DE REPRESENTANTES" )
    cNome  := Space(40)
    cFanta := Space(40)
    cSigla := Space(10)
    cCpf     := Space(14)
    cFone  := Space(14)
    cFax     := Space(14)
    cRg     := Space(18)
    cCgc     := Space(18)
    cEnde  := Space(30)
    cObs     := Space(60)
    cBair  := Space(20)
    cCon     := Space(20)
    cCida  := Space(25)
    cEsta  := Space(02)
    cCep     := Space(09)
    cCodi  := Space(04)
    cInsc  := Space(15)
    cCaixa := Space(03)
    dData  := Date()

    dbSelectArea( "Repres" )
    Repres->(Order( 2 ))
    DbGoBottom()
    cCodi := StrZero( Val( Repres ) + 1 , 4)
    Write( 06, 23, "ANTERIOR " + Repres->Repres + " " + Repres->Nome )
    SetCursor(1) ; DevPos( Row(), 03 ) ; DevOut( "Codigo......:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cCodi, "cCodi", "9999", {|| RepresCerto( @cCodi )},))
    SetCursor(1) ; DevPos( Row()+1, 03 ) ; DevOut( "R. Social...:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cNome, "cNome", "@!", {|| !Empty(cNome) .OR. LastKey() = 5},))
    SetCursor(1) ; DevPos( Row()+1, 03 ) ; DevOut( "CGC/MF......:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cCgc, "cCgc", "99.999.999/9999-99", {|| TestaCgc( cCgc )},))
    SetCursor(1) ; DevPos( Row()+1, 03 ) ; DevOut( "Inscri‡ao...:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cInsc, "cInsc", "@!",,))
    SetCursor(1) ; DevPos( Row()+1, 03 ) ; DevOut( "Endere‡o....:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cEnde, "cEnde", "@!",,))
    SetCursor(1) ; DevPos( Row()+1, 03 ) ; DevOut( "CEP.........:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cCep, "cCep", "99999-999", {|| CepErrado( @cCep, @cCida, @cEsta, @cBair )},))
    SetCursor(1) ; DevPos( Row()+1, 03 ) ; DevOut( "Cidade......:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cCida, "cCida", "@!",,))
    SetCursor(1) ; DevPos( Row()+1, 03 ) ; DevOut( "Bairro......:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cBair, "cBair", "@!",,))
    SetCursor(1) ; DevPos( Row()+1, 03 ) ; DevOut( "Estado......:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cEsta, "cEsta", "@!",,))
    SetCursor(1) ; DevPos( Row()+1, 03 ) ; DevOut( "Telefone....:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cFone, "cFone", "(##)#####-####",,))
    SetCursor(1) ; DevPos( Row()+1, 03 ) ; DevOut( "Fax.........:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cFax, "cFax", "(##)#####-####",,))
    SetCursor(1) ; DevPos( Row()+1, 03 ) ; DevOut( "Cx Postal...:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cCaixa, "cCaixa", "999",,))
    SetCursor(1) ; DevPos( Row()+1, 03 ) ; DevOut( "Contato.....:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cCon, "cCon", "@!",,))
    SetCursor(1) ; DevPos( Row()+1, 03 ) ; DevOut( "Obs.........:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cObs, "cObs", "@!",,))
    ReadModal( GetList, NIL,,,,, ) ; GetList := {} ; ( GetList )
    if LastKey() = 27
        ResTela( cScreen )
        Exit
    endif
    if Conf(" Pergunta: Confirma Inclusao do Registro ?")
        if !RepresCerto( @cCodi)
            Loop
        endif
        if Repres->(Incluiu())
            Repres->Repres := cCodi
            Repres->Nome    := cNome
            Repres->Ende    := cEnde
            Repres->Bair    := cBair
            Repres->Cida    := cCida
            Repres->Con     := cCon
            Repres->Obs     := cObs
            Repres->Esta    := cEsta
            Repres->Cep     := cCep
            Repres->Fone    := cFone
            Repres->Cgc     := cCgc
            Repres->Insc    := cInsc
            Repres->Fax     := cFax
            Repres->Caixa    := cCaixa
            Repres->(Libera())
        endif
    endif
EndDo

Function Represrrado( Var, nRow, nCol, cSigla )

LOCAL aRotina := {{|| RepresInclusao() }}
LOCAL cScreen := SaveScreen()
LOCAL Ind_Ant := IndexOrd()
LOCAL Arq_Ant := Alias()
FIELD Codi, Nome

dbSelectArea( "Repres" )
Repres->(Order( 2 ))
if Repres->(!( DbSeek( Var )))
    Repres->( Order( 1 ))
    Repres->( Escolhe( 03, 01, 22, "Repres + 'Ý' + Nome + 'Ý' + Fone", "CODI NOME REPRESENTANTE                       TELEFONE", aRotina ))
    Var := IF( Len( Var ) = 4, Repres->Repres, Repres->Nome )
endif
if nRow <> Nil
    Write( nRow, nCol, Repres->Nome )
endif
AreaAnt( Arq_Ant, Ind_Ant )
Return(.T.)

Function BarErrado( cCodeBar, lModificar, cSwapBar )

LOCAL Ind_Ant := IndexOrd()
LOCAL Arq_Ant := Alias()
LOCAL Reg_Ant := Recno()
LOCAL lRet      := .T.

if lModificar
    if ltrim(rtrim(cCodeBar)) == cSwapBar
        Return( lRet )
    endif
endif
if LastKey() = 5
    Return( lRet )
endif
Lista->(Order( 11 ))
if Lista->(DbSeek( cCodeBar ))
    ErrorBeep()
    Alerta("Erro: Codigo de Barra Existente.")
    lRet := .F.
endif
AreaAnt( Arq_Ant, Ind_Ant )
DbGoTo( Reg_Ant )
Return( lRet )

Function PagCerto( cCodi, lAlteracao, cSwap )

LOCAL lModificar := IF( lAlteracao <> NIL .AND. lAlteracao, .T., .F. )
LOCAL Ind_Ant      := IndexOrd()
LOCAL Arq_Ant      := Alias()

if LastKey() = 5
    Return( .T. )
endif
if lModificar
    if cCodi == cSwap
        Return( .T. )
    endif
endif
if Empty( cCodi ) .OR. Len(ltrim(rtrim(cCodi))) < 4
    ErrorBeep()
    Alerta( "Erro: Codigo de fornecedor Invalido." )
    Return( .F. )
endif
dbSelectArea( "Pagar" )
Pagar->(Order( 2 ))
if Pagar->(DbSeek( cCodi ))
    ErrorBeep()
    Alerta("Erro: Fornecedor Ja Registrado ou Incluido por outra Esta‡ao.." )
    Pagar->(DbGoBoTTom())
    cCodi := StrZero( Val( Pagar->Codi)+1, 4 )
    AreaAnt( Arq_Ant, Ind_Ant )
    Return(.F.)
endif
AreaAnt( Arq_Ant, Ind_Ant )
Return(.T.)

Function RepresCerto( cCodi )

LOCAL Arq_Ant, Ind_Ant

if LastKey() = 5
    Return( .T. )
endif
if Empty( cCodi )
    ErrorBeep()
    Alerta( "Erro: Codigo Representante Invalido." )
    Return(.F.)
endif
Ind_Ant := IndexOrd()
Arq_Ant := Alias()
dbSelectArea( "Repres" )
Repres->(Order( 2 ))
if (DbSeek( cCodi ) )
    ErrorBeep()
    Alerta("Erro: Representante Ja Registrado." )
    Pagar->(DbGoBoTTom())
    cCodi := StrZero( Val( Repres->Repres ) + 1, 4 )
    AreaAnt( Arq_Ant, Ind_Ant )
    Return(.F.)
endif
AreaAnt( Arq_Ant, Ind_Ant )
Return(.T.)

Function Complet3( xCep , Mcida, Mesta)

if xCep     = "76970-000"
    Mcida := "PIMENTA BUENO"
    Mesta := "RO"
    __Keyboard( Chr( 13 ) + Chr( 13 ) )

endif
Return( .T. )

Function CodiErrado( cCodiIni, cCodiFim, lUltimo, nRow, nCol )

LOCAL aRotina := {{|| InclusaoProdutos() }}
LOCAL Arq_Ant := Alias()
LOCAL Ind_Ant := IndexOrd()

cCodiIni := IF( ValType( cCodiIni ) = "N", StrZero( cCodiIni, 6), cCodiIni )
dbSelectArea( "Lista" )
Lista->(Order( 2 ))
if Lista->(!DbSeek( cCodiIni ))
    Lista->(Order( 3 ))
    Lista->(Escolhe( 03, 00, 22,"Codigo + 'Ý' + Descricao + 'Ý' + Tran( Quant, '999999.99') + 'Ý' + Tran( Varejo, '@E 99,999,999.99') + 'Ý' + Sigla","CODIG DESCRICAO DO PRODUTO                       ESTOQUE         PRECO MARCA", aRotina ))
    cCodiIni := IF( Len( cCodiIni ) > 6, Lista->Descricao, Lista->Codigo )
endif
if nRow <> NIL .AND. nCol <> NIL
    Write( nRow, nCol, Lista->Descricao )
endif
AreaAnt( Arq_Ant, Ind_Ant )
Return( .T. )

Function SimOuNao()

ErrorBeep()


Return( Alert("Esta opcao ira somar as entradas e saidas;" +  "de produtos e atualizar o estoque;; " +  "Deseja continuar ?", {" Sim ", " Nao "}) == 1 )

Proc InclusaoDolar( dData )

LOCAL cScreen    := SaveScreen()
LOCAL GetList    := {}
LOCAL nCotacao := 0

oMenu:Limpa()
if dData = Nil
    dData := Date() + 7
endif
dData     := Date()-1
nCotacao := 0
dbSelectArea( "Taxas" )
Taxas->(Order( 2 ))
WHILE .T.
    dData++
    MaBox( 05, 11, 08, 51, "INCLUSAO DA COTA€AO DOLAR - ESC Retorna" )
    SetCursor(1) ; DevPos( 06, 12 ) ; DevOut( "Data                   ¯" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( dData, "dData", "##/##/##", {|| DolarCerto( dData )},))
    SetCursor(1) ; DevPos( Row()+1, 12 ) ; DevOut( "Cota‡ao Dolar R$       ¯" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( nCotacao, "nCotacao", "99999999.99", {|| nCotacao > 0},))
    ReadModal( GetList, NIL,,,,, ) ; GetList := {} ; ( GetList )
    if LastKey() = 27
        ResTela( cScreen )
        Exit
    endif
    ErrorBeep()
    if Conf("Pergunta: Confirma Inclusao do Registro ?")
        if !DolarCerto( dData )
            Loop
        endif
        if Taxas->(!Incluiu())
            Loop
        endif
        Taxas->DIni      := dData
        Taxas->DFim      := dData
        Taxas->Cotacao  := nCotacao
        Taxas->(Libera())
    endif
EndDo

Proc InclusaoForma()

LOCAL cScreen         := SaveScreen()
LOCAL GetList         := {}
LOCAL cForma         := Space(02)
LOCAL cCondicoes     := Space(40)
LOCAL cDescricao     := Space(40)
LOCAL nComissao     := 0
LOCAL cEspecificar := "S"
LOCAL nMeses         := 0
LOCAL nIof             := 0
LOCAL cDesdobrar     := "N"
LOCAL cVista         := "N"
LOCAL nParcelas     := 1
LOCAL nDias          := 30

oMenu:Limpa()
MaBox( 05, 05, 13, 72, "INCLUSAO DE FORMA PGTO" )
dbSelectArea( "Forma" )
Forma->(Order( 1 ))
WHILE .T.
    Forma->(DbGoBoTTom())
    cForma := StrZero( Val( Forma->Forma ) + 1, 2 )
    cDesdobrar     := "N"
    cVista         := "N"
    nParcelas     := 0
    nDias          := 0
   SetCursor(1) ; DevPos( 06, 06 ) ; DevOut( "Codigo..........:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cForma, "cForma", "99", {|| FormaCerta( cForma )},))
   SetCursor(1) ; DevPos( 07, 06 ) ; DevOut( "Condicoes.......:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cCondicoes, "cCondicoes", "@!", {|| IF( Empty( cCondicoes ), ( ErrorBeep(), Alerta("Erro: Entrada Invalida."), .F. ), .T. )},))
    SetCursor(1) ; DevPos( 08, 06 ) ; DevOut( "Desdobramento...:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cDesdobrar, "cDesdobrar", "!", {|| PickSimNao( @cDesdobrar )},))
    SetCursor(1) ; DevPos( 08, 35 ) ; DevOut( "N§ Parcelas........:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( nParcelas, "nParcelas", "99",, {|| cDesdobrar == "S"}))
    SetCursor(1) ; DevPos( 09, 06 ) ; DevOut( "1§ Parcela Vista:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cVista, "cVista", "!", {|| PickSimNao( @cVista )}, {|| cDesdobrar = "S"}))
   SetCursor(1) ; DevPos( 09, 35 ) ; DevOut( "Dias Entre Parcelas:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( nDias, "nDias", "999",, {|| cDesdobrar == "S"}))
    SetCursor(1) ; DevPos( 10, 06 ) ; DevOut( "Descricao.......:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cDescricao, "cDescricao", "@!",,))
    SetCursor(1) ; DevPos( 11, 06 ) ; DevOut( "Comissao........:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( nComissao, "nComissao", "99.99",,))
    SetCursor(1) ; DevPos( 12, 06 ) ; DevOut( "Taxa Financeiro.:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( nIof, "nIof", "999.9999",,))
    ReadModal( GetList, NIL,,,,, ) ; GetList := {} ; ( GetList )
    if LastKey() = 27
        ResTela( cScreen )
        Exit
    endif
    ErrorBeep()
    if Conf("Pergunta: Confirma Inclusao do Registro ?")
        if !FormaCerta( cForma )
            Loop
        endif
        if Forma->(!Incluiu())
            Loop
        endif
        Forma->Forma        := cForma
        Forma->Condicoes    := cCondicoes
        Forma->Descricao    := cDescricao
        Forma->Comissao    := nComissao
        Forma->Iof            := nIof
        Forma->Desdobrar    := cDesdobrar == "S"
        Forma->Parcelas    := nParcelas
        Forma->Dias         := nDias
        Forma->Vista        := cVista == "S"
        Forma->(Libera())
    endif
EndDo

Function DolarCerto( dData )

if Taxas->(DbSeek( dData ))
    ErrorBeep()
    if Taxas->Cotacao = 0
        Alerta("Erro: Cota‡ao registrada com valor 0...")
    Else
        Alerta("Erro: Cota‡ao desta Data ja registrada...")
    endif
    Return( .F. )
endif
Return( .T. )

Function FormaCerta( cForma )

if Forma->(DbSeek( cForma ))
    ErrorBeep()
    Alerta("Erro: Codigo de Forma de Pgto ja registrada...")
    Return( .F. )
endif
Return( .T. )

Function Cotacao( dData, nCotacao, lExcecao )

LOCAL cScreen := SaveScreen()
LOCAL Arq_Ant := Alias()
LOCAL Ind_Ant := IndexOrd()
LOCAL cString
if lExcecao = NIL

        nCotacao := 1
        Return( .T. )

endif
dbSelectArea( "Taxas" )
Taxas->(Order( 2 ))
if Taxas->(!DbSeek( dData ))
    ErrorBeep()
    cString := "Cotacao de " + Dtoc( dData ) + " Nao Encontrada. Registrar ?"
    if Conf( cString )
         InclusaoDolar( dData )
    endif
    AreaAnt( Arq_Ant, Ind_Ant )
    ResTela( cScreen )
    Return( .F. )
endif
if Taxas->Cotacao = 0
    ErrorBeep()
    cString := "Cotacao ja Registrada com valor 0. Alterar ?"
    if Conf( cString )
        MudaDolar( .T. )
    endif
    AreaAnt( Arq_Ant, Ind_Ant )
    ResTela( cScreen )
    Return( .F. )
endif
nCotacao := Taxas->Cotacao
AreaAnt( Arq_Ant, Ind_Ant )
Return( .T. )

PROC NaoTem()

ErrorBeep()
Alerta("Erro: Nenhum Registro Neste Periodo... ")
Return

Proc CliAltera()

LOCAL GetList    := {}
LOCAL cScreen    := SaveScreen()
LOCAL cCodi     := Space(05)

WHILE .T.
    MaBox( 10, 10, 12, 75 )
    SetCursor(1) ; DevPos( 11, 11 ) ; DevOut( "Codigo Cliente..: " ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cCodi, "cCodi", "99999", {|| RecErrado( @cCodi,, Row(), Col()+1 )},))
    ReadModal( GetList, NIL,,,,, ) ; GetList := {} ; ( GetList )
    if LastKey() = 27
        Return
    endif
    CliInclusao( .T. )
EndDo


Function SeekData( dMinor, dMajor, cCampo )

LOCAL xValor := Date()

if cCampo <> NIL
    DbGoTop()
    xValor := FieldGet( FieldPos( cCampo ))
    if dMinor < xValor
        dMinor := xValor
    endif
endif
WHILE !DbSeek( dMinor++ )
     if dMinor > dMajor
         Return( .F. )
     endif
EndDo
Return( .T. )

Function AchaTipo( cTipo )

Recemov->(Order( 8 ))
if Recemov->(!DbSeek( cTipo ))
    ErrorBeep()
    Alerta("Erro: Tipo nao localizado.")
    Return( .F. )
endif
Return( .T. )

Function Cliente( cCodi, cPraca, cCliRecno, cEsta )

LOCAL aRotinaInc := {{|| CliInclusao() }}
LOCAL aRotinaAlt := {{|| CliInclusao(.T.) }}
LOCAL cScreen    := SaveScreen()
LOCAL Arq_Ant    := Alias()
LOCAL Ind_Ant    := IndexOrd()
LOCAL nRow       := MaxRow()
LOCAL nMaxCol    := MaxCol()

dbSelectArea( "Receber" )
Receber->(Order( 2 ))
Receber->(DbGoTop())
if Receber->(Lastrec()) = 0
    ErrorBeep()
    if Conf( "Nenhum Cliente Registrado... Registrar ? " )
        CliInclusao()
    endif
    AreaAnt( Arq_Ant, Ind_Ant )
    ResTela( cScreen )
    Return( .F. )
endif
if Receber->(!DbSeek( cCodi ))
    Receber->(Order( 1 ))
    Receber->(DbGoTop())
    if nMaxCol > 80
        Receber->(Escolhe( 03, 00, MaxRow()-2,"Codi + 'Ý' + Nome + 'Ý' + Fone + 'Ý' + Fax + 'Ý' + Left( Fanta, 15 ) + 'Ý' + Ende", "CODI NOME DO CLIENTE                           TELEFONE #1    TELEFONE #2    POP             ENDERECO", aRotinaInc, nil, aRotinaAlt ))
    else
        Receber->(Escolhe( 03, 00, MaxRow()-2,"Codi + 'Ý' + Nome + 'Ý' + Fone + 'Ý' + Left( Fanta, 15 )", "CODI NOME DO CLIENTE                          TELEFONE       POP     ", aRotinaInc, nil, aRotinaAlt ))
    endif
endif
cCliRecno := Receber->(Recno())
cCodi      := Receber->Codi
cPraca     := Receber->Cep + "/" + Receber->Cida
cEsta      := Receber->Esta

Write( nRow-7, 15 , Receber->Nome )
Write( nRow-7, 66 , Receber->Codi )

Write( nRow-6, 15 , Receber->Ende )
Write( nRow-6, 59 , Receber->Bair )

Write( nRow-5, 15 , Receber->Cida )
Write( nRow-5, 66 , Receber->Esta )

Write( nRow-4, 15 , Receber->Cep + "/" + Receber->Cida )
Write( nRow-4, 66 , Receber->Esta )

Write( nRow-3, 15 , Receber->Cgc )
Write( nRow-3, 58 , Receber->Insc )

Write( nRow-2, 15 , Receber->Cpf )
Write( nRow-2, 58 , Receber->Rg )
AreaAnt( Arq_Ant, Ind_Ant )
Return( .T. )

Proc Avisa()

ErrorBeep()
Alerta( "Erro: Nada Consta nos parametros informados.")
Return

Proc Cheq11()

LOCAL GetList     := {}
LOCAL cScreen     := SaveScreen(  )
LOCAL cBanco     := Space(10)
LOCAL dData      := Date()
LOCAL cCgc         := Space(18)
LOCAL cConta     := Space(08)
LOCAL cFone      := Space(13)
LOCAL cObs         := Space(40)
LOCAL cTitular  := Space(40)
LOCAL cPoupanca := "N"
LOCAL cAg         := "PIMENTA BUENO" + Space( 25 - Len( "PIMENTA BUENO" ) )
LOCAL cMens      := "N"
LOCAL cExterna  := "S"

WHILE .T.
    oMenu:Limpa()
    cBanco     := Space(10)
    dData      := Date()
    cCgc         := Space(18)
    cConta     := Space(08)
    cFone      := Space(13)
    cObs         := Space(40)
    cTitular  := Space(40)
    cAg         := "PIMENTA BUENO" + Space( 25 - Len( "PIMENTA BUENO" ) )
    cMens      := "N"
    cExterna  := "S"
    cPoupanca := "N"

    dbSelectArea( "Cheque" )
    Cheque->(Order( 1 ))
    DbGoBottom()
    cCodi := StrZero( Val( Codi ) + 1, 4 )
    MaBox( 06, 02, 18, 78, "INCLUSAO DE CONTAS" )
    WHILE .T.
        SetCursor(1) ; DevPos( 07, 03 ) ; DevOut( "Codigo......:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cCodi, "cCodi", "9999", {|| CheCerto( @cCodi )},))
        SetCursor(1) ; DevPos( 08, 03 ) ; DevOut( "Titular.....:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cTitular, "cTitular", "@!", {|| !Empty( cTitular )},))
        SetCursor(1) ; DevPos( 09, 03 ) ; DevOut( "CGC/MF......:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cCgc, "cCgc", "99.999.999/9999-99", {|| TestaCgc( cCgc )},))
        SetCursor(1) ; DevPos( 10, 03 ) ; DevOut( "Abertura....:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( dData, "dData", "##/##/##",,))
        SetCursor(1) ; DevPos( 11, 03 ) ; DevOut( "Banco.......:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cBanco, "cBanco", "@!",,))
        SetCursor(1) ; DevPos( 12, 03 ) ; DevOut( "Telefone....:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cFone, "cFone", "(##)#####-####",,))
        SetCursor(1) ; DevPos( 13, 03 ) ; DevOut( "Agencia.....:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cAg, "cAg", "@K!",,))
        SetCursor(1) ; DevPos( 14, 03 ) ; DevOut( "Conta N§....:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cConta, "cConta", "@!",,))
        SetCursor(1) ; DevPos( 15, 03 ) ; DevOut( "Observ......:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cObs, "cObs", "@!",,))
        SetCursor(1) ; DevPos( 16, 03 ) ; DevOut( "Cob Externa.:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cExterna, "cExterna", "!", {|| cExterna  $ "SN"},))
        SetCursor(1) ; DevPos( 17, 03 ) ; DevOut( "Poupanca....:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cPoupanca, "cPoupanca", "!", {|| cPoupanca $ "SN"},))
        ReadModal( GetList, NIL,,,,, ) ; GetList := {} ; ( GetList )
        if LastKey() = 27
            ResTela( cScreen )
            Exit
        endif
        ErrorBeep()
        nOpcao := Alerta(" Pergunta: Voce Deseja ? ", {" Incluir ", " Alterar ", " Sair " })
        if nOpcao = 1
            if !Checerto( @cCodi )
                Loop
            endif
            dbSelectArea( "Cheque" )
            if Cheque->(Incluiu())
                Cheque->Codi      := cCodi
                Cheque->Titular  := cTitular
                Cheque->Data      := dData
                Cheque->Banco      := cBanco
                Cheque->Cgc       := cCgc
                Cheque->Ag          := cAg
                Cheque->Conta      := cConta
                Cheque->Fone      := cFone
                Cheque->Obs       := cObs
                Cheque->Mens      := IF( cMens      = "S", .T., .F. )
                Cheque->Externa  := IF( cExterna  = "S", .T., .F. )
                Cheque->Poupanca := IF( cPoupanca = "S", .T., .F. )
                Cheque->(Libera())
                cCodi := StrZero( Val( cCodi )+1, 4 )
            endif
        Elseif nOpcao = 2
            Loop
        Else
            Exit
        endif
    EndDo
    ResTela( cScreen )
    Exit
EndDo

Function CheCerto( Var)

LOCAL Arq_Ant := Alias()
LOCAL Ind_Ant := IndexOrd()
if ( Empty( Var ) )
    ErrorBeep()
    Alerta( "Erro: C¢digo Conta Invalida ..." )
    Return( .F. )

endif
dbSelectArea( "Cheque" )
Cheque->(Order( 1 ))
DbGoTop()
if (DbSeek( Var ) )
    ErrorBeep()
    Alerta("Erro: Conta J  Registrada ou Incluida por outra Estacao..." )
    Var := StrZero( Val( Var )+1,4)
    AreaAnt( Arq_Ant, Ind_Ant )
    Return( .F. )

endif
AreaAnt( Arq_Ant, Ind_Ant )
Return( .T. )

Function Cancela( lCancelado)

if Rep_OK()
    lCancelado := .F.
    Return( .T. )
Else
    lCancelado := .T.
    Return( .F. )
endif

Function BaixaGeral( cCodi, nApagar, nPago )

LOCAL cScreen     := SaveScreen()
LOCAL Arq_Ant     := Alias()
LOCAL Ind_Ant     := IndexOrd()
LOCAL nTotal     := 0

Lista->(Order( 2 ))
dbSelectArea( "Saidas" )
Saidas->(Order( 5 ))
if ( ! .F. ) ; dbClearRelation() ; end ; dbSetRelation( "Lista", {|| Codigo}, "Codigo", .F. )
if Saidas->(!DbSeek( cCodi ))
    ErrorBeep()
    Alerta( "Erro: Nenhum Produto Faturado Deste Cliente." )
    Saidas->(DbClearRel())
    AreaAnt( Arq_Ant, Ind_Ant )
    Return( .F. )
endif
WHILE Saidas->Codi = cCodi
    if Saidas->C_C
        nQuant  := ( Saidas->Saida - Saidas->SaidaPaga )
        if nQuant > 0
            nTotal += nQuant * Lista->Varejo
        endif
    endif
    Saidas->(DbSkip(1))
EndDo
if nTotal = 0
    ErrorBeep()
    Alerta( "Erro: Cliente Sem Debito em Conta Corrente." )
    Saidas->(DbClearRel())
    AreaAnt( Arq_Ant, Ind_Ant )
    Return( .F. )
endif
nApagar := nTotal
nPago   := nTotal
Saidas->(DbClearRel())
AreaAnt( Arq_Ant, Ind_Ant )
Return( .T. )

Function SomaPagoInd( nApagar, cFatura, nQuant, cCodigo, nRegistro )

LOCAL oBloco
LOCAL nSoma       := 0
LOCAL cCombinado := ""
if LastKey() = 5
    Return( .T. )
endif
nApagar      := 0
nPago       := 0
cCombinado := cFatura + Space(2) + cCodigo
cTela       := Mensagem(" Aguarde...", Cor(), 20)

Lista->(Order( 2 ))
dbSelectArea( "Saidas" )
Saidas->(Order( 3 ))
if ( ! .F. ) ; dbClearRelation() ; end ; dbSetRelation( "Lista", {|| Codigo}, "Codigo", .F. )
Saidas->(DbGoto( nRegistro ))
if Saidas->Fatura = cFatura .AND. Saidas->Codigo = cCodigo
    nSoma := Saidas->SaidaPaga + nQuant
    if Saidas->Saida >= nSoma .AND. nQuant <> 0
        nApagar := nQuant * Lista->Varejo
        Saidas->(DbClearRel())
        ResTela( cTela )
        Return( .T. )
    Else
        ResTela( cTela )
        cSoma := StrZero((Saidas->Saida - Saidas->SaidaPaga), 7)
        ErrorBeep()

        Alerta(" Erro: Quantidade a baixar invalida..." +     "; Disponivel : " + cSoma )
        Saidas->(DbClearRel())
        Return( .F.)
    endif
endif
ResTela( cTela )
Alerta(" Erro: Registro nao encontrado...")
Saidas->(DbClearRel())
Return( .F. )

Function SomaPago( nApagar, cFatura, nPago )

LOCAL oBloco
if LastKey() = 5
    Return( .T. )
endif
nApagar := 0
nPago   := 0
Lista->(Order( 2 ))
dbSelectArea( "Saidas" )
Saidas->(Order( 3 ))
if ( ! .F. ) ; dbClearRelation() ; end ; dbSetRelation( "Lista", {|| Codigo}, "Codigo", .F. )
oBloco := {|| Saidas->Fatura = cFatura }
if Saidas->(Dbseek( cFatura ))
    WHILE Eval( oBloco )
        if Saidas->C_c
            nApagar += ( Saidas->Saida - Saidas->SaidaPaga ) * Lista->Varejo
            nPago   += Saidas->SaidaPaga * Lista->Varejo
        Else
            nPago   += ( Saidas->SaidaPaga * Lista->Varejo )
        endif
        Saidas->(DbSkip(1))
    EndDo
endif
Saidas->(DbClearRel())
if nApagar = 0
    ErrorBeep()
    Alerta(" Erro: Esta fatura ja esta paga !!")
    Return( .F. )
endif
Return( .T. )

Function CalcSobra( nApagar, nPerc, nSobra )

nSobra := nApagar - (( nApagar * nPerc ) / 100 )
Return( .T. )

Function cDolar( cDolar )

LOCAL cScreen := SaveScreen()
LOCAL aMenu   := { " Real ", " Dolar " }
LOCAL aMoeda  := { "R", "U" }
LOCAL nChoice := 1

MaBox( 20, 33, 23, 43 )
nChoice := Achoice( 21, 34, 22, 42, aMenu )
cDolar  := aMoeda[ IF( nChoice = 0, 1, nChoice )]
__Keyboard( Chr( 13 ) )
ResTela( cScreen )
Return .T.

Proc OrcaLista( lVarejo )

LOCAL cScreen := SaveScreen()
LOCAL Arq_Ant := Alias()
LOCAL Ind_Ant := IndexOrd()
PRIVA aVetor1 := {"Codigo","Descricao", "Quant", IF( lVarejo = 2, "Varejo", "Atacado"), IF( lVarejo = 2, "Atacado", "Varejo"), "Vendida", "Local", "Sigla", "N_Original"}
PRIVA aVetor2 := {"CODIGO","DESCRICAO DO PRODUTO", "ESTOQUE", IF( lVarejo = 2, "VAREJO", "ATACADO"), IF( lVarejo = 2, "ATACADO", "VAREJO"), "VENDIDA","LOCALIZACACAO", "SIGLA","COD FABRICANTE"}

dbSelectArea( "Lista" )
Lista->(Order( 3 ))
Lista->(DbGoTop())
MaBox( 00, 00, 15, MaxCol()-1, "F2 PROCURA Ý  F6 TROCAR ORDEM Ý A-Z PROCURA")
Seta1(15)
DbEdit( 01, 01, 14, MaxCol()-2, aVetor1, "OrcaFunc", .T.,  aVetor2 )
AreaAnt( Arq_Ant, Ind_Ant )
ResTela( cScreen )
Return

Proc NewFatura( cDeleteFile)

LOCAL xAlias := "T" + StrTran( Time(),":") + ".TMP"
Mensagem("Aguarde... Criando Arquivo de Trabalho.")
WHILE File((xAlias))
    xAlias := "T" + StrTran( Time(),":") + ".TMP"
EndDo
















Dbf1 := {{ "CODIGO",   "C", 06, 0 },     { "UN",       "C", 02, 0 },     { "CODI",     "C", 04, 0 },     { "QUANT",    "N", 08, 2 },     { "DESCONTO", "N", 05, 2 },     { "DESCRICAO","C", 40, 0 },     { "PCUSTO",   "N", 13, 2 },     { "VAREJO",   "N", 13, 2 },     { "ATACADO",  "N", 13, 2 },     { "UNITARIO", "N", 13, 2 },     { "TOTAL",    "N", 13, 2 },     { "MARVAR",   "N", 06, 2 },     { "MARATA",   "N", 06, 2 },     { "UFIR",     "N", 07, 2 },     { "IPI",      "N", 05, 2 },     { "II",       "N", 05, 2 },     { "PORC",     "N", 05, 2 }}
DbCreate( xAlias, Dbf1 )
dbUseArea( .T.,, (xAlias), "xAlias", iif( .F. .OR. .T., ! .T., NIL ), .F. )
Return((xAlias))

Function Acha_Reg( cFatu, cCodigo, nQuant, nRegistro )

LOCAL cScreen    := SaveScreen()
LOCAL Arq_Ant    := Alias()
LOCAL Ind_Ant    := IndexOrd()
LOCAL cProcura := cFatu + Space(2) + StrCodigo( cCodigo )
LOCAL aTodos    := {}
LOCAL aRecno    := {}
LOCAL aQuant    := {}
LOCAL nChoice    := 0

dbSelectArea( "Saidas" )
Saidas->(Order( 3 ))
if !( DbSeek( cProcura ))
    Saidas->(Order( 3 ))
    Saidas->(DbSeek( cFatu ))
    WHILE Saidas->Fatura = cFatu
         nQuant    := ( Saidas->Saida - Saidas->SaidaPaga )
         if nQuant > 0
             Aadd( aTodos, Saidas->Codigo + " " + Lista->Descricao )
             Aadd( aRecno, Saidas->(Recno()))
             Aadd( aQuant, nQuant )
         endif
         Saidas->(DbSkip(1))
    EndDo
    MaBox( 03, 19, 17, 79,"CODIGO DESCRICAO DO PRODUTO                             ")
    nChoice := aChoice( 04, 20, 16, 78, aTodos )
    ResTela( cScreen )
    Saidas->(Order( 3 ))
    if nChoice = 0
        Alerta( "Erro: Procura Cancelada..." )
        AreaAnt( Arq_Ant, Ind_Ant )
        Return( .F. )
    endif
    cTemp      := Left( aTodos[nChoice],5)
    nRegistro := aRecno[nChoice]
    cCodigo     := cTemp
    if DbSeek( cFatu + Space(2) + cTemp )
        if nQuant <> Nil
            nQuant  := ( Saidas->Saida - Saidas->SaidaPaga )
        endif
        AreaAnt( Arq_Ant, Ind_Ant )
        Return( .T. )
    endif
    ErrorBeep()
    Alerta( "Erro: Produto Nao Encontrado na Fatura..." )
    AreaAnt( Arq_Ant, Ind_Ant )
    Return( .F. )
endif
if nQuant <> Nil
    nQuant  := ( Saidas->Saida - Saidas->SaidaPaga )
    cCodigo := Saidas->Codigo
endif
AreaAnt( Arq_Ant, Ind_Ant )
Return( .T. )

Function BaixaProcura( cCodi, cFatu, cCodigo, nQuant, nApagar, nRegistro )

LOCAL cScreen     := SaveScreen()
LOCAL Arq_Ant     := Alias()
LOCAL Ind_Ant     := IndexOrd()
LOCAL cProcura  := cFatu + Space(2) + StrCodigo( cCodigo )
LOCAL aTodos     := {}
LOCAL aFatura     := {}
LOCAL aApagar     := {}
LOCAL aQuant     := {}
LOCAL aRegistro := {}
LOCAL nChoice     := 0
LOCAL nTam         := 0
if LastKey() = 5
    Return( .T. )
endif
Lista->(Order( 2 ))
dbSelectArea( "Saidas" )
Saidas->(Order( 5 ))
if ( ! .F. ) ; dbClearRelation() ; end ; dbSetRelation( "Lista", {|| Codigo}, "Codigo", .F. )
if Saidas->(!DbSeek( cCodi ))
    ErrorBeep()
    Alerta( "Erro: Nenhum Produto Faturado Deste Cliente." )
    Saidas->(DbClearRel())
    AreaAnt( Arq_Ant, Ind_Ant )
    Return( .F. )
endif
WHILE Saidas->Codi = cCodi
    if Saidas->C_C
        nQuant  := ( Saidas->Saida - Saidas->SaidaPaga )
        if nQuant > 0
            Aadd( aTodos,      Saidas->Codigo + " " + Lista->Descricao + Str( nQuant, 9, 2 ))
            Aadd( aFatura,   Saidas->(Left( Fatura,7)))
            Aadd( aQuant,      nQuant )
            Aadd( aApagar,   Saidas->VlrFatura )
            Aadd( aRegistro, Saidas->(Recno()))
        endif
    endif
    Saidas->(DbSkip(1))
EndDo
nTam := Len( aTodos )
if nTam = 0
    ErrorBeep()
    Alerta( "Erro: Nenhum Produto a Receber Deste Cliente." )
    Saidas->(DbClearRel())
    AreaAnt( Arq_Ant, Ind_Ant )
    Return( .F. )
endif
MaBox( 00, 10, 14, 78,"CODIGO DESCRICAO DO PRODUTO                             ")
nChoice := aChoice( 01, 11, 13, 77, aTodos )
ResTela( cScreen )
if nChoice = 0
    Alerta( "Erro: Procura Cancelada..." )
    Saidas->(DbClearRel())
    AreaAnt( Arq_Ant, Ind_Ant )
    Return( .F. )
endif
cCodigo     := Left( aTodos[nChoice], 6)
cFatu      := aFatura[nChoice]
nApagar     := aApagar[nChoice]
nQuant     := aQuant[ nChoice ]
nRegistro := aRegistro[ nChoice ]
Saidas->(DbClearRel())
AreaAnt( Arq_Ant, Ind_Ant )
__Keyboard( Chr( 13 ) )
Return( .T. )

Function BaixaLocaliza( cCodi, cFatu )

LOCAL cScreen     := SaveScreen()
LOCAL Arq_Ant     := Alias()
LOCAL Ind_Ant     := IndexOrd()
LOCAL aFatura     := {}
LOCAL nQuant     := 0
LOCAL nChoice     := 0
LOCAL cFatura     := ""

dbSelectArea( "Saidas" )
Saidas->(Order( 5 ))
if Saidas->(!DbSeek( cCodi ))
    ErrorBeep()
    Alerta( "Erro: Nenhum Produto Faturado Deste Cliente." )
    AreaAnt( Arq_Ant, Ind_Ant )
    Return( .F. )
endif
WHILE Saidas->Codi = cCodi
    if Saidas->C_C
        nQuant  := ( Saidas->Saida - Saidas->SaidaPaga )
        if nQuant > 0
            cFatura := Saidas->(Left( Fatura, 7 ))
            if Ascan( aFatura, cFatura ) = 0
                Aadd( aFatura, cFatura )
            endif
        endif
    endif
    Saidas->(DbSkip(1))
EndDo
nTam := Len( aFatura )
if nTam = 0
    ErrorBeep()
    Alerta( "Erro: Nenhum Produto a Receber Deste Cliente." )
    AreaAnt( Arq_Ant, Ind_Ant )
    Return( .F. )
endif
MaBox( 00, 10, 14, 20,"FATURA N§")
nChoice := aChoice( 01, 11, 13, 19, aFatura )
ResTela( cScreen )
if nChoice = 0
    Alerta( "Erro: Procura Cancelada..." )
    AreaAnt( Arq_Ant, Ind_Ant )
    Return( .F. )
endif
cFatu      := aFatura[nChoice]
AreaAnt( Arq_Ant, Ind_Ant )
__Keyboard( Chr( 13 ) )
Return( .T. )


Function PickSituacao( cSituacao )

LOCAL aList      := { "0=Nacional", "1=Estrangeira - Importacao Direta", "2=Estrangeira - Adquirida no Mercado Interno" }
LOCAL aSituacao := { "0", "1", "2" }
LOCAL cScreen := SaveScreen()
LOCAL nChoice
if cSituacao $ aSituacao[1] .OR. cSituacao $ aSituacao[2] .OR. cSituacao $ aSituacao[3]
    Return( .T. )
Else
    MaBox( 19, 34, 23, 79, NIL, NIL, Roloc( Cor()) )
    if (nChoice := AChoice( 20, 35, 22, 78, aList )) <> 0
        cSituacao := aSituacao[ nChoice ]
    endif
endif
ResTela( cScreen )
Return( .T. )


Function PickClasse( cClasse )






LOCAL aList      := { "00=Tributada Integralmente", "10=Tributado e com cobranca do ICMS por Sub. Tributaria",    "20=Com reducao da Base de Calculo", "30=Isenta ou nao tributada e com Cobranca do ICMS por Sub. Tributaria",     "40=Isenta", "41=Nao Tributada","50=Suspensao",     "51=Diferimento", "60=Icms cobrado anteriormente por Sub. Tributaria",    "70=Com reducao de base de calculo e cobranca de ICMS por Substituicao Tributaria",    "90=Outros"}
LOCAL aClasse := { "00", "10", "20", "30", "40", "41", "50", "51", "60", "70", "90" }
LOCAL cScreen := SaveScreen()
LOCAL nTam      := Len( aClasse )
LOCAL nChoice, nX
For nX := 1 To nTam
    if cClasse $ aClasse[nX]
        Return( .T. )
    endif
Next
MaBox( 11, 34, 23, 79, NIL, NIL, Roloc( Cor()) )
if (nChoice := AChoice( 12, 35, 22, 78, aList )) <> 0
    cClasse := aClasse[ nChoice ]
endif
ResTela( cScreen )
Return( .T. )


Function CalculaVenda( nPcusto, nMarVar, nVar )

nVar := (( nPcusto * nMarVar ) / 100 ) + nPcusto
Return( .T. )

Function DataExt( dData )

LOCAL Mes, MesExt

IF( dData = Nil, dData := Date(), dData )
Mes := Month( dData)


MesExt := { "Janeiro","Fevereiro","Marco","Abril","Maio","Junho",    "Julho","Agosto","Setembro","Outubro","Novembro","Dezembro" }

Cidade = "PIMENTA BUENO" + ",  "
Return( Cidade + StrZero( Day( dData), 2 ) +" de " + MesExt[ Mes] +" de " + Str(YEAR( dData ),4))

Proc ReciboRegiao()

LOCAL cScreen     := SaveScreen()
LOCAL nVlr         := 0
LOCAL cValor     := Space(0)
LOCAL Larg         := 80
LOCAL nValor     := Space(0)
LOCAL nOpcao     := 1
LOCAL cDocnr
LOCAL cHist      := Space(60)
LOCAL lCalcular := .F.
LOCAL oBloco

oMenu:Limpa()
cRegiao := Space(02)
dIni      := Date()-30
dFim      := Date()
MaBox( 10, 10, 15, 79 )
SetCursor(1) ; DevPos( 11, 11 ) ; DevOut( "Regiao.... :" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cRegiao, "cRegiao", "99", {|| RegiaoErrada( @cRegiao ) .AND. VerRegiao( cRegiao )},))
SetCursor(1) ; DevPos( 12, 11 ) ; DevOut( "Data Ini.. :" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( dIni, "dIni", "##/##/##",,))
SetCursor(1) ; DevPos( 13, 11 ) ; DevOut( "Data Fim.. :" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( dFim, "dFim", "##/##/##",,))
SetCursor(1) ; DevPos( 14, 11 ) ; DevOut( "Referente..:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cHist, "cHist", "@!",,))
ReadModal( GetList, NIL,,,,, ) ; GetList := {} ; ( GetList )
if LastKey() = 27
    ResTela( cScreen )
    Return
endif
Receber->(Order( 2 ))
dbSelectArea( "Recemov" )
if ( ! .F. ) ; dbClearRelation() ; end ; dbSetRelation( "Receber", {|| Recemov->Codi}, "Recemov->Codi", .F. )
Recemov->(Order( 5 ))
Recemov->(DbSeek( cRegiao ))
oBloco := {|| Recemov->Regiao = cRegiao }
lCalcular := Conf("Pergunta: Calcular Juros ?")
if !Instru80() .OR. !LptOk()
    Restela( cScreen )
    Return
endif
cTela := Mensagem("Aguarde, Imprimindo Recibo.", Cor())
PrintOn()
FPrInt( Chr(27) + "C" + Chr( 33 ))
While Eval( oBloco ) .AND. Recemov->(!Eof()) .AND. Rep_Ok()
    if Recemov->Vcto >= dIni .AND. Recemov->Vcto <= dFim
        cDocnr     := Recemov->Docnr
        nMoeda     := 1
        nVlr         := Recemov->Vlr
        nVlrTotal := Recemov->Vlr
        if lCalcular
            nAtraso     := Atraso( Date(), Vcto )
            nCarencia := Carencia( Date(), Vcto )
            if nAtraso <= 0
                nTotJuros := 0
                nVlrTotal := Recemov->Vlr
            Else
                nTotJuros := nCarencia * Recemov->Jurodia
                nVlrTotal := ( nTotJuros + Recemov->Vlr )
            endif
        endif
        cValor  := ltrim(rtrim(Tran( nVlrTotal,"@E 999,999,999,999.99")))
        nValor  := Extenso( nVlrTotal, nMoeda, 3, Larg )
        SetPrc(0,0)
        nRow := 2
        Write( nRow+00, 00, Repl("=",80))
        Write( nRow+01, 00, GD + Padc(ltrim(rtrim(oAmbiente:xFanta)), 40) + CA )
        Write( nRow+02, 00, Padc( "AV CASTELO BRANCO, 693 - PIONEIROS" + " - " + "PIMENTA BUENO" + " - " + "RO", 80 ))
        Write( nRow+03, 00, Repl("-",80))
        Write( nRow+04, 00, "N§ " + NG + cDocnr + NR )
        Write( nRow+04, 40, GD + "RECIBO" + CA )
        Write( nRow+04, 65, "R$ " + NG + cValor + NR)
        Write( nRow+06, 00, "Recebemos de    : " + NG + Receber->Nome + NR )
        Write( nRow+07, 00, "Estabelecido  a : " + NG + Receber->Ende + NR )
        Write( nRow+08, 00, "na Cidade de    : " + NG + Receber->Cida + NR )
        Write( nRow+10, 00, "A Importancia por extenso abaixo relacionada")
        Write( nRow+11, 00, NG + Left( nValor, Larg ) + NR  )
        Write( nRow+12, 00, NG + SubStr( nValor, Larg + 1, Larg ) + NR  )
        Write( nRow+13, 00, NG + Right( nValor, Larg ) + NR  )
        Write( nRow+15, 00, "Referente a")
        Write( nRow+16, 00, NG + cHist + NR )
        Write( nRow+18, 00, "Para maior clareza firmo(amos) o presente")
        Write( nRow+19, 35, NG + DataExt( Date()) + NR )
        Write( nRow+23, 00, "1§ VIA - CLIENTE" )
        Write( nRow+23, 40, Repl("-",40))
        Write( nRow+24, 00, Repl("=",80))
        __Eject()
    endif
    Recemov->(DbSkip(1))
Enddo
Recemov->(DbClearRel())
Recemov->(DbGoTop())
PrintOff()
ResTela( cTela )
Return

Function VerRegiao( cRegiao )

Recemov->(Order( 5 ))
if Recemov->(!DbSeek( cRegiao ))
    ErrorBeep()
    Alerta("Erro: Regiao Sem Movimento.")
    Return( .F. )
endif
Return( .T. )









function LogAgenda( aAgenda )

Mensagem("Aguarde, Registrando Recibo.")
if Agenda->(Incluiu())
    Agenda->Codi     := aAgenda[1]
    Agenda->Data     := aAgenda[2]
    Agenda->Hora     := Time()
    Agenda->Hist     := aAgenda[3]
    Agenda->Caixa     := aAgenda[4]
    Agenda->Usuario := aAgenda[5]
    Agenda->Ultimo  := aAgenda[6]
    Agenda->(Libera())
    return .T.
endif
return .F.

function LogRecibo( aLog )

    LOCAL Arq_Ant := Alias()
    LOCAL Ind_Ant := IndexOrd()
    LOCAL cScreen := SaveScreen()
    LOCAL xLog      := "RECIBO.LOG"
    LOCAL cString := Space(0)
    LOCAL nLen
    LOCAL nHandle
    LOCAL x

    Mensagem("Aguarde, Registrando Log Recibo.")
    if !ms_swap_file(xLog)
        nHandle := ms_swap_fcreate( xLog, 0 )
        ms_swap_fclose( nHandle )
    endif

    nHandle := ms_swap_fopen( xLog, 2 + 64 )
    nErro := FLocate( nHandle, aLog[7])
    FBot( nHandle )

    if nErro < 0
        FWriteLine( nHandle, Repl("=", 186))
        FWriteLine( nHandle, "TIPO   CODI  NOME CLIENTE                             DOCTO N§  VENCTO   HORA     DATA_OS  USUARIO    CAIX       VALOR RECIBO HISTORICO")
        FWriteLine( nHandle, Repl("-", 186))
    endif

    nLen := Len(aLog)-3

    for x := 1 To nLen
        cString += aLog[x] + " "
    next

    FWriteLine( nHandle, cString )
    ms_swap_fclose(nHandle )

    if Recibo->(Incluiu())
        Recibo->Tipo     := aLog[1]
        Recibo->Codi     := aLog[2]
        Recibo->Nome     := aLog[3]
        Recibo->Docnr     := aLog[4]
        Recibo->Vcto     := Ctod(aLog[5])
        Recibo->Hora     := aLog[6]
        Recibo->Data     := Ctod(aLog[7])
        Recibo->Usuario := aLog[8]
        Recibo->Caixa     := aLog[9]
        Recibo->Vlr      := StrToVal(aLog[10])
        Recibo->Hist     := aLog[11]
        Recibo->Fatura  := aLog[14]
        Recibo->(Libera())
        return .T.
    endif
    return .F.


Function CalcJuros(dData, dVcto, nVlr)

LOCAL nAtraso      := 0
LOCAL nCarencia  := 0
LOCAL nTotJuros  := 0
LOCAL nVlrTotal  := 0
LOCAL nJuro      := oAmbiente:aSciArray[1,8]
LOCAL nDias      := 0
LOCAL nValorCm   := 0
LOCAL nCm        := 0
LOCAL aJuro      := 0
LOCAL nJuroDia   := 0
LOCAL nJuroTotal := 0
IF dData == NIL ; dData := Date() ; END
IF dVcto == NIL ; dVcto := Recemov->Vcto ; END
IF nVlr == NIL ; nVlr := Recemov->Vlr ; END

nAtraso     := Atraso( dData, dVcto )
nCarencia := Carencia( dData, dVcto)
nVlrTotal := nVlr

if nCarencia > 0








   nDias       := (dData-dVcto)
   nValorCm    := CalculaCm(nVlr, dVcto, dData)
   nCm         := (nValorCm - nVlr)
   aJuro       := aAntComposto( nValorCm, nJuro, nDias, (1/30))
   nJuroDia    := aJuro[6]
   nJuroTotal  := aJuro[5]
   nJuroTotal  += nCm
   nJuroDia    := (nJuroTotal / nDias)

    nTotJuros   := nJuroTotal
    nVlrTotal   += nTotJuros
    nMulta       := VlrMulta( dData, dVcto, nVlrTotal )
    nVlrTotal    += nMulta

endif
Return( nVlrTotal )














Function ImprimirEtiqueta( aConfig, oBloco )

LOCAL cScreen      := SaveScreen()
LOCAL nCampos      := 5
LOCAL nTamanho   := 35
LOCAL nMargem      := 0
LOCAL nLinhas      := 1
LOCAL nEspacos   := 1
LOCAL nCarreira  := 1
LOCAL nX           := 0
LOCAL aArray      := {}
LOCAL aGets       := {}
LOCAL lComprimir := .F.

if !InsTru80() .OR. !LptOk()
    ResTela( cScreen )
    Return
endif
nLen      := Len( aConfig )
if nLen > 0
    nCampos      := aConfig[1]
    nTamanho   := aConfig[2]
    nMargem      := aConfig[3]
    nLinhas      := aConfig[4]
    nEspacos   := aConfig[5]
    nCarreira  := aConfig[6]
    lComprimir := aConfig[7] == 1
    For nX := 8 To nLen
        Aadd( aGets, aConfig[nX] )
    Next
endif
aLinha := Array( aConfig[1] )
Afill( aLinha, "" )
PrintOn()
FPrint( _SALTOOFF )
if lComprimir
    FPrint( PQ )
endif
SetPrc( 0, 0 )
WHILE Eval( oBloco ).AND. !Rep_Ok()
    nCol := nMargem
    For nA := 1 To nCarreira
        For nB := 1 To nCampos
            cVar := aGets[nB]
            nTam := Len( &cVar. )
            aLinha[nB] += &cVar. + Space( ( nTamanho - nTam ) + nEspacos )
        Next
        DbSkip(1)
    Next
    For nC := 1 To nCampos
        Qout( aLinha[nC] )
        aLinha[nC] := ""
    Next
    For nD := 1 To nLinhas
        Qout()
    Next
EndDo
PrintOFF()
ResTela( cScreen )
Return

Proc ConfigurarEtiqueta()

LOCAL GetList      := {}
LOCAL cScreen      := SaveScreen()
LOCAL nCampos      := 5
LOCAL nTamanho   := 35
LOCAL nMargem      := 0
LOCAL nLinhas      := 1
LOCAL nEspacos   := 1
LOCAL nCarreira  := 1
LOCAL nComprimir := 0
LOCAL nSpVert      := 1
LOCAL nX           := 0
LOCAL aArray      := {}
LOCAL aGets       := {}
LOCAL cArquivo   := "ETIQUETA.ETI"
LOCAL oEtiqueta

SetKey( -41, NIL )
oMenu:Limpa()
MaBox( 05, 10, 07, 60 )
SetCursor(1) ; DevPos( 06, 11 ) ; DevOut( "Gravar no Arquivo.......:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cArquivo, "cArquivo", "@!", {|| PickArquivo( @cArquivo, "*.ETI", .T.)},))
ReadModal( GetList, NIL,,,,, ) ; GetList := {} ; ( GetList )
if LastKey() = 27
    SetKey( -41, {| p, l, v | ConfigurarEtiqueta( p, l, v ) } )
    ResTela( cScreen )
    Return
endif
oEtiqueta  := TIniNew( oAmbiente:xBaseDoc + "\" + cArquivo )
nCampos      := oEtiqueta:ReadInteger("configuracao", "Campos",    05 )
nTamanho   := oEtiqueta:ReadInteger("configuracao", "Tamanho",   35 )
nMargem      := oEtiqueta:ReadInteger("configuracao", "Margem",    00 )
nLinhas      := oEtiqueta:ReadInteger("configuracao", "Linhas",    01 )
nEspacos   := oEtiqueta:ReadInteger("configuracao", "Espacos",   01 )
nCarreira  := oEtiqueta:ReadInteger("configuracao", "Carreira",  01 )
nComprimir := oEtiqueta:ReadInteger("configuracao", "Comprimir", 00 )
nSpVert      := oEtiqueta:ReadInteger("configuracao", "Vertical",  01 )

MaBox( 08, 10, 17, 60 )
SetCursor(1) ; DevPos( 09, 11 ) ; DevOut( "Quantidade de Campos....:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( nCampos, "nCampos", "99", {| _1 | RangeCheck( _1,, 1, 16 ) },))
SetCursor(1) ; DevPos( 10, 11 ) ; DevOut( "Tamanho da Etiqueta.....:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( nTamanho, "nTamanho", "999", {| _1 | RangeCheck( _1,, 1, 120 ) },))
SetCursor(1) ; DevPos( 11, 11 ) ; DevOut( "Margem Esquerda.........:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( nMargem, "nMargem", "999", {| _1 | RangeCheck( _1,, 0, 250 ) },))
SetCursor(1) ; DevPos( 12, 11 ) ; DevOut( "Linhas Entre Etiquetas..:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( nLinhas, "nLinhas", "99", {| _1 | RangeCheck( _1,, 0, 16 ) },))
SetCursor(1) ; DevPos( 13, 11 ) ; DevOut( "Espaco Entre Etiquetas..:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( nEspacos, "nEspacos", "999", {| _1 | RangeCheck( _1,, 0, 120 ) },))
SetCursor(1) ; DevPos( 14, 11 ) ; DevOut( "Quantidade de Carreiras.:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( nCarreira, "nCarreira", "999", {| _1 | RangeCheck( _1,, 1, 8 ) },))
SetCursor(1) ; DevPos( 15, 11 ) ; DevOut( "Comprimir Impressao.....:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( nComprimir, "nComprimir", "9", {|| PickTam({"Nao","Sim"}, {0,1}, @nComprimir )},))
SetCursor(1) ; DevPos( 16, 11 ) ; DevOut( "Espacamento Vertical....:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( nSpVert, "nSpVert", "9", {|| PickTam({'1/6"','1/8"'}, {0,1}, @nSpVert )},))
ReadModal( GetList, NIL,,,,, ) ; GetList := {} ; ( GetList )
if LastKey() = 27
    SetKey( -41, {| p, l, v | ConfigurarEtiqueta( p, l, v ) } )
    ResTela( cScreen )
    Return
endif
For nX := 1 To nCampos
    cCampo := oEtiqueta:ReadString("campos", "campo" + StrZero( nX, 3), Space(60))
    cCampo += Space(60-Len(cCampo))
    Aadd( aGets, cCampo )
Next
oMenu:Limpa()
MaBox( 01, 01, 02+nCampos, 76, "DEFINICAO DOS CAMPOS DA ETIQUETA" )
For nX := 1 To nCampos
    cLinha := "Linha " + StrZero( nX, 2 ) + "...: "
    SetCursor(1) ; DevPos( 01+nX, 02 ) ; DevOut( cLinha ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( aGets[nX], "aGets[nX]", "@!",,))
Next
ReadModal( GetList, NIL,,,,, ) ; GetList := {} ; ( GetList )
if LastKey() = 27
    SetKey( -41, {| p, l, v | ConfigurarEtiqueta( p, l, v ) } )
    ResTela( cScreen )
    Return
endif
oEtiqueta:Close()
oEtiqueta  := TIniNew( oAmbiente:xBaseDoc + "\" + cArquivo )
oEtiqueta:WriteString("configuracao", "Campos",    StrZero( nCampos,    2))
oEtiqueta:WriteString("configuracao", "Tamanho",   StrZero( nTamanho,   3))
oEtiqueta:WriteString("configuracao", "Margem",    StrZero( nMargem,    3))
oEtiqueta:WriteString("configuracao", "Linhas",    StrZero( nLinhas,    2))
oEtiqueta:WriteString("configuracao", "Espacos",   StrZero( nEspacos,   3))
oEtiqueta:WriteString("configuracao", "Carreira",  StrZero( nCarreira,  2))
oEtiqueta:WriteString("configuracao", "Comprimir", StrZero( nComprimir, 1))
oEtiqueta:WriteString("configuracao", "Vertical",  StrZero( nSpVert,    1))
For nX := 1 To nCampos
    oEtiqueta:WriteString("campos",    "campo" + StrZero( nX, 3), ltrim(rtrim(aGets[nX])))
Next
SetKey( -41, {| p, l, v | ConfigurarEtiqueta( p, l, v ) } )
ResTela( cScreen )
Return

Proc Bordero()

LOCAL Getlist := {}
LOCAL cScreen := SaveScreen()
LOCAL aArray  := {}
LOCAL cDocnr  := Space(09)
LOCAL nTam      := 0
LOCAL nVlr      := 0
LOCAL nTitulo := 0

oMenu:Limpa()
WHILE .T.
    cDocnr := Space(09)
    MaBox( 10, 05, 16, 79 )
    SetCursor(1) ; DevPos( 11, 06 ) ; DevOut( "Documento N§.: " ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cDocnr, "cDocnr", "@!", {|| DocErrado( @cDocnr )},))
    DevPos( 12, 06 ) ; DevOut( "Cliente......: " )
    DevPos( 13, 06 ) ; DevOut( "Emissao......: " )
    DevPos( 14, 06 ) ; DevOut( "Vcto.........: " )
    DevPos( 15, 06 ) ; DevOut( "Valor........: " )
    ReadModal( GetList, NIL,,,,, ) ; GetList := {} ; ( GetList )
    if LastKey() = 27
        ResTela( cScreen )
        Exit
    endif
    Recemov->(Order( 1 ))
    Receber->(Order( 2 ))
    if Recemov->(DbSeek( cDocnr ))
        cCodi := Recemov->Codi
        Receber->(DbSeek( cCodi ))
        Write( 12, 22, Receber->Nome )
        Write( 13, 22, Recemov->Emis )
        Write( 14, 22, Recemov->Vcto )
        Write( 15, 22, Recemov->(Tran( Vlr, "@E 999,999,999.99")))
        if Conf("Pergunta: Selecionar para impressao ?")
            Aadd( aArray, cDocnr )
            nVlr     += Recemov->Vlr
            nTitulo++
        endif
    endif
    if nTitulo >= 14
        Exit
    endif
EndDo
nTam := Len( aArray )
if nTam > 0
    oMenu:Limpa()
    ErrorBeep()
    if !Conf("Pergunta: Deseja Imprimir os Registros ?")
        ResTela( cScreen )
        Return
    endif
    cPrefixo  := Space(07)
    cCodigo     := Space(10)
    cCedente  := Space(15)
    cCarteira := Space(03)
    cVar         := Space(04)
    cBordero  := Space(15)
    cPrefix     := Space(05)
    cEspecie  := Space(03)
    cInstru     := Space(05)
    dData      := Date()
    cResponsa := Space(10)
    cIof         := Space(03)
    cConta     := Space(15)
    cRazao     := Space(20)
    MaBox( 05, 10, 20, 60, "INFORMACOES COMPLEMENTARES")
    SetCursor(1) ; DevPos( 06, 11 ) ; DevOut( "Prefixo Usuario...:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cPrefixo, "cPrefixo", "@!",,))
    SetCursor(1) ; DevPos( 07, 11 ) ; DevOut( "Codigo Usuario....:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cCodigo, "cCodigo", "@!",,))
    SetCursor(1) ; DevPos( 08, 11 ) ; DevOut( "Codigo Cedente....:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cCedente, "cCedente", "@!",,))
    SetCursor(1) ; DevPos( 09, 11 ) ; DevOut( "Carteira..........:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cCarteira, "cCarteira", "@!",,))
    SetCursor(1) ; DevPos( 10, 11 ) ; DevOut( "Var...............:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cVar, "cVar", "@!",,))
    SetCursor(1) ; DevPos( 11, 11 ) ; DevOut( "N§ Bordero........:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cBordero, "cBordero", "@!",,))
    SetCursor(1) ; DevPos( 12, 11 ) ; DevOut( "Prefixo...........:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cPrefix, "cPrefix", "@!",,))
    SetCursor(1) ; DevPos( 13, 11 ) ; DevOut( "Especie...........:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cEspecie, "cEspecie", "@!",,))
    SetCursor(1) ; DevPos( 14, 11 ) ; DevOut( "Instrucoes Codif..:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cInstru, "cInstru", "@!",,))
    SetCursor(1) ; DevPos( 15, 11 ) ; DevOut( "Data Valorizacao..:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( dData, "dData", "##/##/##",,))
    SetCursor(1) ; DevPos( 16, 11 ) ; DevOut( "Codigo Responsab..:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cResponsa, "cResponsa", "@!",,))
    SetCursor(1) ; DevPos( 17, 11 ) ; DevOut( "Iof...............:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cIof, "cIof", "@!",,))
    SetCursor(1) ; DevPos( 18, 11 ) ; DevOut( "Conta Emitente....:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cConta, "cConta", "@!",,))
    SetCursor(1) ; DevPos( 19, 11 ) ; DevOut( "Razao Deposito....:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cRazao, "cRazao", "@!",,))
    ReadModal( GetList, NIL,,,,, ) ; GetList := {} ; ( GetList )
    if LastKey() = 27
        ResTela( cScreen )
        Return
    endif
    if Instru80() .AND. LptOk()
        PrintOn()
        FPrint( PQ )
        Write( 05, 006, ltrim(rtrim(oAmbiente:xNomefir)) )
        Write( 05, 110, "620.269.179-49" )
        Write( 07, 006, "AV CASTELO BRANCO, 693 - PIONEIROS" )
        Write( 07, 090, "76970-000" )
        Write( 07, 110, "PIMENTA BUENO" )

        Write( 09, 020, cPrefixo )
        Write( 09, 033, cCodigo )
        Write( 09, 049, cCedente )
        Write( 09, 074, cCarteira )
        Write( 09, 082, cVar )
        Write( 09, 091, cBordero )
        Write( 09, 118, cPrefix )
        Write( 09, 130, cEspecie )
        Write( 11, 010, Tran( nVlr, "@E 999,999,999.99"))
        Write( 11, 060, cInstru )
        Write( 11, 070, dData )
        Write( 11, 117, cResponsa )
        Write( 13, 004, cIof )
        Write( 13, 034, cConta )
        Write( 13, 060, cRazao )

        nCol    := 19
        nSoma := 0
        cDia    := StrZero( Day( Date()),2)
        cMes    := Mes( Date())
        cAno    := StrZero(Year( Date()),4)
        For nX := 1 To nTam
          if Recemov->(DbSeek( aArray[ nX ]))
                nSoma++
                if nSoma = 1
                    Write( nCol, 06, Recemov->Docnr )
                    Write( nCol, 34, Recemov->Vlr )
                    Write( nCol, 57, Recemov->Vcto )
                Else
                    Write( nCol, 075, Recemov->Docnr )
                    Write( nCol, 103, Recemov->Vlr )
                    Write( nCol, 125, Recemov->Vcto )
                    nSoma := 0
                    nCol++
                endif
            endif
        Next
        Write( 27, 003, "PIMENTA BUENO" )
        Write( 27, 034, cDia )
        Write( 27, 042, cMes )
        Write( 27, 063, cAno )
        Write( 27, 102, Tran( nVlr, "@E 999,999,999.99"))
        Write( 27, 122, nTam )
        __Eject()
        PrintOff()
    endif
endif
ResTela( cScreen )
Return

Function CepCerto( cCep, lModificar, cSwap )

FIELD Cep, Cida, Bair

if LastKey() = 5
    Return( .T. )
endif

if lModificar <> NIL .AND. lModificar
    if cCep == cSwap
        Return( .T. )
    endif
endif

if Empty( cCep )
    ErrorBeep()
    Alerta("Erro: Entrada de Cep Invalido.")
    Return( .F. )
endif
Cep->(Order( 1 ))
if Cep->(DbSeek( cCep ))
    ErrorBeep()
    Alerta("Erro: Cep Ja Registrado. " + Cep->( ltrim(rtrim(Cida))))
    Return( .F. )
endif
Return( .T. )

Function CepErrado( cCep, cCida, cEsta, cBair )

LOCAL aRotina              := {{|| CepInclusao()}}
LOCAL aRotinaAlteracao := {{|| CepInclusao( .T. )}}
LOCAL Ind_Ant              := IndexOrd()
LOCAL Arq_Ant              := Alias()

dbSelectArea( "Cep" )
Cep->(Order( 1 ))
if (Lastrec() = 0 )
    ErrorBeep()
    if Conf(" Pergunta: Nenhum Cep Disponivel. Registrar ?")
        CepInclusao()
    endif
    AreaAnt( Arq_Ant, Ind_Ant )
    Return( .F. )
endif
if Cep->(!DbSeek( cCep ))
    Cep->(Order( 2 ))
    Cep->(Escolhe( 03, 01, 22, "Cep + 'Ý' + Cida + 'Ý' + Esta + 'Ý' + Bair ", "CEP        CIDADE                      UF BAIRRO", aRotina,, aRotinaAlteracao ))
endif
cCep    := Cep->Cep
cCida := Cep->Cida
cEsta := Cep->Esta
if Empty( cBair )
    cBair := Cep->Bair
endif
AreaAnt( Arq_Ant, Ind_Ant )
Return( .T. )

Proc CepPrint()

LOCAL cScreen      := SaveScreen()
LOCAL aMenuArray := { " Video ", " Impressora " }
LOCAL nChoice := 0

M_Title("CONSULTA/IMPRESSAO DE CEP")
nChoice := FazMenu( 10,10, aMenuArray, Cor())
Do Case
    Case nChoice = 0
        ResTela( cScreen )
        Return

    Case nChoice = 1
        CepVideo()

    Case nChoice = 2
        CepImpressora()

EndCase

Proc CepVideo()

LOCAL cScreen := SaveScreen()
LOCAL aCep      := {}
LOCAL cTela

dbSelectArea( "Cep" )
Cep->(Order( 1 ))
Cep->(DbGoTop())
cTela := Mensagem("Aguarde ... ", Cor())

WHILE !Eof() .AND. Rep_Ok()
     Aadd( aCep,  Cep->Cep + " " + Cep->Cida + " " + Cep->Esta + " " + Cep->Bair )
     Cep->(DbSkip(1))
EndDo

if Len( aCep ) <> 0
    ResTela( cTela )
    cString := " CEP       CIDADE                    UF BAIRRO"
    Print( 00, 00, cString + Space( 80 - Len(  cString )), Roloc(Cor()))
    M_Title( "ESC Retorna ")
    FazMenu( 01, 00, aCep, Cor())
endif

ResTela( cScreen )
Return

Proc CepImpressora()

LOCAL cScreen := SaveScreen()
LOCAL Tam      := 80
LOCAL Col      := 58
LOCAL Pagina  := 0
LOCAL lSair   := .F.

if !InsTru80() .OR. !LptOk()
    ResTela( cScreen )
    Return
endif

dbSelectArea( "Cep" )
Cep->(Order( 1 ))
Cep->(DbGoTop())
Mensagem("Aguarde. Imprimindo.", Cor())
PrintOn()
SetPrc( 0, 0 )
WHILE Cep->(!Eof()) .AND. Rel_Ok()

  if Col >= 58
      Write( 00, 00, Linha1( Tam, @Pagina))
      Write( 01, 00, Linha2())
      Write( 02, 00, Linha3(Tam))
      Write( 03, 00, Linha4(Tam, SISTEM_NA2 ))
      Write( 04, 00, Padc( "LISTAGEM DE CEPS",Tam ) )
      Write( 05, 00, Linha5(Tam))
      Write( 06, 00, "CEP       CIDADE                    UF BAIRRO")
      Write( 07, 00, Linha5(Tam))
      Col := 8
  endif

  Qout( Cep, Cida, Esta, Bair )
  Col := Col + 1

  if Col >= 58
      Write( Col, 0,    Repl( "-", Tam ))
      __Eject()
  endif

  Cep->(DbSkip(1))
EndDo
__Eject()
PrintOff()
ResTela( cScreen )
Return


    Proc Edicao( lEditarArquivoDeConfiguracao, cTipoDeArquivo )

    LOCAL cScreen      := SaveScreen()
    LOCAL aMenuArray := {" Sci ", " Ed ", " Edit (DOS) ", " Notepad (Windows) "}
    LOCAL Files       := "*.DOC"
    LOCAL cFiles      := IF( cTipoDeArquivo <> NIL, cTipoDeArquivo, "" )
    LOCAL GetList      := {}
    LOCAL nChoice      := 1
    LOCAL cEditor
    PRIVA Arquivo

    FT_ChDir( oAmbiente:xBaseDoc )
    LETO_SET( 7, ( oAmbiente:xBaseDoc ) )
    if lEditarArquivoDeConfiguracao = NIL
        M_Title("EDITOR DE TEXTO")
        nChoice := FazMenu( 03, 05, aMenuArray, Cor())
        if nChoice = 0
            FT_ChDir( oAmbiente:xBaseDados )
            LETO_SET( 7, ( oAmbiente:xBaseDados ) )
            ResTela( cScreen )
            Return
        endif
        ResTela( cScreen )
        Arquivo := "CARTA.DOC" + Space(03)
        MaBox( 16, 10, 18, 61 )
        SetCursor(1) ; DevPos( 17, 11 ) ; DevOut( "Arquivo a Editar....:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( Arquivo, "Arquivo", "@!",,))
        ReadModal( GetList, NIL,,,,, ) ; GetList := {} ; ( GetList )
        if LastKey() = 27
            FT_ChDir( oAmbiente:xBaseDados )
            LETO_SET( 7, ( oAmbiente:xBaseDados ) )
            ResTela( cScreen )
            Return
        endif
        if Empty( Arquivo )
            M_Title( "Setas CIMA/BAIXO Move")
            Arquivo := Mx_PopFile( 03, 10, 15, 61, Files, Cor())
            if Empty( Arquivo )
                FT_ChDir( oAmbiente:xBaseDados )
                LETO_SET( 7, ( oAmbiente:xBaseDados ) )
                ErrorBeep()
                ResTela( cScreen )
                Return
            endif
        Else
            if nChoice <> 4
                if !File( Arquivo )
                    ErrorBeep()
                    ResTela( cScreen )
                    if !Conf( Rtrim( Arquivo ) + " Nao Encontrado. Posso Cria-lo ? ")
                        FT_ChDir( oAmbiente:xBaseDados )
                        LETO_SET( 7, ( oAmbiente:xBaseDados ) )
                        ResTela( cScreen )
                        Return
                    endif
                endif
            endif
        endif
    Else
        oMenu:Limpa()
        M_Title("ESCOLHA O ARQUIVO DE CONFIGURACAO A ALTERAR" )
        Arquivo := Mx_PopFile( 05, 10, 20, 74, cFiles, Cor() )
    endif
    if nChoice = 1
        SetKey( -9, NIL )
        SetKey( -1, NIL )
        SetKey( 28, NIL )
        SetColor("GR+/N")
        DispBox( 01, 00, 24-1, MaxCol(), 1 )
        SetColor("W/W")
        StatusSup("³F1=HELP³CTRL+P=IMPRIMIR³ESC=SAIR³F2=GRAVA E SAI³F3=LIG ACENTO³F4=DES ACENTO", Cor(2))
        StatusInf( RTrim( Arquivo),"")
        SetColor("B/W")
        SetCursor(1)

        MemoWrit( Arquivo, MemoEdit( MemoRead( Arquivo ), 02, 01, 24-2, (MaxCol()-2), .T., "Linha", 132))
        SetKey( -9, {| p, l, v | Calc( p, l, v ) } )
        oAmbiente:Acento := .F.
        ResTela( cScreen )
        Desliga_Acento()
        SetKey( 28, {| p, l, v | Help( p, l, v ) } )
        FT_ChDir( oAmbiente:xBaseDados )
        LETO_SET( 7, ( oAmbiente:xBaseDados ) )
        Return
    Elseif nChoice = 2
        cEditor := "Ed"
    Elseif nChoice = 3
        cEditor := "Edit"
    Elseif nChoice = 4
        cEditor := "Notepad"
    endif
    i = SWPUSEEMS(.T.)
    i = SWPUSEXMS(.T.)
    i = SWPUSEUMB(.T.)
    i = SWPCURDIR(.T.)
    i = SWPVIDMDE(.T.)
    i = SWPRUNCMD( ( cEditor + " " + Arquivo ), 0, "", "")
    ResTela( cScreen )
    FT_ChDir( oAmbiente:xBaseDados )
    LETO_SET( 7, ( oAmbiente:xBaseDados ) )
    Return

    Proc Comandos()

    LOCAL GetList    := {}
    LOCAL cScreen    := SaveScreen()
    LOCAL cComando := Space(256)
    WHILE .T.
        oMenu:Limpa()
        cComando := Space(256)
        MaBox( 20, 10, 22, 62 )
        SetCursor(1) ; DevPos( 21, 11 ) ; DevOut( "Comando :" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cComando, "cComando", "@!", {|| !Empty( cComando )},))
        ReadModal( GetList, NIL,,,,, ) ; GetList := {} ; ( GetList )
        if LastKey() = 27
            ResTela( cScreen )
            Exit
        endif
        SetColor("")
        Scroll() ; SetPos( 0, 0 )

        DosShell(ltrim(rtrim(cComando)))
    EndDo
    ResTela( cScreen )
    VerDataDos()
    Return

    Function DosBlinker(cComando)

        i = SWPUSEEMS(.T.)
        i = SWPUSEXMS(.T.)
        i = SWPUSEUMB(.T.)
        i = SWPCURDIR(.T.)
        i = SWPVIDMDE(.T.)
        i = SWPDISMSG(.T.)
        i = SWPRUNCMD( cComando, 0, "", "")
        Return NIL

    Function DosShell()

   local cOs    := Upper( OS() )
   local cShell := GetEnv("COMSPEC")

   if at( "WINDOWS", cOs ) <> 0 .OR. at( "DOS", cOs ) <> 0 .OR. at( "OS/2", cOs ) <> 0
      __Run( cShell )
   else
      QOut( "Sinto muito, este programa ‚ para Windows, DOS, e OS/2 somente" )
   endif
    return nil


    Function Linha( Mode, Line, Col )

    LOCAL nCopias      := 1
    LOCAL cScreen      := SaveScreen()
    LOCAL lCancel      := .F.
    LOCAL cOldColor  := SetColor()
    LOCAL Tela1

    DO Case
    Case Mode = 0
        StatusInf( Rtrim( Arquivo), StrZero( Line, 4) + ":" + StrZero( Col, 4 ))
        Return( 0 )

    Case LastKey() =    -1
        Return( 23 )

    Case LastKey() =    -2
        Liga_Acento()
        Return(1)

    Case LastKey() =    -3
        Desliga_Acento()
        Return(1)

    Case LastKey() =    27
        if Conf(" Deseja Gravar o Texto ? " )
            Return( 23 )

        endif

    Case LastKey() =    28
        MaBox( 10, 10, 17, 50, "COMANDOS DE EDICAO")
        Write( 11, 11, "CTRL+Y = Limpar Linha Corrente")
        Write( 12, 11, "CTRL+T = Eliminar Palavra a Direita")
        Write( 13, 11, "DELETE = Eliminar Caractere")
        Write( 14, 11, "INSERT = Liga/Desliga Insercao")
        Write( 15, 11, "HOME   = Vai para Inicio da Linha")
        Write( 16, 11, "END    = Vai para Final da Linha")
        Inkey(0)
        ResTela( cScreen )
        Return( 1 )

    Case LastKey() =    16
        nCopias := 1
        MaBox( 13, 10, 15, 31 )
        SetCursor(1) ; DevPos( 14, 11 ) ; DevOut( "Qtde Copias...:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( nCopias, "nCopias", "999", {|| nCopias > 0},))
        ReadModal( GetList, NIL,,,,, ) ; GetList := {} ; ( GetList )
        if LastKey() = 27 .OR. !Instru80()
            SetColor( cOldColor )
            ResTela( cScreen )
            Return
        endif
        Mensagem("Aguarde, Imprimindo.", Cor())
        PrintOn()
        SetPrc( 0, 0 )
        For X := 1 To nCopias
             Campo      := MemoRead( Arquivo )
             Linhas      := MlCount( Campo, 80 )
             For Linha := 1 To Linhas
                 Imprime := MemoLine( Campo, 80, linha )
                 Write( 0 + Linha -1, 0, Imprime )
             Next
             __Eject()
        Next
        PrintOff()
        SetColor( cOldColor )
        ResTela( cScreen )
        Return

    OtherWise
        Return(0)

    EndCase

    Proc Dos()

    LOCAL cScreen     := SaveScreen()
    LOCAL cOldColor := SetColor()
    LOCAL cOldDir     := Curdir()
    LOCAL nChoice
    SetColor("")
    Scroll() ; SetPos( 0, 0 )
    nChoice := Alerta("Para retornar ao Microbras SCI digite EXIT")
    if nChoice = 0
        ResTela( cScreen )
        SetColor( cOldColor )
        Return
    endif
    QOut( )
    QOut( )
    QOut( )
    i = SWPUSEEMS(.T.)
    i = SWPUSEXMS(.T.)
    i = SWPUSEUMB(.T.)
    i = SWPCURDIR(.T.)
    FT_ChDir( oAmbiente:xBase )
    i = SWPVIDMDE(.T.)
    i = SWPRUNCMD( "", 0, "", "")
    FT_ChDir( cOldDir )
    ResTela( cScreen )
    SetColor( cOldColor )
    VerDataDos()
    Return

    Proc MacroRestore()

    LOCAL GetList    := {}
    LOCAL aDrive    := { "A:","B:","C:","D:","E:","F:","G:","H:","I:","J:"}
    LOCAL aArray1    := { "Todos os Arquivos","Especificar Arquivo" }
    LOCAL aZip        := { "A:\SCI.ZIP", "B:\SCI.ZIP", "C:\SCIBACKU\","D:\SCIBACKU\","E:\SCIBACKU\","F:\SCIBACKU\"}
    LOCAL cScreen    := SaveScreen()
    LOCAL cComando := Space(256)
    LOCAL cOldDir    := Curdir()
    LOCAL nChoice    := 0
    LOCAL nChoice1 := 0
    LOCAL cFiles    := "*.ZIP"
    LOCAL cStr1     := ""
    LOCAL cStr2     := ""

    if !PodeFazerRestauracao()
        Return
    endif

    WHILE .T.
        M_Title("COPIA DE SEGURANCA - RESTAURACAO")
        nChoice := FazMenu( 08, 10, aDrive, Cor())
        if nChoice = 0
            ResTela( cScreen )
            Exit
        endif
        oMenu:Limpa()
        i = SWPUSEEMS(.T.)
        i = SWPUSEXMS(.T.)
        i = SWPUSEUMB(.T.)
        i = SWPCURDIR(.T.)
        i = SWPVIDMDE(.T.)
        i = SWPDISMSG(.T.)
        ErrorBeep()
        cStr1 := "Atencao Insira o disco de dados no " + aDrive[nChoice]
        if nChoice = 1
            cStr2 := "Dcomprim -d -o " + aZip[nChoice]
        Elseif nChoice = 2
            cStr2 := "Dcomprim -d -o " + aZip[nChoice]
        Elseif nChoice >= 3
            cFiles := aDrive[nChoice] + "\SCIBACKU\*.ZIP"
            if !File( cFiles )
              oMenu:Limpa()
              ErrorBeep()
              Alert("Erro: Arquivos de Backup nao disponiveis.")
              ResTela( cScreen )
              Exit
            endif
            oMenu:Limpa()
            M_Title("ESCOLHA O ARQUIVO PARA RESTAURACAO")
            xArquivo := Mx_PopFile( 05, 10, 20, 74, cFiles, Cor() )
            if Empty( xArquivo )
                ErrorBeep()
                ResTela( cScreen )
                Exit
            endif
            cStr2 := "Dcomprim -d -o " + xArquivo
        endif
        M_Title("COPIA DE SEGURANCA - OPCOES")
        nChoice1 := FazMenu( 12, 12, aArray1, Cor())
        if nChoice1 = 0
            ResTela( cScreen )
            Exit
        endif
        if nChoice1 = 1
            if Alert( cStr1, { " Cancelar ", " Continuar " }) = 2
                SetColor("")
                Scroll() ; SetPos( 0, 0 )
                FT_ChDir( oAmbiente:xBase )
                i := SWPRUNCMD( cStr2, 0, "", "" )
                FT_ChDir( cOldDir )
            endif
        Else
            cEspFile := Space( 40 )
            MaBox( 20, 12, 22, 75 )
            SetCursor(1) ; DevPos( 21, 13 ) ; DevOut( "Arquivos :" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cEspFile, "cEspFile", "@!", {|| !Empty( cEspFile )},))
            ReadModal( GetList, NIL,,,,, ) ; GetList := {} ; ( GetList )
            if LastKey() = 27
                ResTela( cScreen )
                Return
            endif
            if Alert( cStr1, { " Cancelar ", " Continuar " }) = 2
                 SetColor("")
                 Scroll() ; SetPos( 0, 0 )
                 FT_ChDir( oAmbiente:xBase )
                 i := SWPRUNCMD( cStr2 + " " + ( cEspFile ), 0, "", "" )
                 FT_ChDir( cOldDir )
             endif
        endif
        ResTela( cScreen )
    EndDo
    Return

    Proc MacroBackup()

    LOCAL GetList    := {}
    LOCAL aArray    := { "A:","B:","C:","D:","E:","F:","G:","H:","I:","J:"}
    LOCAL cScreen    := SaveScreen()
    LOCAL cComando := Space(256)
    LOCAL cOldDir    := Curdir()
    LOCAL cData     := " -S" + StrTran(Dtoc(Date()),"/") + " "
    LOCAL cPath
    LOCAL xDiretorio
    LOCAL xString
    LOCAL xDrive

    if !PodeFazerBackup()
        Return
    endif
    WHILE .T.
        M_Title("COPIA DE SEGURANCA - BACKUP")
        nChoice := FazMenu( 05, 10, aArray, Cor())
        if nChoice = 0
            ResTela( cScreen )
            Exit
        endif
        oMenu:Limpa()
        i = SWPUSEXMS(.T.)
        i = SWPUSEUMB(.T.)
        i = SWPCURDIR(.T.)
        i = SWPVIDMDE(.T.)
        i = SWPDISMSG(.T.)
        ErrorBeep()
        xDrive := aArray[nChoice]
        if nChoice = 1 .OR. nChoice = 2
            if Alert("Atencao Todos o dados do Drive " + xDrive + " serao apagados.", { " Cancelar ", " Continuar " }) = 2
                SetColor("")
                Scroll() ; SetPos( 0, 0 )
                FT_ChDir( oAmbiente:xBase )

                xString := "COMPRIME -EX -RP " + cData + " -&F " + xDrive + "\SCI *.DBF + *.CFG + *.DOC + *.TXT + *.PRO + *.LIS + *.BAT + *.LOG + *.ETI + *.NFF + *.COB + *.DUP + *.DIV"
                i          := SWPRUNCMD( xString, 0, "", "" )
                FT_ChDir( cOldDir )
            endif
        Elseif nChoice > 2
            xDiretorio := xDrive + "\SCIBACKU"
            cDiaMes      := Left( StrTran( Dtoc( Date()), "/"), 4 )
            cDia          := xDiretorio + "\SCI" + cDiaMes
            FT_MkDir( xDiretorio )
            if Conf("Proceder com a copia de Seguranca para " + xDrive + " ?")
                SetColor("")
                Scroll() ; SetPos( 0, 0 )
                FT_ChDir( oAmbiente:xBase )
                xString := "COMPRIME -EX -RP" + cData + cDia + " *.DBF + *.CFG + *.DOC + *.TXT + *.PRO + *.LIS + *.BAT + *.LOG + *.ETI + *.NFF + *.COB + *.DUP + *.DIV"
                i          := SWPRUNCMD( xString, 0, "", "" )
                FT_ChDir( cOldDir )
            endif
        endif
        ResTela( cScreen )
    EndDo
    Return










Proc AtivaRegNew( lAtivaRegNew )

if lAtivaRegNew
    lAtivaRegNew := .F.
    Alert("Busca Proximo Registro DESATIVADA.")
    Return
endif
lAtivaRegNew := .T.
Alert("Busca Proximo Registro ATIVADA.")
Return

Function Tbdemo( Dbf, Index )

LOCAL cScreen    := SaveScreen()
LOCAL Files     := oAmbiente:xBaseDados + "\*.DBF"
LOCAL nColor   := 31
LOCAL cArquivo
LOCAL oBrowse

while( .T. )
    FT_ChDir( oAmbiente:xBaseDados )
    LETO_SET( 7, ( oAmbiente:xBaseDados ) )
    oMenu:Limpa()
    M_Title( "Setas CIMA/BAIXO Move")
    cArquivo := Mx_PopFile( 02, 10, 20, 57, Files, Cor())
    if Empty( cArquivo )
        Tone(1)
        ResTela( cScreen )
        Exit
    endif
    xArquivo := cArquivo
    cArquivo := StrTran( cArquivo, ".DBF", "")
    cArquivo := StrTran( cArquivo, oAmbiente:xBaseDados + "\", "")
    if !UsaArquivo( cArquivo )
        MensFecha()
        Loop
    endif
    oBrowse    := MsBrowse():New()
    nLen        := FCount()
    For i := nLen To 1 Step -1
        oColuna := TBColumnNew( field( i ), FieldWBlock( field( i ), select() ) )
        oBrowse:InsColumn( oBrowse:ColPos, oColuna )
    Next
    oBrowse:Titulo   := "CONSULTA/ALTERACAO/EXCLUSAO ["+ xArquivo + "]"
      oBrowse:PreDoGet := NIL
    oBrowse:PosDoGet := NIL
    oBrowse:Show()
    oBrowse:Processa()
EndDo
ResTela( cScreen )
Mensagem("Aguarde...", Cor())
FechaTudo()
Return

Func VerDataDos()

LOCAL cLimite
LOCAL cDataDos

CenturyOn()
cLimite    := oAmbiente:xDataCodigo
cDataDos := Dtoc( Date())
if Ctod( cDataDos ) > Ctod( cLimite )
    Hard( 1, ProcName(), ProcLine() )
    SetColor("")
    Scroll() ; SetPos( 0, 0 )
    __Quit()
endif
CenturyOff()
Return

function ProBranco( cCodi_Cli, aReg )

LOCAL GetList         := {}
LOCAL cScreen         := SaveScreen()
LOCAL nMoeda         := 1
LOCAL _QtDup         := 0
LOCAL nLargura     := 132
LOCAL nAltura       := oIni:ReadInteger("relatorios","tampromissoria", 33 )
LOCAL cNomeEmpresa := oIni:ReadString("sistema","nomeempresa", ltrim(rtrim(oAmbiente:xNomefir)) )
LOCAL cFantasia     := oIni:ReadString("sistema","fantasia", "TURBONET INFORMATICA" )
LOCAL cCgcEmpresa  := oIni:ReadString("sistema","cgcempresa", "620.269.179-49" )
LOCAL cNomeSocio     := oIni:ReadString("sistema","nomesocio", "VILMAR CATAFESTA" )
LOCAL cCpfSocio     := oIni:ReadString("sistema","cpfsocio", "620.269.179-49" )
LOCAL cStr1
LOCAL cStr2
LOCAL nConta
LOCAL Col
LOCAL Var1
LOCAL var2
LOCAL i
LOCAL Larg
LOCAL nLinhas
LOCAL cDia
LOCAL cMes
LOCAL cAno
LOCAL Vlr_Dup


    cStr1 := cNomeSocio
    cStr2 := cCpfSocio





WHILE .T.
    if PCount() = 0
        cCodi_Cli := Space(05)
        aReg         := {}
        aReg         := EscolheTitulo( cCodi_Cli )
    endif
    if ( _QtDup := Len( aReg )) = 0
       return(Restela( cScreen))
    endif
    if !Instru80()
        Loop
    endif
    Mensagem("Aguarde, Imprimindo Promissorias. ESC Cancela.", 47 )
    PrintOn()
    Fprint( RESETA )
    FPrInt( Chr(27) + "C" + Chr(nAltura))
    FPrint( PQ )
    FPrint( NG )
    SetPrc( 0, 0 )
    nConta := 0
    Col     := 0
    Receber->(Order( 2 ))
    Recemov->(Order( 2 ))
    dbSelectArea( "Recemov" )
    if ( ! .F. ) ; dbClearRelation() ; end ; dbSetRelation( "Receber", {|| Recemov->Codi}, "Recemov->Codi", .F. )
    Recemov->(Order( 2 ))
    FOR i :=  1 TO _qtdup
        DbGoto( aReg[i] )
        if Receber->Cgc = "  .   .   /    -  " .OR. Receber->Cgc = Space( 18 )
            Var1 := Receber->Cpf
            Var2 := Receber->Rg
        Else
            Var1 := Receber->Cgc
            Var2 := Receber->Insc
        endif
        Larg      := 125-41
        nLinhas := 2
        cMes      := Mes( Date())
        cDia      := Left( Dtoc( Date()),2)
        cAno      := Right( Dtoc( Date()),1)
        Vlr_Dup := Extenso( Recemov->Vlr, nMoeda, nLinhas, Larg )
        Write( Col,   000, PQ + Repl("=", nLargura))
        Write( Col+1, 000, PQ + "N§ " + Recemov->Docnr)
        Write( Col+1, 113, PQ + "VENCIMENTO: " + Dtoc(Recemov->Vcto) )
        Write( Col+2, 112, PQ + "VALOR R$  : " + ltrim(rtrim(Tran( Recemov->Vlr, "@E 9,999,999,999.99"))))
        Write( Col+3, 000, "No " + PQ + DataExtenso( Recemov->Vcto ) + "." + C18 )
        Write( Col+4, 000, "pagarei por unica via de " + GD + "NOTA PROMISSORIA")
        Write( Col+6, 000, "a " + PQ + cStr1 + C18)
        Write( Col+6, 070, "CNPJ/CPF " + PQ + cStr2 + C18 )
        Write( Col+8, 000, "ou a sua ordem a quantia de " + PQ + Left( Vlr_Dup, Larg) + C18 )
        Write( Col+9, 000, PQ + Right( Vlr_Dup, Larg-4) + " em moeda corrente deste pais.")
        Write( Col+11, 000, "Pagavel em: " + PQ + "PIMENTA BUENO" + "/" + "RO" + C18 )
        Write( Col+12, 000, "Emitente  : " + PQ + Receber->Nome + " " + Receber->Codi + Space(14) + "PIMENTA BUENO" + "/" + "RO" + ", " + DataExt1( Date()) + C18 )
        Write( Col+13, 000, "Cnpj/Cpf  : " + PQ + Var1 + C18 )
        Write( Col+14, 000, "Endereco  : " + PQ + Receber->Ende + " - " + Receber->(ltrim(rtrim(Cida)) + "/" + Esta ) + C18 )

        Write( Col+17, 000, PQ + Repl("_",50) + Space(22) + Repl("_",60) + C18 )
        Write( Col+18, 000, PQ + "AVALISTA : " + Receber->Conhecida + Space(21) + Receber->Nome + C18 )
        Write( Col+19, 000, PQ + "CPF      : " + Receber->CpfAval + C18 )
        Write( Col+20, 000, PQ + Repl("=", nLargura))
        nConta++
        __Eject()
        nConta := 0
        Col     := 0
    Next
    PrintOff()
    Recemov->(DbClearRel())
    Recemov->(DbGoTop())
    if PCount() <> 0
        ResTela( cScreen )
        Return
    endif
EndDo
ResTela( cScreen )
Return

Proc DupPersonalizado( cCodi_Cli, aReg )

LOCAL GetList            := {}
LOCAL cScreen            := SaveScreen()
LOCAL nMoeda            := 1
LOCAL aMenu             := { "Imprimir, Usando um Arquivo Existente", "Criar Arquivo de Configuracao ", "Alterar Arquivos de Duplicata", "Configurar arquivos padrao"}
LOCAL aNt                := {}
LOCAL nChoice            := 0
LOCAL lRetornoBeleza := .F.
LOCAL nLen                := 0
LOCAL _QtDup            := 0
LOCAL nX                 := 0
LOCAL cVar1             := ""
LOCAL cVar2             := ""
LOCAL cCepPagto        := ""
LOCAL cCidaPagto        := ""
LOCAL cEstaPagto        := ""
LOCAL nLargura         := 0
LOCAL cExtenso         := ""
LOCAL aDados            := {}
LOCAL aMoeda            := {"R$ ", "US$ ", "URV " }
LOCAL cMoeda            := aMoeda[1]
LOCAL nPag                := 0
LOCAL lImprimir        := .F.
LOCAL i                    := 0
LOCAL Larg                := 0
LOCAL Vlr_Dup            := 0
LOCAL nA                 := 0
LOCAL cMora             := ""
LOCAL xDuplicata        := oIni:ReadString("impressao", "dup", NIL )
LOCAL aDuplicata


WHILE .T.
    if PCount() = 0
        cCodi_Cli := Space(05)
        aReg         := {}
        aReg         := EscolheTitulo( cCodi_Cli )
    endif
    if ( _QtDup := Len( aReg )) = 0
        ResTela( cScreen )
        Return
    endif
    if xDuplicata = NIL
        ErrorBeep()
        WHILE .T.
            lImprimir := .F.
            oMenu:Limpa()
            M_Title("IMPRESSAO DE DUPLICATAS")
            nChoice := FazMenu( 10, 10, aMenu, Cor())
            Do Case
            Case nChoice = 0
                Exit
            Case nChoice = 1
                ErrorBeep()
                aDuplicata := LerDuplicata(, @lRetornoBeleza )
                if !lRetornoBeleza
                    Loop
                endif
                lImprimir := .T.
                Exit
            Case nChoice = 2
                GravaDuplicata()
                Loop
            Case nChoice = 3
                Edicao( .T., "*.DUP" )
                Loop
            Case nChoice = 4
                ConfImpressao()
            EndCase
            lImprimir := .T.
            Exit
        EndDo
        if !lImprimir
            aReg := {}
            Loop
        endif
    Else
        aDuplicata := LerDuplicata( xDuplicata, @lRetornoBeleza )
        if !lRetornoBeleza
            xDuplicata := NIL
            Loop
        endif
        lImprimir := .T.
    endif
    if !InsTru80() .OR. !Rep_Ok()
        ResTela( cScreen )
        Exit
    endif
    cMoeda := aMoeda[IF( nMoeda = 0, 1, nMoeda )]
    Mensagem("Aguarde Imprimindo Duplicatas. ESC Cancela.", 47 )
    PrintOn()







        FPrint( RESETA )
        anT                        := aDuplicata
        XIMPRIMIRCONDENSADO    := 01
        XIMPRIMIR12CPI         := 02
        XIMPRIMIRNEGRITO        := 03
        XESPACAMENTOVERTICAL := 04
        nPag                        := 05
        XTAMANHOEXTENSO        := 31
        if aNt[XIMPRIMIRCONDENSADO,1]  > 0 ; FPrint( PQ )            ; endif
        if aNt[XIMPRIMIR12CPI,1]         > 0 ; FPrint( _CPI12 )     ; endif
        if aNt[XIMPRIMIRNEGRITO,1]      > 0 ; FPrint( NG )            ; endif
        if aNt[XESPACAMENTOVERTICAL,1] = 0 ; FPrint( _SPACO1_6 ) ; endif
        if aNt[XESPACAMENTOVERTICAL,1] = 1 ; FPrint( _SPACO1_8 ) ; endif
        FPrInt( Chr( 27 ) + "C" + Chr( anT[nPag,01]))
        SetPrc( 0,0 )

    Cep->(Order( 1 ))
    FOR i :=  1 TO _qtdup
        Recemov->(DbGoto( aReg[i] ))
        if Receber->Cgc = "  .   .   /    -  " .OR. Receber->Cgc = Space( 18 )
            cVar1 := Receber->Cpf
            cVar2 := Receber->Rg
        Else
            cVar1 := Receber->Cgc
            cVar2 := Receber->Insc
        endif




            cCepPagto  := Receber->Praca
            cCidaPagto := Receber->Cida
            cEstaPagto := Receber->Esta
            if Cep->(DbSeek( cCepPagto ))
                cCidaPagto := Cep->Cida
                cEstaPagto := Cep->Esta
            endif
            Larg      := IF( anT[XTAMANHOEXTENSO,01] >= 0, anT[XTAMANHOEXTENSO,01], 56 )
            Vlr_Dup := Extenso( Recemov->Vlr, nMoeda, 2, Larg )
            cMora   := cMoeda + ltrim(rtrim(Tran( Recemov->Jurodia,"@E 999,999.99")))
            aDados  := {}
            Aadd( aDados, ltrim(rtrim(oAmbiente:xNomefir)) )
            Aadd( aDados, "AV CASTELO BRANCO, 693 - PIONEIROS" )
            Aadd( aDados, "620.269.179-49" )
            Aadd( aDados, "3.708.860-9 SSP/PR" )
            Aadd( aDados, Recemov->Emis )
            Aadd( aDados, Tran( Recemov->VlrFatu,"@E 999,999,999.99" ))
            Aadd( aDados, Recemov->Fatura )
            Aadd( aDados, Tran( Recemov->Vlr,"@E 999,999,999.99" ))
            Aadd( aDados, Recemov->Docnr )
            Aadd( aDados, Recemov->Vcto )
            Aadd( aDados, cMora )
            Aadd( aDados, Recemov->CodiVen )
            Aadd( aDados, Receber->Nome )
            Aadd( aDados, Receber->Codi )
            Aadd( aDados, Receber->Ende )
            Aadd( aDados, Receber->Bair )
            Aadd( aDados, Receber->Cida )
            Aadd( aDados, Receber->Cep )
            Aadd( aDados, Receber->Esta )
            Aadd( aDados, cCidaPagto )
            Aadd( aDados, Receber->Praca )
            Aadd( aDados, cEstaPagto )
            Aadd( aDados, cVar1 )
            Aadd( aDados, cVar2 )
            Aadd( aDados, Left( Vlr_Dup, Larg ))
            Aadd( aDados, Right( Vlr_Dup, Larg ))
            Aadd( aDados, Receber->Banco )
            nLen := (Len( anT )-2)
            For nA := 6 To nLen
                if nA = 30
                    IF( anT[nA, 01] >= 0, Write( anT[nA, 01],   anT[nA, 02], aDados[nA-5] ),)
                    IF( anT[nA, 01] >= 0, Write( anT[nA, 01]+1, anT[nA, 02], aDados[nA-4] ),)
                Else
                    IF( anT[nA, 01] >= 0, Write( anT[nA, 01], anT[nA, 02], aDados[nA-5] ),)
                endif
            Next
            IF( anT[32, 01] >= 0, Write( anT[32, 01], anT[32, 02], aDados[27]),)
            __Eject()

    Next
    PrintOff()
    Recemov->(DbClearRel())
    Recemov->(DbGoTop())
    if PCount() <> 0
        ResTela( cScreen )
        Return
    endif
EndDo

Proc SubDuplicata( cVar1, cVar2, nMoeda )

LOCAL nLargura  := 53
LOCAL nVlr_Dup  := Extenso( Recemov->Vlr, nMoeda, 3, nLargura )
LOCAL cDia         := StrZero( Day( Recemov->Emis ), 2 )
LOCAL cMes         := Mes( Recemov->Emis )
LOCAL cAno         := StrZero( Year( Recemov->Emis ),4)

Write( 01, 96 , Recemov->Vcto )
Write( 03, 50 , cDia )
Write( 03, 56 , cMes )
Write( 03, 75 , Right( cAno, 1 ))
Write( 03, 85 , Left( Receber->Nome, 18))
Write( 04, 81 , Right( Receber->Nome, 22))
Write( 06, 85 , Tran( Recemov->Vlr,"@E 9,999,999,999.99" ))
Write( 07, 00 , Tran( Recemov->VlrFatu,"@E 999,999,999.99" ))
Write( 07, 19 , Recemov->Fatura )
Write( 07, 32 , Tran( Recemov->Vlr,"@E 9,999,999,999.99" ))
Write( 07, 52 , Recemov->Docnr )
Write( 07, 65 , Recemov->Vcto )
Write( 10, 27 , ltrim(rtrim(Tran( Recemov->Vcto - Recemov->Emis, "999"))) + " DIAS * " + Recemov->Fatura )
Write( 11, 81 , Recemov->Docnr )
Write( 13, 23 , Receber->Nome + Space(07) + Receber->Codi )
Write( 14, 23 , Receber->Ende + Space(12) + Right( Receber->Fone, 8))
Write( 15, 23 , Receber->Cep + "/" + Receber->Cida + Space(11) + Receber->Esta )
Write( 16, 23 , Receber->Cep + "/" + Receber->Cida + Space(11) + Receber->Esta )
Write( 17, 23 , cVar1 )
Write( 17, 57 , cVar2 )
Write( 18, 96 , Recemov->Vcto )
Write( 19, 23 , Left( nVlr_Dup, nLargura ))
Write( 20, 23 , SubStr( nVlr_Dup, nLargura + 1, nLargura ))
Write( 20, 85 , Left( Receber->Nome, 18))
Write( 21, 23 , Right(    nVlr_Dup, nLargura ))
Write( 21, 81 , Right( Receber->Nome, 22))
Write( 23, 85 , Tran( Recemov->Vlr,"@E 9,999,999,999.99" ))
Write( 26, 11 , "TRAB: " + Receber->Trabalho + " CARGO: " + Receber->Cargo )
Write( 28, 81 , Recemov->Docnr )
return


function ProxCodigo( cCodigo )

    return( StrZero( Val( cCodigo ) + 1, 6 ))

Function PedePermissao( nNivel, cAutorizado )

LOCAL GetList    := {}
LOCAL Arq_Ant    := Alias()
LOCAL Ind_Ant    := IndexOrd()
LOCAL cScreen    := SaveScreen()
LOCAL cRetorno := .F.
LOCAL cNome    := Space(10)
LOCAL cPasse   := Space(10)
LOCAL cSenha
LOCAL Passe
LOCAL cPara     := ""



















LOCAL aPara    := { {10,  "ALTERAR REGISTROS           "}, {11,  "EXCLUIR REGISTROS           "}, {12,  "FAZER DEVOLUCAO DE FATURA   "}, {13,  "FAZER PAGAMENTOS            "}, {14,  "FAZER RECEBIMENTOS          "}, {40,  "FAZER RECIBO VLR ZERADO OU A MENOR "}, {20,  "FATURA COM ESTOQUE NEGATIVO OU ZERADO"}, {21,  "VENDER COM LIMITE ESTOURADO "}, {25,  "EXCEDER DESCONTO MAXIMO     "}, {26,  "FAZER DEVOLUCAO DE ENTRADAS "}, {27,  "ALTERAR EMISSAO DA FATURA   "}, {28,  "ALTERAR DATA RECEBIMENTO    "}, {30,  "ALTERAR DATA DO FATURAMENTO "}, {31,  "ALTERAR DATA DE RECEBIMENTO "}, {120, "VERIFICAR PRECO DE CUSTO    "}, {200, "USAR TECLAS CTRL+P          "}, {300, "VISUALIZAR DETALHE DE CAIXA "}, {400, "VENDER COM DEBITO EM ATRASO "}, {500, "IMPRIMIR RELATORIO DE COBRANCA"}}
FIELD Senha

if !AbreUsuario()
    AreaAnt( Arq_Ant, Ind_Ant )
    return( .F. )
endif

oMenu:Limpa()
dbSelectArea( "Usuario" )
Usuario->(Order( 1 ))

WHILE .T.
   nPos   := Ascan2( aPara, nNivel, 1 )

    if nPos <> 0
        cPara := aPara[nPos,2 ]
    endif

    MaBox( 10, 15, 14, 70, "SOLICITACAO DE PERMISSAO" )
    DevPos( 11, 16 ) ; DevOut( "Para....:   " + cPara )
   SetCursor(1) ; DevPos( 12, 16 ) ; DevOut( "Usuario.:  " ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cNome, "cNome", "@!", {|| UsuarioErrado( @cNome )},))
    SetCursor(1) ; DevPos( 13, 16 ) ; DevOut( "Senha...:  " ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cPasse, "cPasse", "@S", {|| SenhaErrada(cNome, cPasse)},))
    ReadModal( GetList, NIL,,,,, ) ; GetList := {} ; ( GetList )

    if LastKey() = 27
        Usuario->(DbCloseArea())
        AreaAnt( Arq_Ant, Ind_Ant )
        Restela( cScreen )
        Return( .F. )
    endif

    cNome    := ltrim(rtrim(cNome))
    cRetorno := .F.
   if     nNivel = 11
      cRetorno := IF( Usuario->(MSDecrypt( NivelA)) = "S", .T., .F. )
      if !cRetorno
         cRetorno := TIniNew(cNome + ".INI"):ReadBool("permissao","PodeExcluirRegistros", .F. )
      endif
    elseif nNivel = 10
      cRetorno := IF( Usuario->(MSDecrypt( Nivel0)) = "S", .T., .F. )
      if !cRetorno
         cRetorno := TIniNew(cNome + ".INI"):ReadBool("permissao","PodeAlterarRegistros", .F. )
      endif
   Elseif nNivel = 12
       cRetorno := IF( Usuario->(MSDecrypt( NivelB)) = "S", .T., .F. )
   Elseif nNivel = 27
         cRetorno := IF( Usuario->(MSDecrypt( NivelB)) = "S", .T., .F. )
     Elseif nNivel = 13
         cRetorno := IF( Usuario->(MSDecrypt( NivelC)) = "S", .T., .F. )
     Elseif nNivel = 14
         cRetorno := IF( Usuario->(MSDecrypt( NivelD)) = "S", .T., .F. )
     Elseif nNivel = 21
         cRetorno := IF( Usuario->(MSDecrypt( NivelK)) = "S", .T., .F. )
     Elseif nNivel = 26
         cRetorno := IF( Usuario->(MSDecrypt( NivelP)) = "S", .T., .F. )
     Elseif nNivel = 25
         cRetorno := IF( Usuario->(MSDecrypt( NivelO)) = "S", .T., .F. )
     Elseif nNivel = 20
         cRetorno := IF( Usuario->(MSDecrypt( NivelJ)) = "S", .T., .F. )
     Elseif nNivel = 27
         cRetorno := IF( Usuario->(MSDecrypt( NivelQ)) = "S", .T., .F. )
     Elseif nNivel = 28
         cRetorno := IF( Usuario->(MSDecrypt( NivelR)) = "S", .T., .F. )
     Elseif nNivel = 120
         cRetorno := IF( Usuario->(MSDecrypt( NivelB)) = "S", .T., .F. )
     Elseif nNivel = 200
       cRetorno := TIniNew( cNome + ".INI"):ReadBool("permissao","usarteclactrlp", .F. )
     Elseif nNivel = 300
       cRetorno := TIniNew( cNome + ".INI"):ReadBool("permissao","visualizardetalhecaixa", .F. )
     Elseif nNivel = 400
       cRetorno := TIniNew( cNome + ".INI"):ReadBool("permissao","vendercomdebito", .F. )
     Elseif nNivel = 500
       cRetorno := TIniNew( cNome + ".INI"):ReadBool("permissao","imprimirrolcobranca", .F. )
     Elseif nNivel = 40
       cRetorno := TIniNew( cNome + ".INI"):ReadBool("permissao","recibozerado", .F. )
     endif
     Usuario->(DbCloseArea())

    if !cRetorno
       cRetorno := TIniNew(cNome + ".INI"):ReadBool("permissao","usuarioadmin", .F.)
    endif

     if !cRetorno
         AreaAnt( Arq_Ant, Ind_Ant )
         ErrorBeep()
       Alert("ERRO: Solicite autorizacao para a tarefa.")
         ResTela( cScreen )
         Return( .F. )
     endif

     if cAutorizado <> NIL
         cAutorizado := cNome
     endif

     AreaAnt( Arq_Ant, Ind_Ant )
     ResTela( cScreen )
     return( cRetorno )
EndDo



Function PickTam2( aNatu, aCfop, aTxIcms, cCfop, cNatu, nTxIcms )

LOCAL GetList     := {}
LOCAL cScreen     := SaveScreen()
LOCAL nLen         := Len( aCfop )
LOCAL aJunto     := {}
LOCAL nPos
LOCAL nChoice

if LastKey() = 5
    Return( .T. )
endif

if cCfop == "0.000"
    IncluiCfop()
    aNatu   := LerNatu()
    aCfop   := LerCFop()
    aTxIcms := LerIcms()
    ResTela( cScreen )
    Return( .F. )
endif

if cCfop <> Space(05)
    nPos := Ascan( aCfop, cCfop )
    if nPos <> 0
        cNatu := aNatu[nPos]
        if aTxIcms[nPos] <> 0 .OR. cCfop <> Space(05) .OR. cCfop <> " .   " .OR. !Empty( cNatu )
            nTxIcms := aTxIcms[nPos]
            Return( .T. )
        endif
    endif
endif
nLen := Len( aCfop )
For i := 1 To nLen
    Aadd( aJunto, Tran(aCfop[i],"9.999") + "|" + Tran( aTxIcms[i], "99.99") + "|" + aNatu[i] )
Next
MaBox( 10, 01, 12+nLen, 45, NIL, NIL, Roloc( Cor()) )
if (nChoice := AChoice( 11, 03, 10+nLen, 44, aJunto )) <> 0
    cCfop   := aCfop[ nChoice ]
    cNatu   := aNatu[ nChoice ]
    nTxIcms := aTxIcms[ nChoice ]
    if cCfop == "0.000"
        IncluiCfop()
        aNatu   := LerNatu()
        aCfop   := LerCFop()
        aTxIcms := LerIcms()
        ResTela( cScreen )
        Return( .F. )
    endif
endif
ResTela( cScreen )
Return( .T. )

Function VerCfop( xcFop)

LOCAL GetList := {}
LOCAL aCfop   := LerCfop()

if xcFop == Space(05) .OR. xcFop = " .   "
    ErrorBeep()
    Alerta("Erro: Cfop invalido.")
    Return( .F. )
endif
if Ascan( aCfop, xcFop ) <> 0
    ErrorBeep()
    Alerta("Erro: Cfop ja registrado.")
    Return( .F. )
endif
Return( .T. )

Function LerCfop()

LOCAL GetList := {}
LOCAL cFile   := "CFOP.INI"
LOCAL aCfop   := {"0.000","5.102","6.102","5.915", "6.915"}
LOCAL nCampos := 0
LOCAL n          := 0
LOCAL cCfop   := ""
LOCAL oCfop

FT_ChDir( oAmbiente:xBaseDoc )
LETO_SET( 7, ( oAmbiente:xBaseDoc ) )
oCfop   := TIniNew( cFile )
nCampos := oCfop:ReadInteger("configuracao", "campos", 0 )
For n := 1 To nCampos
  cCfop := oCfop:ReadString("campos", "campo" + StrZero(n, 3), NIL, 1)
  Aadd( acfop, cCFop )
Next
oCfop:Close()
FT_ChDir( oAmbiente:xBaseDados )
LETO_SET( 7, ( oAmbiente:xBaseDados ) )
Return( acFop )

Function LerIcms()

LOCAL GetList := {}
LOCAL cFile   := "CFOP.INI"
LOCAL nCampos := 0
LOCAL aIcms   := {00.00, 17.00, 12.00, 17.00, 12.00 }
LOCAL oCfop

FT_ChDir( oAmbiente:xBaseDoc )
LETO_SET( 7, ( oAmbiente:xBaseDoc ) )
oCfop   := TIniNew( cFile )
nCampos := oCfop:ReadInteger("configuracao", "campos", 0 )
For n := 1 To nCampos
  nTx_Icms := Val( oCfop:ReadString("campos", "campo" + StrZero(n, 3), NIL, 2))
  Aadd( aIcms, nTx_Icms )
Next
oCfop:Close()
FT_ChDir( oAmbiente:xBaseDados )
LETO_SET( 7, ( oAmbiente:xBaseDados ) )
Return( aIcms )

Function LerNatu()

LOCAL GetList := {}
LOCAL cFile   := "CFOP.INI"
LOCAL nCampos := 0
LOCAL oCfop
LOCAL aNatu := {"[INCLUIR NOVO]           ","VENDA DENTRO ESTADO      ","VENDA FORA ESTADO        ","REMESSA CONSERTO DENTRO  ","REMESSA CONSERTO FORA    "}

FT_ChDir( oAmbiente:xBaseDoc )
LETO_SET( 7, ( oAmbiente:xBaseDoc ) )
oCfop   := TIniNew( cFile )
nCampos := oCfop:ReadInteger("configuracao", "campos", 0 )
For n := 1 To nCampos
  cNatu    := oCfop:ReadString("campos", "campo" + StrZero(n, 3), NIL, 3)
  Aadd( aNatu, cNatu )
Next
oCfop:Close()
FT_ChDir( oAmbiente:xBaseDados )
LETO_SET( 7, ( oAmbiente:xBaseDados ) )
Return( aNatu )

Function AscancNatu( aCfop, cCfop, aNatu )

LOCAL nPos    := Ascan( aCfop, cCfop )
LOCAL cNatu := ""

if nPos <> 0
    cNatu := aNatu[nPos]
endif
Return( cNatu )

Procedure IncluiCFop()

LOCAL GetList    := {}
LOCAL cScreen    := SaveScreen()
LOCAL cFile     := "CFOP.INI"
LOCAL cFop        := Space(05)
LOCAL cNatu     := Space(20)
LOCAL nTx_Icms := 0
LOCAL nCampos    := 0
LOCAL cBuffer
LOCAL oCfop

oMenu:Limpa()
WHILE .T.
    MaBox( 10, 10, 14, 52 )
    SetCursor(1) ; DevPos( 11, 11 ) ; DevOut( "Cfop..............:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cFop, "cFop", "9.999", {|| VerCfop( cFop )},))
    SetCursor(1) ; DevPos( 12, 11 ) ; DevOut( "Natureza Operacao.:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cNatu, "cNatu", "@!", {|| EntradaInvalida({|| Empty( cNatu )}, NIL )},))
    SetCursor(1) ; DevPos( 13, 11 ) ; DevOut( "Taxa Icms.........:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( nTx_Icms, "nTx_Icms", "99.99",,))
    ReadModal( GetList, NIL,,,,, ) ; GetList := {} ; ( GetList )
    if LastKey() = 27
        ResTela( cScreen )
        Return
    endif
    ErrorBeep()
    if Conf("Pergunta: Incluir registro ?")
        FT_ChDir( oAmbiente:xBaseDoc )
        LETO_SET( 7, ( oAmbiente:xBaseDoc ) )
        oCfop := TIniNew( cFile )
        nCampos := oCfop:ReadInteger("configuracao", "campos", 0 )
        nCampos++
        cTx_Icms := Tran( nTx_Icms, "99.99")
        cBuffer := cFop
        cBuffer += ";"
        cBuffer += cTx_Icms
        cBuffer += ";"
        cBuffer += cNatu
        oCfop:WriteInteger("configuracao", "campos", nCampos )
        oCfop:WriteString("campos","campo" + StrZero( nCampos, 3 ), cBuffer )
        oCFop:Close()
        FT_ChDir( oAmbiente:xBaseDados )
        LETO_SET( 7, ( oAmbiente:xBaseDados ) )
    endif
EndDO

Function EntradaInvalida( oBloco, cMensagem )

if( cMensagem = NIL, cMensagem := "Erro: Entrada Invalida.", cMensagem )
Return( IF( Eval( oBloco ), ( ErrorBeep(), Alerta( cMensagem ), .F. ), .T. ))

Proc BaixasRece( cCaixa, cVendedor )

LOCAL cScreen := SaveScreen()
LOCAL Arq_Ant := Alias()
LOCAL Ind_Ant := IndexOrd()
LOCAL GetList := {}
LOCAL aLog      := {}
LOCAL aMenu   := Array(3)
LOCAL cCodiCx
LOCAL lEmitir
LOCAL nAtraso
LOCAL nDebito
LOCAL lComissao
LOCAL nRecno
LOCAL cCodi
LOCAL nRecoCli
LOCAL dEmis
LOCAL dData
LOCAL dVcto
LOCAL cVcto
LOCAL nVpag
LOCAL nVlr
LOCAL cPort
LOCAL cFatu
LOCAL cTipo
LOCAL cTipoParcial
LOCAL cCodiVen
LOCAL nJuro
LOCAL Comis_Lib
LOCAL cNossoNr
LOCAL nOpcao
LOCAL cBordero
LOCAL nPorc
LOCAL nTotJuros
LOCAL nVlrTotal
LOCAL nVlrPago
LOCAL nChSaldo
LOCAL nRecno1
LOCAL cDocnr
LOCAL nLocaliza
LOCAL nCotacao
LOCAL cDc
LOCAL nSobra     := 0
LOCAL cCodiCob  := Space(04)
LOCAL cCobSN     := "N"
LOCAL cObs         := Space(40)
LOCAL nDesconto := 0
LOCAL nMulta     := 0
LOCAL nEscolha  := 0
LOCAL cNome
LOCAL cEnde
LOCAL cCida
LOCAL cCodiCx1
LOCAL cDc1
LOCAL cDc2
LOCAL cHist
LOCAL cLcJur
LOCAL cDcJur
LOCAL cCodiJur
LOCAL nCol
LOCAL nRow
LOCAL nCarencia
LOCAL nJuroDia
LOCAL nVlrSemJuro
LOCAL cCodiCx2
LOCAL cHist2
LOCAL xAtraso
LOCAL nVlrLcto
LOCAL nDiferenca
LOCAL nRecRecebido
LOCAL cRegiao
LOCAL cParcial     := "Q"
LOCAL cString        := "BX " + ltrim(rtrim(cVendedor)) + "."
LOCAL nPercentual := 0
LOCAL lExcluir     := .T.
LOCAL xAgenda
LOCAL nComissao1    := 0
LOCAL nComissao2    := 0
LOCAL nComissao3    := 0
LOCAL nDiaIni1     := 0
LOCAL nDiaIni2     := 0
LOCAL nDiaIni3     := 0
LOCAL nDiaFim1     := 0
LOCAL nDiaFim2     := 0
LOCAL nDiaFim3     := 0
LOCAL nRecibo        := 1
LOCAL nAutenticar := 2
LOCAL nNenhum        := 3
LOCAL lDesconto    := .F.
FIELD Vlr
FIELD Port
FIELD Tipo
FIELD Juro
FIELD NossoNr
FIELD Bordero
FIELD Porc
FIELD Emis
FIELD Vcto
FIELD Codi
FIELD Fatura
FIELD ComDisp
FIELD Comissao
FIELD CodiVen
FIELD ComBloq
FIELD Docnr

if !PodeReceber()
     ResTela( cScreen )
     Return
endif

lDesconto             := oIni:ReadBool("baixasrece","campodesconto", .F. )
nRecibo                 := oIni:ReadInteger("baixasrece","recibo", 1 )
nAutenticar          := oIni:ReadInteger("baixasrece","autenticar", 2 )
nNenhum                 := oIni:ReadInteger("baixasrece","nenhum", 3 )
aMenu[nRecibo]      := "Recibo"
aMenu[nAutenticar] := "Autenticar"
aMenu[nNenhum]      := "Nenhum"
WHILE .T.
    cDocnr := Space(09)
    MaBox( 10, 10, 12, 40 )
    SetCursor(1) ; DevPos( 11, 11 ) ; DevOut( "Documento N§....: " ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cDocnr, "cDocnr", "@!", {|| DocErrado( @cDocnr )},))
    ReadModal( GetList, NIL,,,,, ) ; GetList := {} ; ( GetList )
    if LastKey() = 27
        AreaAnt( Arq_Ant, Ind_Ant )
        ResTela( cScreen )
        Exit
    endif
    oMenu:Limpa()
    Receber->(Order( 2 ))
    dbSelectArea( "ReceMov" )
    Recemov->(Order( 1 ))
    if ( ! .F. ) ; dbClearRelation() ; end ; dbSetRelation( "Receber", {|| Codi}, "Codi", .F. )
    cNome     := Receber->Nome
    cEnde     := Receber->Ende
    cCida     := Receber->Cida
    nRecno    := Recno()
    nRecoCli := Receber->(Recno())
    dData     := Date()
    nVpag     := Vlr
    cPort     := Port
    cTipo     := Recemov->Tipo
    cTipoParcial := Recemov->Tipo
    nJuro     := Juro
    cNossoNr := NossoNr
    cBordero := Bordero
    nPorc     := Porc
    cCodiCx    := "0000"
    cCodiCx1 := Space(04)
    cCodiCx2 := Space(04)
    cDc        := "C"
    cDc1        := "C"
    cDc2        := "C"
    cHist     := "REC " + cNome
    cCodiCob := IF( Recemov->RelCob, Recemov->Cobrador, Space(04))
    cCobSN    := IF( Recemov->RelCob, "S", "N")
    cLcJur    := "N"
    cObs        := cString + Space(40-Len(cString))
    cDcJur    := "C"
    cCodiJur := cCodiCx
    WHILE .T.
        nCol := 05
        nRow := 05
        MaBox( 04, 04 , nRow+18 , 78, "RECEBIMENTOS" )
        DevPos( nRow+00, nCol ) ; DevOut( "Cliente.....: " + Receber->Codi + " " + Receber->Nome )
        DevPos( nRow+01, nCol ) ; DevOut( "Tipo........: " + cTipo )
        DevPos( nRow+01, nCol+35 ) ; DevOut( "Docto N§....: " + cDocnr )
        DevPos( nRow+02, nCol ) ; DevOut( "Nosso N§....: " + cNossoNr )
        DevPos( nRow+02, nCol+35 ) ; DevOut( "Bordero.....: " + cBordero )
        DevPos( nRow+03, nCol ) ; DevOut( "Emissao.....: " + Dtoc( Emis ) )
        DevPos( nRow+03, nCol+35 ) ; DevOut( "Vencto......: " + Dtoc( Vcto ) )
        DevPos( nRow+04, nCol ) ; DevOut( "Juros Mes...: " + Tran( nJuro , "@E 9,999,999,999.99" ) )
        DevPos( nRow+04, nCol+35 ) ; DevOut( "Dias Atraso.: " )
        DevPos( nRow+05, nCol ) ; DevOut( "Valor.......: " + Tran( Vlr ,   "@E 9,999,999,999.99" ) )
        DevPos( nRow+06, nCol ) ; DevOut( "Jrs Devidos.: " )
        DevPos( nRow+07, nCol ) ; DevOut( "Vlr c/Juros.: " )
        SetCursor(1) ; DevPos( nRow+08, nCol ) ; DevOut( "Data Pgto...: " ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( dData, "dData", "##/##/##", {|| PodeRecDataDif( dData )},))
        ReadModal( GetList, NIL,,,,, ) ; GetList := {} ; ( GetList )
        if LastKey() = 27
            Exit
        endif
        nAtraso        := Atraso( dData, Vcto )
        nCarencia    := Carencia( dData, Vcto )
        nJuroDia     := JuroDia( Vlr, Juro )
        nDesconto    := VlrDesconto( dData, Vcto, Vlr )
        nPercentual := PercDesconto( dData, Vcto, Vlr )

        nMulta        := 0
        nVlrSemJuro := Recemov->Vlr

        if lDesconto = .F.
            if nAtraso <= 0
                nTotJuros := 0
                nVlrTotal := ( Vlr + nMulta ) - nDesconto
            Else
                nTotJuros := nJurodia * nCarencia
                nVlrTotal := (( Vlr + nTotJuros ) + nMulta )- nDesconto
            endif
        Elseif lDesconto = .T.
            if nAtraso <= 0
                nTotJuros := 0
                nVlrTotal := ( Vlr + nMulta )
            Else
                nTotJuros := nJurodia * nCarencia
                nVlrTotal := (( Vlr + nTotJuros ) + nMulta )
            endif
        endif
        nMulta        := VlrMulta( dData, Vcto, nVlrTotal )
        nVlrTotal    += nMulta

        Write( nRow+04, nCol+35, "Dias Atraso.: " + Tran( nAtraso,   "99999") + " Dias" )
        Write( nRow+05, nCol+35, "Desconto....: " + Tran( nDesconto, "@E 9,999,999,999.99"))
        Write( nRow+06, nCol,     "Jrs Devidos.: " + Tran( nTotJuros, "@E 9,999,999,999.99"))
        Write( nRow+06, nCol+35, "Multa.......: " + Tran( nMulta,    "@E 9,999,999,999.99"))
        Write( nRow+07, nCol,     "Vlr c/juros.: " + Tran( nVlrTotal, "@E 9,999,999,999.99"))

        nVlrPago := nVlrTotal
        if lDesconto = .T.
            SetCursor(1) ; DevPos( nRow+08, nCol+35 ) ; DevOut( "Desconto....: " ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( nPercentual, "nPercentual", "999.99", {|| (nVlrPago := ( nVlrTotal - ((nVlrTotal * nPercentual) / 100 ))) >= 0 .OR. (nVlrPago := ( nVlrTotal - ((nVlrTotal * nPercentual) / 100 ))) <= 0},))
        endif
        SetCursor(1) ; DevPos( nRow+09, nCol ) ; DevOut( "Valor Pago..: " ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( nVlrPago, "nVlrPago", "@E 9,999,999,999.99",,))
        SetCursor(1) ; DevPos( nRow+09, nCol+35 ) ; DevOut( "Bordero.....: " ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cBordero, "cBordero", "@!",,))
        SetCursor(1) ; DevPos( nRow+10, nCol ) ; DevOut( "Tipo........: " ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cTipo, "cTipo", "@!", {|| PickTam({"DinHeiro","Nota Promissoria","Duplicata Mercantil","CHeque a Vista","ReQuisicao","BoNus","Cheque Pre-Datado","DiFerenca Rec/Pag","Direta Livre","CarTao", "OUtros"}, {"DH    ","NP    ","DM    ","CH    ","RQ    ","BN    ","CP    ","DF    ","DL    ","CT    ","OU    "}, @cTipo )},))
        SetCursor(1) ; DevPos( nRow+10, nCol+35 ) ; DevOut( "Portador....: " ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cPort, "cPort", "@!",,))
        SetCursor(1) ; DevPos( nRow+11, nCol ) ; DevOut( "Conta Caixa.: " ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cCodiCx, "cCodiCx", "9999", {|| CheErrado( @cCodiCx,, Row(), nCol+28 )},))
        SetCursor(1) ; DevPos( nRow+11, nCol+20 ) ; DevOut( "D/C.:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cDc, "cDc", "!", {|| PickTam({"Credito em conta","Debito em conta"}, {"C","D"}, @cDc )},))

        SetCursor(1) ; DevPos( nRow+12, nCol ) ; DevOut( "C. Partida..: " ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cCodiCx1, "cCodiCx1", "9999", {|| CheErrado( @cCodiCx1,, Row(), nCol+28, .T. )},))
        SetCursor(1) ; DevPos( nRow+12, nCol+20 ) ; DevOut( "D/C.:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cDc1, "cDc1", "!", {|| PickTam({"Credito em conta","Debito em conta"}, {"C","D"}, @cDc1 )},))

        SetCursor(1) ; DevPos( nRow+13, nCol ) ; DevOut( "C. Partida..: " ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cCodiCx2, "cCodiCx2", "9999", {|| CheErrado( @cCodiCx2,, Row(), nCol+28, .T. )},))
        SetCursor(1) ; DevPos( nRow+13, nCol+20 ) ; DevOut( "D/C.:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cDc2, "cDc2", "!", {|| PickTam({"Credito em conta","Debito em conta"}, {"C","D"}, @cDc2 )},))

        SetCursor(1) ; DevPos( nRow+14, nCol ) ; DevOut( "Historico...: " ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cHist, "cHist", "@!", {|| !Empty( cHist )},))
        SetCursor(1) ; DevPos( nRow+15, nCol ) ; DevOut( "Observacoes.: " ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cObs, "cObs", "@!",,))
        SetCursor(1) ; DevPos( nRow+16, nCol ) ; DevOut( "Com. Cobr...: " ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cCobSN, "cCobSN", "!", {|| PickSimNao( @cCobSN )},))
        SetCursor(1) ; DevPos( nRow+16, nCol+20 ) ; DevOut( "Cob...:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cCodiCob, "cCodiCob", "9999", {|| FunErrado( @cCodiCob,, Row(), Col() + 1 )}, {|| cCobSN = "S"}))
        SetCursor(1) ; DevPos( nRow+17, nCol ) ; DevOut( "Separar Jrs.: " ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cLcJur, "cLcJur", "!", {|| PickSimNao( @cLcJur )},))
        SetCursor(1) ; DevPos( nRow+17, nCol+20 ) ; DevOut( "Conta.:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cCodiJur, "cCodiJur", "9999", {|| CheErrado( @cCodiJur,, Row(), Col() + 1 )}, {|| cLcJur = "S"}))
        ReadModal( GetList, NIL,,,,, ) ; GetList := {} ; ( GetList )
        if LastKey() = 27
            Exit
        endif
        cCodiVen      := Recemov->CodiVen
        cCodi          := Recemov->Codi
        cRegiao         := Recemov->Regiao
        dEmis          := Recemov->Emis
        dVcto          := Recemov->Vcto
        nVlr             := Recemov->Vlr
        cTipoParcial := Recemov->Tipo
        cFatu          := Recemov->Fatura
        lComissao     := Recemov->Comissao
        nOpcao         := Conf( "Pergunta: Confirma a baixa deste Titulo ?", { " Sim ", " Alterar ", " Cancelar "})
        lEmitir         := 1
        if nOpcao = 1
            if nVlrPago <> nVlrTotal
                ErrorBeep()

                lEmitir := Conf("Valor pago diferente que o devido.;;Pergunta: Fazer Baixa como:",    {"Quitando", "Parcial", "Diferenca C/C", "Cancelar"})
                if lEmitir = 0 .OR. lEmitir = 4
                    Loop
                endif
                Do Case
                Case lEmitir = 1
                    cParcial := "Q"
                Case lEmitir = 2
                    cParcial := "P"
                Case lEmitir = 3
                    cParcial := "D"
                EndCase
                if lEmitir = 3
                    cCodiCx2 := Space(04)
                    cDc2        := " "
                    cHist2    := cHist
                    MaBox( nRow+15, 05 , nRow+18 , 74, "LANCAMENTOS DIFERENCA C/C")
                    SetCursor(1) ; DevPos( nRow+16, nCol ) ; DevOut( "Conta Caixa.: " ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cCodiCx2, "cCodiCx2", "9999", {|| CheErrado( @cCodiCx2,, Row(), nCol+28 )},))
                    SetCursor(1) ; DevPos( nRow+16, nCol+20 ) ; DevOut( "D/C.:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cDc2, "cDc2", "!", {|| cDc2 $ "DC"},))
                    SetCursor(1) ; DevPos( nRow+17, nCol ) ; DevOut( "Historico...: " ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cHist2, "cHist2", "@!", {|| !Empty( cHist2 )},))
                    ReadModal( GetList, NIL,,,,, ) ; GetList := {} ; ( GetList )
                    if LastKey() = 27
                        Loop
                    endif
                    ErrorBeep()
                    if !Conf("Pergunta: Confirma Lancamento ?")
                        Loop
                    endif
                endif
            endif
            Receber->(DbGoTo( nRecoCli ))
            if Cheque->(!TravaArq())    ; DbUnLockAll() ; Loop ; endif
            if Chemov->(!TravaArq())    ; DbUnLockAll() ; Loop ; endif

            nLocaliza := Recemov->(Recno())
            xAtraso     := Receber->Matraso
            if nAtraso > 999
                nAtraso := 999
            endif
            if xAtraso < nAtraso
                if Receber->(TravaReg())
                    Receber->Matraso := IF( nAtraso > 999, 999, nAtraso )
                    Receber->(Libera())
                endif
            endif

            Cheque->(Order( 1 ))
            if cLcJur == "S"
                nVlrLcto := ( nVlrPago - nVlrSemJuro )
                if Cheque->(DbSeek( cCodiJur )) .OR. !Empty( cCodiJur )
                    if Cheque->(TravaReg())
                        nChSaldo := Cheque->Saldo
                        if Chemov->(Incluiu())
                            if cDc = "C"
                                nChSaldo       += nVlrLcto
                                Cheque->Saldo += nVlrLcto
                                Chemov->Cre   := nVlrLcto
                            Else
                                nChSaldo       -= nVlrLcto
                                Cheque->Saldo -= nVlrLcto
                                Chemov->Deb   := nVlrLcto
                            endif
                            Chemov->Codi    := cCodiJur
                            Chemov->Docnr    := cDocnr
                            Chemov->Emis    := dData
                            Chemov->Data    := dData
                            Chemov->Baixa    := Date()
                            Chemov->Hist    := "REC JUROS TITULO N§ " + cDocnr
                            Chemov->Saldo    := nChSaldo
                            Chemov->Tipo    := cTipo
                            Chemov->Caixa    := IF( cCaixa = Nil, Space(4), cCaixa )
                            Chemov->Fatura := cFatu
                        endif
                        Chemov->(Libera())
                    endif
                    Cheque->(Libera())
                endif
            endif

            if Cheque->(DbSeek( cCodiCx )) .OR. !Empty( cCodiCx )
                if Cheque->(TravaReg())
                    nVlrLcto := nVlrPago
                    if cLcJur == "S"
                        nVlrLcto := nVlrSemJuro
                    endif
                    nChSaldo := Cheque->Saldo
                    if Chemov->(Incluiu())
                        if cDc = "C"
                            nChSaldo       += nVlrLcto
                            Cheque->Saldo += nVlrLcto
                            Chemov->Cre   := nVlrLcto
                        Else
                            nChSaldo       -= nVlrLcto
                            Cheque->Saldo -= nVlrLcto
                            Chemov->Deb   := nVlrLcto
                        endif
                        Chemov->Codi    := cCodiCx
                        Chemov->Docnr    := cDocnr
                        Chemov->Emis    := dData
                        Chemov->Data    := dData
                        Chemov->Baixa    := Date()
                        Chemov->Hist    := cHist
                        Chemov->Saldo    := nChSaldo
                        Chemov->Tipo    := cTipo
                        Chemov->Caixa    := IF( cCaixa = Nil, Space(4), cCaixa )
                        Chemov->Fatura := cFatu
                    endif
                    Chemov->(Libera())
                endif
                Cheque->(Libera())
            endif

            if Cheque->(DbSeek( cCodiCx1 )) .OR. !Empty( cCodiCx1 )
                if Cheque->(TravaReg())
                    nChSaldo := Cheque->Saldo
                    if Chemov->(Incluiu())
                        if cDc1 = "C"
                            nChSaldo       += nVlrPago
                            Cheque->Saldo += nVlrPago
                            Chemov->Cre   := nVlrPago
                        Else
                            nChSaldo       -= nVlrPago
                            Cheque->Saldo -= nVlrPago
                            Chemov->Deb   := nVlrPago
                        endif
                        Chemov->Codi    := cCodiCx1
                        Chemov->Docnr    := cDocnr
                        Chemov->Emis    := dData
                        Chemov->Data    := dData
                        Chemov->Baixa    := Date()
                        Chemov->Hist    := cHist
                        Chemov->Saldo    := nChSaldo
                        Chemov->Tipo    := cTipo
                        Chemov->Caixa    := IF( cCaixa = Nil, Space(4), cCaixa )
                        Chemov->Fatura := cFatu
                    endif
                    Chemov->(Libera())
                endif
                Cheque->(Libera())
            endif

            if Cheque->(DbSeek( cCodiCx2 )) .OR. !Empty( cCodiCx2 )
                if Cheque->(TravaReg())
                    nChSaldo := Cheque->Saldo
                    if Chemov->(Incluiu())
                        if cDc2 = "C"
                            nChSaldo       += nVlrPago
                            Cheque->Saldo += nVlrPago
                            Chemov->Cre   := nVlrPago
                        Else
                            nChSaldo       -= nVlrPago
                            Cheque->Saldo -= nVlrPago
                            Chemov->Deb   := nVlrPago
                        endif
                        Chemov->Codi    := cCodiCx2
                        Chemov->Docnr    := cDocnr
                        Chemov->Emis    := dData
                        Chemov->Data    := dData
                        Chemov->Baixa    := Date()
                        Chemov->Hist    := cHist
                        Chemov->Saldo    := nChSaldo
                        Chemov->Tipo    := cTipo
                        Chemov->Caixa    := IF( cCaixa = Nil, Space(4), cCaixa )
                        Chemov->Fatura := cFatu
                    endif
                    Chemov->(Libera())
                endif
                Cheque->(Libera())
            endif

            if lEmitir = 3
                if Cheque->(DbSeek( cCodiCx2 )) .OR. !Empty( cCodiCx2 )
                    if Cheque->(TravaReg())
                        nChSaldo   := Cheque->Saldo
                        if nVlrTotal < nVlrPago
                            nDiferenca := ( nVlrPago - nVlrTotal )
                        Else
                            nDiferenca := ( nVlrTotal - nVlrPago )
                        endif
                        if Chemov->(Incluiu())
                            if cDc2 = "C"
                                nChSaldo       += nDiferenca
                                Cheque->Saldo += nDiferenca
                                Chemov->Cre   := nDiferenca
                            Else
                                nChSaldo       -= nDiferenca
                                Cheque->Saldo -= nDiferenca
                                Chemov->Deb   := nDiferenca
                            endif
                            Chemov->Codi    := cCodiCx2
                            Chemov->Docnr    := cDocnr
                            Chemov->Emis    := dData
                            Chemov->Data    := dData
                            Chemov->Baixa    := Date()
                            Chemov->Hist    := cHist2
                            Chemov->Saldo    := nChSaldo
                            Chemov->Tipo    := "DF"
                            Chemov->Caixa    := IF( cCaixa = Nil, Space(4), cCaixa )
                            Chemov->Fatura := cFatu
                        endif
                        Chemov->(Libera())
                    endif
                    Cheque->(Libera())
                endif
            endif

            if Recebido->(Incluiu())
                Recebido->Codi      := cCodi
                Recebido->Caixa     := IF( cCaixa = Nil, Space(4), cCaixa )
                Recebido->Regiao     := cRegiao
                Recebido->CodiVen  := cCodiVen
                Recebido->Docnr     := cDocnr
                Recebido->Emis      := dEmis
                Recebido->Vcto      := dVcto
                Recebido->Baixa     := Date()
                Recebido->Vlr         := nVlr
                Recebido->DataPag  := dData
                Recebido->VlrPag     := nVlrPago
                Recebido->Port      := cPort
                Recebido->Tipo      := cTipo
                Recebido->Juro      := nJuro
                Recebido->NossoNr  := cNossoNr
                Recebido->Bordero  := cBordero
                Recebido->Fatura     := cFatu
                Recebido->Obs         := cObs
                Recebido->Parcial  := cParcial
                Recebido->Docnr     := cParcial + Right(cDocnr, 8)
                nRecRecebido         := Recebido->(Recno())
                Recebido->(Libera())
            endif

            nRecno1    := Recno()
            Recemov->(DbGoTo( nLocaliza))
            if Recemov->(TravaReg())
                if nVlrPago < nVlrTotal .AND. lEmitir = 2
                    nSobra                := ( nVlrTotal - nVlrPago )
                    nCotacao             := 0
                    Recemov->Vcto        := IF( nAtraso <= 0, Recemov->Vcto, dData )
                    Recemov->Vlr        := nSobra
                    Recemov->VlrDolar := nSobra
                    Recemov->Jurodia    := JuroDia( nSobra, nJuro )
                    Recemov->Docnr     := "R" + Recemov->(Right(Docnr, 8))
                    Recemov->Obs        := "RESTANTE PARCELA: " + Docnr
                Else
                    Recemov->(DbDelete())
                endif
            endif
            Recemov->(Libera())



            if nPorc <> 0
                if !Empty( cFatu )
                    Vendemov->(Order( 2 ))
                    if Vendemov->(DbSeek( cFatu ))
                        if Vendemov->Comdisp < Vendemov->Comissao
                            if lComissao
                                if Vendemov->(TravaReg())
                                    cCodiVen  := Vendemov->CodiVen
                                    if nVlrPago >= nVlr
                                        Comis_Lib := ( nVlr * nPorc) / 100
                                    Else
                                        Comis_Lib := ( nVlrPago * nPorc) / 100
                                    endif
                                    Vendemov->ComBloq := ( Vendemov->ComBloq - Comis_Lib )
                                    Vendemov->ComDisp := ( Vendemov->ComDisp + Comis_Lib )
                                    if Vendemov->ComBloq < 0
                                        Vendemov->ComBloq := 0
                                        Vendemov->ComDisp := Vendemov->Comissao
                                    endif
                                endif
                                Vendemov->(Libera())
                                Vendedor->(Order( 1 ))
                                if Vendedor->(DbSeek( cCodiVen ))
                                    if Vendedor->(TravaReg())
                                        Vendedor->ComBloq     := ( Vendedor->ComBloq - Comis_Lib )
                                        Vendedor->ComDisp     := ( Vendedor->ComDisp + Comis_Lib )
                                        if Vendedor->ComBloq < 0
                                            Vendedor->ComBloq := 0
                                            Vendedor->ComDisp := Vendedor->Comissao
                                        endif
                                    endif
                                    Vendedor->(Libera())
                                endif
                            endif
                        endif
                    endif
                endif
            endif



            if cCobSn = "S"
                lProcessarComissao := .T.
                nComissao1 := oIni:ReadInteger("comissaoperiodo1", "comissao", 0 )
                nComissao2 := oIni:ReadInteger("comissaoperiodo2", "comissao", 0 )
                nComissao3 := oIni:ReadInteger("comissaoperiodo3", "comissao", 0 )
                nDiaIni1   := oIni:ReadInteger("comissaoperiodo1", "diaini", 0 )
                nDiaIni2   := oIni:ReadInteger("comissaoperiodo2", "diaini", 0 )
                nDiaIni3   := oIni:ReadInteger("comissaoperiodo3", "diaini", 0 )
                nDiaFim1   := oIni:ReadInteger("comissaoperiodo1", "diafim", 0 )
                nDiaFim2   := oIni:ReadInteger("comissaoperiodo2", "diafim", 0 )
                nDiaFim3   := oIni:ReadInteger("comissaoperiodo3", "diafim", 0 )
                nPorcCob   := 0
                Do Case
                Case nAtraso >= nDiaIni1 .AND. nAtraso <= nDiaFim1
                    if nComissao1 <= 0
                        ErrorBeep()
                        Alerta("Erro: Informe ao Supervisor que nao foi definido;comissao para cobrador em Arquivos/Configuracao ;da Base de Dados/Financeiro.;;Nao sera lancado comissao do cobrador!")
                        lProcessarComissao := .F.
                    endif
                    nPorcCob := nComissao1
                Case nAtraso >= nDiaIni2 .AND. nAtraso <= nDiaFim2
                    if nComissao2 <= 0
                        ErrorBeep()
                        Alerta("Erro: Informe ao Supervisor que nao foi definido;comissao para cobrador em Arquivos/Configuracao ;da Base de Dados/Financeiro.;;Nao sera lancado comissao do cobrador!")
                        lProcessarComissao := .F.
                    endif
                    nPorcCob := nComissao2
                Case nAtraso >= nDiaIni3
                    if nComissao3 <= 0
                        ErrorBeep()
                        Alerta("Erro: Informe ao Supervisor que nao foi definido;comissao para cobrador em Arquivos/Configuracao ;da Base de Dados/Financeiro.;;Nao sera lancado comissao do cobrador!")
                        lProcessarComissao := .F.
                    endif
                    nPorcCob := nComissao3
                EndCase
                if lProcessarComissao
                    Vendedor->(Order( 1 ))
                    if Vendedor->(DbSeek( cCodiCob ))
                        if Vendedor->(TravaReg())
                            Comis_Lib := ( nVlrPago * nPorcCob ) / 100
                            dbSelectArea( "Vendemov" )
                            if Vendemov->(Incluiu())
                                Vendemov->Docnr      := cDocnr
                                Vendemov->Dc          := "C"
                                Vendemov->Descricao := cHist
                                Vendemov->Regiao      := cRegiao
                                Vendemov->Pedido      := cDocnr
                                Vendemov->DataPed   := dData
                                Vendemov->CodiVen   := cCodiCob
                                Vendemov->Vlr          := nVlrPago
                                Vendemov->Data       := dData
                                Vendemov->Porc       := nPorcCob
                                Vendemov->Fatura      := cFatu
                                Vendemov->Codi       := cCodi
                                Vendemov->Combloq   := 0
                                Vendemov->Comissao  := Comis_Lib
                                Vendedor->Comissao  += Comis_Lib
                                Vendemov->Comdisp   := Comis_Lib
                                Vendedor->ComDisp   += Comis_Lib
                            endif
                            Vendemov->(Libera())
                        endif
                        Vendedor->(Libera())
                    endif
                endif
            endif
            Recemov->(Order( 2 ))
























            oMenu:Limpa()
            if Receber->(DbSeek( cCodi ))
                if Receber->Spc
                    Recemov->(Order( 2 ))
                    if Recemov->(!DbSeek( cCodi ))
                        Alerta("Informa: Cliente sem debito e negativado SPC.")
                    endif
                endif
            endif
            aLog    := {}
            cVcto := Dtoc( dVcto )
            Aadd( aLog, "BAIXAS" )
            Aadd( aLog, cCodi )
            Aadd( aLog, cNome)
            Aadd( aLog, cDocnr )
            Aadd( aLog, cVcto )
            Aadd( aLog, Time())
            Aadd( aLog, Dtoc(Date()))
            Aadd( aLog, oAmbiente:xUsuario + Space( 10 - Len( oAmbiente:xUsuario )))
            Aadd( aLog, cCaixa    )
            Aadd( aLog, Tran( nVlrPago,"@E 999,999,999,999.99"))
            Aadd( aLog, cObs )
            Aadd( aLog, cEnde )
            Aadd( aLog, cCida )
            Aadd( aLog, cFatu )
            LogRecibo( aLog )
            M_Title("Pergunta: DESEJA IMPRIMIR ?")
            nEscolha := FazMenu( 10, 10, aMenu )
            if nEscolha = nRecibo

                aLog[1] := oAmbiente:cTipoRecibo
                aLog[11] := "PAG PARCIAL PARCELA CONTRATO SERVICOS DE INTERNET."
                ReciboIndividual( cCaixa, cVendedor, aLog, nRecRecebido )
            Elseif nEscolha = nAutenticar
                Autenticar( nRecRecebido, nSobra )
            endif
        Elseif nOpcao = 2
            Loop
        endif
          Exit
    EndDo
    Recemov->(DbClearRel())
    Recemov->(DbGoTop())
    ResTela( cScreen )
EndDo

Function SplitCor( cColor, nForeGround, nBackGround )
















LOCAL aCores := {{"N",  0, "Black",  "Preto"}, {"B",  1, "Blue",   "Azul"}, {"G",  2, "Green",  "Verde"}, {"BG", 3, "Cyan",   "Ciano"}, {"R",  4, "Red",    "Vermelho"}, {"RB", 5, "Magenta","Magenta"}, {"GR", 6, "Brown",  "Marrom"}, {"W",  7, "White",  "Branco"}, {"N+", 8, "Gray",   "Cinza"}, {"B+", 9, "Bright Blue","Azul Intenso"}, {"G+", 10, "Bright Green","Verde Intenso"}, {"BG+", 11, "Bright Cyan","Ciano Intenso"}, {"R+",  12, "Bright Red", "Vermelho Intenso"}, {"RB+", 13, "Bright Magenta", "Magenta Intenso"}, {"GR+", 14, "Yellow", "Amarelo"}, {"W+",  15, "Bright White", "Branco Intenso"}}
LOCAL aSplit        := Array(5,2)
LOCAL cStandard
LOCAL cEnhanced
LOCAL cBorder
LOCAL cBackGround
LOCAL cUnseleted

if( cColor = NIL, cColor := SetColor(), cColor )
if( nForeGround = NIL, nForeGround := 1, nForeGround )
if( nBackGround = NIL, nBackGround := 1, nBackGround )

cStandard    := SubStr(cColor, 1, At(",",cColor)-1)
cTemp         := SubStr(cStandard, 1, At("/",cStandard)-1)
aSplit[1,1] := cTemp
aSplit[1,2] := DelAntesdaVirgula(cStandard, "/")
cColor        := DelAntesdaVirgula(cColor, ",")

cEnhanced    := SubStr(cColor, 1, At(",",cColor)-1)
cTemp         := SubStr(cEnhanced, 1, At("/",cEnhanced)-1)
aSplit[2,1] := cTemp
aSplit[2,2] := DelAntesdaVirgula(cEnhanced, "/")
cColor        := DelAntesdaVirgula(cColor, ",")

cBorder        := SubStr(cColor, 1, At(",",cColor)-1)
cTemp         := SubStr(cBorder, 1, At("/",cBorder)-1)
aSplit[3,1] := cTemp
aSplit[3,2] := DelAntesdaVirgula(cBorder, "/")
cColor        := DelAntesdaVirgula(cColor, ",")

cBackGround := SubStr(cColor, 1, At(",",cColor)-1)
cTemp         := SubStr(cBackGround, 1, At("/",cBackGround)-1)
aSplit[4,1] := cTemp
aSplit[4,2] := DelAntesdaVirgula(cBackGround, "/")
cColor        := DelAntesdaVirgula(cColor, ",")

cUnseleted    := cColor
cTemp         := SubStr(cUnseleted, 1, At("/",cUnseleted)-1)
aSplit[5,1] := cTemp
aSplit[5,2] := DelAntesdaVirgula(cUnseleted, "/")






















Return( aSplit )

Function DelAntesdaVirgula(cString, cStrLocate)

LOCAL cDeletar := SubStr(cString, 1, At(cStrLocate,cString))
Return(cString := Stuff(cString, 1, Len(cDeletar), ""))


Function ReciboIndividual( cCaixa, cVendedor, aLog, xVlrRecibo, xDocnr, lLancarJurosNaoPago, nVlrPago, dDataPag, xObs, lAjustarValorOriginal)

LOCAL Arq_Ant       := Alias()
LOCAL Ind_Ant       := IndexOrd()
LOCAL cScreen       := SaveScreen()
LOCAL GetList       := {}
LOCAL nVlr          := 0
LOCAL aRecibo       := {}
LOCAL nOpcao        := 1
LOCAL cVlr          := Space(0)
LOCAL cVlrLog       := Space(0)
LOCAL cValor        := Space(0)
LOCAL cHist         := Space(60)
LOCAL cObs          := Space(60)
LOCAL cString       := Space(60)
LOCAL lCalcular     := .F.
LOCAL lParcial      := .F.
LOCAL dDeposito     := Date()
LOCAL nVlrComJuros  := 0
LOCAL lSucesso      := .F.
LOCAL cLetraParcial := Space(0)
LOCAL cNewDocnr     := Space(0)
LOCAL nContaLetra   := 0
LOCAL nSomaParcial  := 0
LOCAL nPercentual   := 0
LOCAL lRetVal       := .T.
LOCAL nValorDoRecibo
LOCAL nDividendo
LOCAL nPos
LOCAL lSelecao
LOCAL nY
LOCAL nLenSelecao
LOCAL cTitulo
LOCAL xTitulo
LOCAL nRecno
LOCAL nRow
LOCAL nCol
LOCAL lSair
LOCAL dVcto
LOCAL cCodi
LOCAL cNome
LOCAL cEnde
LOCAL cCida
LOCAL cFatu
IF xVlrRecibo == NIL ; xVlrRecibo := 0 ; END
IF nVlrPago == NIL ; nVlrPago := 0 ; END
IF lLancarJurosNaoPago == NIL ; lLancarJurosNaoPago := .F. ; END
IF lSelecao == NIL ; lSelecao := .F. ; END
IF dDataPag == NIL ; dDataPag := nil ; END
IF lAjustarValorOriginal == NIL ; lAjustarValorOriginal := .F. ; END

if !lLancarJurosNaoPago
   aLog := NIL
endif

if ValType( xDocnr ) = "A"
    Mensagem("INFO: Aguarde somando...")
    cDocnr     := xDocnr[1]
    nVlrRecibo := FT_Asum( xVlrRecibo )
    xTitulo    := "IMPRESSAO SELECAO DE "
    lSelecao   := .T.
    nLenSelecao := Len(xDocnr)
else
   cDocnr     := xDocnr
    nVlrRecibo := xVlrRecibo
    xTitulo    := "IMPRESSAO INDIVIDUAL DE "
endif

WHILE .T.
    if !lLancarJurosNaoPago
       oMenu:Limpa()
    endif
    if aLog == NIL
        lSair        := IF( cDocnr = NIL, .F., .T. )
        cDocnr       := IF( cDocnr = NIL, Space(09), cDocnr)
        nRow         := 11
        nCol         := 27
        nVlr         := Round(nVlr,2)
        nVlrComJuros := Round(nVlrRecibo, 2)
        nVlrRecibo   := Round(nVlrRecibo, 2)

        if !lLancarJurosNaoPago
           if lSelecao
                MaBox( 01, 00, 09, MaxCol(), "RELACAO DOS TITULOS SELECIONADOS")
                nPos       := 2
                nDividendo := if(MaxCol() <= 80, 2 , if(MaxCol() > 80 .AND. MaxCol() <= 132, 4 , 5))
                SetPos( nPos, 01)
                for nY := 1 to nLenSelecao
                    if nY % nDividendo == 0
                        SetPos( ++nPos, 01)
                    endif
                   QQout( "[" + StrZero(nY,2) + "]" + xDocnr[nY], space(1), Tran(xVlrRecibo[ny], "@E 9,999,999.99"),Space(02))
                next
            endif
            if      oAmbiente:cTipoRecibo == "RECCAR"
                cTitulo := "RECIBO PAGTO EM CARTEIRA"
                Mabox( 10, 00, 15, Maxcol(), Xtitulo + Ctitulo )
            Elseif oAmbiente:cTipoRecibo == "RECBCO"
                cTitulo := "RECIBO VIA DEP BANCARIO"
                MaBox( 10, 00, 17, MaxCol(), xTitulo + cTitulo )
            Elseif oAmbiente:cTipoRecibo == "RECOUT"
                cTitulo := "RECIBO PAGTO VIA OUTROS"
                MaBox( 10, 00, 17, MaxCol(), xTitulo + cTitulo )
            endif

            SetCursor(1) ; DevPos( 11, 01 ) ; DevOut( "Documento N§....:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cDocnr, "cDocnr", "@!", {|| DocErrado( @cDocnr, @nVlr, @nVlrRecibo, NIL, @cHist, Row(), Col()+1)},))
            SetCursor(1) ; DevPos( 12, 01 ) ; DevOut( "Valor...........:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( nVlr, "nVlr", "999999999.99", {|| lPodeReciboZerado(@nVlr, nVlrComJuros, lSelecao) .AND. lPrtExtenso(nVlr, NIL , NIL , Row(), Col()+1, 45, xVlrRecibo)},))
            SetCursor(1) ; DevPos( 13, 01 ) ; DevOut( "Valor Recibo....:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( nVlrRecibo, "nVlrRecibo", "999999999.99", {|| lPrtExtenso(nVlr, @nVlrRecibo, lSelecao, Row(), Col()+1, 45, xVlrRecibo)},))
            SetCursor(1) ; DevPos( 14, 01 ) ; DevOut( "Referente.......:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cHist, "cHist", "@!",,))

            if      oAmbiente:cTipoRecibo == "RECCAR"
            Elseif oAmbiente:cTipoRecibo == "RECBCO"
                SetCursor(1) ; DevPos( 15, 01 ) ; DevOut( "Data Deposito...:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( dDeposito, "dDeposito", "##/##/##", {|| lValidDep1( dDeposito, @cObs )},))
                SetCursor(1) ; DevPos( 16, 01 ) ; DevOut( "Observacoes.....:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cObs, "cObs", "@!",,))
            Elseif oAmbiente:cTipoRecibo == "RECOUT"
                SetCursor(1) ; DevPos( 15, 01 ) ; DevOut( "Data Pagamento..:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( dDeposito, "dDeposito", "##/##/##", {|| lValidDep2( dDeposito, @cObs )},))
                SetCursor(1) ; DevPos( 16, 01 ) ; DevOut( "Observacoes.....:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cObs, "cObs", "@!",,))
            endif
            ReadModal( GetList, NIL,,,,, ) ; GetList := {} ; ( GetList )
            if LastKey() = 27 .OR. !Instru80() .OR. !LptOk()
                Recemov->(DbClearRel())
                AreaAnt( Arq_Ant, Ind_Ant )
                ResTela( cScreen )
                return lSucesso
            endif

        else
            if !(DocErrado( @cDocnr, @nVlr, @nVlrRecibo, NIL, @cHist, NIL, NIL, lLancarJurosNaoPago))
                lSair    := .T.
                lSucesso := .F.
                exit
            endif
            nVlr         := Round(CalcJuros(dDataPag, NIL),2)
            nVlrRecibo   := Round(nVlrPago,2)
            nVlrComJuros := nVlr

        endif

        Mensagem("Aguarde, Ajustando base de dados.")

        if !lSelecao
           xDocnr     := {}
            xVlrRecibo := {}
            xObs       := {}
            Aadd( xDocnr, cDocnr )
            Aadd( xVlrRecibo, nVlrRecibo )
            Aadd( xObs, cHist )
            nLenSelecao := Len( xDocnr )
        endif

        Receber->(Order( 2 ))
        dbSelectArea( "Recemov" )
        Recemov->(Order( 1 ))
        if ( ! .F. ) ; dbClearRelation() ; end ; dbSetRelation( "Receber", {|| Codi}, "Codi", .F. )

        nSomaParcial   := 0
        nVlrGet        := nVlr
        nVlrReciboGet  := nVlrRecibo
        xHist          := cHist
        for nY := 1 to nLenSelecao
            Recemov->(DbSeek( xDocnr[nY]))
            nTam            := Len(ltrim(rtrim(Recemov->Obs)))
            cComplemento := "PAG PARCIAL "
            cString         := "PARCELA CONTRATO SERVICOS DE INTERNET."
            cHist          := cString + Space(60-Len(cString))
            cHist         := IF( Empty(Recemov->Obs), cComplemento + cHist, cComplemento + Left(Recemov->Obs,nTam) + Space((60-12-nTam)))

            cDocnr       := Recemov->Docnr
            nRecno       := Recemov->(Recno())
            nVlr         := Round( nVlr,2)
            nVlrRecibo   := Round( iif( nVlrRecibo == 0, nVlrRecibo, xVlrRecibo[nY]),2)
            nVlrComJuros := nVlr

            if nVlrReciboGet < nVlrGet .AND. !lSelecao
                if nVlrReciboGet <> 0
                    if !lLancarJurosNaoPago
                        Mensagem("Aguarde, Ajustando registro parcial.")
                    endif
                    lSucesso := LancaParcial( cDocnr, nRecno, nVlr, nVlrRecibo, nVlrComJuros, dDataPag, lLancarJurosNaoPago, lSucesso, lAjustarValorOriginal )
                endif
            endif

            if !lLancarJurosNaoPago
               if lSelecao
                    if nVlrReciboGet == nVlrGet


                    elseif nVlrReciboGet == 0
                       nVlrRecibo     := 0
                        xVlrRecibo[nY] := nVlrRecibo
                    elseif nVlrReciboGet > nVlrGet
                        nPercentual  := ((nVlrReciboGet / nVlrGet ) * 100 ) - 100
                        nVlrRecibo   := Round(xVlrRecibo[nY],2)
                        nVlrRecibo   += Round((nVlrRecibo * nPercentual ) / 100, 2)
                        nSomaParcial += nVlrRecibo

                        if nY == nLenSelecao
                            nVlrRecibo  += ( nVlrReciboGet - nSomaParcial )
                        endif
                        xVlrRecibo[nY] := nVlrRecibo

                    elseif nVlrReciboGet < nVlrGet
                        nVlrRecibo   := Round(xVlrRecibo[nY],2)
                        nSomaParcial += nVlrRecibo

                        if nY == nLenSelecao .OR. nSomaParcial >= nVlrReciboGet
                            nVlr         := nVlrRecibo
                            nVlrComJuros := nVlr
                            nVlrRecibo   -= ( nSomaParcial - nVlrReciboGet )
                            Mensagem("Aguarde, Ajustando registro parcial.")
                            lSucesso     := LancaParcial( cDocnr, nRecno, nVlr, nVlrRecibo, nVlrComJuros, dDataPag, lLancarJurosNaoPago, lSucesso, lAjustarValorOriginal )
                        endif
                        xVlrRecibo[nY]  := nVlrRecibo
                        if nSomaParcial >= nVlrReciboGet
                            Asize( xDocnr, nY)
                            Asize( xVlrRecibo, nY)
                            Asize( xObs, nY )
                            nLenSelecao := nY
                        endif
                    endif
                endif
            endif

            if !lLancarJurosNaoPago
                lSucesso := AjustaReceber( nRecno, nVlrRecibo, xHist, nVlr )
                cCodi    := Recemov->Codi
                cFatu    := Recemov->Fatura
                cNome    := Receber->Nome
                cEnde    := Receber->Ende
                cCida    := Receber->Cida
                cVcto    := Dtoc(Recemov->Vcto)
                nMoeda   := 1

                if nLenSelecao == 1
                   lSelecao := .F.
                endif

                if lSelecao


                    nValorDoRecibo := nVlrReciboGet
                   cVlr           := ltrim(rtrim(Tran( nValorDoRecibo,"@E 999,999,999,999.99")))
                    cVlrLog        := ltrim(rtrim(Tran( xVlrRecibo[nY],"@E 999,999,999,999.99")))
                    cValor         := Extenso( nValorDoRecibo, nMoeda, 3, 132 )
                else
                    cVlr           := ltrim(rtrim(Tran( nVlrRecibo, "@E 999,999,999,999.99")))
                   cVlrLog        := cVlr
                    cValor         := Extenso( nVlrRecibo, nMoeda, 3, 80 )
                endif

                aLog := {}
                Aadd( aLog, oAmbiente:cTipoRecibo )
                Aadd( aLog, cCodi )
                Aadd( aLog, cNome)
                Aadd( aLog, cDocnr )
                Aadd( aLog, cVcto )
                Aadd( aLog, Time())
                if oAmbiente:cTipoRecibo == "RECBCO" .OR. oAmbiente:cTipoRecibo == "RECOUT"
                    Aadd( aLog, Dtoc(dDeposito))
                else
                    Aadd( aLog, Dtoc(Date()))
                endif
                Aadd( aLog, oAmbiente:xUsuario + Space( 10 - Len( oAmbiente:xUsuario )))
                Aadd( aLog, cCaixa )
                Aadd( aLog, Tran( nVlrRecibo,"@E 999,999,999,999.99"))
                Aadd( aLog, (ltrim(rtrim(cHist)) + Space(1)+ ltrim(rtrim(cObs))))
                Aadd( aLog, cEnde )
                Aadd( aLog, cCida )
                Aadd( aLog, cFatu )

                if lSelecao
                    aAgenda := { cCodi, Date(), "PAG PARCIAL {DOC:" + cDocnr + " - VCTO:" + cVcto + " - PAGO:" + cVlrLog + " - RECIBO COMBO:" + cVlr + "}", cCaixa, oAmbiente:xUsuario, .T. }
                else
                    aAgenda := { cCodi, Date(), "PAG PARCIAL {DOC:" + cDocnr + " - VCTO:" + cVcto + " - PAGO:" + cVlrLog + " - RECIBO INDIV:" + cVlr + "}", cCaixa, oAmbiente:xUsuario, .T. }
                endif
                while !LogRecibo( aLog    ) ; enddo
                While !LogAgenda( aAgenda ) ; enddo

            endif
        next
    Else
        if !Instru80() .OR. !LptOk()
            Recemov->(DbClearRel())
            AreaAnt( Arq_Ant, Ind_Ant )
            Restela( cScreen )
            return lSucesso
        endif
        lSair    := .T.
        lSucesso := .T.
        cCodi    := aLog[2]
        cNome    := aLog[3]
        cDocnr   := aLog[4]
        cVcto    := aLog[5]
        cHist    := aLog[11]
        cEnde    := aLog[12]
        cCida    := aLog[13]
        cFatu    := aLog[14]
        nMoeda   := 1
        cVlr       := ltrim(rtrim(aLog[10]))
        cValor   := Extenso( nVlrRecibo, nMoeda, 2, Larg )
        aAgenda := { cCodi, Date(), "PAG PARCIAL {DOC:" + cDocnr + " - VCTO:" + cVcto + " - PAGO:" + cVlr + "}", cCaixa, oAmbiente:xUsuario, .T. }
        LogRecibo( aLog )
        LogAgenda( aAgenda )
    endif

    if !lLancarJurosNaoPago
        cTela := Mensagem("Aguarde, Emitindo Recibo.", Cor())
        PrintOn()
        FPrInt( Chr(27) + "C" + Chr( 33 ))
        if lSelecao
           FPrint( PQ )
            nTamForm := 132
            nRow     := -1
            SetPrc(0,0)
        else
           nTamForm := 80
            nRow     := 0
            SetPrc(0,0)
            Write( nRow+00, 00, Repl("=", nTamForm))
        endif
        Write( nRow+01, 00, GD + Padc(ltrim(rtrim(oAmbiente:xFanta)), nTamForm / 2) + CA )
        Write( nRow+02, 00, Padc("AV CASTELO BRANCO, 693 - PIONEIROS" + " - " + "PIMENTA BUENO" + " - " + "RO", nTamForm ))
        Write( nRow+03, 00, Repl("-", nTamForm ))
        Write( nRow+04, 00, GD + Padc(cTitulo, nTamForm / 2 ) + CA )
        if lSelecao
            nForCol := 0
           for nY := 1 to nLenSelecao
                xVlr := ltrim(rtrim(Tran( xVlrRecibo[nY],"@E 999,999,999,999.99")))
                Write( nRow+05, nForCol, PQ + "N§ " + xDocnr[nY] + Space(1) + "R$ " + xVlr + NR + _CPI10 )
                if nY < nLenSelecao
                   nForCol += 30
                   if nForCol >= 132
                      nForCol := 0
                       nRow++
                    endif
                endif
            next
        else
            Write( nRow+05, 00, Padr("N§ " + NG + cDocnr + NR + " VCTO " + NG + cVcto + NR, nTamForm))
            Write( nRow+05, 00, Padl("R$ " + NG + cVlr + NR, nTamForm))
        endif
        nRow++
        Write( nRow+06, 00, "Recebemos de    : " + NG + cNome + NR )
        Write( nRow+07, 00, "Estabelecido  a : " + NG + ltrim(rtrim(cEnde)) + if(lSelecao, " - " + cCida, "") + NR )
        if lSelecao
           nRow--
        else
           Write( nRow+08, 00, "na Cidade de    : " + NG + cCida + NR )
        endif
        Write( nRow+10, 00, "A Importancia por extenso abaixo relacionada : " + NG + "R$ " + cVlr + NR )
        Write( nRow+11, 00, NG + Left( cValor, nTamForm ) + NR  )
        Write( nRow+12, 00, NG + Right( cValor, nTamForm ) + NR  )
        Write( nRow+14, 00, "Referente a")
        Write( nRow+15, 00, NG + cHist + NR )

        if oAmbiente:cTipoRecibo == "RECBCO" .OR. oAmbiente:cTipoRecibo == "RECOUT"
            Write( nRow+16, 00, NG + ltrim(rtrim(cObs)) + NR )
        else
           nRow--
        endif

        if oAmbiente:cTipoRecibo == "RECBCO" .OR. oAmbiente:cTipoRecibo == "RECOUT"
            dDataIMpressao := dDeposito
        Else
            dDataIMpressao := Date()
        endif
        Write( nRow+18, 00, Padl( NG + DataExt( dDataImpressao ) + NR, nTamForm))
        Write( nRow+21, nTamForm / 2 , Repl("-", nTamform/2))
        Write( nRow+22, 00, "1§ VIA - CLIENTE" )
        Write( nRow+22, nTamForm / 2 , oAmbiente:xUsuario )
        Write( nRow+23, 00, Repl("=", nTamForm))
        Write( nRow+24, 00, Padc("ESTE RECIBO NAO QUITA EVENTUAIS DEBITOS/MENSALIDADES ANTERIORES", nTamForm))
        __Eject()
        PrintOff()
        Recemov->(DbSkip(1))
        Recemov->(DbClearRel())
        Recemov->(DbGoTop())
        ResTela( cTela )
    endif
    aLog := NIL
    if lSair
        Exit
    endif
EndDo
ResTela( cScreen )
AreaAnt( Arq_Ant, Ind_Ant )
return lSucesso

function AjustaReceber( nRecno, nVlrRecibo, xHist, nVlr )

LOCAL cStr

Recemov->(DbGoto( nRecno))
cStr := ltrim(rtrim(Recemov->Obs))
iif(len(cStr) <> 0, cStr += iif(right(cStr,1) <> ".", ". ", " "), cStr += "")

if nVlrRecibo == 0 .AND. nVlr == 0
    if Recemov->(TravaReg())
        Recemov->Obs     := iif(Empty(xHist), cStr + xHist, xHist )
        Recemov->Vlr     := 0
        Recemov->Datapag := Date()
        Recemov->StPag   := .T.
        Recemov->(Libera())
        return .T.
    endif
    return .F.
endif

if nVlrRecibo == 0 .AND. nVlr > 0
    if Recemov->(TravaReg())
        Recemov->Obs     := cStr + xHist
        Recemov->Datapag := Date()
        Recemov->StPag   := .T.
        Recemov->(Libera())
        return .T.
    endif
    return .F.
endif
if Recemov->(TravaReg())
    Recemov->VlrPag  := nVlrRecibo
    Recemov->Datapag := Date()
    Recemov->StPag   := .T.
    Recemov->(Libera())
    return .T.
endif
return .F.

Function lPodeReciboZerado(nVlr, nVlrComJuros, lSelecao)

LOCAL nNivel  := 40
LOCAL lAdmin  := TIniNew(oAmbiente:xUsuario + ".INI"):ReadBool("permissao","usuarioadmin", .F.)
LOCAL lRetVal := .T.

if lSelecao <> NIL .AND. lSelecao == .T.
    if nVlr < nVlrComJuros
        nVlr := nVlrComJuros
        Alerta("ERRO: Nao se pode alterar o valor de varios recibos.")
        return .F.
    endif
endif

if !lAdmin
   if ArredondarParaCima( nVlr ) < nVlrComJuros
      nVlr := IF((lRetVal := PedePermissao(nNivel)), nVlr, nVlrComJuros)
   endif
endif
Return(lRetVal)

function ArredondarParaCima(nVlr)

return(Int(nVlr) + 1)

function LancaParcial( cDocnr, nRecno, nVlr, nVlrRecibo, nVlrComJuros, dDataPag, lLancarJurosNaoPago, lSucesso, lAjustarValorOriginal )

LOCAL nContaLetra   := 1
LOCAL cLetraParcial := Chr(Asc(Left( cDocnr,1)) + nContaLetra)
LOCAL cNewDocnr     := cLetraParcial + Right( cDocnr, 8)
LOCAL lRetVal       := .T.
LOCAL nVlrAnt       := Recemov->Vlr

while lRetVal
    if Recemov->(!DbSeek( cNewDocnr ))
        lRetVal := .F.
    else
        cLetraParcial := Chr(Asc(Left( cDocnr,1)) + (++nContaLetra))
        cNewDocnr     := cLetraParcial + Right( cDocnr, 8)
    endif
enddo

Recemov->(DbGoto( nRecno))
if lAjustarValorOriginal
    if Recemov->(TravaReg())
        Recemov->VlrOrigina := iif(Recemov->VlrOrigina <= 0, nVlrAnt, Recemov->VlrOrigina)
        Recemov->Vlr        -= (nVlr - nVlrRecibo)
        Recemov->(Libera())
    endif
    lSucesso := .T.
endif
if DuplicaReg( cLetraParcial, nVlr, nVlrRecibo, nVlrComJuros, dDataPag)
    Recemov->(DbGoto( nRecno))
    if Recemov->(TravaReg())
        Recemov->VlrOrigina := iif(Recemov->VlrOrigina <= 0, nVlrAnt, Recemov->VlrOrigina )
        if nVlrRecibo < Recemov->Vlr
            Recemov->Vlr        := nVlrRecibo
        endif
        if !lLancarJurosNaoPago
            Recemov->VlrPag  := nVlrRecibo
            Recemov->Datapag := Date()
            Recemov->StPag   := .T.
        endif
        Recemov->(Libera())
    endif
    lSucesso := .T.
endif
return lSucesso

Function lPrtExtenso( nVlr, nVlrRecibo, lSelecao, nRow, nCol, nLarg, xVlrRecibo)

LOCAL nNivel     := 40
LOCAL lAdmin     := TIniNew(oAmbiente:xUsuario + ".INI"):ReadBool("permissao","usuarioadmin", .F.)
LOCAL Arq_Ant    := Alias()
LOCAL Ind_Ant    := IndexOrd()
LOCAL lRetVal    := .T.
LOCAL nMoeda     := 1
LOCAL nLinhas    := 1
LOCAL cMsg       := NIL
LOCAL cMsg1      := "ERRO: Percebo que voce usou o modo selecao e o valor nao paga nem o primeiro RECIBO!;A maneira correta de emitir recibo parcial seria individualmente.;De qualquer forma selecionou somente 1 recibo, assim vou quebrar teu galho!;;Voce sabe o que esta fazendo?"
LOCAL cMsg2      := "ERRO: Percebo que voce usou o modo selecao e o valor nao paga nem o primeiro RECIBO!;A maneira correta de emitir recibo parcial seria individualmente.;;Voce sabe o que esta fazendo?"
LOCAL nLenRecibo := 1

if( nLarg = NIL, nLarg := 45, nLarg )
Write( nRow, nCol, Extenso( If(nVlrRecibo = NIL, nVlr, nVlrRecibo), nMoeda, nLinhas, nLarg))













if lSelecao <> NIL .AND. lSelecao == .T.
    if nVlrRecibo < nVlr
       if nVlrRecibo <> 0
           if nVlrRecibo < xVlrRecibo[1]
                nLenRecibo := Len(xVlrRecibo)
               cMsg := iif( nLenRecibo <= 1, cMsg1, cMsg2)
                if alerta( cMsg, {" Sim ", " Nao "} ) == 1
                    return .T.
                endif
                nVlrRecibo := nVlr
                return .F.
            endif
        endif
    endif
endif

if !lAdmin
    if nVlrRecibo <> NIL .AND. nVlrRecibo == 0
       nVlrRecibo := IF((lRetVal := PedePermissao(nNivel)), nVlrRecibo, nVlr)
    endif
endif
if nVlrRecibo <> NIL .AND. lSelecao <> NIL .AND. lSelecao == .T.
   if nVlrRecibo == 0
        if alerta("Deseja lan‡ar movimento a receber em substituicao a selecao?;  uma ¢tima oportunidade! - (Lancamento semi automatico)", {" Sim ", " Nao "} ) == 1
            ReceNormal( .T., cCaixa, {Recemov->Codi, nVlr} )
            AreaAnt( Arq_Ant, Ind_Ant )
        endif
    endif
endif
Return(lRetVal)












Function lValidDep1( dDeposito, cObs )

cObs := "EFETUADO DEP BANCO CREDIP EM DATA DE "
cObs += Dtoc( dDeposito ) + "."
cObs += Space(60-Len(cObs))
Return(.T.)



Function lValidDep2( dDeposito, cObs )

cObs := "PAGO EM MAOS A TIAGO TIMOTEO DE OLIVEIRA EM DATA DE "
cObs += Dtoc( dDeposito ) + "."
cObs += Space(60-Len(cObs))
Return(.T.)



Function DuplicaReg( cLetraParcial, nVlr, nVlrRecibo, nVlrComJuros, dAtual )

LOCAL Arq_Ant := Alias()
LOCAL Ind_Ant := IndexOrd()
LOCAL xTemp   := FTempName()
LOCAL aStru   := Recemov->(DbStruct())
LOCAL nConta  := Recemov->(FCount())
LOCAL cDocnr  := Recemov->Docnr
LOCAL cObs    := "REST FATURA " + cDocnr
LOCAL XObs    := "REST FATURA "
LOCAL xTrim
LOCAL lRet      := .F.
LOCAL nAt     := 0
LOCAL aJuro   := {}
LOCAL xRegistro
LOCAL cStr
LOCAL cTrim
IF dAtual == NIL ; dAtual := Date() ; END

xTrim := ltrim(rtrim(Recemov->Obs))
nAt   += RAt(ltrim(rtrim(xObs)), xTrim)
if nAt > 0
  xTrim := ltrim(rtrim(StrTran(xTrim, SubStr(xTrim, nAt, nAt + 21), "")))
endif
xRegistro := Recemov->(Recno())
DbCreate( xTemp, aStru )
dbUseArea( .T.,, (xTemp), "xAlias", iif( .F. .OR. .T., ! .T., NIL ), .F. )
xAlias->(DbAppend())
For nField := 1 To nConta
    xAlias->(FieldPut( nField, Recemov->(FieldGet( nField ))))
Next
if Recemov->(Incluiu())
    For nField := 1 To nConta
        Recemov->(FieldPut( nField, xAlias->(FieldGet( nField ))))
    Next
    Recemov->VlrOrigina := 0
    Recemov->Docnr   := cLetraParcial + Right( cDocnr, 8)
   Recemov->Vlr     := (nVlr - nVlrRecibo)
    Recemov->VlrPag  := 0
    Recemov->DataPag := Ctod("//")
    Recemov->StPag   := .F.

   Recemov->Vcto    := Recemov->Vcto
    cStr             := xTrim ; iif(len(cStr)<> 0, cStr += iif(right(cStr,1) <> ".", ". " + cObs, " " + cObs), cStr += cObs)
    Recemov->Obs     := cStr
   aJuro := CalcCmJuros( 1 , NIL , Recemov->Vlr, Recemov->Vcto, dAtual)
    Recemov->Juro      := aJuro[1]
   Recemov->JuroDia   := aJuro[2]
   Recemov->JuroTotal := aJuro[3]
    Recemov->(Libera())
    lRet := .T.
endif
xAlias->(DbCloseArea())
Ferase(xTemp)
AreaAnt( Arq_Ant, Ind_Ant )
Recemov->(DbGoto( xRegistro ))
Return( lRet )

Proc FoneTroca()

LOCAL nConta := 0

ErrorBeep()
if !Conf("Pergunta: Tem absoluta certeza?")
    Return
endif
oMenu:Limpa()
dbSelectArea( "RECEBER" )
Receber->(DbgoTop())
While !Eof()
    cFone      := TrocaFone( Receber->Fone )
    cFax         := TrocaFone( Receber->Fax )
    cFone1     := TrocaFone( Receber->Fone1 )
    cFone2     := TrocaFone( Receber->Fone2 )
    cFoneAval := TrocaFone( Receber->FoneAval )
    if Receber->(TravaReg())
        Receber->Fone        := cFone
        Receber->Fax        := cFax
        Receber->Fone1     := cFone1
        Receber->Fone2     := cFone2
        Receber->FoneAval := cFoneAval
        Receber->(Libera())
        Receber->(DbSkip(1))
    endif
EnddO

Function TrocaFone( cFone )





if Left(cFone, 6) == "(0069)" .AND.     SubStr( cFone, 10,1) == "-"  .AND.     SubStr( cFone, 07,1) <> "9" .AND.     SubStr( cFone, 07,1) <> "8"
    cTroca := "(69)93" + Substr(cFone,7,8)
    QOut( cFone, cTroca )




ElsEif Left(cFone, 6) == "(0069)" .AND.     SubStr( cFone, 10,1) = "-" .AND.     SubStr( cFone, 07,1) = "9" .OR.     SubStr( cFone, 07,1) = "8"
    cTroca := "(69)99" + Substr(cFone,7,8)
    QOut( cFone, cTroca )




Elseif Left(cFone, 6) == "(069 )" .AND.     SubStr( cFone, 10,1) == "-"  .AND.     SubStr( cFone, 07,1) <> "9" .AND.     SubStr( cFone, 07,1) <> "8"
    cTroca := "(69)93" + Substr(cFone,7,8)
    QOut( cFone, cTroca )




ElsEif Left(cFone, 6) == "(069 )" .AND.     SubStr( cFone, 10,1) = "-" .AND.     SubStr( cFone, 07,1) = "9" .OR.     SubStr( cFone, 07,1) = "8"
    cTroca := "(69)99" + Substr(cFone,7,8)
    QOut( cFone, cTroca )


ElsEif Left(cFone, 6) == "(0693)" .AND.     SubStr( cFone, 10,1) = "-"
    cTroca := "(69)93" + Substr(cFone,7,8)
    QOut( cFone, cTroca )

ElsEif Left(cFone, 6) == "(0699)" .AND.     SubStr( cFone, 10,1) = "-"
    cTroca := "(69)99" + Substr(cFone,7,8)
    QOut( cFone, cTroca )

ElsEif Left(cFone, 6) == "(0698)" .AND.     SubStr( cFone, 10,1) = "-"
    cTroca := "(69)98" + Substr(cFone,7,8)
    QOut( cFone, cTroca )
Else
     cTroca := cFone
     Qout(cFone, "Sem troca")
endif
Return( cTroca )

function SeekLog(xTodos, aTodos, nIndex, lRecepago)

LOCAL xLog         := "RECIBO.LOG"
LOCAL Arq_Ant     := Alias()
LOCAL Ind_Ant     := IndexOrd()
LOCAL nLen
LOCAL cDocnr
LOCAL nVlrDevido
LOCAL nJurosPago
LOCAL nSaldo
LOCAL x
LOCAL cFull := ""

if nIndex == NIL
    nLen  := Len( oRecePosi:aTodos )
    nIni  := 1
else
    nLen := nIndex
    nIni := nIndex
endif

for x := nIni To nLen
    if oAmbiente:lReceber
        if !oReceposi:xTodos[x,17]
           cFull := cSeekRecebido(x)
            Loop
        endif
        cFull := cSeekRecibo(x)
    else
        cSeekNil(x)
    endif
    if oReceposi:nOrdem == 3 .OR. lRecepago <> NIL
        oRecePosi:aAtivoSwap[x]  := .T.
        oRecePosi:aAtivo[x]         := .T.
    endif
next

if oAmbiente:lK_Ctrl_Ins
    K_Ctrl_Ins()
endif

AreaAnt( Arq_Ant, Ind_Ant )
return cFull

function cSeekRecebido(x)

    LOCAL nPrincipal := oReceposi:xTodos[x,5]
    LOCAL nSaldo      := 0
    LOCAL nJurosPago := (oReceposi:xTodos[x,9] - nPrincipal)
    LOCAL nAtraso      := oReceposi:xTodos[x,4]
    LOCAL cFull         := strFormatRecebido({x, nAtraso, nJurosPago, nSaldo})
    LOCAL cDocnr     := oReceposi:xTodos[x,1]

    oReceposi:aHistRecibo[x]          := oReceposi:xTodos[x,11]
    oReceposi:aUserRecibo[x]          := oReceposi:xTodos[x,11]
    oReceposi:aReciboImpresso[x]      := .F.
    oRecePosi:aAtivoSwap[x]           := .F.
    oRecePosi:aAtivo[x]                  := .F.
    oRecePosi:aDatapag[x]               := oReceposi:xTodos[x,16]
    oRecePosi:nAberto                   += nSaldo
    oRecePosi:nPrincipal               += nPrincipal
    oRecePosi:nRecebido                    += oReceposi:xTodos[x,9]
    oRecePosi:nJurosPago               += nJurosPago
    oRecePosi:nQtdDoc++
    oReceposi:aTodos[x]                  := cFull
    oReceposi:alMulta[x]                     := .F.
    oReceposi:xTodos[x,7]     := oReceposi:xTodos[x,9]
    oReceposi:xTodos[x,8]     := nJurosPago
    oReceposi:xTodos[x,9]     := nSaldo
    return cFull

function cSeekNil(x)

    LOCAL cDocnr     := oReceposi:xTodos[x,1]

    dbSelectArea( "RECIBO" )
    Recibo->(Order( 3))
    oRecePosi:aAtivo[x]        := .F.
    oRecePosi:aAtivoSwap[x] := .F.
    if Recibo->(DbSeek(cDocnr))
        oRecePosi:aAtivoSwap[x]      := .T.
        oRecePosi:aAtivo[x]             := .T.
        oRecePosi:aHistRecibo[x]     := Recibo->Hist
        oRecePosi:aUserRecibo[x]     := ltrim(rtrim(Recibo->Usuario)) + "/" + Recibo->Hora
        oReceposi:aReciboImpresso[x] := .T.
    endif
    return NIL

function cSeekRecibo(x)

    LOCAL nPrincipal := oReceposi:xTodos[x,5]
    LOCAL nJurosPago := 0
    LOCAL nSaldo      := 0
    LOCAL nVlrDevido := 0
    LOCAL nAtraso    := 0
    LOCAL cFull         := oReceposi:sTrFormataATodos(x)
    LOCAL cDocnr     := oReceposi:xTodos[x,1]

    dbSelectArea( "RECIBO" )
    Recibo->(Order( 3))
    if Recibo->(DbSeek( cDocnr ))
        While Recibo->Docnr = cDocnr
            if Recibo->Vlr == 0
                nVlrDevido              := 0
                oRecePosi:aAtivoSwap[x] := .F.
                oRecePosi:aAtivo[x]        := .F.
                oRecePosi:nQtdDoc++
            else
                nVlrDevido := (nPrincipal - Recibo->Vlr)
                if nVlrDevido <= 0
                    nJurosPago              := ( Recibo->Vlr - nPrincipal)
                    oRecePosi:aAtivoSwap[x] := .F.
                    oRecePosi:aAtivo[x]        := .F.
                    oRecePosi:nQtdDoc++
                    oRecePosi:nRecebido        += Recibo->Vlr
                    oRecePosi:nJurosPago     += nJurosPago
                else
                    nSaldo                        := nVlrDevido
                    oRecePosi:nAberto         += nSaldo
                endif
            endif

            nAtraso        := Atraso( Recibo->Data, oReceposi:xTodos[x,3])
            cFull         := strFormatRecebido({x, nAtraso, nJurosPago, nSaldo})

            oReceposi:aTodos[x]                  := cFull
            oReceposi:alMulta[x]                      := .F.
            oRecePosi:aDatapag[x]               := oReceposi:xTodos[x,16]
            oReceposi:xTodos[x,7]     := Recibo->Vlr
            oReceposi:xTodos[x,8]     := nJurosPago
            oReceposi:xTodos[x,9]     := nSaldo
            oReceposi:aHistRecibo[x]          := Recibo->Hist
            oReceposi:aUserRecibo[x]          := ltrim(rtrim(Recibo->Tipo)) + "/" + ltrim(rtrim(Recibo->Usuario)) + "/" + Recibo->Hora
            oReceposi:aReciboImpresso[x]      := .T.
            oRecePosi:nPrincipal               += nPrincipal
            Recibo->(DbSkip(1))
        EndDo
    endif
    return cFull


function strFormatRecebido(aParam)

   LOCAL cFull := ""

    cFull += Left( oReceposi:aTodos[aParam[1]], 24) + Space(1)
    cFull += StrZero(aParam[2], 4 )
    cFull += SubStr( oReceposi:aTodos[aParam[1]], 30, 22) + Space(1)
    cFull += Dtoc( Recibo->Data ) + Space(1)
    cFull += Tran(aParam[3],   "@E 9,999.99") + Space(1)
    cFull += Tran(Recibo->Vlr, "@E 99,999.99") + Space(1)
    cFull += Tran(aParam[4],   "@E 999,999.99") + Space(1)
    cFull += oReceposi:xTodos[aParam[1],11]
    return cFull


Function AchaCor(nCor, nPos)
    return((aCor:= Pattern())[Ascan(aCor[nCor,1]), nPos])

Function AllColors()

LOCAL aPattern := {}
LOCAL x

For x:= 0 To 255 step 16
    nBlack         := x + 00
    nBlue          := x + 01
    nGreen         := x + 02
    nCyan          := x + 03
    nRed           := x + 04
    nMagenta       := x + 05
    nBrown         := x + 06
    nWhite         := x + 07
    nGray          := x + 08
    nBrightBlue    := x + 09
    nBrightGreen   := x + 10
    nBrightCyan    := x + 11
    nBrightRed     := x + 12
    nBrightMagenta := x + 13
    nYellow        := x + 14
    nBrightWhite   := x + 15















   Aadd( aPattern, { nBlack, nBlue, nGreen, nCyan, nRed, nMagenta, nBrown, nWhite, nGray, nBrightBlue, nBrightGreen, nBrightCyan, nBrightRed, nBrightMagenta, nYellow, nBrightWhite})
next
return ( aPattern )

Function AscanCor(nPos)

LOCAL aPattern := AllColors()
LOCAL nCor     := int(oAmbiente:CorMenu/16)+1
LOCAL nX
LOCAL nY


return aPattern[nCor, nPos]

for nX := 1 To 16
    for nY := 1 To 16
        if nCor = aPattern[nX,nY]
            return( aPattern[nX,nPos])
        endif
    next
next
return( 0 )

Function Pattern()

LOCAL aPattern := {}
LOCAL nCorIni
LOCAL nCorFim
LOCAL nCorHKLightBar
LOCAL nCorHotKey
LOCAL nCorDesativada
LOCAL nAzul
LOCAL x

For x:= 0 To 255 step 16
   nCorIni        := x
    nCorFim        := x + 15
    nCorHKLightBar := x + 12
    nCorHotKey     := x + 10
    nCorDesativada := x + 08

    nBlack         := x + 00
    nBlue          := x + 01
    nGreen         := x + 02
    nCyan          := x + 03
    nRed           := x + 04
    nMagenta       := x + 05
    nBrown         := x + 06
    nWhite         := x + 07
    nGray          := x + 08
    nBrightBlue    := x + 09
    nBrightGreen   := x + 10
    nBrightCyan    := x + 11
    nBrightRed     := x + 12
    nBrightMagenta := x + 13
    nYellow        := x + 14
    nBrightWhite   := x + 15




















   Aadd( aPattern, { nCorIni, nCorFim, nCorHKLightBar, nCorHotKey, nCorDesativada, nBlack, nBlue, nGreen, nCyan, nRed, nMagenta, nBrown, nWhite, nGray, nBrightBlue, nBrightGreen, nBrightCyan, nBrightRed, nBrightMagenta, nYellow, nBrightWhite})
next
return ( aPattern )


Function AscanCorHKLightBar(nCor)

LOCAL aPattern := Pattern()
LOCAL nX

For nX := 1 To Len( aPattern)
   if nCor >= aPattern[nX,1] .AND. nCor <= aPattern[nX,2]
       return( aPattern[nX,3])
    endif
next
return( 0 )

Function AscanCorHotKey(nCor)

LOCAL aPattern := Pattern()
LOCAL nX

For nX := 1 To Len( aPattern)
   if nCor >= aPattern[nX,1] .AND. nCor <= aPattern[nX,2]
       return( aPattern[nX,4])
    endif
next
return( 0 )

Function AscanCorDesativada(nCor)

LOCAL aPattern := Pattern()
LOCAL nX

For nX := 1 To Len( aPattern)
   if nCor >= aPattern[nX,1] .AND. nCor <= aPattern[nX,2]
       return( aPattern[nX,5])
    endif
next
return( 0 )

Function AscanCorMenu(nCor)

LOCAL aPattern := Pattern()
LOCAL nX

For nX := 1 To Len( aPattern)
   if nCor >= aPattern[nX,1] .AND. nCor <= aPattern[nX,2]
       return( aPattern[nX,5])
    endif
next
return( 0 )

Function AscanCorBlue(nCor)

LOCAL aPattern := Pattern()
LOCAL nX

For nX := 1 To Len( aPattern)
   if nCor >= aPattern[nX,1] .AND. nCor <= aPattern[nX,2]
       return( aPattern[nX,15])
    endif
next
return( 0 )

Proc FichaAtendimento(cCaixa, cVendedor, xTodos, nCurElemento)

LOCAL Arq_Ant     := Alias()
LOCAL Ind_Ant     := IndexOrd()
LOCAL cScreen     := SaveScreen()
LOCAL GetList     := {}
LOCAL cVisita     := Space(60)
LOCAL cObs         := Space(60)
LOCAL cTitulo     := "FICHA DE ATENDIMENTO/ATIVACAO"
        cCodi      := Space(05)

dbSelectArea( "Receber" )
Receber->(Order( 2))
WHILE .T.
    oMenu:Limpa()

    if xTodos = NIL
        dData   := Date()
        cHora   := Time()
        cVisita := ltrim(rtrim(cVisita)) + Space(60-Len(ltrim(rtrim(cVisita))))
        cObs      := ltrim(rtrim(cObs))     + Space(60-Len(ltrim(rtrim(cObs))))
    Else
        cCodi   := xTodos[nCurElemento,1]
        dData   := xTodos[nCurElemento,2]
        cHora   := xTodos[nCurElemento,3]
        cVisita := Left(xTodos[nCurElemento,4],60)
    endif
    MaBox( 10, 00, 14, 80, "IMPRESSAO " +cTitulo )
    SetCursor(1) ; DevPos( 11, 01 ) ; DevOut( "Codigo Cliente..:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cCodi, "cCodi", "99999", {|| RecErrado( @cCodi,, Row(), Col()+1)},))
    SetCursor(1) ; DevPos( 12, 01 ) ; DevOut( "Motivo Visita...:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cVisita, "cVisita", "@!", {|| !Empty(cVisita)},))
    SetCursor(1) ; DevPos( 13, 01 ) ; DevOut( "Observacoes.....:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cObs, "cObs", "@!",,))
    ReadModal( GetList, NIL,,,,, ) ; GetList := {} ; ( GetList )
    if LastKey() = 27
      AreaAnt( Arq_Ant, Ind_Ant )
      ResTela( cScreen )
      Return
    endif
    if Conf("Pergunta: Confirma Impressao ?")
        if !Instru80() .OR. !LptOk()
            Loop
        endif
        cTela := Mensagem("Aguarde, Imprimindo Ficha.", Cor())
        PrintOn()
        FPrInt( Chr(27) + "C" + Chr( 33 ))
        SetPrc(0,0)
        nRow := 1
        cVisita := ltrim(rtrim(cVisita))

        if Len( cVisita) > 0
            cVisita += IF(Right(cVisita,1) = ".", " ",". ")
        endif

        cObs      := ltrim(rtrim(cObs))
        if Len( cObs) > 0
            cObs      += IF(Right(cObs,1) = ".", "",".")
        endif

        Write( nRow+00, 00, Repl("=",80))
        Write( nRow+01, 00, GD + Padc(ltrim(rtrim(oAmbiente:xFanta)), 40) + CA )
        Write( nRow+02, 00, Padc( "AV CASTELO BRANCO, 693 - PIONEIROS" + " - " + "PIMENTA BUENO" + " - " + "RO", 80 ))
        Write( nRow+03, 00, Repl("-",80))
        Write( nRow+04, 00, GD + Padc( cTitulo, 40) + CA )
        Write( nRow+06, 00, "DATA     : " + NG + Dtoc(dData) + NR)
        Write( nRow+06, 58, "HORA   : " + NG + cHora + NR)
        Write( nRow+07, 00, "NOME     : " + NG + Receber->Nome + NR )
        Write( nRow+07, 58, "FONE   : " + NG + Receber->Fone + NR )
        Write( nRow+08, 00, "ENDERECO : " + NG + Receber->Ende + NR )
        Write( nRow+08, 58, "BAIRRO : " + NG + Left(ltrim(rtrim(Receber->Bair)),17) + NR )
        Write( nRow+09, 00, "CIDADE   : " + NG + Receber->Cida + NR )
        Write( nRow+09, 58, "FONE   : " + NG + Receber->Fax + NR )
        Write( nRow+11, 00, "MOTIVO VISITA : " + NG + cVisita + NR )
        Write( nRow+12, 00, "OBSERVACOES   : " + NG + cObs + NR )
        Write( nRow+14, 00, "FOI ATENDIDA RECLAMACAO ?: " + NG + "___________" + NR )
        Write( nRow+14, 48, "INTERNET FUNCIONANDO ?: " + NG + "___________" + NR )
        Write( nRow+16, 00, "NOME/ASSINATURA  : " + NG + Repl("_",60) + NR )
        Write( nRow+18, 00, "RELATORIO TECNICO: " + NG + Repl("_",60) + NR )
        Write( nRow+20, 00, "DATA ATIVACAO    : " + NG + Dtoc(Receber->Data) + NR)
        Write( nRow+20, 48, "ATENDIDO POR: " + NG + "_____________________" + NR )
        Write( nRow+21, 00, Repl("-",80))
        Write( nRow+22, 00, "O CLIENTE declara expressamente e garante, para todos os fins de direito, que as")
        Write( nRow+23, 00, "informacoes  aqui  prestadas sao  verdadeiras, e possui  capacidade  plena  pela")
        Write( nRow+24, 00, "utilizacao dos servicos prestados pela CONTRATADA.")
        Write( nRow+25, 00, Repl("=",80))
        Write( nRow+26, 00, "Impresso por: " + cCaixa + " " + cVendedor)
        __Eject()
        PrintOff()
        if xTodos = NIL
            if Agenda->(Incluiu())
                Agenda->Codi     := cCodi
                Agenda->Data     := dData
                Agenda->Hora     := cHora
                Agenda->Hist     := cVisita + cObs
                Agenda->Caixa     := cCaixa
                Agenda->Usuario := cVendedor
                Agenda->(Libera())
            endif
        endif
    endif
EndDo
ResTela( cScreen )
AreaAnt( Arq_Ant, Ind_Ant )
Return

Function AchaUltVcto( cCodi, dFim )

LOCAL cScreen      := SaveScreen()
LOCAL GetList      := {}
LOCAL Arq_Ant      := Alias()
LOCAL Ind_Ant      := IndexOrd()
LOCAL nRecno     := Recemov->(Recno())
LOCAL aReg       := {}

Recemov->(Order(2))
if Recemov->( DbSeek( cCodi ))
   While Recemov->Codi = cCodi
        Aadd( aReg, Recemov->Vcto)
        Recemov->(DbSkip( 1 ))
    enddo
endif
if len( aReg) > 0
   Asort( aReg,,, {|x,y|y < x })
    dFim :=  aReg[1]
endif
AreaAnt( Arq_Ant, Ind_Ant )
return .T.



function DuplicaDocnr()

    LOCAL cScreen := SaveScreen()
    LOCAL Arq_Ant := Alias()
    LOCAL Ind_Ant := IndexOrd()
    LOCAL xTemp   := FTempName()
    LOCAL aStru   := Recemov->(DbStruct())
    LOCAL nConta  := Recemov->(FCount())
    LOCAL cCodi
    LOCAL xRegistro
    LOCAL xRegLocal

    ErrorBeep()
    if !Conf("Pergunta: Duplicar registro sob o cursor ?")
        Return( .F. )
    endif
    xRegistro := Recemov->(Recno())
    DbCreate( xTemp, aStru )
    dbUseArea( .T.,, (xTemp), "xAlias", iif( .F. .OR. .T., ! .T., NIL ), .F. )
    xAlias->(DbAppend())
    For nField := 1 To nConta
        xAlias->(FieldPut( nField, Recemov->(FieldGet( nField ))))
    Next
    if Recemov->(Incluiu())
        For nField := 1 To nConta
            Recemov->(FieldPut( nField, xAlias->(FieldGet( nField ))))
        Next
        xRegLocal := Recemov->(Recno())
        Recemov->(Libera())
    endif
    xAlias->(DbCloseArea())
    Ferase(xTemp)
    AreaAnt( Arq_Ant, Ind_Ant )
    Recemov->(DbGoto( xRegistro ))
    Return( .T. )




Function DuplicaAgenda()

LOCAL cScreen := SaveScreen()
LOCAL Arq_Ant := Alias()
LOCAL Ind_Ant := IndexOrd()
LOCAL xTemp   := FTempName()
LOCAL aStru   := Agenda->(DbStruct())
LOCAL nConta  := Agenda->(FCount())
LOCAL cCampo
LOCAL cCodi
LOCAL xRegistro
LOCAL xRegLocal

ErrorBeep()
if !Conf("Pergunta: Duplicar registro sob o cursor ?")
    Return( .F. )
endif
xRegistro := Agenda->(Recno())
DbCreate( xTemp, aStru )
dbUseArea( .T.,, (xTemp), "xAlias", iif( .F. .OR. .T., ! .T., NIL ), .F. )
xAlias->(DbAppend())
For nField := 1 To nConta
    cCampo := Agenda->(FieldName( nField ))
    if cCampo <> "ID"
        xAlias->(FieldPut( nField, Agenda->(FieldGet( nField ))))
    endif
Next
if Agenda->(Incluiu())
    For nField := 1 To nConta
        cCampo := Agenda->(FieldName( nField ))
        if cCampo <> "ID"
            Agenda->(FieldPut( nField, xAlias->(FieldGet( nField ))))
        endif
    Next
    xRegLocal := Agenda->(Recno())
    Agenda->(Libera())
endif
xAlias->(DbCloseArea())
Ferase(xTemp)
AreaAnt( Arq_Ant, Ind_Ant )
Agenda->(DbGoto( xRegistro ))
return( .T. )



Function NewPosiAgeInd( cCodi, nRecno, lRecarregar )

PRIVA oReceposi := TReceposiNew(07, 00, MaxRow()-4, MaxCol())
PosiAgeInd( cCodi, nRecno, lRecarregar )
oAmbiente:PosiAgeInd := .F.
return NIL

Function PosiAgeInd( cCodi, nRecno, lRecarregar )

LOCAL GetList    := {}
LOCAL cScreen    := SaveScreen()
LOCAL nConta    := 0
LOCAL dCalculo := Date()
LOCAL cString    := ""
LOCAL lPilha
LOCAL nValorTotal
LOCAL nTotalGeral
LOCAL aCabec
LOCAL nJuros
LOCAL cTela
LOCAL oBloco
LOCAL cRegiao
LOCAL dIni
LOCAL dFim
LOCAL Col
LOCAL cFilter
FIELD Regiao
FIELD Vcto
FIELD Juro
FIELD Codi
FIELD Docnr
FIELD Emis
FIELD Vlr

lPilha := cCodi <> NIL
WHILE .T.
     oReceposi:RenewVar()
    oAmbiente:PosiAgeInd := .T.
    dIni        := Date()-30
    dFim        := Date()
    dCalculo := Date()
    if !lPilha
        oMenu:Limpa()
        cCodi     := Space(05)
        MaBox( 14, 45, 16, 75 )
        SetCursor(1) ; DevPos( 15, 46 ) ; DevOut( "Cliente......:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cCodi, "cCodi", "99999", {|| RecErrado( @cCodi )},))
        ReadModal( GetList, NIL,,,,, ) ; GetList := {} ; ( GetList )
        if LastKey() = 27
            DbClearRel()
            ResTela( cScreen )
            Exit
        endif
    endif
    dbSelectArea( "Agenda" )
    Agenda->(Order( 6 ))
    if Agenda->(!DbSeek( cCodi ))
        Nada()
        if lPilha
            DbClearRel()
            ResTela( cScreen )
            Exit
        Else
            Loop
        endif
    endif
    oBloco  := {|| Field->Codi == cCodi }
    cFilter := "Field->Codi == cCodi."
   Col                  := 12
   nConta               := 0
   cTela                := Mensagem("Aguarde... ", Cor())
   While Eval( oBloco ) .AND. !Eof() .AND. !Tecla_ESC()
        if nConta > 65535
            Alerta("Erro: Impossivel mostrar mais do que 65535 registros.")
            Exit
        endif
        nConta++
        cSep        := "|"
        cAgenda1 := Dtoc(Agenda->Data)
        cAgenda2 := Agenda->Hora
        cAgenda3 := Agenda->Usuario
        cAgenda4 := Agenda->Hist

        cString1 := StrZero( nConta, 3)
        cString1 += cSep
        cString1 += cAgenda1
        cString1 += cSep
        cString1 += cAgenda2
        cString1 += cSep
        cString1 += Left(cAgenda3,6)
        cString1 += cSep
        cString1 += cAgenda4

        Aadd( oRecePosi:aAtivo, .T. )
      Aadd( oRecePosi:aAtivoSwap, .T. )
      Aadd( oRecePosi:aRecno, Agenda->(Recno()))
        Aadd( oReceposi:aCodi, cCodi )
        Aadd( oReceposi:aTodos, cString1 )
        Aadd( oReceposi:xTodos, {cCodi, Agenda->Data, Agenda->Hora, Agenda->Hist})
        Agenda->(DbSkip(1))
        oMenu:ContaReg()
    EndDo

    restela( cTela )
    if Len( oReceposi:aTodos ) > 0
        oReceposi:PosiAgeInd  := .T.
        oMenu:StatInf()
        oMenu:ContaReg(nConta)
        oReceposi:CloneVarColor()

        if lRecarregar <> NIL .AND. !lRecarregar
            return
        endif

        MaBox( 00, 00, 06, MaxCol())
        oRecePosi:aBottom      := oReceposi:BarraSoma()
        oRecePosi:cTop := " # |DATA    |HORA    |USER  |OBSERVACOES AGENDADA"
        oRecePosi:cTop += Space( MaxCol() - Len( cString ))
        oRecePosi:Redraw_()
        __Funcao( 0, 1, 1 )
        lPageCircular := .F.
        oRecePosi:aChoice_(oReceposi:aTodos, oRecePosi:aAtivo, "__Funcao", lPageCircular )
        oRecePosi:PosiAgeInd := .F.
        oAmbiente:PosiAgeInd := .F.
        oReceposi:Reset()
    endif
    ResTela( cScreen )
    if lPilha
        Return
    endif
EndDo



function NewPosiAgeAll( lRecarregar )

PRIVA oRecePosi     := TReceposiNew(07, 00, MaxRow()-4, MaxCol())
PosiAgeAll( lRecarregar )
oAmbiente:PosiAgeALL := .F.
return

function PosiAgeAll( lRecarregar )

LOCAL GetList    := {}
LOCAL cScreen    := SaveScreen()
LOCAL nConta    := 0
LOCAL cString    := ""
LOCAL cAgenda1 := ""
LOCAL cAgenda2 := ""
LOCAL cAgenda3 := ""
LOCAL cCodi    := Space(05)
LOCAL NewTodos
LOCAL cSep
LOCAL xLen
LOCAL cTela
LOCAL oBloco
STATI dIni
STATI dFim
STATI nOrdem
FIELD Data
FIELD Codi
FIELD Hist

lPilha := lRecarregar <> NIL
WHILE .T.
    oRecePosi:RenewVar()
    oAmbiente:PosiAgeAll := .T.
    if !lPilha
        dIni := Date()-30
        dFim := Date()
        MaBox( 15, 45, 18, 75 )
        SetCursor(1) ; DevPos( 16, 46 ) ; DevOut( "Data Inicial.:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( dIni, "dIni", "##/##/##",,))
        SetCursor(1) ; DevPos( 17, 46 ) ; DevOut( "Data Final...:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( dFim, "dFim", "##/##/##", {|| IF((Empty(dIni) .OR. dFim < dIni), ( ErrorBeep(), Alerta("Ooops!: Entre com uma data valida!"), .F. ), .T. )},))
        ReadModal( GetList, NIL,,,,, ) ; GetList := {} ; ( GetList )
        if LastKey() = 27
            DbClearRel()
            ResTela( cScreen )
            Exit
        endif

        aMenu := {"Data {Ultimo Agendamento}","Data {Todos Agendamentos}","Codigo {Ultimo Agendamento}","Codigo {Todos Agendamentos}", "Data {Ultimo Agendamento} - Ultimos por primeiro","Data {Todos Agendamentos} - Ultimos por primeiro","Codigo {Ultimo Agendamento} - Ultimos por primeiro","Codigo {Todos Agendamentos} - Ultimos por primeiro"}


        M_Title("ESCOLHA ORDEM DE AMOSTRAGEM")
        nOrdem := FazMenu( 19 , 45 , aMenu)

        if LastKey() = 27
            ResTela( cScreen )
            Exit
        endif
    endif

    Receber->(Order( 2 ))
    dbSelectArea( "Agenda" )
   nConta   := 0
   NewTodos := {}
   oBloco   := {|| Agenda->Data >= dIni .AND. Agenda->Data <= dFim }
    Agenda->(Order( 7 ))
    OrdScope( 0, dTos(dIni))
    OrdScope( 1, dTos(dFim))
    cTela  := Mensagem("Pass #1 Aguarde... Filtrando registros. ESC cancela.")
    Agenda->(DbGoTop())
    if Sx_KeyCount() == 0
        OrdScope( 0 )
        OrdScope( 1 )
        Nada()
        ResTela( cScreen )
        Loop
    endif
   While Eval( oBloco ) .AND. !Tecla_ESC()
        if nConta > 65535
            Alerta("Erro: Impossivel mostrar mais do que 65535 registros.")
            Exit
        endif
        cCodi := Agenda->Codi
        nConta++
        Aadd( oReceposi:xTodos, {cCodi, Agenda->Data, Agenda->Hora, Agenda->Hist, Agenda->Usuario, Agenda->(Recno())})
        aadd( oReceposi:Color_pFore,  oReceposi:CorDuplicado )
        oMenu:ContaReg()
        Agenda->(DbSkip(1))
    endDo
    OrdScope( 0 )
    OrdScope( 1 )
    cCodi     := Agenda->Codi
    cSep        := "|"
    ResTela( cTela )


    cTela := Mensagem("Pass #2 Aguarde... Indexando registros.")
    if     nOrdem = 1  .OR. nOrdem = 5
        asort( oReceposi:xTodos,,, {|x,y|y[1] > x[1]})
        xLen := Len(oReceposi:xTodos)
        NewTodos := {}
        for nT := 2 To xLen
            cCodi := oReceposi:xTodos[nT-1 , 1]
            if oReceposi:xTodos[nT-1 , 4] <> "PAG PARCIAL"
                if oReceposi:xTodos[nT, 1] <> cCodi
                    aadd( NewTodos, oReceposi:xTodos[nT-1])
                    aadd( oReceposi:Color_pFore,  oReceposi:CorDuplicado )
                endif
            endif
        next
        oReceposi:xTodos := NewTodos
        if nOrdem = 1
            asort( oReceposi:xTodos,,, {|x,y|y[2] > x[2]})
        else
            asort( oReceposi:xTodos,,, {|x,y|y[2] < x[2]})
        endif

    elseif nOrdem = 2  .OR. nOrdem = 6
        asort( oReceposi:xTodos,,, {|x,y|y[1] > x[1]})
        xLen := Len(oReceposi:xTodos)
        for nT := 2 To xLen
            cCodi := oReceposi:xTodos[nT-1 , 1]
            if oReceposi:xTodos[nT, 1] == cCodi
                oReceposi:Color_pFore[nT-1] := oReceposi:CorRecibo
            endif
        next
        if nOrdem = 2
            asort( oReceposi:xTodos,,, {|x,y|y[2] > x[2]})
        else
            asort( oReceposi:xTodos,,, {|x,y|y[2] < x[2]})
        endif

    elseif nOrdem = 3 .OR. nOrdem = 7
        asort( oReceposi:xTodos,,, {|x,y|y[1] > x[1]})
        xLen := Len(oReceposi:xTodos)
        NewTodos := {}
        for nT := 2 To xLen
            cCodi := oReceposi:xTodos[nT-1 , 1]
            if oReceposi:xTodos[nT-1 , 4] <> "PAG PARCIAL"
                if oReceposi:xTodos[nT, 1] <> cCodi
                    aadd( NewTodos, oReceposi:xTodos[nT-1])
                    aadd( oReceposi:Color_pFore,  oReceposi:CorDuplicado )
                endif
            endif
        next
        if nOrdem = 3
            oReceposi:xTodos := NewTodos
        else
            oReceposi:xTodos := NewTodos
            asort( oReceposi:xTodos,,, {|x,y|y[2] < x[2]})
        endif

    elseif nOrdem = 4  .OR. nOrdem = 8
        asort( oReceposi:xTodos,,, {|x,y|y[1] > x[1]})
        xLen := Len(oReceposi:xTodos)
        for nT := 2 To xLen
            cCodi := oReceposi:xTodos[nT-1 , 1]
            if oReceposi:xTodos[nT, 1] == cCodi
                oReceposi:Color_pFore[nT-1] := oReceposi:CorRecibo
            endif
        next
        if nOrdem = 8
            asort( oReceposi:xTodos,,, {|x,y|y[1] < x[1]})
        endif

    endif

    xLen := Len(oReceposi:xTodos)
    for nT := 1 To xLen
        cAgenda1 := Dtoc(oReceposi:xTodos[nT, 2])
        cAgenda2 := oReceposi:xTodos[nT, 3]
        cAgenda3 := oReceposi:xTodos[nT, 5]
        cAgenda4 := oReceposi:xTodos[nT, 4]

        cString1 := StrZero( nT, 3)
        cString1 += cSep
        cString1 += cAgenda1
        cString1 += cSep
        cString1 += cAgenda2
        cString1 += cSep
        cString1 += Left(cAgenda3, 6)
        cString1 += cSep
        cString1 += cAgenda4
        aadd( oReceposi:aTodos,       cString1 )
        aadd( oReceposi:Color_pBack,  oAmbiente:CorLightBar )
        aadd( oReceposi:Color_pUns,   oReceposi:CorRecibo )
        aadd( oReceposi:aCodi,        oReceposi:xTodos[nT, 1])
        aadd( oRecePosi:aRecno,       oReceposi:xTodos[nT, 6])
        aadd( oRecePosi:aAtivo,       .T. )
      aadd( oRecePosi:aAtivoSwap,   .T. )
    next

    ResTela( cTela )
    if nConta = 0
        Nada()
        Loop
    endif
    if Len(oReceposi:aTodos) > 0
        oReceposi:PosiAgeAll := .T.
        oMenu:StatInf()
        oMenu:ContaReg(nConta)
        oReceposi:CloneVarColor()

        if lRecarregar <> NIL .AND. !lRecarregar
            return
        endif

        MaBox( 00, 00, 06, MaxCol())
        oRecePosi:aBottom      := oReceposi:BarraSoma()
        oRecePosi:cTop := " # |DATA    |HORA    |USER  |OBSERVACOES AGENDADA"
        oRecePosi:cTop += Space( MaxCol() - Len( cString ))
        oRecePosi:Redraw_()
        __Funcao( 0, 1, 1 )
        lPageCircular := .F.
        oRecePosi:aChoice_(oReceposi:aTodos, oRecePosi:aAtivo, "__Funcao", lPageCircular )
        oRecePosi:PosiAgeAll := .F.
        oAmbiente:PosiAgeAll := .F.
        oReceposi:Reset()
    endif
    ResTela( cScreen )
    if lPilha
        Return
    endif
EndDo



function NewPosiAgeReg( lRecarregar)

PRIVA oRecePosi := TReceposiNew(07, 00, MaxRow()-4, MaxCol())
PosiAgeReg( lRecarregar)
oAmbiente:PosiAgeAll := .F.
return

function PosiAgeReg( lRecarregar)

LOCAL GetList    := {}
LOCAL cScreen    := SaveScreen()
LOCAL nConta    := 0
LOCAL cString    := ""
LOCAL cAgenda1 := ""
LOCAL cAgenda2 := ""
LOCAL cAgenda3 := ""
LOCAL cAgenda4 := ""
LOCAL cRegiao  := Space(2)
LOCAL dIni     := Date()-30
LOCAL dFim     := Date()
LOCAL cCodi
LOCAL cTela
LOCAL oBloco
LOCAL oBloco2
LOCAL oBloco3
FIELD Data
FIELD Codi
FIELD Hist

lPilha := cCodi <> NIL
WHILE .T.
    oRecePosi:RenewVar()
    oAmbiente:PosiAgeAll := .T.
    MaBox( 15, 45, 19, 75 )
    SetCursor(1) ; DevPos( 16, 46 ) ; DevOut( "Regiao.......:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cRegiao, "cRegiao", "99", {|| RegiaoErrada( @cRegiao )},))
    SetCursor(1) ; DevPos( 17, 46 ) ; DevOut( "Data Inicial.:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( dIni, "dIni", "##/##/##",,))
    SetCursor(1) ; DevPos( 18, 46 ) ; DevOut( "Data Final...:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( dFim, "dFim", "##/##/##",,))
    ReadModal( GetList, NIL,,,,, ) ; GetList := {} ; ( GetList )
    if LastKey() = 27
        DbClearRel()
        ResTela( cScreen )
        Exit
    endif
    Receber->(Order(4))
   if Receber->(!DbSeek(cRegiao))
        Nada()
        ResTela( cScreen )
        Loop
    endif
   nConta               := 0
   oReceposi:aTodos     := {}
   oReceposi:xTodos     := {}
   oReceposi:aCodi      := {}
   oRecePosi:aAtivo     := {}
   oRecePosi:aAtivoSwap := {}
   oRecePosi:aRecno     := {}
   oBloco               := {|| Receber->Regiao = cRegiao }
   cTela                := Mensagem("Aguarde... Filtrando registros. ESC cancela.")
   While Eval(oBloco) .AND. !Tecla_ESC()
      cCodi := Receber->Codi
        Agenda->(Order(6))
      if Agenda->(!DbSeek(cCodi))
            Receber->(DbSkip(1))
            Loop
        endif
      oBloco2 := {|| Agenda->Codi = cCodi }
      While Eval( oBloco2 ) .AND. !Tecla_ESC()
            if nConta > 65535
                Alerta("Erro: Impossivel mostrar mais do que 65535 registros.")
                Exit
            endif
         oBloco3 := {|| Agenda->Data >= dIni .AND. Agenda->Data <= dFim}
         if !(Eval(oBloco3))
            Agenda->(DbSkip(1))
            Loop
         endif
            cSep        := "|"
            cAgenda1 := Dtoc(Agenda->Data)
            cAgenda2 := Agenda->Hora
            cAgenda3 := Agenda->Usuario
            cAgenda4 := Agenda->Hist
            cString1 := StrZero( nConta, 3)
            cString1 += cSep
            cString1 += cAgenda1
            cString1 += cSep
            cString1 += cAgenda2
            cString1 += cSep
            cString1 += Left(cAgenda3,6)
            cString1 += cSep
            cString1 += cAgenda4
         nConta++
         Aadd( oReceposi:aCodi, cCodi )
         Aadd( oRecePosi:aAtivo, .T. )
         Aadd( oRecePosi:aAtivoSwap, .T. )
         Aadd( oRecePosi:aRecno, Agenda->(Recno()))
         Aadd( oReceposi:aTodos, cString1 )
         Aadd( oReceposi:xTodos, {cCodi, Agenda->Data, Agenda->Hora, Agenda->Hist})
         Agenda->(DbSkip(1))
            oMenu:ContaReg()
        EndDo
        Receber->(DbSkip(1))
    EndDo
    OrdScope( 0 )
    OrdScope( 1 )
    ResTela( cTela )
    if nConta = 0
        Nada()
        Loop
    endif
    if Len(oReceposi:aTodos) > 0
        oReceposi:PosiAgeAll := .T.
        oMenu:StatInf()
        oMenu:ContaReg(nConta)
        oReceposi:CloneVarColor()

        if lRecarregar <> NIL .AND. !lRecarregar
            return
        endif

        MaBox( 00, 00, 06, MaxCol())
        oRecePosi:aBottom      := oReceposi:BarraSoma()
        oRecePosi:cTop := " # |DATA    |HORA    |USER  |OBSERVACOES AGENDADA"
        oRecePosi:cTop += Space( MaxCol() - Len( cString ))
        oRecePosi:Redraw_()
        __Funcao( 0, 1, 1 )
        lPageCircular := .F.
        oRecePosi:aChoice_(oReceposi:aTodos, oRecePosi:aAtivo, "__Funcao", lPageCircular )
        oRecePosi:PosiAgeAll := .F.
        oAmbiente:PosiAgeAll := .F.
        oReceposi:Reset()
    endif
    ResTela( cScreen )
    if lPilha

        Return
    endif
EndDo

function NewPosiReceber( nChoice, xParam, cCaixa, lRescisao, nASort, cTipoRecibo, lRecarregar, lRecepago, xOrdem)

PRIVA oReceposi := TReceposiNew(07, 00, MaxRow()-4, MaxCol())
PosiReceber( nChoice, xParam, cCaixa, lRescisao, nASort, cTipoRecibo, lRecarregar, lRecepago, xOrdem )
oAmbiente:lReceber := .F.
return NIL

function PosiReceber( nChoice, xParam, cCaixa, lRescisao, nASort, cTipoRecibo, lRecarregar, lRecepago, xOrdem )

LOCAL GetList     := {}
LOCAL cScreen     := SaveScreen()
LOCAL nConta     := 0
LOCAL nT          := 0
LOCAL xLen         := 0
LOCAL nJuroDia  := 0
LOCAL cColor     := SetColor()
LOCAL nMaxCol   := MaxCol()
LOCAL aMenu     := {"Todos Lancamentos - Inclusive recibos emitidos", "Somente em aberto - Nao incluir recibos emitidos", "Somente Recebidos - Nao incluir em aberto"}
LOCAL lSair     := .T.
LOCAL linhaembranco   := ";"
LOCAL linhahorizontal := "-"
LOCAL Ind_Recemov
LOCAL Ind_Recebido
LOCAL lCalcular
LOCAL nValorTotal
LOCAL nTotalGeral
LOCAL aCabec
LOCAL nJuros
LOCAL cTela
LOCAL oBloco
LOCAL oBloco2
LOCAL Col
LOCAL xObs
LOCAL cStr
LOCAL xDataPag
LOCAL lMsg
LOCAL nJuroMesComposto
STATI dIni
STATI dFim
STATI cRegiao
STATI dCalculo
STATI nOrdem
STATI cTipo
STATI cFatu
STATI cCodi
STATI xSeek
FIELD Regiao
FIELD Vcto
FIELD Juro
FIELD Codi
FIELD Docnr
FIELD Emis
FIELD Vlr
IF cTipoRecibo == NIL ; cTipoRecibo := nil ; END


if( lRescisao = NIL, lRescisao := .F., lRescisao )
Receber->(Order( 2 ))
Recemov->(DbGoTop())
if Recemov->(Eof())
    Nada()
    ResTela( cScreen )
    Return
endif

if( cCodi = NIL, cCodi := Space(05), cCodi )
WHILE .T.
    oReceposi:RenewVar()
    oAmbiente:lReceber := .T.
    lSair              := .T.
   Do Case
    Case nChoice = 1
        if xParam <> NIL
            cCodi    := xParam
            xSeek    := cCodi
         dFim     := Ctod("31/12/" + Right(Dtoc(Date()),2))
            dCalculo := Date()
            AchaUltVcto(cCodi, @dFim)
            if oAmbiente:Ano2000
            dIni := Ctod("01/01/80")
            Else
            dIni := Ctod("01/01/01")
            endif
            if xOrdem == nil
                nOrdem := 1
            else
                nOrdem := xOrdem
            endif
        else
           cCodi    := Space(5)
         dIni     := Ctod("01/01/91")
         dFim     := Ctod("31/12/" + Right(Dtoc(Date()),2))
         dCalculo := Date()
            if lRescisao
                cStr        := "Data Rescisao:"
            Else
                cStr        := "Calcular ate.:"
            endif
            MaBox( 14, 45, 19, 75 )
         SetCursor(1) ; DevPos( 15, 46 ) ; DevOut( "Cliente......:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cCodi, "cCodi", "99999", {|| RecErrado(@cCodi)},))
         SetCursor(1) ; DevPos( 16, 46 ) ; DevOut( "Data Inicial.:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( dIni, "dIni", "##/##/##", {|| AchaUltVcto(cCodi, @dFim)},))
         SetCursor(1) ; DevPos( 17, 46 ) ; DevOut( "Data Final...:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( dFim, "dFim", "##/##/##", {|| IF((Empty(dFim) .OR. dFim < dIni), ( ErrorBeep(), Alerta("Ooops!: Entre com uma data valida! Maior ou igual data inicial"), .F. ), .T. )},))
         SetCursor(1) ; DevPos( 18, 46 ) ; DevOut( cStr ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( dCalculo, "dCalculo", "##/##/##",,))
            ReadModal( GetList, NIL,,,,, ) ; GetList := {} ; ( GetList )
            if LastKey() = 27
                DbClearRel()
                resTela( cScreen )
                Exit
            endif
            mensagem("Informa: Verifique a opcao de ativar mostrar ou nao clientes desativados.", 31, 14, 76)
            M_Title("ESCOLHA ORDEM DE AMOSTRAGEM")
            nOrdem := FazMenu( 20 , 45 , aMenu)
            if nOrdem = 0 .OR. LastKey() = 27
                ResTela( cScreen )
                loop
            endif
            xParam := cCodi
            lSair  := .F.
            xSeek  := cCodi
            oReceposi:nOrdem := nOrdem
        endif

        Recebido->(Order(4))
        Recemov->(Order(2))
        if lRecepago == NIL
            if Recemov->(!DbSeek(xSeek))
                if Recebido->(!DbSeek(xSeek))
                    Nada()
                    if xParam <> NIL
                        Exit
                    else
                        Loop
                    endif
                endif
            endif
        else
            if Recebido->(!DbSeek(xSeek))
                xParam := NIL
                Nada()
                ResTela( cScreen )
                Loop
            endif
        endif

        Ind_Recebido := Recebido->(IndexOrd())
        Ind_Recemov  := Recemov->(IndexOrd())
        oBloco         := {|| Recemov->Codi  = xSeek }
        oBloco2         := {|| Recebido->Codi = xSeek }
        oReceposi:PosiReceber := .T.

    Case nChoice = 2
        if xParam == NIL
            cRegiao    := Space(02)
            dIni        := Ctod("01/01/91")
            dFim        := Ctod("31/12/" + Right(Dtoc(Date()),2))
            dCalculo := Date()
            MaBox( 14, 45, 19, 75 )
            SetCursor(1) ; DevPos( 15, 46 ) ; DevOut( "Regiao.......:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cRegiao, "cRegiao", "99", {|| RegiaoErrada( @cRegiao )},))
            SetCursor(1) ; DevPos( 16, 46 ) ; DevOut( "Data Inicial.:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( dIni, "dIni", "##/##/##",,))
            SetCursor(1) ; DevPos( 17, 46 ) ; DevOut( "Data Final...:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( dFim, "dFim", "##/##/##", {|| IF((Empty(dFim) .OR. dFim < dIni), ( ErrorBeep(), Alerta("Ooops!: Entre com uma data valida! Maior ou igual data inicial"), .F. ), .T. )},))
            SetCursor(1) ; DevPos( 18, 46 ) ; DevOut( "Calcular ate.:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( dCalculo, "dCalculo", "##/##/##",,))
            ReadModal( GetList, NIL,,,,, ) ; GetList := {} ; ( GetList )
            if LastKey() = 27
                DbClearRel()
                ResTela( cScreen )
                Exit
            endif
            mensagem("Informa: Verifique a opcao de ativar mostrar ou nao clientes desativados.", 31, 14, 76)
            M_Title("ESCOLHA ORDEM DE AMOSTRAGEM")
            nOrdem := FazMenu( 20 , 45 , aMenu)
            if nOrdem = 0 .OR. LastKey() = 27
                ResTela( cScreen )
                loop
            endif
            xParam := cRegiao
            lSair  := .F.
            oReceposi:nOrdem := nOrdem
        endif
        Recebido->(Order(9))
        Recemov->(Order(5))
        xSeek := cRegiao
        if lRecepago == NIL
            if Recemov->(!DbSeek(xSeek))
                if Recebido->(!DbSeek(xSeek))
                    xParam := NIL
                    Nada()
                    Loop
                endif
            endif
        else
            if Recebido->(!DbSeek(xSeek))
                xParam := NIL
                Nada()
                ResTela( cScreen )
                Loop
            endif
        endif
        Ind_Recebido := Recebido->(IndexOrd())
        Ind_Recemov  := Recemov->(IndexOrd())
        oBloco  := {|| Recemov->Regiao  = xSeek }
        oBloco2 := {|| Recebido->Regiao = xSeek }

        oReceposi:PosiReceber := .T.

    Case nChoice = 3
        if xParam == NIL
            dIni        := Ctod("01/" + StrZero(Month(Date()),2) + "/" + Right(Dtoc(Date()),2))
            dFim        := Date()
            dCalculo := Date()
            MaBox( 14, 45, 18, 75 )
            SetCursor(1) ; DevPos( 15, 46 ) ; DevOut( "Data Inicial.:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( dIni, "dIni", "##/##/##",,))
            SetCursor(1) ; DevPos( 16, 46 ) ; DevOut( "Data Final...:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( dFim, "dFim", "##/##/##", {|| IF((Empty(dFim) .OR. dFim < dIni), ( ErrorBeep(), Alerta("Ooops!: Entre com uma data valida! Maior ou igual data inicial"), .F. ), .T. )},))
            SetCursor(1) ; DevPos( 17, 46 ) ; DevOut( "Calcular ate.:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( dCalculo, "dCalculo", "##/##/##",,))
            ReadModal( GetList, NIL,,,,, ) ; GetList := {} ; ( GetList )
            if LastKey() = 27
                DbClearRel()
                ResTela( cScreen )
                Exit
            endif
            mensagem("Informa: Verifique a opcao de ativar mostrar ou nao clientes desativados.", 31, 14, 76)
            M_Title("ESCOLHA ORDEM DE AMOSTRAGEM")
            nOrdem := FazMenu( 19 , 45 , aMenu)
            if nOrdem = 0 .OR. LastKey() = 27
                ResTela( cScreen )
                loop
            endif
            xParam := dIni
            lSair  := .F.
            oReceposi:nOrdem := nOrdem
        endif

        cTela := Mensagem("Aguarde... Filtrando registros. ESC cancela.")
        Recibo->(Order(5))
        Recebido->(Order( 2 ))
        nIndex := IIF( cTipoRecibo = nil , 3, 9)
        nIndex := IIF( nOrdem == 3, 9, nIndex)
        Recemov->(Order(nIndex))
        xSeek := dIni
        if lRecepago == NIL
            if Recemov->(!SeekData( dIni, dFim, IIF( nIndex == 3, "Vcto", "Datapag")))
                if Recebido->(!SeekData( dIni, dFim, "Datapag"))
                    xParam := NIL
                    Nada()
                    xParam := NIL
                    ResTela( cScreen )
                    Loop
                endif
            endif
        else
            if Recibo->(!SeekData( dIni, dFim, "Data"))
                if Recebido->(!SeekData( dIni, dFim, "Datapag"))
                    xParam := NIL
                    Nada()
                    ResTela( cScreen )
                    Loop
                endif
            endif
        endif

        Ind_Recebido := Recebido->(IndexOrd())
        Ind_Recemov  := Recemov->(IndexOrd())

        if cTipoRecibo <> NIL
            oBloco         := {|| Recemov->DataPag  >= dIni .AND. Recemov->DataPag <= dFim }
        else
            if nOrdem == 3
                oBloco     := {|| Recemov->DataPag  >= dIni .AND. Recemov->DataPag <= dFim }
            else
                oBloco     := {|| Recemov->Vcto     >= dIni .AND. Recemov->Vcto    <= dFim }
            endif
        endif
        oBloco2         := {|| Recebido->DataPag >= dIni .AND. Recebido->DataPag <= dFim }
        oReceposi:PosiReceber        := .T.
        oRecePosi:lReceberPorPeriodo := .T.

    Case nChoice = 4
        if xParam == NIL
            cTipo     := Space(06)
            dIni        := Ctod("01/01/91")
            dFim        := Ctod("31/12/" + Right(Dtoc(Date()),2))
            dCalculo := Date()
            MaBox( 14, 45, 19, 75 )
            SetCursor(1) ; DevPos( 15, 46 ) ; DevOut( "Tipo.........:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cTipo, "cTipo", "@!", {|| AchaTipo( cTipo )},))
            SetCursor(1) ; DevPos( 16, 46 ) ; DevOut( "Data Inicial.:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( dIni, "dIni", "##/##/##",,))
            SetCursor(1) ; DevPos( 17, 46 ) ; DevOut( "Data Final...:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( dFim, "dFim", "##/##/##", {|| IF((Empty(dFim) .OR. dFim < dIni), ( ErrorBeep(), Alerta("Ooops!: Entre com uma data valida! Maior ou igual data inicial"), .F. ), .T. )},))
            SetCursor(1) ; DevPos( 18, 46 ) ; DevOut( "Calcular ate.:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( dCalculo, "dCalculo", "##/##/##",,))
            ReadModal( GetList, NIL,,,,, ) ; GetList := {} ; ( GetList )
            if LastKey() = 27
                Recemov->(DbClearRel())
                Recemov->(DbGoTop())
                ResTela( cScreen )
                Exit
            endif
            mensagem("Informa: Verifique a opcao de ativar mostrar ou nao clientes desativados.", 31, 14, 76)
            M_Title("ESCOLHA ORDEM DE AMOSTRAGEM")
            nOrdem := FazMenu( 20 , 45 , aMenu)
            if nOrdem = 0 .OR. LastKey() = 27
                ResTela( cScreen )
                loop
            endif
            xParam := cTipo
            lSair  := .F.
            oReceposi:nOrdem := nOrdem
        endif
        Recebido->(Order(11))
        Recemov->(Order(8))
        xSeek := cTipo
        if lRecepago == NIL
            if Recemov->(!DbSeek(xSeek))
                if Recebido->(!DbSeek(xSeek))
                    xParam := NIL
                    Nada()
                    Loop
                endif
            endif
        else
            if Recebido->(!DbSeek(xSeek))
                xParam := NIL
                Nada()
                ResTela( cScreen )
                Loop
            endif
        endif
        Ind_Recebido := Recebido->(IndexOrd())
        Ind_Recemov  := Recemov->(IndexOrd())
        oBloco  := {|| Recemov->Tipo = xSeek }
        oBloco2 := {|| Recebido->Tipo = xSeek }

        oReceposi:PosiReceber := .T.

    Case nChoice = 5
        if xParam == NIL
            dCalculo := Date()
            cFatu    := Space(7)
            MaBox( 14, 45, 16, 67 )
            SetCursor(1) ; DevPos( 15, 46 ) ; DevOut( "Fatura N§.:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( cFatu, "cFatu", "@!", {|| VisualAchaFatura( @cFatu )},))
            ReadModal( GetList, NIL,,,,, ) ; GetList := {} ; ( GetList )
            if LastKey() = 27
                Recemov->(DbClearRel())
                Recemov->(DbGoTop())
                ResTela( cScreen )
                Exit
            endif
            mensagem("Informa: Verifique a opcao de ativar mostrar ou nao clientes desativados.", 31, 14, 76)
            M_Title("ESCOLHA ORDEM DE AMOSTRAGEM")
            nOrdem := FazMenu( 19 , 45 , aMenu)
            if nOrdem = 0 .OR. LastKey() = 27
                ResTela( cScreen )
                Loop
            endif
            xParam := cFatu
            lSair  := .F.
            oReceposi:nOrdem := nOrdem
        else
            cFatu := xParam
        endif
        dbSelectArea( "Recebido" )
        Recebido->(Order( 3 ))
        Ind_Recebido := Recebido->(IndexOrd())
        dbSelectArea( "Recemov" )
        Recemov->(Order( 4 ))
        Ind_Recemov  := Recemov->(IndexOrd())
        oBloco         := {|| Recemov->Fatura = cFatu }
        oBloco2         := {|| Recebido->Fatura = cFatu }
        xSeek          := cFatu
        if lRecepago == NIL
            if Recemov->(!DbSeek(cFatu))
                if Recebido->(!DbSeek(cFatu))
                    Nada()
                    if xParam <> NIL
                        ResTela( cScreen )
                        Exit
                    Else
                        Loop
                    endif
                endif
            endif
        else
            if Recebido->(!DbSeek(cFatu))
                Nada()
                if xParam <> NIL
                    ResTela( cScreen )
                    Exit
                Else
                    Loop
                endif
            endif
        endif


        oReceposi:PosiReceber := .T.

    Case nChoice = 6
       if xParam == NIL
            dCalculo := Date()
            MaBox( 14, 45, 16, 75 )
            SetCursor(1) ; DevPos( 15, 46 ) ; DevOut( "Calcular ate.:" ) ; SetCursor(1) ; SetPos( Row(), Col()+1 ) ; AAdd( GetList, _GET_( dCalculo, "dCalculo", "##/##/##", {|| IF(Empty(dCalculo), ( ErrorBeep(), Alerta("Ooops!: Entre com uma data valida!"), .F. ), .T. )},))
            ReadModal( GetList, NIL,,,,, ) ; GetList := {} ; ( GetList )
            if LastKey() = 27
                Recemov->(DbClearRel())
                Recemov->(DbGoTop())
                ResTela( cScreen )
                Exit
            endif
            mensagem("Informa: Verifique a opcao de ativar mostrar ou nao clientes desativados.", 31, 14, 76)
            M_Title("ESCOLHA ORDEM DE AMOSTRAGEM")
            nOrdem := FazMenu( 19 , 45 , aMenu)
            if nOrdem = 0 .OR. LastKey() = 27
                ResTela( cScreen )
                Loop
            endif
            xParam := dCalculo
            lSair  := .F.
            oReceposi:nOrdem := nOrdem
        endif
        Recebido->(Order(4))
        Recebido->(DbGotop())
        Recemov->(Order(2))
        if lRecepago == NIL
            if Recemov->(Eof())
                if Recebido->(Eof())
                    xParam := NIL
                    Nada()
                    Loop
                endif
            endif
        else
            if Recebido->(Eof())
                xParam := NIL
                Nada()
                ResTela( cScreen )
                Loop
            endif
        endif
        Ind_Recebido := Recebido->(IndexOrd())
        Ind_Recemov  := Recemov->(IndexOrd())
        oBloco         := {|| Recemov->(!Eof()) }
        oBloco2         := {|| Recebido->(!Eof()) }

        oReceposi:PosiReceber := .T.

    Case nChoice = 7
        cFatu := Right(xParam[1], 8)
        cCodi := xParam[2]
        dIni  := xParam[3]
        dFim  := xParam[4]

        dbSelectArea( "Recebido" )
        Recebido->(Order( 1 ))
        Ind_Recebido := Recebido->(IndexOrd())
        dbSelectArea( "Recemov" )
        Recemov->(Order( 12 ))
        Ind_Recemov  := Recemov->(IndexOrd())
        oBloco         := {|| Right(Recemov->Docnr,  8) = cFatu }
        oBloco2         := {|| Right(Recebido->Docnr, 8) = cFatu }
        xSeek          := cFatu

        if lRecepago == NIL
            if Recemov->(!DbSeek(cFatu))
                if Recebido->(!DbSeek(cFatu))




                    alertaPy(" INFO: Nada encontrado nos parametros informados abaixo: ;-;;" +     " Fatura: " + cFatu + ";" +     " Codigo: " + cCodi + ";" +     "  Busca: " + xSeek + ";" +     "   Data: " + dToc(dIni), 31 , .F.)
                    if xParam <> NIL
                        ResTela( cScreen )
                        Exit
                    Else
                        Loop
                    endif
                endif
            endif
        else
            if Recebido->(!DbSeek(cFatu))




                alertaPy(" INFO: Nada encontrado nos parametros informados abaixo: ;-;;" +     " Fatura: " + cFatu + ";" +     " Codigo: " + cCodi + ";" +     "  Busca: " + xSeek + ";" +     "   Data: " + dToc(dIni), 31 , .F.)
                if xParam <> NIL
                    ResTela( cScreen )
                    Exit
                Else
                    Loop
                endif
            endif
        endif


        oReceposi:PosiReceber := .T.

    Case nChoice = 8
      cCodi := xParam[1]
      dIni  := xParam[2]
        dFim  := xParam[3]

        xSeek := iif(nOrdem == 3, dIni, cCodi + dTos(dIni))
        Recebido->(Order(iif(nOrdem == 3, 2, 12)))
        Recemov->(Order(iif(nOrdem == 3, 9, 11)))
        if lRecepago == NIL
            if Recemov->(!DbSeek(xSeek))
                if Recebido->(!DbSeek(xSeek))



                    alertaPy(" INFO: Nada encontrado nos parametros informados abaixo: ;-;;" +     " Codigo: " + cCodi + ";" +     "  Busca: " + xSeek + ";" +     "   Data: " + dToc(dIni), 31 , .F.)
                    if xParam <> NIL
                        Exit
                    else
                        Loop
                    endif
                endif
            endif
        else
            if Recebido->(!DbSeek(xSeek))
                xParam := NIL



                alertaPy(" INFO: Nada encontrado nos parametros informados abaixo: ;-;;" +     " Codigo: " + cCodi + ";" +     "  Busca: " + xSeek + ";" +     "   Data: " + dToc(dIni), 31 , .F.)
                ResTela( cScreen )
                Loop
            endif
        endif

        Ind_Recebido := Recebido->(IndexOrd())
        Ind_Recemov  := Recemov->(IndexOrd())
        if nOrdem == 3
            oBloco        := {|| Recemov->DataPag  >= dIni .AND. Recemov->DataPag  <= dFim }
            oBloco2         := {|| Recebido->DataPag >= dIni .AND. Recebido->DataPag <= dFim }
        else
            oBloco        := {|| Recemov->Codi  = cCodi .AND. Recemov->DataPag  >= dIni .AND. Recemov->DataPag  <= dFim }
            oBloco2         := {|| Recebido->Codi = cCodi .AND. Recebido->DataPag >= dIni .AND. Recebido->DataPag <= dFim }
        endif
        oReceposi:PosiReceber := .T.

    EndCase

    nRecebido    := 0
    nValorTotal := 0
    nTotalGeral := 0
    nJuros        := 0
    nMulta        := 0
    nAtraso        := 0
    nDesconto    := 0
    nSoma         := 0
    Col            := 12
    nConta        := 0
    xObs            := Space(0)
    cTela         := Mensagem("Aguarde, Localizando registros em aberto", Cor())
    lCalcular    := (dCalculo <> Ctod("00/00/00"))
    dCalculo     := IF(!lCalcular, Date(), dCalculo)

    if lRecepago == NIL


        Receber->(Order( 2 ))
        Recibo->(Order( 3))
        if nChoice <> 3 .AND. nChoice <> 6
            dbSelectArea( "Recemov" )
            Recemov->(Order( Ind_Recemov ))
            Recemov->(DbSeek( xSeek ))
        endif

        WHILE Recemov->(Eval(oBloco))

            if nConta >= 65535
                alerta("Erro: Impossivel mostrar mais de 65535 registros.")
                exit
            endif

            cCodi    := Recemov->Codi
            cDocnr   := Recemov->Docnr
            xDataPag := Ctod("31/12/2099")
            xId      := 0

            Recibo->(Order(3))
            if Recibo->(DbSeek( Recemov->Docnr ))
                xDataPag := Recibo->Data
                xId      := Recibo->id
            else
                if nChoice <> 5 .AND. nChoice <> 6
                    if Recemov->Vcto < dIni .OR. Recemov->Vcto > dFim
                        Recemov->(DbSkip(1))
                        Loop
                    endif
                endif
            endif

            if cTipoRecibo <> NIL
                if Recibo->(DbSeek(cDocnr)) .AND. Recibo->Data >= dIni .AND. Recibo->Data <= dFim
                    xDataPag := Recibo->Data
                    if oAmbiente:cTipoRecibo <> "RECALL"
                        if Recibo->Tipo <> oAmbiente:cTipoRecibo
                            Recemov->(DbSkip(1))
                            Loop
                        endif
                    endif
                else
                    Recemov->(DbSkip(1))
                    Loop
                endif
            endif

            if cTipoRecibo == NIL
                if !oAmbiente:Mostrar_Desativados .AND. nOrdem <> 3
                    if nChoice <> 1
                        if nChoice <> 5
                            Receber->(Order( 2 ))
                            if Receber->(DbSeek( cCodi ))
                                if !Receber->Suporte
                                    Recemov->(DbSkip(1))
                                    Loop
                                endif
                            endif
                        endif
                    endif
                endif
            endif

            if     nOrdem == NIL .OR. nOrdem == 1 .OR. oAmbiente:PosiAgeInd .OR. oAmbiente:PosiAgeAll

            elseif nOrdem == 2
                if Recibo->(DbSeek(cDocnr))
                    Recemov->(DbSkip(1))
                    Loop
                endif

            elseif nOrdem == 3
                if Recibo->(!DbSeek(cDocnr))
                    Recemov->(DbSkip(1))
                    Loop
                endif
                if Recibo->Data < dIni .OR. Recibo->Data > dFim
                    Recemov->(DbSkip(1))
                    Loop
                endif
            endif

            xObs    := Recemov->Obs
            cCodi   := Recemov->Codi
            nAtraso := Atraso( dCalculo, Recemov->Vcto )
            nVlr      := Recemov->Vlr
            if lRescisao
                if nAtraso < 0
                    if nAtraso < -30
                        nVlr *= 0.5
                    Else
                        nDiaComUso := (30 + nAtraso)
                        nDiaSemUso := (30 - nDiaComUso)
                        nVlrComUso := (nDiaComUso * (nVlr/30))
                        nVlrSemUso := (nDiaSemUso * (nVlr/30)*0.5)
                        nVlr          := (nVlrComUso + nVlrSemUso)
                    endif
                endif
            endif
            if lCalcular
                nCarencia    := Carencia( dCalculo, Recemov->Vcto )
                nMulta        := 0
                nDesconto    := VlrDesconto( dCalculo, Recemov->Vcto, nVlr )
                nJurodia     := Recemov->Jurodia
                nJuros        := IF( nAtraso <= 0, 0, ( nCarencia * nJurodia ))
            endif

            nValorTotal += nVlr
            nTotalGeral += nVlr
            nTotalGeral += nJuros
            nTotalGeral += nMulta
            nTotalGeral -= nDesconto
            nSoma         := ((nVlr + nMulta ) + nJuros ) - nDesconto
            nMulta        := VlrMulta( dCalculo, Recemov->Vcto, nSoma )
            nSoma         += nMulta
            nTotalGeral += nMulta
            nConta++
            lAtivo        := .T.


























            Recemov->(Aadd( oReceposi:xTodos, { Docnr, Emis, Vcto, nAtraso, nVlr, nDesconto, nMulta, nJuros, nSoma, Codi, xObs, dTos(xDataPag)+dTos(Vcto)+Docnr, dTos(Vcto)+Docnr, dTos(xDataPag)+dTos(Vcto), Fatura, xDataPag, lAtivo, Recno(), dTos(xDataPag)+Docnr+dTos(Vcto), dTos(xDataPag)+Fatura+Docnr+dTos(Vcto), dTos(xDataPag)+Right(Docnr,8)+dTos(Vcto), dTos(xDataPag)+codi+Right(Docnr,8)+dTos(Vcto), xId, VlrOrigina, }))
            Recemov->(DbSkip(1))
        EndDo
        Restela( cTela )
    endif



    cTela := Mensagem("Aguarde, Localizando registros Recebidos")
    if nChoice <> 3 .AND. nChoice <> 6
        dbSelectArea( "Recebido" )
        Recebido->(Order( Ind_Recebido ))
        Recebido->(DbSeek( xSeek ))
    endif

    WHILE Recebido->(Eval(oBloco2))
        if nConta >= 65535
            Alerta("Informa: Impossivel mostrar mais do que 65535 registros.")
            Exit
        endif
        cDocnr   := Recebido->Docnr
        cCodi    := Recebido->Codi
        lAtivo     := .T.

        if     nOrdem == NIL .OR. nOrdem == 1 .OR. oAmbiente:PosiAgeInd .OR. oAmbiente:PosiAgeAll

        elseif nOrdem == 2
            if Recibo->(DbSeek(cDocnr))
                Recebido->(DbSkip(1))
                Loop
            endif

        elseif nOrdem == 3
            if Recibo->(!DbSeek(cDocnr))
                Recebido->(DbSkip(1))
                Loop
            endif
            if Recibo->Data < dIni .OR. Recibo->Data > dFim
                Recebido->(DbSkip(1))
                Loop
            endif
        endif

        nValorTotal += Recebido->Vlr
        nTotalGeral += Recebido->VlrPag
        xId         := 0
        xVlrOrigina := 0


























        Recebido->(Aadd( oReceposi:xTodos,    { Docnr, Emis, Vcto, (DataPag-Vcto), Vlr, 0, 0, 0, VlrPag, Codi, Obs, dTos(DataPag)+dTos(Vcto)+Docnr, dTos(Vcto)+Docnr, dTos(DataPag)+dTos(Vcto), Fatura, Datapag, lAtivo, Recno(), dTos(DataPag)+Docnr+dTos(Vcto), dTos(DataPag)+Fatura+Docnr+dTos(Vcto), dTos(DataPag)+Right(Docnr,8)+dTos(Vcto), dTos(DataPag)+codi+Right(Docnr,8)+dTos(Vcto), xId, xVlrOrigina,    }))
        nConta++
        Recebido->(DbSkip(1))
    EndDo

    lRegistroEmBranco := .F.


    lRegistroEmBranco := oRecePosi:RegistroEmBranco(ccodi, cFatu)


    ResTela( cTela )

    Recemov->(OrdScope(0))  ; Recemov->(OrdScope(1))
    Recebido->(OrdScope(0)) ; Recebido->(OrdScope(1))

    if Len( oReceposi:xTodos ) > 0
        cTela := Mensagem("Informa: Aguarde, ordenando.")
        if nChoice = 5
            Asort( oReceposi:xTodos,,, {|x,y|y[13] > x[13]})
        elseif nChoice = 3
           if nOrdem = 1
                Asort( oReceposi:xTodos,,, {|x,y|y[12] > x[12]})
            elseif nOrdem = 2
                Asort( oReceposi:xTodos,,, {|x,y|y[12] > x[12]})
            elseif nOrdem = 3
                Asort( oReceposi:xTodos,,, {|x,y|y[23] > x[23]})
            endif
        else
           if nChoice = 1 .AND. xParam <> NIL .AND. nAsort <> NIL
               Asort( oReceposi:xTodos,,, {|x,y|y[nAsort] > x[nAsort]})
            else
                if cTipoRecibo == nil
                    Asort( oReceposi:xTodos,,, {|x,y|y[12] > x[12]})
                else
                    Asort( oReceposi:xTodos,,, {|x,y|y[22] > x[22]})
                endif
            endif
        endif

        if lRegistroEmBranco
            if nConta > 1
                nPos := Ascan( oReceposi:xTodos, {|aVal|Aval[10] == "00000"})
                oReceposi:xTodos[nPos,10] := oReceposi:xTodos[2,10]
            endif
        endif

        xLen := Len(oReceposi:xTodos)
        nCor := iif(lRecepago        == NIL , NIL , oReceposi:CorDuplicado)
        nCor := iif(oReceposi:nOrdem == 3 , oReceposi:CorDesativado, nCor)
        For nT := 1 To xLen
           oReceposi:addcolor(nCor)
            Aadd( oReceposi:aHistRecibo, Space(0))
            Aadd( oReceposi:aUserRecibo, Space(0))
            Aadd( oReceposi:aReciboImpresso, .F. )
            Aadd( oReceposi:aAtivoSwap,  oReceposi:xTodos[nT,17])
            Aadd( oReceposi:aAtivo,       oReceposi:xTodos[nT,17])
            Aadd( oReceposi:aDatapag,       oReceposi:xTodos[nT,16])
         Aadd( oReceposi:aRecno,      oReceposi:xTodos[nT,18])
            Aadd( oReceposi:alMulta,    (oReceposi:xTodos[nT,7] <> 0))
         Aadd( oReceposi:aCodi,       oReceposi:xTodos[nT,10] )
            Aadd( oReceposi:aTodos,{})
            oRecePosi:sTrFormataATodos(nT)
        Next
        Restela( cTela )
        cTela                 := Mensagem("Informa: Aguarde, Calculando...")
        oReceposi:CloneVarColor()
        nJuroMesComposto      := oAmbiente:aSciArray[1,8]
        nJuroMesComposto      := IF( nJuroMesComposto <= 0 .OR. nJuroMesComposto == nil , 1 , nJuroMesComposto)
        oReceposi:dini        := dini
      oReceposi:dfim        := dfim
      oReceposi:dcalculo    := dcalculo
        oReceposi:nChoice     := nChoice
        oReceposi:xParam      := xParam
        oReceposi:lRescisao   := lRescisao
        oReceposi:lCalcular   := lCalcular
        AltJrInd(1,nJuroMesComposto, oReceposi:aCodi[1], (lMsg := .F.), oSender := oReceposi)

        if oAmbiente:Mostrar_Recibo
            SeekLog(oReceposi:xTodos, oReceposi:aTodos, nil, lRecepago)
        endif

        ResTela( cTela )
        oMenu:StatInf()
        oMenu:ContaReg(xLen)

        if lRecarregar <> NIL .AND. !lRecarregar
            return
        endif

        oRecePosi:cTop := " DOCTO N§  EMIS   VENCTO ATRA   ORIGINAL  PRINCIPAL DESC/PAG    JUROS  PG/MULTA     ABERTO       SOMA OBSERVACAO"
        MaBox( 00, 00, 06, nMaxCol )
        oRecePosi:cTop     += Space( MaxCol() - Len(oRecePosi:cTop))
        oRecePosi:cBottom := Space(13) + "PRINCIPAL             JUROS  PG/MULTA     ABERTO       SOMA"
        oRecePosi:aBottom := oReceposi:BarraSoma()
        __Funcao( 0, 1, 1 )

        lPageCircular := .F.
        oRecePosi:aChoice_(oReceposi:aTodos, oRecePosi:aAtivo, "__Funcao", lPageCircular )
        SetColor(cColor)
        oReceposi:PosiReceber := .F.
        oAmbiente:lReceber     := .F.
        oReceposi:Reset()
    endif
    resTela( cScreen )
    if !lSair
        xParam := NIL
    endif
    if lSair
        oReceposi:nOrdem := NIL
        exit
    endif
EndDo



Function __Funcao( nMode, nCurElemento)

LOCAL Arq_Ant      := Alias()
LOCAL Ind_Ant      := IndexOrd()
LOCAL cString         := Space(0)
LOCAL cObs             := Space(0)
LOCAL cObs1          := Space(0)
LOCAL nTamAtivo     := Len(oRecePosi:aAtivo)
LOCAL pFore          := Cor( 1 )
LOCAL pBack          := Cor( 5 )



LOCAL pUns           := AscanCorHKLightBar( pFore)
LOCAL oVenlan      := TIniNew( oAmbiente:xUsuario + ".INI")
LOCAL lAdmin       := oVenlan:ReadBool("permissao","usuarioadmin", .F. )
LOCAL nReg         := 0
LOCAL x
LOCAL nLen
LOCAL lLancarJurosNaoPago
LOCAL nJuroMesComposto
LOCAL cCodi
STATIC lStack
STATIC nRecno
FIELD UltCompra
FIELD Matraso
FIELD VlrCompra


























SetKey( 28, NIL )
SetKey( -1, NIL )
SetKey( -4, NIL )

nJuroMesComposto  := oAmbiente:aSciArray[1,8]
nJuroMesComposto  := IF( nJuroMesComposto <= 0 .OR. nJuroMesComposto == nil , 1 , nJuroMesComposto)
x                 := nCurElemento
cCodi             := oReceposi:aCodi[x]
nReg              := oReceposi:aRecno[x]
oReceposi:CurElemento := x
if oReceposi:PosiAgeInd
   if nRecno <> nil
       Agenda->(DbGoto(nRecno))
    endif
endif


nKey := UltimaTecla()

Do Case
Case nMode = 0
    cString := Space(0)
    if lStack <> NIL
      cString += "MOSTRA INDIVIDUAL|"
    endif
    if !oAmbiente:Mostrar_Desativados
      cString += "FILTRO ATIVADO|"
    endif
    if oAmbiente:Mostrar_Recibo
        if oAmbiente:lReceber
         cString += "RECIBO ATIVO[vm=encontrado]|"
        Else
         cString += "RECIBO ATIVO[vm=NAO encontrado]|"
        endif
    endif
   cString += "ESC RETORNA|"
   cString := "F2-TXJURO|F3-EDITAR|F4-DUPLICA|F5-ATUALIZA|CTRL+F5=VLR ORIGINAL|F6-ORDEM|F7=VISFATURA|SPC-FATURA|" + cString
    StatusSup( cString, Cor(2))
    Receber->(Order( 2 ))
    nMaxCol := MaxCol()
    cCodi   := oReceposi:aCodi[nCurElemento]
    if Receber->(DbSeek( cCodi ))
       Write( 01, 01, Space(nMaxCol-2))
        Write( 02, 01, Space(nMaxCol-2))
        Write( 03, 01, Space(nMaxCol-2))
        Write( 04, 01, Space(nMaxCol-2))
        Write( 05, 01, Space(nMaxCol-2))
        Write( 01, 01, cCodi + " " + Receber->Nome )
        Write( 02, 01, Receber->Ende + " " + Receber->Bair )
        Write( 03, 01, Receber->Cep  + "/" + Receber->Cida + " " + Receber->Esta )
        Write( 04, 01, Receber->Obs  )
        Write( 05, 01, Receber->Obs1 )
        Write( 01, nMaxCol-28, "Inicio      : " + Dtoc( Receber->Data ))
        Write( 02, nMaxCol-28, "Telefone #1 : " + Receber->Fone )
        Write( 03, nMaxCol-28, "Telefone #2 : " + Receber->Fax )
        Write( 04, nMaxCol-28, "Vlr Fatura  : " )

            if !oRecePosi:PosiAgeInd
                if !oReceposi:PosiAgeAll
                    if oRecePosi:aAtivo[nCurElemento]
                        cColor := SetColor()
                        Write( 04, 01, Space(nMaxCol-2))
                        Write( 05, 01, Space(nMaxCol-2))
                        cObs      := ltrim(rtrim(oReceposi:xTodos[nCurElemento,11]))
                        cObs1   := ltrim(rtrim(oReceposi:aUserRecibo[nCurElemento])) + "/"
                        cObs1   += ltrim(rtrim(Left(oReceposi:aHistRecibo[nCurElemento],(nMaxCol-4))))
                        Write( 04, 01, "{" + Left(cObs1,(nMaxCol-28)) + "}", pUns)
                        if Len( cObs ) <> 0
                            Write( 05, 01, "{" + Left(cObs,(nMaxCol-4)) + "}", pUns)
                        Else
                            cObs := Right(oReceposi:xTodos[nCurElemento,1],02)
                            Write( 05, 01, "{" + cObs + "¦ PARCELA DE SERVICOS DE INTERNET.}", pUns)
                        endif
                    endif
                endif
            endif

    Else
       Write( 01, 01, Space(nMaxCol-2))
        Write( 02, 01, Space(nMaxCol-2))
        Write( 03, 01, Space(nMaxCol-2))
        Write( 03, 01, "***** CLIENTE NAO LOCALIZADO ***** TALVEZ DELETADO?")
        Write( 04, 01, Space(nMaxCol-2))
        Write( 05, 01, Space(nMaxCol-2))
    endif
    return( 2)



Case nMode = 1
    return( 2)



Case nMode = 2
    return( 2)



Case LastKey() = 27
    return( 0)



Case LastKey() = 397
    if nCurElemento <= 1
        nCurElemento := 1
        return(2)
    endif
    if !oRecePosi:aAtivo[--nCurElemento]
        oRecePosi:aAtivo[nCurElemento] := .T.
    endif
    HB_KeyPut(5)
    return( 2)



Case LastKey() = 401
    if nCurElemento >= nTamAtivo
        nCurElemento := nTamAtivo
        return( 2)
    endif
    if !oRecePosi:aAtivo[++nCurElemento]
        oRecePosi:aAtivo[nCurElemento] := .T.
    endif
    HB_KeyPut(24)
    return( 2)



Case LastKey() = 28
    HelpReceposi()
    return( 2)



Case LastKey() = 10 .AND. oReceposi:PosiAgeAll
    cCodi := oReceposi:aCodi[ nCurElemento ]
    oReceposi:PosiAgeAll := .F.
    NewPosiAgeInd( cCodi, nReg )
    oReceposi:PosiAgeAll := .T.
    return( 2)



Case LastKey() = 10 .AND. oReceposi:PosiAgeInd
    if !ladmin
        if !PodeAlterar()
            alertaPy(" INFO: Utilize as teclas CTRL + P para imprimir RECIBO! ;-;; Use ESC para retornar.;", 31 , .F.)
        endif
    else
        cCodi  := oReceposi:aCodi[ nCurElemento ]
       nRecno := oReceposi:aRecno[nCurElemento]
      Agenda->(DbGoto(nRecno))
        AgendaDbedit(nRecno)
        oReceposi:Color_pFore[x] := oReceposi:CorAlterado
        Repaint(NIL , x + 1)
        oReceposi:Color_pFore[x] := oReceposi:CorAlterado
        return( 5 )
    endif
    return( 2)



Case LastKey() = 10 .AND. oReceposi:Posireceber
    if !ladmin
        if !PodeAlterar()
            nNivel = 10
            if !PedePermissao(nNivel)
                alertaPy(" INFO: Utilize as teclas CTRL + P para imprimir RECIBO! ;-;; Use ESC para retornar.;", 31 , .F.)
                Return( 2)
            endif
        endif
    endif
    x     := nCurElemento
    cCodi := oReceposi:aCodi[x]
    nReg  := oReceposi:aRecno[x]
    if AlteraReceber(oReceposi:xTodos[x, 1], nReg)
       AtualizaReg(nReg)
        if cCodi <> oReceposi:aCodi[x]
            oReceposi:DeleteReg(x)
            return( 10 )
        endif
        oReceposi:Color_pFore[x] := oReceposi:CorAlterado

        return( 5 )
    endif
    return( 2)



Case LastKey() = -3 .AND. oReceposi:PosiReceber
    if !ladmin
        if !PodeIncluir()
            alertaPy(" INFO: Utilize as teclas CTRL + P para imprimir RECIBO! ;-;; Use ESC para retornar.;", 31 , .F.)
        endif
    else
        Recemov->(DbGoto(nReg))
      if DuplicaDocnr()
           oReceposi:AddColor(oReceposi:CorDuplicado)
            Repaint(NIL , x + 1)
            oReceposi:Color_pFore[x]     := oReceposi:CorDuplicado
            oReceposi:Color_pFore[x + 1] := oReceposi:CorDuplicado
            return( 5 )
        endif
    endif
    return( 2)



Case LastKey() = -2 .AND. oReceposi:PosiReceber
    RecemovDbedit( cCodi, nReg)
    if AtualizaReg(nReg)
        ReleaseSelecao()
        Repaint(NIL , x)
    endif
    return( 5 )



Case LastKey() = -90 .AND. oReceposi:PosiReceber
    RecemovDbedit( cCodi, nReg)
    if AtualizaReg(nReg)
        ReleaseSelecao()
        Repaint(NIL , x)
    endif
    return( 5 )



Case LastKey() = -3 .AND. oReceposi:PosiAgeInd .OR. LastKey() = -3 .AND. oReceposi:PosiAgeAll
    if !ladmin
        if !PodeIncluir()
            alertaPy(" INFO: Utilize as teclas CTRL + P para imprimir RECIBO! ;-;; Use ESC para retornar.;", 31 , .F.)
        endif
    else
        Agenda->(DbGoto(nReg))
      if DuplicaAgenda()
            oReceposi:AddColor(oReceposi:CorDuplicado)
            Repaint(NIL , x + 1 )
            oReceposi:Color_pFore[x]     := oReceposi:CorDuplicado
            oReceposi:Color_pFore[x + 1] := oReceposi:CorDuplicado
            return( 5 )
        endif
    endif
    return( 2)



Case LastKey() = -4 .AND. oReceposi:PosiReceber
   if oAmbiente:lReceber
        if AtualizaReg(nReg)
            ReleaseSelecao()
            Repaint(cCodi, x)
        endif
    endif
    return( 5 )



Case LastKey() = 16 .AND. oReceposi:PosiReceber
   if len(oReceposi:aDocnr_Selecao_Imprimir) > 0
        if (ReciboIndividual( cCaixa, NIL, NIL, oReceposi:aSoma_Selecao_Imprimir, oReceposi:aDocnr_Selecao_Imprimir, nil , nil , nil , oReceposi:aObs_Selecao_Imprimir ))
            oReceposi:ResetSelecao()
            return( 5)
        endif
    else
        x := nCurElemento
        if oReceposi:xTodos[x, 1] == "000000-00"
            ErrorBeep()
            alertaPy(" ERRO: Escolha uma fatura valida. ;-;; Use ESC para retornar.;", 31 , .F.)
            return( 2)
        endif
        ReciboIndividual( cCaixa, NIL, NIL, oReceposi:xTodos[nCurElemento,9], oReceposi:xTodos[nCurElemento,1])
    endif
    return( 2)

Case LastKey() = 16 .AND. oReceposi:PosiAgeInd
    FichaAtendimento( cCaixa, cVendedor, oReceposi:xTodos, nCurElemento)
    return( 2)

Case LastKey() = 16 .AND. oReceposi:PosiAgeAll
    FichaAtendimento( cCaixa, cVendedor, oReceposi:xTodos, nCurElemento)
    return( 2)



Case LastKey() = 22 .AND. oReceposi:PosiReceber
    AgeCobranca( cCodi)

    return( 5)

Case LastKey() = 22 .AND. oReceposi:PosiAgeInd
    if AgeCobranca( cCodi )
        oReceposi:AddColor(oReceposi:CorDuplicado)
        Repaint()
        return( 5)
    endif
    return( 2)

Case LastKey() = 22 .AND. oReceposi:PosiAgeAll
    if AgeCobranca( cCodi )
        Repaint()
        return( 5)
    endif
    return( 2)



Case LastKey() = 402
    if oReceposi:PosiAgeInd .OR. oReceposi:PosiAgeAll
        AgeCobranca( cCodi )
        return( 2)
    else
       K_Ctrl_Ins()
        return( 2 )
    endif
    return( 2)



Case LastKey() = 403
    K_Ctrl_Del()
    return( 2)



Case LastKey() = 13 .AND. oReceposi:PosiAgeAll
    if oReceposi:PosiReceber .AND. oReceposi:PosiAgeInd
        return( 2)
    endif
    NewPosiReceber(1, cCodi)
    return( 2)

Case LastKey() = 13 .AND. oReceposi:PosiAgeInd
     if oAmbiente:lReceber .OR. oReceposi:PosiReceber
        alertaPy(" INFO: Novamente? rsrs  ;-;; Use ESC para retornar.;", 31 , .F.)
        return( 2)
    endif
    if oAmbiente:lRecepago
        alertaPy(" INFO: Novamente? rsrs  ;-;; Use ESC para retornar.;", 31 , .F.)
    else
        NewPosiReceber(1, cCodi)
    endif
    return( 2)

Case LastKey() = 13 .AND. oReceposi:PosiReceber
    if oAmbiente:PosiAgeInd .OR. oReceposi:PosiAgeInd .OR. oReceposi:PosiAgeAll
        alertaPy(" INFO: Novamente? rsrs  ;-;; Use ESC para retornar.;", 31 , .F.)
        return( 2)
    endif
    if oRecePosi:lReceberPorPeriodo
       NewPosiReceber(1, cCodi)
        return( 2)
    endif
    NewPosiAgeInd( cCodi)
    return( 2)

Case LastKey() = 13
    if lStack = NIL
        lStack := .T.
        NewPosiReceber(1, cCodi)
        lStack := NIL
        oRecePosi:Redraw_()
        return( 2)
    else
        alertaPy(" ERRO: ESC retornar, apos escolha outro cliente ou CTRL+P imprimir.INFO: Novamente? rsrs  ;-;; Use ESC para retornar.;", 31 , .F.)
    endif
    return( 2)


Case LastKey() = -5
    if oReceposi:PosiAgeInd .OR. oReceposi:PosiAgeAll
        Return( 2)
    endif

    if oReceposi:PosiReceber








        aMenu := {    "Mostrar em Ordem [VCTO   ][DOCNR ]",    "Mostrar em Ordem [DATAPAG][VCTO  ]",    "Mostrar em Ordem [DATAPAG][VCTO  ][DOCNR]",    "Mostrar em Ordem [DATAPAG][DOCNR ][VCTO ]",    "Mostrar em Ordem [DATAPAG][FATURA][DOCNR][VCTO]",    "Mostrar em Ordem [VCTO]",    "Mostrar em Ordem [DOCNR]" }

        M_Title("ESCOLHA A ORDEM DE VISUALIZACAO")
        nOp := FazMenu( 10,10, aMenu, Cor())
        Do Case
        Case nOp = 0
            Return(2)
        Case nOp = 1
           PosiReceber(1, cCodi, nil, nil, 13 )
        Case nOp = 2
           PosiReceber(1, cCodi, nil, nil, 14 )
        Case nOp = 3
           PosiReceber(1, cCodi, nil, nil, 12 )
        Case nOp = 4
           PosiReceber(1, cCodi, nil, nil, 19 )
        Case nOp = 5
           PosiReceber(1, cCodi, nil, nil, 20 )
        Case nOp = 6
           PosiReceber(1, cCodi, nil, nil, 3 )
        Case nOp =7
           PosiReceber(1, cCodi, nil, nil, 1 )
        EndCase
        oRecePosi:Redraw_()
      return( 2)
    endif
    return( 2)


Case LastKey() =-1
    if oReceposi:PosiAgeInd .OR. oReceposi:PosiAgeAll
         return( 2)
    endif

    if oReceposi:PosiReceber
      if AltJrInd(1,NIL, cCodi, nil, oSender := oReceposi)
           Repaint( cCodi, x)
         return( 5)
      endif
   endif
    return( 2)


Case LastKey() = 7 .AND. oReceposi:Posireceber
    if oReceposi:PosiReceber
        if !PodeExcluir()
         nNivel = 11
         if !PedePermissao(nNivel)
            Return( 2)
         endif
      endif
      if Conf("Pergunta: Deletar registro RECEMOV?")
         Recemov->(DbGoto(oReceposi:aRecno[x]))
         if Recemov->(TravaReg())
            Recemov->(DbDelete())
                Recemov->(Libera())
                oReceposi:DeleteReg(x)

                return( 10)
            endif
      endif
   endif
    return( 2 )

Case LastKey() = 7 .AND. oReceposi:PosiAgeInd .OR. oReceposi:PosiAgeAll
    if oReceposi:PosiAgeInd .OR. oReceposi:PosiAgeAll
      if !PodeExcluir()
         nNivel = 11
         if !PedePermissao(nNivel)
            return( 2 )
         endif
      endif
      if Conf("Pergunta: Deletar registro AGENDA?")
         Agenda->(DbGoto(oReceposi:aRecno[nCurElemento]))
         if Agenda->(TravaReg())
            Agenda->(DbDelete())
                Agenda->(Libera())
                if Agenda->(!DbSeek( cCodi ))
                    return( 0)
                endif
                Repaint( cCodi, x)
                return( 5 )
            endif
        endif
   endif
    return( 2 )

Case LastKey() = 406
    if oReceposi:PosiReceber
       if Conf("Pergunta: Lancar juros nao pagos?")
          nLen  := Len( oReceposi:xTodos)
            cTela := Mensagem("Aguarde, Lancando juros nao pagos.")
           for x := 2 to nLen
                if oReceposi:aAtivoSwap[x] <> NIL .AND. oRecePosi:aAtivoSwap[x]
                    loop
                endif
              Recemov->(DbGoto(oReceposi:aRecno[x]))
              if (Carencia( oReceposi:xTodos[x, 16], oReceposi:xTodos[x, 3])) > 0
                   lLancarJurosNaoPago   := .T.
                    lAjustarValorOriginal := .T.
                   if (ReciboIndividual( cCaixa, NIL, NIL, oReceposi:xTodos[x,9], oReceposi:xTodos[x,1], lLancarJurosNaoPago, oReceposi:xTodos[x, 7], oReceposi:xTodos[x, 16], NIL, lAjustarValorOriginal))
                       oReceposi:AddColor(oReceposi:CorDuplicado)
                    endif
                endif
            next
            Restela( cTela )
            AltJrInd(1, NIL, cCodi, (lMsg := .F.), oSender := oReceposi)
            Repaint( cCodi, x)
         return( 5)
        endif
    endif
   return( 2)

Case LastKey() = 42
    if oReceposi:PosiReceber
        if !(oRecePosi:aReciboImpresso[x])

            alertaPy(" ERRO: Selecione uma parcela paga! ;-;; Use ESC para retornar.;", 31 , .F.)
            return( 2)
        endif
       if Conf("Pergunta: Lancar juros nao pagos desta parcela?")

                cTela := Mensagem("Aguarde, Lancando juros nao pagos.")
                Recemov->(DbGoto(oReceposi:aRecno[x]))
                if (Carencia( oReceposi:xTodos[x, 16], oReceposi:xTodos[x, 3])) > 0
                    lLancarJurosNaoPago   := .T.
                    lAjustarValorOriginal := .T.
                    if (ReciboIndividual( cCaixa, NIL, NIL, oReceposi:xTodos[x,9], oReceposi:xTodos[x,1], lLancarJurosNaoPago, oReceposi:xTodos[x, 7], oReceposi:xTodos[x, 16], NIL, lAjustarValorOriginal))
                        Restela( cTela )
                        AltJrInd(1, NIL, cCodi, (lMsg := .F.), oSender := oReceposi)
                        oReceposi:AddColor(oReceposi:CorDuplicado)
                        Repaint( cCodi, x)
                        return( 5)
                    endif
                endif
                Restela( cTela )

        endif
    endif
   return( 2)

Case LastKey() =  -24
    if oReceposi:PosiReceber
        if !(oRecePosi:aReciboImpresso[x])

            alertaPy(" ERRO: Selecione uma parcela paga! ;-;; Use ESC para retornar.;", 31 , .F.)
            return( 2)
        endif
       if Conf("Pergunta: Ajustar valor original?")

                cTela := Mensagem("Aguarde, Lancando juros nao pagos.")
                Recemov->(DbGoto(oReceposi:aRecno[x]))
                if (Carencia( oReceposi:xTodos[x, 16], oReceposi:xTodos[x, 3])) > 0
                    lLancarJurosNaoPago   := .T.
                    lAjustarValorOriginal := .T.
                    if (ReciboIndividual( cCaixa, NIL , NIL , oReceposi:xTodos[x,9], oReceposi:xTodos[x,1], lLancarJurosNaoPago, oReceposi:xTodos[x, 7], oReceposi:xTodos[x, 16], NIL , lAjustarValorOriginal))
                        Restela( cTela )
                        AltJrInd(1, NIL, cCodi, (lMsg := .F.), oSender := oReceposi)
                        oReceposi:AddColor(oReceposi:CorAlterado)
                        Repaint( cCodi, x)
                        return( 5)
                    endif
                endif
                Restela( cTela )

        endif
    endif
   return( 2)

Case LastKey() = -6 .AND. oReceposi:Posireceber
   x := nCurElemento
    if oReceposi:xTodos[x, 1] == "000000-00"
        ErrorBeep()
        alertaPy(" ERRO: Escolha uma fatura valida. ;-;; Use ESC para retornar.;", 31 , .F.)
        return( 2)
    endif
    Ped_Cli9_2(oReceposi:xTodos[x, 15])
   return( 2)

Case LastKey() = -26 .AND. oReceposi:Posireceber
    x := nCurElemento
    if oReceposi:xTodos[x, 1] == "000000-00"
        ErrorBeep()
        alertaPy(" ERRO: Escolha uma fatura valida. ;-;; Use ESC para retornar.;", 31 , .F.)
        return( 2)
    endif
    if oReceposi:PosiReceber
        if (ManuFatura( cCaixa, NIL , .T., oReceposi:xTodos[x, 15]))
            AreaAnt( Arq_Ant, Ind_Ant )
            AltJrInd(1 , NIL , cCodi, (lMsg := .F.), oSender := oReceposi)
            Repaint( cCodi, x)
        endif
    endif
    return( 5)

Case LastKey() = -29 .AND. oReceposi:Posireceber
    x := nCurElemento
    if oReceposi:PosiReceber
        Orcamento(.T., cCaixa)
        AreaAnt( Arq_Ant, Ind_Ant )
        AltJrInd(1 , NIL , cCodi, (lMsg := .F.), oSender := oReceposi)
        Repaint( cCodi, x)
    endif
    return( 5)

Case LastKey() = 43 .AND. oReceposi:Posireceber
    x := nCurElemento
    if oReceposi:xTodos[x, 1] == "000000-00"
        ErrorBeep()
        alertaPy(" ERRO: Escolha uma fatura valida. ;-;; Use ESC para retornar.;", 31 , .F.)
        return( 2)
    endif

    if oReceposi:PosiReceber
      oReceposi:aAtivo[nCurElemento] := .F.
        Aadd( oReceposi:aDocnr_Selecao_Imprimir, oReceposi:xTodos[nCurElemento, 1])
        Aadd( oReceposi:aSoma_Selecao_Imprimir,  oReceposi:xTodos[nCurElemento, 9])
        Aadd( oReceposi:aObs_Selecao_Imprimir,   oReceposi:xTodos[nCurElemento, 11])
        Aadd( oReceposi:aCurElemento_Selecao,    nCurElemento )
        oReceposi:nSoma_Total_Imprimir        += oReceposi:xTodos[nCurElemento, 9]
        oReceposi:nPrincipalSelecao           += oReceposi:xTodos[nCurElemento, 5]
        oReceposi:nMultaSelecao               += oReceposi:xTodos[nCurElemento, 7]
        oReceposi:nJurosSelecao               += oReceposi:xTodos[nCurElemento, 8]
        oReceposi:nRescisaoSelecao            += oReceposi:aRescisao[nCurElemento]
        oReceposi:RedrawSelecao()
        oReceposi:Color_pUns[nCurElemento]    := oReceposi:CorSelecao
        oReceposi:CloneVarColor()

        return( 5)
   endif
    return( 2)

Case LastKey() = 45 .AND. oReceposi:Posireceber
    if oReceposi:PosiReceber
        x := nCurElemento
        x := len(oReceposi:aDocnr_Selecao_Imprimir)
        if x > 0
            nCurElemento := oReceposi:aCurElemento_Selecao[x]
            oReceposi:nSoma_Total_Imprimir        -= oReceposi:xTodos[nCurElemento, 9]
            oReceposi:nPrincipalSelecao           -= oReceposi:xTodos[nCurElemento, 5]
            oReceposi:nMultaSelecao               -= oReceposi:xTodos[nCurElemento, 7]
            oReceposi:nJurosSelecao               -= oReceposi:xTodos[nCurElemento, 8]
            oReceposi:nRescisaoSelecao            -= oReceposi:aRescisao[nCurElemento]
            Asize( oReceposi:aDocnr_Selecao_Imprimir,  (x-1))
            Asize( oReceposi:aSoma_Selecao_Imprimir,   (x-1))
            Asize( oReceposi:aObs_Selecao_Imprimir,    (x-1))
            Asize( oReceposi:aCurElemento_Selecao,     (x-1))
            oReceposi:aAtivo[nCurElemento]             := .T.
            oReceposi:RedrawSelecao()
            oReceposi:CurElemento := nCurElemento
            oReceposi:CloneVarColor()


            if (x-1) = 0
                oReceposi:ResetAll()
            endif
            return( 10)
        endif
    endif
    return( 2)

Case LastKey() = 32
    x := nCurElemento
    if oReceposi:xTodos[x, 1] == "000000-00"
        ErrorBeep()
        alertaPy(" ERRO: Escolha uma fatura valida. ;-;; Use ESC para retornar.;", 31 , .F.)
        return( 2)
    endif
    if oReceposi:PosiAgeInd .OR. oReceposi:PosiAgeAll
        return( 2)
    endif
    if oReceposi:PosiReceber
        if !oAmbiente:lK_Insert
            if oAmbiente:lReceber
                oAmbiente:lK_Insert := .T.
                oAmbiente:ZebrarAmostragem := .T.
                NewPosiReceber(5, oReceposi:xTodos[nCurElemento, 15])
                oAmbiente:lReceber := .T.
                oAmbiente:ZebrarAmostragem := .F.
                Repaint( cCodi, x)
            else
                NewPosiReceber(5, oReceposi:xTodos[nCurElemento, 15])
            endif
            oAmbiente:lK_Insert := .F.
        else
            if !oAmbiente:lK_Insert_Plus
               oAmbiente:lK_Insert_Plus   := .T.
                NewPosiReceber(7, {oReceposi:xTodos[nCurElemento, 1], oReceposi:xTodos[nCurElemento, 10], oReceposi:xTodos[nCurElemento, 16], oReceposi:xTodos[nCurElemento, 16]})
                oAmbiente:lK_Insert_Plus   := .F.
            else
                alertaPy(" INFO: Novamente? rsrs ;-;; Use ESC para retornar.;", 31 , .F.)
            endif
        endif
    endif
    return( 5 )

Case LastKey() = 400
    if oReceposi:PosiAgeInd .OR. oReceposi:PosiAgeAll
        return( 2)
    endif
    if oReceposi:PosiReceber
        if !oAmbiente:lK_Insert
            oAmbiente:lK_Insert := .T.
            if oAmbiente:lReceber
                NewPosiReceber(8, {oReceposi:xTodos[nCurElemento, 10], oReceposi:xTodos[nCurElemento, 16], oReceposi:xTodos[nCurElemento, 16]})
                oAmbiente:lK_Insert := .F.
                oAmbiente:lReceber := .T.
                iif(oReceposi:nOrdem == 3, NIL , Repaint(cCodi, x))
                if oAmbiente:lK_Ctrl_Ins
                   K_Ctrl_Ins()
                endif
            else
                NewPosiReceber(8, {oReceposi:xTodos[nCurElemento, 10], oReceposi:xTodos[nCurElemento, 16], oReceposi:xTodos[nCurElemento, 16]})
            endif
            oAmbiente:lK_Insert := .F.
        else
            alertaPy(" INFO: Novamente? rsrs ;-;; Use ESC para retornar.;", 31 , .F.)
        endif
    endif
    return( 5 )

OtherWise
   return( 2)

EndCase
return nil



function Repaint(cCodi, nCurElemento, nChoice)

LOCAL lRecarregar := .F.
LOCAL nLen
LOCAL xParam
IF cCodi == NIL ; cCodi := oReceposi:aCodi[oReceposi:CurElemento] ; END
IF nChoice == NIL ; nChoice := oReceposi:nChoice ; END

hb_default(@xParam, iif(nChoice == 1, cCodi, oReceposi:xParam))
oReceposi:ColorToAmbiente()
if oReceposi:Posireceber
    PosiReceber(nChoice, xParam, NIL, NIL, NIL, NIL, .F.)
elseif oReceposi:PosiAgeInd
    PosiAgeInd(cCodi, NIL, .F.)
elseif oReceposi:PosiAgeAll
    PosiAgeAll(.F.)
endif

nLen := Len(oReceposi:aTodos)
IF nCurElemento == NIL ; nCurElemento := nLen ; END

oReceposi:CurElemento := iif(nCurElemento > nlen, nLen, nCurElemento)
oRecePosi:ImprimeSoma()

return NIL

function AtualizaReg(nReg)

LOCAL aJuro := {}
LOCAL nT    := oReceposi:CurElemento

Recemov->(DbGoto(nReg))
aJuro := CalcCmJuros( 1 , NIL , Recemov->Vlr, Recemov->Vcto, Date())

if Recemov->(TravaReg())
    Recemov->Juro      := aJuro[1]
    Recemov->JuroDia   := aJuro[2]
    Recemov->JuroTotal := aJuro[3]
    if Recibo->(DbSeek(Recemov->Docnr))
        Recemov->Datapag := Recibo->Data
        Recemov->VlrPag  := Recibo->Vlr
        Recemov->StPag   := .T.
    endif
    Recemov->(Libera())
    oReceposi:xTodos[nT, 10]   := Recemov->Codi
    oReceposi:xTodos[nT, 1]  := Recemov->Docnr
    oReceposi:xTodos[nT, 2]   := Recemov->Emis
    oReceposi:xTodos[nT, 3]   := Recemov->Vcto
    oReceposi:xTodos[nT, 11]    := Recemov->Obs
    oReceposi:xTodos[nT, 5]    := Recemov->Vlr
    oReceposi:xTodos[nT, 4] := Date() - Recemov->Vcto
    oReceposi:xTodos[nT, 9]   := AtualizaSoma(oReceposi)[3]
    oReceposi:xTodos[nT, 7]  := AtualizaSoma(oReceposi)[1]
    oReceposi:xTodos[nT, 8]  := AtualizaSoma(oReceposi)[2]
    oReceposi:xTodos[nT, 9]   := AtualizaSoma(oReceposi)[3]
   oRecePosi:sTrFormataATodos(nT)
    SeekLog(oReceposi:xTodos, oReceposi:aTodos, nT)
    oReceposi:Displine( oReceposi:aTodos[nT], oReceposi:nTop + oReceposi:nPos - oReceposi:nAtTop, oReceposi:nLeft, .T., .T., oReceposi:nNumCols, nT )
    oRecePosi:aBottom := oReceposi:BarraSoma()
    return .T.
endif
return .F.

function AtualizaSoma(oSender)

LOCAL nAtraso    := Atraso( oSender:dCalculo, Recemov->Vcto )
LOCAL nVlr       := Recemov->Vlr
LOCAL    nDiaComUso := 0
LOCAL    nDiaSemUso := 0
LOCAL nVlrComUso := 0
LOCAL nVlrSemUso := 0
LOCAL nCarencia  := 0
LOCAL nMulta     := 0
LOCAL nDesconto  := 0
LOCAL nJuroDia   := 0
LOCAL nJuros     := 0
LOCAL nSoma      := 0

if oSender:lRescisao
    if nAtraso < 0
        if nAtraso < -30
            nVlr *= 0.5
        else
            nDiaComUso := (30 + nAtraso)
            nDiaSemUso := (30 - nDiaComUso)
            nVlrComUso := (nDiaComUso * (nVlr/30))
            nVlrSemUso := (nDiaSemUso * (nVlr/30)*0.5)
            nVlr          := (nVlrComUso + nVlrSemUso)
        endif
    endif
endif
if oSender:lCalcular
    nCarencia    := Carencia( oSender:dCalculo, Recemov->Vcto )
    nMulta        := 0
    nDesconto    := VlrDesconto( oSender:dCalculo, Recemov->Vcto, nVlr )
    nJurodia     := Recemov->Jurodia
    nJuros        := IF( nAtraso <= 0, 0, ( nCarencia * nJurodia ))
endif
nSoma         := ((nVlr + nMulta ) + nJuros ) - nDesconto
nMulta        := VlrMulta( oSender:dCalculo, Recemov->Vcto, nSoma )
nSoma         += nMulta
return {nMulta, nJuros, nSoma}

function ReleaseSelecao()

nLen := len(oReceposi:aDocnr_Selecao_Imprimir)
if nLen > 0
   for x := 1 to nLen
        nCurElemento                       := oReceposi:aCurElemento_Selecao[x]
        oReceposi:Color_pUns[nCurElemento] := oReceposi:CorRecibo
        oReceposi:aAtivo[nCurElemento]     := .T.
        oReceposi:RedrawSelecao()
    next
    oReceposi:ResetAll()
    oReceposi:CloneVarColor()
endif

function RecemovDbedit(cCodi, nRecno)

LOCAL Arq_Ant    := Alias()
LOCAL Ind_Ant    := IndexOrd()
LOCAL cScreen    := SaveScreen()
LOCAL oBrowse    := MsBrowse():New()
LOCAL cDocnr
SetKey( -2, NIL )

oMenu:Limpa()
dbSelectArea( "Recemov" )
Recemov->(Order( 2 ))
Recemov->(OrdScope( 0, cCodi))
Recemov->(OrdScope( 1, cCodi))
Recemov->(DbGoto(nRecno))
oBrowse:Add( "CODI",       "Codi")
oBrowse:Add( "TIPO",       "Tipo")
oBrowse:Add( "DOCNR",      "Docnr")
oBrowse:Add( "FATURA",     "Fatura")
oBrowse:Add( "EMIS",       "Emis")
oBrowse:Add( "VCTO",       "Vcto")
oBrowse:Add( "VLR",        "Vlr")
oBrowse:Add( "VLR ORIGINAL","VlrOrigina")
oBrowse:Add( "DATAPAG",    "Datapag")
oBrowse:Add( "VLRPAG",     "Vlrpag")
oBrowse:Add( "OBS",        "Obs")
oBrowse:Titulo   := "CONSULTA/ALTERACAO DE TITULOS A RECEBER"
oBrowse:Show()
oBrowse:Processa()
Recemov->(OrdScope(0))
Recemov->(OrdScope(1))
Recemov->(DbGoTop())
AreaAnt( Arq_Ant, Ind_Ant )
return(resTela(cScreen))

function RefreshTela()

LOCAL xLen           := Len(oRecePosi:xTodos)
LOCAL aJuro       := {}
LOCAL nReg

For nT := 1 To xLen
    nReg  := oReceposi:aRecno[nT]
    AtualizaReg(nReg)
next

return .T.

function K_Ctrl_Ins()

LOCAL nTamAtivo := Len(oRecePosi:aAtivo)

For x := 1 To nTamAtivo
    oRecePosi:aAtivo[x] := .T.
    if !oRecePosi:aAtivoSwap[x]
        oReceposi:Color_pFore[x] := oReceposi:CorDesativado
    endif
Next
oReceposi:ResetSelecao()
oAmbiente:lK_Ctrl_Ins := .T.
oAmbiente:lK_Ctrl_Del := .F.
return NIL

function K_Ctrl_Del()

LOCAL nTamAtivo := Len(oRecePosi:aAtivo)

For x := 1 To nTamAtivo
    oRecePosi:aAtivo[x] := oRecePosi:aAtivoSwap[x]
Next
oReceposi:ResetSelecao()
oAmbiente:lK_Ctrl_Ins := .F.
oAmbiente:lK_Ctrl_Del := .T.
return NIL

function HelpReceposi

    linhaembranco   := ";"
    linhahorizontal := "-"






















    alertaPy(   "         F1 : ESTE HELP                         " + ";" +     "         F2 : ATUALIZAR TAXAS DE JUROS          " + ";" +     "         F3 : EDITAR LANCAMENTOS                " + ";" +     "         F4 : DUPLICAR REGISTRO                 " + ";" +     "         F5 : ATUALIZAR TELA                    " + ";" +     "         F6 : ESCOLHER ORDEM AMOSTRAGEM         " + ";" +     "         F7 : VISUALIZAR FATURA                 " + ";" +     "        F10 : CALCULADORA                       " + ";" +     linhahorizontal + ";" +     "        INS : INSERIR AGENDAMENTO               " + ";" +     "        DEL : EXCLUIR REGISTRO                  " + ";" +     "    TECLA + : SELECIONAR REGISTRO               " + ";" +     "    TECLA - : DE-SELECIONAR REGISTRO            " + ";" +     "    TECLA * : LANCAR JUROS NŽO PAGOS PARCELA    " + ";" +     "BARRA SPACO : FILTRAR FATURA                    " + ";" +     linhahorizontal + ";" +     " CTRL+ENTER : ALTERAR REGISTRO                  " + ";" +     "     CTRL+P : IMPRIMIR RECIBO                   " + ";" +     "    CTRL+F5 : AJUSTAR VALOR ORIGINAL PARCELA    " + ";" +     "    CTRL+F7 : ALTERAR FATURA                    " + ";" +  "   CTRL+F10 : FATURAR                           " + ";" +  "     CTRL+* : LANCAR JUROS NAO PAGOS INDIVIDUAL " + ";" +     "     CTRL_+ : FILTRAR RECEBIDO POR DATAPAG      ", 31, .T.)
    return nil


function UltimaTecla()
   LOCAL nKey := LastKey()
    MS_SetConsoleTitle("TECLA # " + ltrim(rtrim(nKey)))
    return nKey


function EventStateAchoice()
#line 9972 "apoio.prg"
    hb_gtInfo( 60, { | nKey |
            SWITCH nKey
            CASE 402
                RETURN nKey
            ENDSWITCH
            RETURN nKey
        })

